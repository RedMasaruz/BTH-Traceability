<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <!-- Updated viewport to include safe-area for iOS devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ระบบบันทึกและติดตามเกษตรกร</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="ระบบบันทึกและติดตามข้อมูลเกษตรกร - บริษัท บ้านไทยเฮิร์บเซ็นเตอร์ จำกัด">
    <meta name="theme-color" content="#16a34a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BTH Farmer">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- App Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512x512.png">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-192x192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+Thai:wght@400;500;600;700;800&family=Sarabun:wght@400;600;700&display=swap"
        rel="stylesheet">
    <style>
        /* Pastel Palette and Responsive enhancements merged with original styles
           - Restored original styles and added fluid/responsive variables + improved breakpoints
           - Keeps existing theme and detailed component rules while making layout stable across
             phones, tablets (including iPad) and desktops
        */

        /* ---------------------------
           Responsive variables (added/merged)
           --------------------------- */
        :root {
            /* Colors */
            --color-pastel-bg: #f5f8fa;
            --color-card-a: #DCD0FF;
            --color-card-a-dark: #A396D1;
            --color-card-b: #B9FBC0;
            --color-card-b-dark: #8BD193;
            --color-accent: #f7c9b6;
            --color-text-dark: #333333;
            --color-primary-medium: #44403c;
            --color-primary-dark: #292524;
            --dynamic-accent: #16a34a;
            --dynamic-highlight-bg: rgba(139, 209, 147, 0.12);
            --color-warning-bg: #fff7ed;
            --color-warning-accent: #fb923c;
            --color-border: #e5e7eb;

            /* Fluid typography (clamp) */
            --fs-xs: clamp(0.78rem, 0.67rem + 0.4vw, 0.95rem);
            --fs-sm: clamp(0.9rem, 0.85rem + 0.35vw, 1.05rem);
            --fs-base: clamp(1rem, 1rem + 0.5vw, 1.12rem);
            --fs-lg: clamp(1.1rem, 1.05rem + 0.8vw, 1.35rem);
            --fs-xl: clamp(1.35rem, 1.2rem + 1.2vw, 1.75rem);
            --fs-2xl: clamp(1.6rem, 1.45rem + 1.6vw, 2.1rem);

            /* Spacing scale */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2.5rem;

            /* Touch target */
            --touch-size: 44px;

            /* Breakpoints */
            --bp-mobile-max: 600px;
            --bp-tablet-max: 1024px;
            --bp-desktop-min: 1025px;

            /* Additional layout vars for merged styles */
            --gap-xs: 0.5rem;
            --gap-sm: 0.75rem;
            --gap-md: 1rem;
            --gap-lg: 1.5rem;
        }

        body {
            font-family: 'Noto Sans Thai', 'Inter', sans-serif;
            background-color: var(--color-pastel-bg);
            color: var(--color-text-dark);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-text-size-adjust: 100%;
            font-size: var(--fs-base);
        }

        .form-container {
            max-width: min(1200px, 96%);
            background-color: white;
            padding: clamp(16px, 2.6vw, 32px);
            border-radius: clamp(10px, 2vw, 20px);
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            margin: 0 auto;
            border: 1px solid rgba(0, 0, 0, 0.02);
        }

        /* MAIN MENU STYLES - UPDATED (merged with original) */
        .main-menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: clamp(12px, 1.6vw, 28px);
            margin-top: clamp(16px, 2.4vw, 32px);
        }

        .portal-card-enhanced {
            border-radius: 1.5rem;
            padding: clamp(12px, 2.5vw, 32px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: linear-gradient(135deg,
                    rgba(255, 255, 255, 0.9) 0%,
                    rgba(255, 255, 255, 0.7) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 160px;
            /* base shadow used for all portal cards to keep visual consistency */
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.06), 0 4px 6px rgba(15, 23, 42, 0.04);
        }

        .portal-card-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg,
                    #1B5E20 0%,
                    #4CAF50 50%,
                    #C8E6C9 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .portal-card-enhanced:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 30px 60px rgba(15, 23, 42, 0.09), 0 8px 20px rgba(15, 23, 42, 0.06);
        }

        .portal-card-enhanced:hover::before {
            opacity: 1;
        }

        .card-icon-wrapper {
            width: clamp(56px, 8vw, 96px);
            height: clamp(56px, 8vw, 96px);
            margin: 0 auto 1.5rem;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1),
                inset 0 0 0 1px rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
        }

        .portal-card-enhanced:hover .card-icon-wrapper {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15),
                inset 0 0 0 1px rgba(255, 255, 255, 0.8);
        }

        .card-title {
            font-size: clamp(1.0rem, 0.9rem + 0.8vw, 1.5rem);
            font-weight: 800;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            line-height: 1.15;
        }

        .card-description {
            font-size: var(--fs-sm);
            line-height: 1.6;
            color: #4a5568;
            text-align: center;
            margin-bottom: 1rem;
        }

        .card-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.5rem;
            text-align: center;
            width: 100%;
        }

        /* Specific card colorings preserved from original */
        #card-sheet-a .card-badge {
            background: linear-gradient(135deg, var(--color-green-light) 0%, var(--color-green-dark) 100%);
            color: #166534;
        }

        #card-sheet-b .card-badge {
            background: linear-gradient(135deg, #93C5FD 0%, #3b82f6 100%);
            color: white;
        }

        #card-sheet-b-use .card-badge {
            background: linear-gradient(135deg, #FFD6A5 0%, #fb923c 100%);
            color: #7c2d12;
        }

        /* --------- Restore green card (card-sheet-a) complete visual styles ---------
           These overrides ensure the green card (ประวัติข้อมูลแปลงกระท่อม)
           appearance is preserved and not unintentionally overridden by generic rules.
           This block restores background, padding, rounded corners, badge, CTA, icon color,
           title color, subtle inner glow and hover behaviour like in original design.
        */
        #card-sheet-a.portal-card-enhanced {
            background: linear-gradient(135deg, #E6FFF0 0%, #F0FFF6 100%) !important;
            border: 1px solid rgba(34, 197, 94, 0.06) !important;
            /* Use the same base shadow style as .portal-card-enhanced to ensure consistency */
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.06), 0 4px 6px rgba(15, 23, 42, 0.04) !important;
            color: #0b5a34 !important;
            padding: clamp(18px, 3.2vw, 36px) !important;
            border-radius: 22px !important;
            min-height: 220px !important;
        }

        /* Icon wrapper specific for green card */
        #card-sheet-a .card-icon-wrapper {
            background: linear-gradient(180deg, #ffffff 0%, #f7fff9 100%) !important;
            box-shadow: 0 18px 30px rgba(48, 145, 86, 0.06), inset 0 2px 0 rgba(255, 255, 255, 0.9) !important;
            border-radius: 16px !important;
        }

        /* Make the icon stroke fill green where applicable */
        #card-sheet-a .card-icon-wrapper svg {
            color: #10b981;
            /* tailwind emerald-400 like */
            width: clamp(40px, 6vw, 64px);
            height: clamp(40px, 6vw, 64px);
        }

        /* Title on green card: use solid dark green for best contrast */
        #card-sheet-a .card-title {
            background: none !important;
            background-clip: unset !important;
            -webkit-background-clip: unset !important;
            -webkit-text-fill-color: unset !important;
            color: #065f46 !important;
            font-size: clamp(1.05rem, 1.0rem + 0.9vw, 1.6rem) !important;
            line-height: 1.05 !important;
        }

        /* Description color slightly muted green/dark */
        #card-sheet-a .card-description {
            color: #166534 !important;
            opacity: 0.9;
            font-size: var(--fs-sm) !important;
        }

        /* CTA / badge styles emphasized */
        #card-sheet-a .card-badge {
            background: linear-gradient(90deg, #CFF7D9 0%, #8BD193 100%) !important;
            color: #044e2f !important;
            box-shadow: 0 8px 22px rgba(34, 128, 71, 0.08) !important;
            padding: 10px 18px !important;
            border-radius: 999px !important;
            display: inline-block;
            font-weight: 700 !important;
        }

        /* If there's a button inside the card (pastel-button) give it the green gradient look */
        #card-sheet-a .pastel-button {
            background: linear-gradient(90deg, #A7E0AE 0%, #7ED08C 100%) !important;
            color: #064e3b !important;
            box-shadow: 0 10px 24px rgba(34, 128, 71, 0.08) !important;
            border: none !important;
            padding: 10px 18px !important;
            border-radius: 999px !important;
        }

        /* Preserve hover tone but keep green emphasis */
        #card-sheet-a.portal-card-enhanced:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 30px 60px rgba(15, 23, 42, 0.09) !important;
        }

        /* Ensure text inside remains legible on all sizes */
        #card-sheet-a .card-title,
        #card-sheet-a .card-description,
        #card-sheet-a .card-badge {
            -webkit-font-smoothing: antialiased;
        }

        /* card-glow from original */
        .card-glow {
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .portal-card-enhanced:hover .card-glow {
            opacity: 1;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .portal-card-enhanced {
            animation: fadeInUp 0.6s ease forwards;
            animation-delay: calc(var(--card-index, 0) * 0.1s);
            opacity: 0;
        }

        /* Responsive adjustments (merged with original mobile rules) */
        @media (max-width: 768px) {
            .main-menu-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .portal-card-enhanced {
                padding: 2rem 1.5rem;
            }

            .card-icon-wrapper {
                width: 70px;
                height: 70px;
            }
        }

        /* Original portal-card styles preserved */
        .portal-card {
            border-radius: 1rem;
            padding: 2rem;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: scale(1);
        }

        .portal-card:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
            transform: scale(1.02);
        }

        /* FORM MENU view specific overrides */
        #form-menu-view .bg-green-50 {
            background-color: #f0fdf4;
        }

        #form-menu-view .border-green-300 {
            border-color: #86efac;
        }

        #form-menu-view .bg-green-100 {
            background-color: #dcfce7;
        }

        #form-menu-view .text-green-600 {
            color: #16a34a;
        }

        #form-menu-view .hover\:bg-green-50:hover {
            background-color: #f0fdf4;
        }

        #form-menu-view .hover\:border-green-300:hover {
            border-color: #86efac;
        }

        #form-menu-view .group-hover\:bg-green-200:hover {
            background-color: #bbf7d0;
        }

        #form-menu-view .group-hover\:text-green-600:hover {
            color: #16a34a;
        }

        /* specific original card backgrounds (kept) */
        #card-sheet-a {
            background: linear-gradient(135deg, var(--color-green-light), #e6ffec);
        }

        #card-sheet-b {
            background: linear-gradient(135deg, #93C5FD, #e0f2fe);
        }

        #card-sheet-b-use {
            background: linear-gradient(135deg, #FFD6A5, #ffecda);
        }

        /* Inputs styling merged */
        input[type="text"],
        input[type="tel"],
        input[type="number"],
        input[type="date"],
        textarea,
        select {
            padding: clamp(8px, 1.2vw, 12px);
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #ffffff;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            font-size: var(--fs-sm);
        }

        input:focus,
        textarea:focus,
        select:focus {
            border-color: var(--color-green-dark, #8BD193);
            outline: none;
            box-shadow: 0 0 0 3px rgba(139, 209, 147, 0.5);
        }

        .pastel-button {
            background-color: var(--color-green-light);
            color: var(--color-text-dark);
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 4px var(--color-green-dark);
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .pastel-button:hover {
            background-color: #A7E0AE;
            box-shadow: 0 2px var(--color-green-dark);
            transform: translateY(2px);
        }

        .pastel-button:active {
            transform: translateY(4px);
            box-shadow: 0 0 var(--color-green-dark);
        }

        .search-button {
            background-color: var(--color-card-b);
            color: var(--color-text-dark);
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 4px var(--color-card-b-dark);
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .search-button:hover {
            background-color: #A7E0AE;
            box-shadow: 0 2px var(--color-card-b-dark);
            transform: translateY(2px);
        }

        .search-button:active {
            transform: translateY(4px);
            box-shadow: 0 0 var(--color-card-b-dark);
        }

        .radio-group label {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            transition: all 0.2s;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: var(--fs-sm);
        }

        input[type="radio"]:checked+label,
        input[type="checkbox"]:checked+label {
            background-color: #dcfce7;
            border-color: #16a34a;
            font-weight: 600;
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--color-green-dark);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            display: inline-block;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Colors and utilities from original preserved */
        .bg-green-50 {
            background-color: #f0fdf4;
        }

        .bg-blue-50 {
            background-color: #f0f9ff;
        }

        .bg-orange-50 {
            background-color: #fff7ed;
        }

        .text-green-800 {
            color: #166534;
        }

        .text-blue-800 {
            color: #1e40af;
        }

        .text-orange-800 {
            color: #9a3412;
        }

        /* Utilities preserved */
        .hidden {
            display: none !important;
        }

        .block {
            display: block;
        }

        .flex {
            display: flex;
        }

        .grid {
            display: grid;
        }

        .space-y-4>*+* {
            margin-top: 1rem;
        }

        .space-y-6>*+* {
            margin-top: 1.5rem;
        }

        .space-x-4>*+* {
            margin-left: 1rem;
        }

        .mb-1 {
            margin-bottom: 0.25rem;
        }

        .mb-2 {
            margin-bottom: 0.5rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mb-6 {
            margin-bottom: 1.5rem;
        }

        .mt-2 {
            margin-top: 0.5rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .mt-6 {
            margin-top: 1.5rem;
        }

        .p-4 {
            padding: 1rem;
        }

        .p-8 {
            padding: 2rem;
        }

        .pt-2 {
            padding-top: 0.5rem;
        }

        .pt-4 {
            padding-top: 1rem;
        }

        .pb-2 {
            padding-bottom: 0.5rem;
        }

        .rounded-lg {
            border-radius: 0.5rem;
        }

        .rounded-xl {
            border-radius: 0.75rem;
        }

        .border {
            border: 1px solid #e5e7eb;
        }

        .border-t {
            border-top: 1px solid #e5e7eb;
        }

        .bg-stone-50 {
            background-color: #fafaf9;
        }

        .bg-stone-100 {
            background-color: #f5f5f4;
        }

        .bg-white {
            background-color: white;
        }

        .text-sm {
            font-size: var(--fs-sm);
        }

        .text-lg {
            font-size: var(--fs-lg);
        }

        .text-xl {
            font-size: var(--fs-xl);
        }

        .text-2xl {
            font-size: var(--fs-2xl);
        }

        .text-3xl {
            font-size: clamp(1.8rem, 1.6rem + 1.8vw, 2.4rem);
        }

        .font-medium {
            font-weight: 500;
        }

        .font-semibold {
            font-weight: 600;
        }

        .font-bold {
            font-weight: 700;
        }

        .font-extrabold {
            font-weight: 800;
        }

        .text-stone-500 {
            color: #78716c;
        }

        .text-stone-600 {
            color: #57534e;
        }

        .text-stone-700 {
            color: #44403c;
        }

        .text-stone-800 {
            color: #292524;
        }

        .text-red-600 {
            color: #dc2626;
        }

        .whitespace-nowrap {
            white-space: nowrap;
        }

        .flex-grow {
            flex-grow: 1;
        }

        .w-full {
            width: 100%;
        }

        .h-4 {
            height: 1rem;
        }

        .h-6 {
            height: 1.5rem;
        }

        .h-8 {
            height: 2rem;
        }

        .h-16 {
            height: 4rem;
        }

        .w-4 {
            width: 1rem;
        }

        .w-6 {
            width: 1.5rem;
        }

        .w-8 {
            width: 2rem;
        }

        .w-16 {
            width: 4rem;
        }

        .ml-2 {
            margin-left: 0.5rem;
        }

        .ml-4 {
            margin-left: 1rem;
        }

        .mr-1 {
            margin-right: 0.25rem;
        }

        .fixed {
            position: fixed;
        }

        .absolute {
            position: absolute;
        }

        .relative {
            position: relative;
        }

        .inset-0 {
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }

        .top-4 {
            top: 1rem;
        }

        .left-4 {
            left: 1rem;
        }

        .z-10 {
            z-index: 10;
        }

        .z-50 {
            z-index: 50;
        }

        .bg-opacity-30 {
            opacity: 0.3;
        }

        .opacity-30 {
            opacity: 0.3;
        }

        .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .shadow-2xl {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        /* Grid layouts preserved */
        .grid-cols-1 {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }

        .grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .grid-cols-3 {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        .md\:grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .md\:grid-cols-3 {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        .col-span-full {
            grid-column: 1 / -1;
        }

        .md\:col-span-2 {
            grid-column: span 2 / span 2;
        }

        /* Extra responsive rules (merged & added) */
        .radio-group input[type="checkbox"]:checked+label,
        .radio-group label.active {
            background-color: #dcfce7 !important;
            border-color: #16a34a !important;
            color: #166534;
            font-weight: 600;
        }

        select:disabled {
            background-color: #f9fafb;
            color: #374151;
            cursor: not-allowed;
            opacity: 1;
        }

        .bg-gray-100 {
            background-color: #f3f4f6;
        }

        .cursor-not-allowed {
            cursor: not-allowed;
        }

        .blue-button {
            background-color: #C3E0F5;
            color: #1E293B;
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 4px #8AB5DE;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .blue-button:hover {
            background-color: #9FC3EB;
            transform: translateY(2px);
            box-shadow: 0 2px #8AB5DE;
        }

        .blue-button:active {
            transform: translateY(4px) scale(0.98);
            box-shadow: 0 0 0 #8AB5DE;
            background-color: #BFD0F5;
        }

        /* Admin table responsive rules */
        .admin-table-scroll {
            max-height: 70vh;
            overflow: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .admin-table-scroll table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .admin-table-scroll thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #f8fafc;
        }

        .admin-table-scroll th {
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e5e7eb;
            white-space: nowrap;
            background: #f8fafc;
            color: #374151;
            min-width: 120px;
        }

        .admin-table-scroll td {
            padding: 10px 8px;
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: top;
            max-width: 200px;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .admin-table-scroll tr:hover {
            background-color: #e0f2fe !important;
        }

        /* Responsive scrolling adjustments */
        @media (max-width: 768px) {
            .admin-table-scroll {
                max-height: 50vh;
            }

            .admin-table-scroll th,
            .admin-table-scroll td {
                padding: 8px 6px;
                font-size: 12px;
                min-width: 100px;
            }
        }

        /* Custom scrollbar */
        .admin-table-scroll::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .admin-table-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .admin-table-scroll::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .admin-table-scroll::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Additional merged styles (original had many, preserved where needed) */

        /* ===== Additional styles inserted per user request (kept) ===== */
        .container {
            max-width: 1000px;
            margin: 20px auto;
            background: var(--color-card-bg);
            padding: 30px;
            border-radius: 20px;
            box-shadow:
                -10px -10px 20px rgba(255, 255, 255, 1),
                10px 10px 30px rgba(174, 174, 192, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .section-overview {
            background-color: var(--dynamic-highlight-bg);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            border: 1px solid var(--dynamic-accent);
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.1);
        }

        ol,
        ul {
            padding-left: 20px;
        }

        li {
            margin-bottom: 5px;
        }

        .step {
            background-color: var(--color-card-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--color-border);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
        }

        .step::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 6px;
            height: 100%;
            background-color: var(--dynamic-accent);
            opacity: 1;
        }

        .step:hover {
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            transform: translateY(-5px);
            border-color: var(--dynamic-accent);
        }

        .important {
            color: #EF4444;
            font-weight: 700;
        }

        .non-mandatory-note {
            font-size: 0.9em;
            font-weight: 400;
            color: var(--color-primary-medium);
            margin-left: 5px;
        }

        .note {
            background-color: var(--color-warning-bg);
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
            border-left: 8px solid var(--color-warning-accent);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            color: #4B5563;
        }

        .note-accent {
            background-color: var(--dynamic-highlight-bg) !important;
            border-left-color: var(--dynamic-accent) !important;
            color: var(--color-primary-dark) !important;
        }

        .status-box {
            display: inline-block;
            width: 18px;
            height: 18px;
            border-radius: 4px;
            margin-right: 8px;
            vertical-align: middle;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .red-box {
            background-color: #F87171;
        }

        .blue-box {
            background-color: #60A5FA;
        }

        .green-box {
            background-color: #4ADE80;
        }

        .yellow-box {
            background-color: #FCD34D;
        }

        hr {
            border: 0;
            border-top: 1px solid var(--color-border);
            margin: 40px 0;
        }

        /* Navigation tabs improved for touch */
        .nav-tabs {
            display: flex;
            flex-wrap: nowrap;
            gap: 12px;
            margin-bottom: 25px;
            padding: 10px 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .nav-tab {
            background: var(--color-card-bg);
            border: 1px solid var(--color-border);
            padding: 10px 20px;
            cursor: pointer;
            font-family: 'Noto Sans Thai', sans-serif;
            font-size: var(--fs-sm);
            font-weight: 600;
            color: var(--color-primary-medium);
            border-radius: 30px;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            user-select: none;
            white-space: nowrap;
            min-height: var(--touch-size);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .nav-tab:hover {
            color: var(--color-primary-dark);
            background-color: var(--dynamic-highlight-bg);
            border-color: var(--dynamic-accent);
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }

        .nav-tab.active {
            color: var(--color-card-bg);
            background-color: var(--dynamic-accent);
            border-color: var(--dynamic-accent);
            font-weight: 700;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .content-section {
            display: none;
            padding-top: 15px;
        }

        .content-section.active {
            display: block;
        }

        /* small-screen adjustments */
        @media (max-width: 600px) {
            body {
                padding: 10px;
                font-size: 14px;
            }

            .form-container {
                max-width: none;
                margin: 10px 0;
                padding: 15px 10px;
                border-radius: 12px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            }

            h1 {
                font-size: 1.8em;
                margin-bottom: 15px;
                padding-bottom: 10px;
            }

            h2 {
                font-size: 1.5em;
                margin-top: 15px;
                margin-bottom: 15px;
                padding-bottom: 5px;
            }

            h3 {
                font-size: 1.3em;
                margin-top: 15px;
            }

            .nav-tabs {
                justify-content: center;
                gap: 8px 6px;
                padding: 0;
            }

            .nav-tab {
                padding: 8px 14px;
                font-size: 0.9em;
                white-space: nowrap;
            }

            .step {
                padding: 10px 10px 10px 20px;
                margin-bottom: 10px;
            }

            .step::before {
                width: 4px;
            }
        }

        /* admin table wrapper rules merged and preserved */
        #admin-table-wrapper {
            overflow: visible !important;
        }

        #admin-table-container {
            max-height: 70vh !important;
            overflow: auto !important;
            -webkit-overflow-scrolling: touch !important;
            touch-action: pan-y !important;
            pointer-events: auto !important;
        }

        /* Accessibility focus */
        :focus {
            outline: 3px solid rgba(99, 102, 241, 0.12);
            outline-offset: 2px;
        }

        /* Safe-area support for iOS */
        @supports (padding: max(0px)) {
            body {
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        /* End merged head styles */
    </style>
</head>

<body class="p-4 md:p-8">

    <!-- Login Modal สำหรับตัวแทน -->
    <div id="login-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden"
        style="background: rgba(0, 0, 0, 0.5);">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold text-stone-800 mb-6 text-center">เข้าสู่ระบบสำหรับตัวแทน</h2>
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="space-y-4">
                    <div>
                        <label for="username" class="block text-sm font-medium mb-1">Username</label>
                        <input type="text" id="username" placeholder="username" required
                            class="w-full p-3 border border-stone-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium mb-1">Password</label>
                        <input type="password" id="password" placeholder="password" required
                            class="w-full p-3 border border-stone-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                    </div>
                    <div id="login-error" class="text-red-500 text-sm hidden text-center"></div>

                    <button id="login-submit" type="submit" class="w-full blue-button py-3 rounded-lg font-semibold">
                        เข้าสู่ระบบ
                    </button>
                    <button type="button" onclick="hideLoginModal()"
                        class="w-full bg-stone-200 text-stone-700 py-3 rounded-lg font-semibold hover:bg-stone-300">
                        ยกเลิก
                    </button>
                    <div class="text-center text-sm text-red-500 mt-4">
                        <p>หากลืมรหัสผ่าน: <strong>เข้าสู่ระบบ</strong></p>
                        <p>ติดต่อผู้ดูแลระบบ</p>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Back Button -->
    <button id="back-button" onclick="goBack()"
        class="fixed top-4 left-4 px-4 py-2 rounded-full bg-white shadow-lg z-10 hidden" title="กลับหน้าหลัก">
        <div class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-400 mr-1" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            <span class="text-sm text-stone-600">กลับหน้าหลัก</span>
        </div>
    </button>

    <div class="form-container mx-auto">
        <div id="api-warning" class="hidden"></div>

        <div id="api-status" class="hidden mt-4 p-3 rounded-lg text-sm"></div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="fixed inset-0 z-40 flex items-center justify-center hidden">
            <div class="absolute inset-0 bg-black opacity-20"></div>
            <div class="bg-white p-6 rounded-xl shadow-xl z-50 flex items-center">
                <div class="loading-spinner mr-3"></div>
                <span class="text-stone-700 font-medium" id="loading-text">กำลังโหลด...</span>
            </div>
        </div>

        <!-- Message Box -->
        <div id="message-box" class="fixed inset-0 z-50 flex items-center justify-center hidden">
            <div class="absolute inset-0 bg-black opacity-30"></div>
            <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full z-10 border-t-4 border-stone-800">
                <h3 id="message-title" class="text-xl font-bold mb-4 text-stone-800"></h3>
                <p id="message-content" class="mb-6 text-stone-600"></p>
                <button onclick="hideMessageBox()" class="w-full blue-button py-2 rounded-lg">ตกลง</button>
            </div>
        </div>

        <!-- MAIN MENU VIEW - UPDATED DESIGN -->
        <div id="main-menu-view" class="space-y-6 relative">
            <!-- added relative so absolute button positions correctly -->
            <!-- Admin floating button (top-right) -->
            <button id="admin-floating-btn" onclick="adminCheckAuthAndInit()" title="ผู้ดูแลระบบ (Admin)"
                aria-label="Admin"
                class="absolute top-4 right-4 z-50 transform hover:scale-105 transition-transform duration-200"
                style="width:72px; height:72px; border-radius:12px; background: linear-gradient(135deg,#0f766e,#10b981); box-shadow: 0 12px 30px rgba(16,185,129,0.18); display:flex; align-items:center; justify-content:center; flex-direction:column; color:white; border: none;">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="1.6" style="width:34px;height:34px;color:white;">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 11c2.21 0 4-1.79 4-4S14.21 3 12 3 8 4.79 8 7s1.79 4 4 4zM6 20a6 6 0 0112 0" />
                </svg>
                <span
                    style="font-size:11px; margin-top:2px; font-weight:700; color:rgba(255,255,255,0.95);">Admin</span>
            </button>

            <div class="text-center mb-10">
                <h1 class="text-3xl font-extrabold text-stone-800 mb-3">
                    ระบบบันทึกและติดตามข้อมูลเกษตรกร
                </h1>
                <p class="text-sm text-gray-500">
                    เลือกเมนูที่ต้องการเพื่อเริ่มต้นใช้งานระบบ
                </p>
                <div class="flex justify-center space-x-4 mt-4">
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
                        <span class="text-xs text-gray-600">ฟอร์มข้อมูลพื้นฐาน</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded-full bg-blue-500 mr-2"></div>
                        <span class="text-xs text-gray-600">ระบบตัวแทน</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded-full bg-orange-500 mr-2"></div>
                        <span class="text-xs text-gray-600">รายงานประจำวัน</span>
                    </div>
                </div>
            </div>

            <div class="main-menu-grid">
                <!-- Card 1: Survey Form - เปลี่ยนเป็นสีเขียว -->
                <div id="card-sheet-a" class="portal-card-enhanced" onclick="showView('form-menu-view')"
                    style="--card-index: 1;">
                    <div class="card-glow"></div>
                    <div class="card-icon-wrapper">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-green-600" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                    <h2 class="card-title">ประวัติข้อมูลแปลงกระท่อม</h2>
                    <p class="card-description">
                        บันทึกข้อมูลแปลงกระท่อม สำหรับเกษตรกรรายใหม่
                    </p>
                    <div class="card-badge">
                        ฟอร์มสำรวจพื้นที่
                    </div>
                </div>

                <!-- Card 2: Data Management -->
                <div id="card-sheet-b" class="portal-card-enhanced" onclick="checkAuthAndShowSubmenu()"
                    style="--card-index: 2;">
                    <div class="card-glow"></div>
                    <div class="card-icon-wrapper">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-600" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                    </div>
                    <h2 class="card-title">เข้าสู่ระบบสำหรับตัวแทนเท่านั้น</h2>
                    <p class="card-description">
                        จัดการข้อมูลและผลการวิเคราะห์ค่าสาร สำหรับตัวแทนบริษัท
                    </p>
                    <div class="card-badge">
                        ระบบตัวแทนเฉพาะ
                    </div>
                </div>

                <!-- Card 3: Usage Report 4-7-16 -->
                <div id="card-sheet-b-use" class="portal-card-enhanced" onclick="showView('sheet-b-use-view')"
                    style="--card-index: 3;">
                    <div class="card-glow"></div>
                    <div class="card-icon-wrapper">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-orange-600" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 4h8l-1 3H9L8 4z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M7 7h10l1 13H6L7 7z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 11c-2 1-2 3 0 4c2-1 2-3 0-4z" />
                        </svg>
                    </div>
                    <h2 class="card-title">บันทึกกิจกรรมการจัดการแปลงของเกษตรกร</h2>
                    <p class="card-description">
                        <span class="block text-red-500 font-semibold mt-2 text-sm">
                            (บันทึกข้อมูลทุกครั้งที่เข้าสวนนะครับ)
                        </span>
                    </p>
                    <div class="card-badge">
                        รายงานประจำทุกครั้ง
                    </div>
                </div>

                <!-- Card 4: Leaf Sample -->
                <div class="portal-card-enhanced" onclick="openLeafSampleForm()"
                    style="--card-index: 4; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);">
                    <div class="card-glow"></div>
                    <div class="card-icon-wrapper"
                        style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-cyan-600" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.27 6.96L12 12.01l8.73-5.05" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 22.08V12" />
                        </svg>
                    </div>
                    <h2 class="card-title">ส่งตัวอย่างใบกระท่อมให้บริษัท</h2>
                    <p class="card-description">
                        สำหรับเกษตรกรหรือตัวแทนที่จะซื้อขายกับบริษัท
                        <span class="block text-red-500 font-semibold mt-2 text-sm">
                            (ส่งตัวอย่างใบเพื่อตรวจค่าสาร)
                        </span>
                    </p>
                    <div class="card-badge"
                        style="background: linear-gradient(135deg, #a5f3fc 0%, #06b6d4 100%); color: #164e63;">
                        ตรวจวิเคราะห์แล็บ
                    </div>
                </div>
            </div>

            <!-- Footer note -->
            <div class="text-center mt-12 pt-6 border-t border-gray-200">
                <div class="mb-2 fw-bold">บริษัท บ้านไทยเฮิร์บเซ็นเตอร์ จำกัด</div>
                <div class="mb-2">ช่องทางติดต่อ: <a href="https://line.me/ti/p/LV4OFl3dcU" target="_blank"
                        class="btn btn-success fw-bold mx-1 d-inline-flex align-items-center gap-1"><i
                            class="fab fa-line"></i>
                        กดเพื่อสแกน QR เพิ่มเพื่อน และแชทผ่าน LINE </a> | <a href="tel:0924579929"
                        class="text-warning text-decoration-none fw-bold">092-4579929</a> | <a href="tel:0635033042"
                        class="text-warning text-decoration-none fw-bold">063-5033042</a></div>
            </div>
        </div>

        <!-- FORM MENU VIEW - เปลี่ยนสีเป็นเขียวทั้งหมด -->
        <div id="form-menu-view" class="space-y-6 hidden">
            <div class="text-center mb-6 md:mb-10">
                <h2 class="text-xl md:text-2xl font-bold text-stone-800 mb-2">แจ้งข้อมูลแปลงกระท่อม</h2>
                <p class="text-sm md:text-base text-stone-600">กรุณาเลือกประเภทแบบฟอร์มที่ต้องการ</p>
            </div>

            <div class="bg-white rounded-lg md:rounded-xl shadow-lg p-4 md:p-6 max-w-6xl mx-auto">
                <nav class="space-y-3">
                    <!-- =========== START: แทรกฟอร์มสำรวจข้อมูลพื้นที่ปลูกพืชมุนไพรกระท่อม =========== -->
                    <div id="survey-form-container"
                        class="bg-white rounded-lg md:rounded-xl shadow-lg p-3 md:p-6 max-w-6xl mx-auto">
                        <!-- ฟอร์มสำรวจข้อมูลพื้นที่ปลูกพืชมุนไพรกระท่อม -->
                        <div id="formStep" class="main-container">
                            <div class="form-card">
                                <div
                                    class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 md:mb-6 gap-4">
                                    <div class="w-full md:w-auto">
                                        <h1
                                            class="form-title text-lg md:text-xl lg:text-2xl font-bold text-stone-800 mb-2">
                                            ข้อมูลพื้นที่ปลูกพืชมุนไพรกระท่อม บริษัท บ้านไทยเฮิร์บเซ็นเตอร์ จำกัด</h1>
                                        <p class="form-subtitle text-xs md:text-sm text-stone-600 mb-2">15 หมู่ 12 ตำบล
                                            ท่าบุญมี
                                            อำเภอ เกาะจันทร์ จังหวัด ชลบุรี 20240</p>
                                        <p class="mb-2 text-xs md:text-sm">
                                            ช่องทางติดต่อ:
                                            <a href="tel:0924579929" class="text-green-600 font-semibold">092-4579929</a> | <a href="tel:0635033042" class="text-green-600 font-semibold">063-5033042</a>
                                        </p>
                                    </div>
                                    <img src="https://i.postimg.cc/rsL6ZK4T/image.jpg" alt="BTH Logo"
                                        class="h-16 md:h-24 lg:h-32 w-auto object-contain mx-auto md:mx-0">
                                </div>

                                <form id="kratomForm" novalidate>
                                    <!-- ข้อมูลเกษตรกรและแปลงกระท่อม -->
                                    <div class="form-section border border-gray-200 rounded-lg p-3 md:p-6 mb-4 md:mb-6">
                                        <h3
                                            class="section-title text-lg md:text-xl font-bold text-stone-800 mb-3 md:mb-4">
                                            <i class="bi bi-geo-alt-fill me-2"></i>ข้อมูลเกษตรกรและแปลงกระท่อม
                                        </h3>
                                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-12 gap-3 md:gap-4">
                                            <!-- สถานะตัวแทนเกษตรกร -->
                                            <div class="sm:col-span-2 lg:col-span-3">
                                                <label
                                                    class="form-label block font-medium mb-1 text-stone-800">สถานะตัวแทนเกษตรกร</label>
                                                <div class="radio-group flex flex-wrap gap-2">
                                                    <input type="radio" id="agent-none" name="farmer_agent" value="none"
                                                        class="hidden" onchange="toggleAgentInput()">
                                                    <label for="agent-none"
                                                        class="px-3 py-2 rounded-lg cursor-pointer border border-gray-300 bg-white text-sm">
                                                        ยังไม่มีตัวแทน
                                                    </label>
                                                    <input type="radio" id="agent-have" name="farmer_agent" value="have"
                                                        class="hidden" onchange="toggleAgentInput()">
                                                    <label for="agent-have"
                                                        class="px-3 py-2 rounded-lg cursor-pointer border border-gray-300 bg-white text-sm">
                                                        มีตัวแทน
                                                    </label>
                                                </div>
                                                <input type="text" id="agent-name" name="agent_name"
                                                    placeholder="โปรดระบุชื่อตัวแทน"
                                                    class="hidden mt-2 w-full px-3 py-2 border border-gray-300 rounded text-sm">
                                            </div>

                                            <!-- ชื่อเกษตรกร -->
                                            <div class="sm:col-span-2 lg:col-span-6">
                                                <label
                                                    class="form-label block font-medium mb-1 text-stone-800">ชื่อและนามสกุล<span
                                                        class="text-red-600">*</span></label>
                                                <div class="grid grid-cols-2 gap-2">
                                                    <input type="text" id="farmer_firstname" name="farmer_firstname"
                                                        class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                        required placeholder="ชื่อ">
                                                    <input type="text" id="farmer_lastname" name="farmer_lastname"
                                                        class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                        required placeholder="นามสกุล">
                                                </div>
                                                <!-- hidden legacy field for backward compatibility -->
                                                <input type="hidden" id="farmer_name_main" name="farmer_name_main"
                                                    value="">
                                            </div>

                                            <!-- เบอร์โทร -->
                                            <div class="sm:col-span-1 lg:col-span-3">
                                                <label for="tel"
                                                    class="form-label block font-medium mb-1 text-stone-800">เบอร์โทร<span
                                                        class="text-red-600">*</span></label>
                                                <input type="tel"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="tel" name="tel" required placeholder="เบอร์โทร">
                                            </div>

                                            <!-- พิกัด X -->
                                            <div class="sm:col-span-1 lg:col-span-3">
                                                <label for="coord_x"
                                                    class="form-label block font-medium mb-1 text-stone-800">พิกัด
                                                    X<span class="text-red-600">*</span></label>
                                                <input type="number" step="any"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="coord_x" name="coord_x" required placeholder="เช่น 13.7563">
                                            </div>

                                            <!-- พิกัด Y -->
                                            <div class="sm:col-span-1 lg:col-span-3">
                                                <label for="coord_y"
                                                    class="form-label block font-medium mb-1 text-stone-800">พิกัด
                                                    Y<span class="text-red-600">*</span></label>
                                                <input type="number" step="any"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="coord_y" name="coord_y" required placeholder="เช่น 100.5018">
                                            </div>

                                            <!-- ตำบล -->
                                            <div class="sm:col-span-1 lg:col-span-2">
                                                <label for="subdistrict"
                                                    class="form-label block font-medium mb-1 text-stone-800">ตำบล<span
                                                        class="text-red-600">*</span></label>
                                                <input type="text"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="subdistrict" name="subdistrict" required placeholder="ตำบล">
                                            </div>

                                            <!-- อำเภอ -->
                                            <div class="sm:col-span-1 lg:col-span-2">
                                                <label for="district"
                                                    class="form-label block font-medium mb-1 text-stone-800">อำเภอ<span
                                                        class="text-red-600">*</span></label>
                                                <input type="text"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="district" name="district" required placeholder="อำเภอ">
                                            </div>

                                            <!-- จังหวัด -->
                                            <div class="sm:col-span-1 lg:col-span-2">
                                                <label for="province"
                                                    class="form-label block font-medium mb-1 text-stone-800">จังหวัด<span
                                                        class="text-red-600">*</span></label>
                                                <input type="text"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="province" name="province" required placeholder="จังหวัด">
                                            </div>

                                            <!-- หลักฐานที่ดิน -->
                                            <div class="sm:col-span-2 lg:col-span-12">
                                                <label for="land_evidence"
                                                    class="form-label block font-medium mb-1 text-stone-800">หลักฐานที่ดิน</label>
                                                <select id="land_evidence" name="land_evidence"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base">
                                                    <option value="">-- ระบุหลักฐานที่ดิน --</option>
                                                    <option value="โฉนดที่ดิน (น.ส. 4 จ.)">โฉนดที่ดิน (น.ส. 4 จ.)
                                                    </option>
                                                    <option value="น.ส. 3 (ครุฑดำ)">น.ส. 3 (ครุฑดำ)</option>
                                                    <option value="น.ส. 3 ก. (ครุฑเขียว)">น.ส. 3 ก. (ครุฑเขียว)</option>
                                                    <option value="น.ส. 3 ข. (ครุฑดำ)">น.ส. 3 ข. (ครุฑดำ)</option>
                                                    <option value="ส.ป.ก. 4-01">ส.ป.ก. 4-01</option>
                                                    <option value="ใบจอง (น.ส. 2)">ใบจอง (น.ส. 2)</option>
                                                    <option value="ภ.ด.ส.">ภ.ด.ส.</option>
                                                    <option value="ภ.บ.ท. 5">ภ.บ.ท. 5</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div
                                            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-12 gap-3 md:gap-4 mt-3 md:mt-4">
                                            <!-- จำนวนต้นทั้งหมด -->
                                            <div class="sm:col-span-1 lg:col-span-3">
                                                <label for="tree_count"
                                                    class="form-label block font-medium mb-1 text-stone-800">จำนวนต้นทั้งหมด<span
                                                        class="text-red-600">*</span></label>
                                                <input type="number"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="tree_count" name="tree_count" required placeholder="จำนวนต้น">
                                            </div>

                                            <!-- วันที่ปลูก -->
                                            <div class="sm:col-span-1 lg:col-span-6">
                                                <label for="plant_date"
                                                    class="form-label block font-medium mb-1 text-stone-800">ว/ด/ป
                                                    ปลูกต้นกล้า<span class="text-red-600">*</span></label>
                                                <input type="text"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="plant_date" name="plant_date" required
                                                    placeholder="วัน/เดือน/ปี ที่ปลูก (D/M/YYYY)">
                                            </div>

                                            <!-- จำนวนต้นที่พร้อมขายจริง -->
                                            <div class="sm:col-span-1 lg:col-span-3">
                                                <label for="ready_to_sell_count"
                                                    class="form-label block font-medium mb-1 text-stone-800">จำนวนต้นที่พร้อมขายจริง<span
                                                        class="text-red-600">*</span></label>
                                                <input type="number"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="ready_to_sell_count" name="ready_to_sell_count" required
                                                    placeholder="จำนวนต้นที่พร้อมขาย">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- การบริหารจัดการแปลง -->
                                    <div class="form-section border border-gray-200 rounded-lg p-3 md:p-6 mb-4 md:mb-6">
                                        <h3
                                            class="section-title text-lg md:text-xl font-bold text-stone-800 mb-3 md:mb-4">
                                            <i class="bi bi-tools me-2"></i>การบริหารจัดการแปลง
                                        </h3>
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                                            <!-- ระบบให้น้ำ -->
                                            <div>
                                                <label class="form-label block font-medium mb-1 text-stone-800">
                                                    ระบบให้น้ำ <small
                                                        class="text-gray-500">(เลือกได้มากกว่าหนึ่ง)</small>
                                                </label>
                                                <div class="flex flex-col gap-2">
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="water_rain"
                                                            name="water_system[]" value="น้ำฝน">
                                                        <label for="water_rain"
                                                            class="cursor-pointer text-sm">น้ำฝน</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="water_natural"
                                                            name="water_system[]" value="แหล่งน้ำธรรมชาติ">
                                                        <label for="water_natural"
                                                            class="cursor-pointer text-sm">แหล่งน้ำธรรมชาติ</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="water_reservoir"
                                                            name="water_system[]" value="แหล่งกักเก็บน้ำ">
                                                        <label for="water_reservoir"
                                                            class="cursor-pointer text-sm">แหล่งกักเก็บน้ำ</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="water_irrigation"
                                                            name="water_system[]" value="ชลประทาน">
                                                        <label for="water_irrigation"
                                                            class="cursor-pointer text-sm">ชลประทาน</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="water_ground"
                                                            name="water_system[]" value="น้ำบาดาล">
                                                        <label for="water_ground"
                                                            class="cursor-pointer text-sm">น้ำบาดาล</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="water_sprinkler"
                                                            name="water_system[]" value="สปริงเกอร์">
                                                        <label for="water_sprinkler"
                                                            class="cursor-pointer text-sm">สปริงเกอร์</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="water_other"
                                                            name="water_system[]" value="อื่นๆ"
                                                            data-other-target="water_other_text">
                                                        <label for="water_other" class="cursor-pointer text-sm">อื่นๆ
                                                            (ระบุ)</label>
                                                    </div>
                                                </div>
                                                <input type="text" id="water_other_text"
                                                    class="form-control mt-2 hidden w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                    placeholder="ระบุระบบให้น้ำอื่นๆ">
                                                <label for="water_ph"
                                                    class="form-label block font-medium mt-3 mb-1 text-stone-800">ค่า PH
                                                    น้ำ</label>
                                                <input type="text"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="water_ph" name="water_ph" placeholder="ค่า PH น้ำ">
                                            </div>

                                            <!-- วิธีให้ปุ๋ย -->
                                            <div>
                                                <label class="form-label block font-medium mb-1 text-stone-800">
                                                    ระบบให้ปุ๋ย <small
                                                        class="text-gray-500">(เลือกได้มากกว่าหนึ่ง)</small>
                                                </label>
                                                <div class="flex flex-col gap-2">
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="fert_organic"
                                                            name="fertilizer_method[]" value="ปุ๋ยอินทรีย์">
                                                        <label for="fert_organic"
                                                            class="cursor-pointer text-sm">ปุ๋ยอินทรีย์</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="fert_chemical"
                                                            name="fertilizer_method[]" value="ปุ๋ยเคมี">
                                                        <label for="fert_chemical"
                                                            class="cursor-pointer text-sm">ปุ๋ยเคมี</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="fert_manure"
                                                            name="fertilizer_method[]" value="ปุ๋ยคอก">
                                                        <label for="fert_manure"
                                                            class="cursor-pointer text-sm">ปุ๋ยคอก</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="fert_bio"
                                                            name="fertilizer_method[]" value="ปุ๋ยชีวภาพ">
                                                        <label for="fert_bio"
                                                            class="cursor-pointer text-sm">ปุ๋ยชีวภาพ</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="fert_organic_chemical"
                                                            name="fertilizer_method[]" value="ปุ๋ยอินทรีย์เคมี">
                                                        <label for="fert_organic_chemical"
                                                            class="cursor-pointer text-sm">ปุ๋ยอินทรีย์เคมี</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="fert_other"
                                                            name="fertilizer_method[]" value="อื่นๆ"
                                                            data-other-target="fert_other_text">
                                                        <label for="fert_other" class="cursor-pointer text-sm">อื่นๆ
                                                            (ระบุ)</label>
                                                    </div>
                                                </div>
                                                <input type="text" id="fert_other_text"
                                                    class="form-control mt-2 hidden w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                    placeholder="โปรดระบุชนิดปุ๋ยอื่นๆ ที่ใช้">
                                                <label for="soil_ph"
                                                    class="form-label block font-medium mt-3 mb-1 text-stone-800">ค่า PH
                                                    ดิน</label>
                                                <input type="text"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="soil_ph" name="soil_ph" placeholder="ค่า PH ดิน">
                                            </div>

                                            <!-- ฮอร์โมน / อื่นๆ (รวมแร่ภูเขาไฟ ย้ายมาที่นี่) -->
                                            <div>
                                                <label
                                                    class="form-label block font-medium mb-1 text-stone-800">สารปรับปรุงดิน</label>

                                                <!-- ย้าย 'แร่ภูเขาไฟ' มาที่ส่วนนี้ -->
                                                <div class="flex items-center mb-2">
                                                    <input class="mr-2" type="checkbox" id="mineral_volcanic"
                                                        name="mineral_options[]" value="แร่ภูเขาไฟ">
                                                    <label for="mineral_volcanic"
                                                        class="cursor-pointer text-sm">แร่ภูเขาไฟ</label>
                                                </div>
                                                <label for="hormone_and_other"
                                                    class="form-label block font-medium mb-1 text-stone-800">ฮอร์โมน /
                                                    อื่นๆ</label>

                                                <!-- รวมช่องฮอร์โมนและช่องอื่นๆ เป็นช่องเดียว -->
                                                <input type="text"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base mb-3"
                                                    id="hormone_and_other" name="hormone_and_other"
                                                    placeholder="ระบุฮอร์โมนและข้อมูลอื่นๆ (ถ้ามี)">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ข้อมูลฤดูกาล -->
                                    <div class="form-section border border-gray-200 rounded-lg p-3 md:p-6 mb-4 md:mb-6">
                                        <h3
                                            class="section-title text-lg md:text-xl font-bold text-stone-800 mb-3 md:mb-4">
                                            <i class="bi bi-cloud-rain me-2"></i>ข้อมูลฤดูกาล แต่ละพื้นที่ปลูก
                                        </h3>
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">

                                            <!-- ฤดูแตัวแทน -->
                                            <div>
                                                <label
                                                    class="form-label block font-bold mb-1 text-stone-800">ช่วงฤดูแล้ง</label>
                                                <select
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base mb-2"
                                                    name="dry_start_month" id="dry_start_month">
                                                    <option value="">เดือนเริ่มต้น</option>
                                                    <option value="1">มกราคม</option>
                                                    <option value="2">กุมภาพันธ์</option>
                                                    <option value="3">มีนาคม</option>
                                                    <option value="4">เมษายน</option>
                                                    <option value="5">พฤษภาคม</option>
                                                    <option value="6">มิถุนายน</option>
                                                    <option value="7">กรกฎาคม</option>
                                                    <option value="8">สิงหาคม</option>
                                                    <option value="9">กันยายน</option>
                                                    <option value="10">ตุลาคม</option>
                                                    <option value="11">พฤศจิกายน</option>
                                                    <option value="12">ธันวาคม</option>
                                                </select>
                                                <select
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    name="dry_end_month" id="dry_end_month">
                                                    <option value="">เดือนสิ้นสุด</option>
                                                    <option value="1">มกราคม</option>
                                                    <option value="2">กุมภาพันธ์</option>
                                                    <option value="3">มีนาคม</option>
                                                    <option value="4">เมษายน</option>
                                                    <option value="5">พฤษภาคม</option>
                                                    <option value="6">มิถุนายน</option>
                                                    <option value="7">กรกฎาคม</option>
                                                    <option value="8">สิงหาคม</option>
                                                    <option value="9">กันยายน</option>
                                                    <option value="10">ตุลาคม</option>
                                                    <option value="11">พฤศจิกายน</option>
                                                    <option value="12">ธันวาคม</option>
                                                </select>
                                            </div>

                                            <!-- ฤดูฝน -->
                                            <div>
                                                <label
                                                    class="form-label block font-bold mb-1 text-stone-800">ช่วงฤดูฝน</label>
                                                <select
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base mb-2"
                                                    name="rainy_start_month" id="rainy_start_month">
                                                    <option value="">เดือนเริ่มต้น</option>
                                                    <option value="1">มกราคม</option>
                                                    <option value="2">กุมภาพันธ์</option>
                                                    <option value="3">มีนาคม</option>
                                                    <option value="4">เมษายน</option>
                                                    <option value="5">พฤษภาคม</option>
                                                    <option value="6">มิถุนายน</option>
                                                    <option value="7">กรกฎาคม</option>
                                                    <option value="8">สิงหาคม</option>
                                                    <option value="9">กันยายน</option>
                                                    <option value="10">ตุลาคม</option>
                                                    <option value="11">พฤศจิกายน</option>
                                                    <option value="12">ธันวาคม</option>
                                                </select>
                                                <select
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    name="rainy_end_month" id="rainy_end_month">
                                                    <option value="">เดือนสิ้นสุด</option>
                                                    <option value="1">มกราคม</option>
                                                    <option value="2">กุมภาพันธ์</option>
                                                    <option value="3">มีนาคม</option>
                                                    <option value="4">เมษายน</option>
                                                    <option value="5">พฤษภาคม</option>
                                                    <option value="6">มิถุนายน</option>
                                                    <option value="7">กรกฎาคม</option>
                                                    <option value="8">สิงหาคม</option>
                                                    <option value="9">กันยายน</option>
                                                    <option value="10">ตุลาคม</option>
                                                    <option value="11">พฤศจิกายน</option>
                                                    <option value="12">ธันวาคม</option>
                                                </select>
                                            </div>

                                            <!-- ฤดูหนาว -->
                                            <div>
                                                <label
                                                    class="form-label block font-bold mb-1 text-stone-800">ช่วงฤดูหนาว</label>
                                                <select
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base mb-2"
                                                    name="winter_start_month" id="winter_start_month">
                                                    <option value="">เดือนเริ่มต้น</option>
                                                    <option value="1">มกราคม</option>
                                                    <option value="2">กุมภาพันธ์</option>
                                                    <option value="3">มีนาคม</option>
                                                    <option value="4">เมษายน</option>
                                                    <option value="5">พฤษภาคม</option>
                                                    <option value="6">มิถุนายน</option>
                                                    <option value="7">กรกฎาคม</option>
                                                    <option value="8">สิงหาคม</option>
                                                    <option value="9">กันยายน</option>
                                                    <option value="10">ตุลาคม</option>
                                                    <option value="11">พฤศจิกายน</option>
                                                    <option value="12">ธันวาคม</option>
                                                </select>
                                                <select
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    name="winter_end_month" id="winter_end_month">
                                                    <option value="">เดือนสิ้นสุด</option>
                                                    <option value="1">มกราคม</option>
                                                    <option value="2">กุมภาพันธ์</option>
                                                    <option value="3">มีนาคม</option>
                                                    <option value="4">เมษายน</option>
                                                    <option value="5">พฤษภาคม</option>
                                                    <option value="6">มิถุนายน</option>
                                                    <option value="7">กรกฎาคม</option>
                                                    <option value="8">สิงหาคม</option>
                                                    <option value="9">กันยายน</option>
                                                    <option value="10">ตุลาคม</option>
                                                    <option value="11">พฤศจิกายน</option>
                                                    <option value="12">ธันวาคม</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- มาตรฐานแปลงและคู่สัญญา -->
                                    <div class="form-section border border-gray-200 rounded-lg p-3 md:p-6 mb-4 md:mb-6">
                                        <h3
                                            class="section-title text-lg md:text-xl font-bold text-stone-800 mb-3 md:mb-4">
                                            <i class="bi bi-file-earmark-check me-2"></i>มาตรฐานแปลงและคู่สัญญา
                                        </h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                                            <!-- GAP สมุนไพร -->
                                            <div>
                                                <label class="form-label block font-bold mb-1 text-stone-800">
                                                    ข้อมูล GAP สมุนไพร<span class="text-red-600">*</span>
                                                </label>
                                                <div class="flex flex-col gap-2">
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="radio" name="gap_status" id="gap_yes"
                                                            value="yes" onchange="toggleDateRange('gap', true)">
                                                        <label for="gap_yes" class="cursor-pointer">มี</label>
                                                    </div>
                                                    <div id="gap-date-range" class="mt-2 hidden">
                                                        <label
                                                            class="form-label block text-sm mb-1 text-stone-800">ถ้ามี
                                                            โปรดระบุ</label>
                                                        <div class="grid grid-cols-2 gap-2">
                                                            <div>
                                                                <input type="date"
                                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                                    name="gap_start_date" id="gap_start_date"
                                                                    placeholder="วันเริ่มต้น">
                                                            </div>
                                                            <div>
                                                                <input type="date"
                                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                                    name="gap_end_date" id="gap_end_date"
                                                                    placeholder="วันหมดอายุ">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="radio" name="gap_status" id="gap_no"
                                                            value="no" onchange="toggleDateRange('gap', false)">
                                                        <label for="gap_no" class="cursor-pointer">ไม่มี</label>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- GACP สมุนไพร -->
                                            <div>
                                                <label class="form-label block font-bold mb-1 text-stone-800">
                                                    ข้อมูล GACP สมุนไพร<span class="text-red-600">*</span>
                                                </label>
                                                <div class="flex flex-col gap-2">
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="radio" name="gacp_status"
                                                            id="gacp_yes" value="yes"
                                                            onchange="toggleDateRange('gacp', true)">
                                                        <label for="gacp_yes" class="cursor-pointer">มี</label>
                                                    </div>
                                                    <div id="gacp-date-range" class="mt-2 hidden">
                                                        <label
                                                            class="form-label block text-sm mb-1 text-stone-800">ถ้ามี
                                                            โปรดระบุ</label>
                                                        <div class="grid grid-cols-2 gap-2">
                                                            <div>
                                                                <input type="date"
                                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                                    name="gacp_start_date" id="gacp_start_date">
                                                            </div>
                                                            <div>
                                                                <input type="date"
                                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                                    name="gacp_end_date" id="gacp_end_date">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="radio" name="gacp_status" id="gacp_no"
                                                            value="no" onchange="toggleDateRange('gacp', false)">
                                                        <label for="gacp_no" class="cursor-pointer">ไม่มี</label>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- คู่สัญญา -->
                                            <div class="md:col-span-2">
                                                <label class="form-label block font-bold mt-3 mb-1 text-stone-800">
                                                    ข้อมูล คู่สัญญา<span class="text-red-600">*</span>
                                                </label>
                                                <div class="flex flex-col gap-2">
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="radio" name="contract_status"
                                                            id="contract_yes" value="old">
                                                        <label for="contract_yes"
                                                            class="cursor-pointer">ติดสัญญาเก่า</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="radio" name="contract_status"
                                                            id="contract_no" value="none">
                                                        <label for="contract_no"
                                                            class="cursor-pointer">ไม่ติดสัญญาเก่า</label>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="mt-3">
                                                <label class="form-label block font-medium mb-1 text-stone-800">
                                                    ค่าสารไมทราไจนีน <span class="text-red-600">*</span>
                                                </label>
                                                <div class="flex flex-col gap-2">
                                                    <div class="flex items-center">
                                                        <input class="mr-2 substance-cb" type="checkbox"
                                                            id="substance_checked" name="substance_status"
                                                            value="checked">
                                                        <label for="substance_checked"
                                                            class="cursor-pointer text-sm">มีการตรวจค่าสาร</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2 substance-cb" type="checkbox"
                                                            id="substance_not_checked" name="substance_status"
                                                            value="not_checked">
                                                        <label for="substance_not_checked"
                                                            class="cursor-pointer text-sm">ยังไม่เคยมีการตรวจค่าสาร</label>
                                                    </div>
                                                </div>
                                                <div id="substanceValueBox" class="mt-3 hidden">
                                                    <label for="substance_value"
                                                        class="form-label block font-medium mb-1 text-stone-800">
                                                        ระบุค่าสารไมทราไจนีน
                                                    </label>
                                                    <input type="number" step="any"
                                                        class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                        id="substance_value" name="substance_value"
                                                        placeholder="เช่น 1.25">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ข้อมูลสายพันธุ์กระท่อม -->
                                    <div class="form-section border border-gray-200 rounded-lg p-3 md:p-6 mb-4 md:mb-6">
                                        <h3
                                            class="section-title text-lg md:text-xl font-bold text-stone-800 mb-3 md:mb-4">
                                            <i class="bi bi-trophy-fill me-2"></i>ข้อมูลสายพันธุ์กระท่อม
                                        </h3>

                                        <!-- เลือกสายพันธุ์กระท่อม -->
                                        <div class="mb-4">
                                            <label
                                                class="form-label block font-bold mb-1 text-stone-800">สายพันธุ์กระท่อม</label>
                                            <div class="flex flex-wrap gap-3">
                                                <div class="flex items-center">
                                                    <input class="mr-2 stem-cb" type="checkbox" value="red"
                                                        id="stem_red" name="stem_selector">
                                                    <label for="stem_red" class="cursor-pointer text-sm">ก้านแดง</label>
                                                </div>
                                                <div class="flex items-center">
                                                    <input class="mr-2 stem-cb" type="checkbox" value="white"
                                                        id="stem_white" name="stem_selector">
                                                    <label for="stem_white"
                                                        class="cursor-pointer text-sm">ก้านขาว</label>
                                                </div>
                                                <div class="flex items-center">
                                                    <input class="mr-2 stem-cb" type="checkbox" value="green"
                                                        id="stem_green" name="stem_selector">
                                                    <label for="stem_green"
                                                        class="cursor-pointer text-sm">ก้านเขียว</label>
                                                </div>
                                                <div class="flex items-center">
                                                    <input class="mr-2 stem-cb" type="checkbox" value="cross"
                                                        id="stem_cross" name="stem_selector">
                                                    <label for="stem_cross"
                                                        class="cursor-pointer text-sm">ข้ามสายพันธุ์</label>
                                                </div>
                                                <div class="flex items-center">
                                                    <!-- เพิ่ม data-other-target เพื่อเชื่อมกับ textarea #other_varieties -->
                                                    <input class="mr-2 stem-cb" type="checkbox" value="other"
                                                        id="stem_other" name="stem_selector"
                                                        data-other-target="other_varieties">
                                                    <label for="stem_other" class="cursor-pointer text-sm">อื่นๆ</label>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- ระบุชื่อ (ข้ามสายพันธุ์ / อื่นๆ) -->
                                        <div id="special-name" class="hidden mb-4">
                                            <label
                                                class="form-label block font-bold mb-1 text-stone-800">ระบุชื่อสายพันธุ์
                                                (ข้ามสายพันธุ์)</label>
                                            <input type="text"
                                                class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                name="special_species_name" id="special_species_name"
                                                placeholder="ระบุชื่อสายพันธุ์">
                                        </div>

                                        <!-- เพิ่มช่องสำหรับ 'อื่นๆ' ของสายพันธุ์ แยกจากข้ามสายพันธุ์ -->
                                        <div class="mb-4">
                                            <label class="form-label block font-bold mb-1 text-stone-800">อื่นๆ
                                                (สายพันธุ์อื่นๆ
                                                ที่นอกเหนือจากรายการ)</label>
                                            <!-- ซ่อนเริ่มต้นไว้ จะถูกแสดงเมื่อ checkbox ชื่อ 'อื่นๆ' ถูกติ๊ก (data-other-target) -->
                                            <textarea id="other_varieties" name="other_varieties"
                                                class="hidden w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                rows="2"
                                                placeholder="ระบุชื่อสายพันธุ์อื่นๆ (คั่นด้วยคอมม่า ถ้ามากกว่า 1)"></textarea>
                                        </div>

                                        <!-- container ของแต่ละก้าน -->
                                        <div id="stem-sections"></div>

                                        <!-- รวมจำนวนทั้งหมด -->
                                        <div class="mt-4 w-full md:w-1/2">
                                            <label
                                                class="form-label block font-bold mb-1 text-stone-800">จำนวนต้นรวมที่ระบุในส่วนสายพันธุ์</label>
                                            <input type="number"
                                                class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base bg-gray-50"
                                                id="total_tree_count" readonly>
                                        </div>
                                    </div>

                                    <!-- ข้อมูลพื้นที่ย้อนหลัง 3ปี -->
                                    <div class="form-section border border-gray-200 rounded-lg p-3 md:p-6 mb-4 md:mb-6">
                                        <h3
                                            class="section-title text-lg md:text-xl font-bold text-stone-800 mb-3 md:mb-4">
                                            <i class="bi bi-list-ol me-2"></i>ข้อมูลพื้นที่ย้อนหลัง 3ปี
                                        </h3>
                                        <div class="flex flex-wrap gap-2">
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_empty"
                                                    name="past_land_types[]" value="พื้นที่เปล่า">
                                                <label for="past_empty"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">พื้นที่เปล่า</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_fruit_garden"
                                                    name="past_land_types[]" value="พื้นที่ทำสวนผลไม้">
                                                <label for="past_fruit_garden"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">พื้นที่ทำสวนผลไม้</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_rice"
                                                    name="past_land_types[]" value="พื้นที่ทำนา">
                                                <label for="past_rice"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">พื้นที่ทำนา</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_vegetable"
                                                    name="past_land_types[]" value="พื้นที่แปลงพืชผัก">
                                                <label for="past_vegetable"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">พื้นที่แปลงพืชผัก</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_fill"
                                                    name="past_land_types[]" value="พื้นที่ดินถมใหม่">
                                                <label for="past_fill"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">พื้นที่ดินถมใหม่</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_mixed"
                                                    name="past_land_types[]" value="พื้นที่เกษตรผสมผสาน">
                                                <label for="past_mixed"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">พื้นที่เกษตรผสมผสาน</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_pond"
                                                    name="past_land_types[]" value="สระน้ำ">
                                                <label for="past_pond"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">สระน้ำ</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_forest"
                                                    name="past_land_types[]" value="พื้นที่ป่า">
                                                <label for="past_forest"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">พื้นที่ป่า</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_mangrove"
                                                    name="past_land_types[]" value="พื้นที่ป่าชายเลน">
                                                <label for="past_mangrove"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">พื้นที่ป่าชายเลน</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_other"
                                                    name="past_land_types[]" value="อื่นๆ"
                                                    data-other-target="past_other_text">
                                                <label for="past_other"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">อื่นๆ
                                                    (ระบุ)</label>
                                            </div>
                                        </div>
                                        <input type="text" id="past_other_text"
                                            class="form-control mt-2 hidden w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                            placeholder="ระบุอื่นๆ (ย้อนหลัง 3 ปี)">
                                    </div>

                                    <!-- ตัวแทนผู้ประสานงาน -->
                                    <div class="form-section border border-gray-200 rounded-lg p-3 md:p-6 mb-4 md:mb-6">
                                        <h3
                                            class="section-title text-lg md:text-xl font-bold text-stone-800 mb-3 md:mb-4">
                                            <i class="bi bi-person-lines-fill me-2"></i>ตัวแทนผู้ประสานงาน
                                        </h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label for="coordinator_name"
                                                    class="form-label block font-medium mb-1 text-stone-800">ตัวแทนผู้ประสานงาน<span
                                                        class="text-red-600">*</span></label>
                                                <input type="text"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="coordinator_name" name="coordinator_name" required
                                                    placeholder="ชื่อตัวแทนผู้ประสานงาน">
                                            </div>
                                            <div>
                                                <label for="coordinator_tel"
                                                    class="form-label block font-medium mb-1 text-stone-800">เบอร์โทรของตัวแทนผู้ประสานงาน<span
                                                        class="text-red-600">*</span></label>
                                                <input type="tel"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="coordinator_tel" name="coordinator_tel" required
                                                    placeholder="เบอร์โทรศัพท์">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ปุ่มส่งข้อมูล -->
                                    <div class="text-center mt-6">
                                        <button type="button" id="nextBtn"
                                            class="btn btn-primary bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold text-sm md:text-base">
                                            <i class="bi bi-eye-fill me-2"></i>ดูตัวอย่างและส่งข้อมูล
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Preview Step (hidden initially) -->
                        <div id="previewStep" class="main-container hidden">
                            <div class="form-card">
                                <h2 class="form-title text-lg md:text-xl lg:text-2xl font-bold text-stone-800 mb-2">
                                    <i
                                        class="bi bi-search me-2 text-red-600"></i>ตัวอย่างแบบฟอร์มจริงสำรวจข้อมูลแปลงกระท่อม
                                </h2>
                                <p class="form-subtitle text-sm md:text-base text-stone-600 mb-4 md:mb-6">
                                    กรุณาตรวจสอบความถูกต้องของข้อมูลทั้งหมดก่อนกดส่ง</p>

                                <div id="previewCard" class="p-4 border rounded-lg bg-gray-50 mb-6">
                                    <p class="text-gray-500 text-center">กำลังโหลดข้อมูลตัวอย่าง...</p>
                                </div>

                                <div class="flex flex-col sm:flex-row justify-between gap-4">
                                    <button id="backBtn"
                                        class="btn btn-secondary bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-semibold text-sm md:text-base">
                                        <i class="bi bi-arrow-left-circle-fill me-2"></i>ย้อนกลับ
                                    </button>
                                    <button id="submitBtn"
                                        class="btn btn-primary bg-gradient-to-b from-green-600 to-green-800 hover:from-green-700 hover:to-green-900 text-white px-6 py-3 rounded-lg font-semibold text-sm md:text-base shadow-lg">
                                        <i class="bi bi-cloud-upload-fill me-2"></i>ยืนยันและส่งข้อมูล
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- =========== END: แทรกฟอร์มสำรวจข้อมูลพื้นที่ปลูกพืชมุนไพรกระท่อม =========== -->

                    <!-- ปุ่มสำหรับขยายพื้นที่ปลูกเพิ่ม -->
                    <button onclick="openExpansionForm()"
                        class="w-full text-left p-4 rounded-lg font-semibold text-gray-700 hover:bg-green-50 hover:border-green-300 transition duration-200 border-2 border-gray-200 flex items-center group">
                        <div
                            class="flex items-center justify-center h-10 w-10 md:h-12 md:w-12 bg-green-100 rounded-lg mr-3 md:mr-4 group-hover:bg-green-200 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 md:h-6 md:w-6 text-green-600"
                                fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                            </svg>
                        </div>
                        <div class="flex-grow">
                            <div class="text-sm md:text-base font-bold text-stone-800">2.
                                แจ้งข้อมูลเกษตรกรที่ต้องการขยายพื้นที่ปลูกเพิ่ม</div>
                            <div class="text-xs text-red-500 mt-1">สำหรับขยายพื้นที่ปลูกเพิ่ม</div>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 group-hover:text-green-600"
                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>

                    <!-- ปุ่มกลับ -->
                    <div class="mt-6 pt-4 border-t border-gray-200 text-center">
                        <button onclick="showView('form-menu-view')"
                            class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm transition duration-200">
                            <i class="bi bi-arrow-left me-1"></i>กลับไปเลือกรายการ
                        </button>
                    </div>
                </nav>

                <!-- ข้อความแนะนำ -->
                <div class="mt-6 pt-4 border-t border-gray-200 text-center">
                    <p class="text-xs text-stone-500">💡 เลือกเมนูที่ต้องการเพื่อดำเนินการต่อ</p>
                </div>
            </div>
        </div>

        <!-- SUBMENU VIEW (จัดการข้อมูล) -->
        <div id="submenu-view" class="space-y-6 hidden">
            <header class="mb-10 text-center">
                <div class="flex justify-between items-center mb-4">
                    <button onclick="logout()"
                        class="bg-red-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-600 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                        ออกจากระบบ
                    </button>
                </div>
                <h2 class="text-2xl font-bold text-stone-800 mb-2">ระบบตัวแทนของบริษัท บ้านไทยเฮิร์บ เซ็นเตอร์ จำกัด
                </h2>
                <p class="text-stone-600">กรุณาเลือกรายการจัดการข้อมูลแร่/นาโน/ค่าสารและอื่นๆ</p>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Card A: Sheet A - Farm & Farmer Info -->
                <div class="portal-card cursor-pointer" onclick="showView('sheet-a-view')"
                    style="background: linear-gradient(135deg, #A5C9FF, #dae7ff);">
                    <div class="flex items-center justify-center h-16 w-16 bg-white bg-opacity-30 rounded-full mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-800" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold text-stone-800 mb-2">ตัวแทนต้องกรอกข้อมูลลูกสวนที่ได้รับแร่และนาโนไปใช้
                    </h2>
                    <p class="text-sm text-stone-600">บันทึกข้อมูลการรับแร่และนาโน</p>
                </div>

                <div class="portal-card cursor-pointer" style="background: linear-gradient(135deg, #bbf7d0, #dcfce7);">
                    <div class="flex items-center justify-center h-16 w-16 bg-white bg-opacity-30 rounded-full mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-800" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold text-stone-800 mb-2">ติดตั้งและจัดการการส่งออกตัวแทน (กำลังแก้ไข)</h2>
                    <p class="text-sm text-stone-600"></p>
                </div>

                <div class="portal-card cursor-pointer" onclick="showView('sheet-c-view')"
                    style="background: linear-gradient(135deg, #fdba74, #fed7aa);">
                    <div class="flex items-center justify-center h-16 w-16 bg-white bg-opacity-30 rounded-full mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-800" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold text-stone-800 mb-2">หน้าสรุปข้อมูลเกษตรกรทั้งหมดของตัวแทน</h2>
                    <p class="text-sm text-stone-600">ดูและค้นหาข้อมูลทั้งหมดที่บันทึกไว้</p>
                </div>

                <!-- Card B: Sheet B - Usage Summary -->
                <div class="portal-card cursor-pointer" onclick="showView('sheet-b-view')"
                    style="background: linear-gradient(135deg, #fecaca, #fee2e2);">
                    <div class="flex items-center justify-center h-16 w-16 bg-white bg-opacity-30 rounded-full mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-800" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold text-stone-800 mb-2">ผลตรวจค่าสาร</h2>
                    <p class="text-sm text-stone-600">ข้อมูลแปลงค่าสารก่อนใช้และค่าสารหลังใช้ (ค้นหา)</p>
                </div>
            </div>
        </div>

        <!-- SHEET A VIEW -->
        <div id="sheet-a-view" class="space-y-6 hidden">
            <div class="w-full pt-6 pb-2 px-6">
                <h2 class="text-2xl font-bold text-stone-700">
                    บันทึกข้อมูลการรับแร่และนาโนของเกษตรกร
                </h2>
            </div>
            <form id="sheet-a-form" onsubmit="handleSheetASubmit(event)" class="space-y-6">
                <div class="space-y-4 pt-4 border rounded-lg p-4 bg-stone-50">
                    <h3 class="text-lg font-semibold text-stone-700">ตัวแทนที่เกษตรกรสังกัด</h3>
                    <label for="a-long-affiliation" class="block text-sm font-medium mb-1">
                        <span id="long-affiliation-label">กรุณาเลือกตัวแทน</span>
                        <span id="auto-selected-label"
                            class="text-green-600 text-sm hidden">(เลือกอัตโนมัติจากการล็อกอิน)</span>
                    </label>
                    <select id="a-long-affiliation" required class="w-full">
                        <option value="" disabled selected>--- เลือกตัวแทนที่สังกัด ---</option>
                    </select>
                </div>

                <div class="space-y-4 p-4 border rounded-lg">
                    <h3 class="text-lg font-semibold text-stone-700">ข้อมูลส่วนตัวเกษตรกรที่จะรับแร่/นาโน</h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="a-fullname" class="block text-sm font-medium mb-1">ชื่อ-สกุล เกษตรกร</label>
                            <input type="text" id="a-fullname" placeholder="ชื่อ-สกุล" required class="w-full">
                        </div>
                        <div>
                            <label for="a-phone" class="block text-sm font-medium mb-1">หมายเลขโทรศัพท์ เกษตรกร</label>
                            <input type="tel" id="a-phone" placeholder="หมายเลขโทรศัพท์" required pattern="[0-9]{9,15}"
                                class="w-full">
                        </div>
                    </div>

                    <label for="a-id" class="block text-sm font-medium mb-1">รหัสเกษตรกร: ตัวแทนเป็นผู้กำหนดรหัสเอง<span
                            class="text-red-500">(ตัวแทนต้องตั้งให้เกษตรกรของตัวเอง)</span></label>
                    <input type="text" id="a-id" placeholder="เช่น TEST101 หรือ Test01N " required>

                    <h3 class="sm font-medium pt-2 border-t border-stone-100 text-stone-700">ที่อยู่ปัจจุบัน</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="a-address-tambon" class="block text-sm font-medium mb-1">ตำบล</label>
                            <input type="text" id="a-address-tambon" placeholder="ตำบล" class="w-full">
                        </div>
                        <div>
                            <label for="a-address-amphoe" class="block text-sm font-medium mb-1">อำเภอ</label>
                            <input type="text" id="a-address-amphoe" placeholder="อำเภอ" class="w-full">
                        </div>
                        <div>
                            <label for="a-address-province" class="block text-sm font-medium mb-1">จังหวัด</label>
                            <input type="text" id="a-address-province" placeholder="จังหวัด" class="w-full">
                        </div>
                    </div>
                    <textarea id="a-emergency" rows="2" placeholder="ข้อมูลการติดต่อฉุกเฉินหรือผู้แทน (ถ้ามี)"
                        class="w-full"></textarea>
                </div>

                <div class="space-y-4 pt-4 border rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-stone-700">ข้อมูลแปลง</h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="a-gpsx" class="block text-sm font-medium mb-1">พิกัด GPS: X</label>
                            <input type="text" id="a-gpsx" placeholder="เช่น 13.7563" required class="w-full">
                        </div>
                        <div>
                            <label for="a-gpsy" class="block text-sm font-medium mb-1">พิกัด GPS: Y</label>
                            <input type="text" id="a-gpsy" placeholder="เช่น 100.5018" required class="w-full">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="a-plotsize"
                                class="block text-sm font-medium mb-1">ขนาดแปลงที่ใช้แร่และนาโนจริง</label>
                            <input type="number" id="a-plotsize" placeholder="ขนาดแปลง (ไร่) " required min="0.1"
                                step="0.1" class="w-full">
                            <small class="text-stone-500">หน่วย: ไร่</small>
                        </div>
                        <div class="md:col-span-2">
                            <label for="a-cropspecies"
                                class="block text-sm font-medium mb-1">สายพันธุ์ที่จะใช้กับแร่และนาโน</label>
                            <input type="text" id="a-cropspecies" placeholder="เช่น ก้านแดงหางกั้ง,4ปี">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">ระบบให้น้ำ<span
                                class="text-xs text-red-500 ml-2">(เลือกได้มากกว่าหนึ่ง)</span></label>
                        <div class="radio-group flex flex-wrap gap-2">
                            <input type="checkbox" id="water-rain" name="a-watering" value="น้ำฝน" class="hidden"
                                onchange="toggleOtherWateringInput()">
                            <label for="water-rain" class="px-4 py-2 rounded-lg cursor-pointer">น้ำฝน</label>

                            <input type="checkbox" id="water-irrigation" name="a-watering" value="ชลประทาน"
                                class="hidden" onchange="toggleOtherWateringInput()">
                            <label for="water-irrigation" class="px-4 py-2 rounded-lg cursor-pointer">ชลประทาน</label>

                            <input type="checkbox" id="water-ground" name="a-watering" value="น้ำบาดาล" class="hidden"
                                onchange="toggleOtherWateringInput()">
                            <label for="water-ground" class="px-4 py-2 rounded-lg cursor-pointer">น้ำบาดาล</label>

                            <input type="checkbox" id="water-sprinkler" name="a-watering" value="สปริงเกอร์"
                                class="hidden" onchange="toggleOtherWateringInput()">
                            <label for="water-sprinkler" class="px-4 py-2 rounded-lg cursor-pointer">สปริงเกอร์</label>

                            <input type="checkbox" id="water-other" name="a-watering" value="อื่นๆ" class="hidden"
                                onchange="toggleOtherWateringInput()">
                            <label for="water-other" class="px-4 py-2 rounded-lg cursor-pointer">อื่นๆ (ระบุ)</label>
                        </div>
                        <input type="text" id="a-watering-other-text"
                            placeholder="ระบุระบบให้น้ำอื่นๆ (เช่น สระน้ำ, น้ำจากบ่อพัก)" class="hidden mt-2 w-full">
                    </div>

                    <div>
                        <h3 class="text-sm font-medium mb-1 pt-2 border-t border-stone-100 text-stone-700">
                            วิธีให้ปุ๋ย<span class="text-xs text-red-500 ml-2">(เลือกได้มากกว่าหนึ่ง)</span></label>
                            <div class="radio-group flex flex-wrap gap-2">
                                <input type="checkbox" id="fert-organic" name="a-fertilizer-method" value="ปุ๋ยอินทรีย์"
                                    class="hidden" onchange="toggleOtherFertilizerInput()">
                                <label for="fert-organic"
                                    class="px-4 py-2 rounded-lg cursor-pointer">ปุ๋ยอินทรีย์</label>

                                <input type="checkbox" id="fert-chemical" name="a-fertilizer-method" value="ปุ๋ยเคมี"
                                    class="hidden" onchange="toggleOtherFertilizerInput()">
                                <label for="fert-chemical" class="px-4 py-2 rounded-lg cursor-pointer">ปุ๋ยเคมี</label>

                                <input type="checkbox" id="fert-manure" name="a-fertilizer-method" value="ปุ๋ยคอก"
                                    class="hidden" onchange="toggleOtherFertilizerInput()">
                                <label for="fert-manure" class="px-4 py-2 rounded-lg cursor-pointer">ปุ๋ยคอก</label>

                                <input type="checkbox" id="fert-volcanic" name="a-fertilizer-method" value="แร่ภูเขาไฟ"
                                    class="hidden" onchange="toggleOtherFertilizerInput()">
                                <label for="fert-volcanic"
                                    class="px-4 py-2 rounded-lg cursor-pointer">แร่ภูเขาไฟ</label>

                                <input type="checkbox" id="fert-other" name="a-fertilizer-method" value="อื่นๆ"
                                    class="hidden" onchange="toggleOtherFertilizerInput()">
                                <label for="fert-other" class="px-4 py-2 rounded-lg cursor-pointer">อื่นๆ (ระบุ)</label>
                            </div>
                            <input type="text" id="a-fertilizer-other-text"
                                placeholder="โปรดระบุชนิดปุ๋ยอื่นๆ ที่ใช้ (เช่น ปุ๋ยน้ำชีวภาพ, ปุ๋ยชีวภาพ)"
                                class="hidden mt-2 w-full">
                    </div>
                </div>

                <div class="space-y-4 pt-4 border rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-stone-700">ข้อมูลการรับแร่และนาโน</h3>

                    <!-- ข้อมูลตัวแทนรับแร่ -->
                    <div class="border rounded-lg p-4 bg-purple-50">
                        <h4 class="font-semibold text-purple-800 mb-3">ข้อมูลการรับแร่ของตัวแทน</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="a-long-receive-mineral-date"
                                    class="block text-sm font-medium mb-1">วันที่ตัวแทนรับแร่จากบริษัท</label>
                                <input type="date" id="a-long-receive-mineral-date" required class="w-full">
                            </div>
                            <div>
                                <label for="a-long-receive-mineral-amount"
                                    class="block text-sm font-medium mb-1">จำนวนแร่ที่ตัวแทนรับไป (กระสอบ)</label>
                                <input type="number" id="a-long-receive-mineral-amount" required min="1" step="1"
                                    class="w-full">
                            </div>
                        </div>
                    </div>

                    <!-- ข้อมูลตัวแทนรับนาโน -->
                    <div class="border rounded-lg p-4 bg-indigo-50">
                        <h4 class="font-semibold text-indigo-800 mb-3">ข้อมูลการรับนาโนของตัวแทน</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="a-long-receive-nano-date"
                                    class="block text-sm font-medium mb-1">วันที่ตัวแทนรับนาโนจากบริษัท</label>
                                <input type="date" id="a-long-receive-nano-date" required class="w-full">
                            </div>
                            <div>
                                <label for="a-long-receive-nano-amount"
                                    class="block text-sm font-medium mb-1">จำนวนนาโนที่ตัวแทนรับไป (ลิตร)</label>
                                <input type="number" id="a-long-receive-nano-amount" required min="0.1" step="0.1"
                                    class="w-full">
                            </div>
                        </div>
                    </div>

                    <!-- ข้อมูลเกษตรกรรับแร่/นาโน -->
                    <div class="border rounded-lg p-4 bg-blue-50">
                        <h4 class="font-semibold text-blue-800 mb-3">ข้อมูลรับแร่/นาโนของเกษตรกร</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="a-datecollect"
                                    class="block text-sm font-medium mb-1">วันที่เกษตรกรมารับแร่</label>
                                <input type="date" id="a-datecollect" required class="w-full">
                            </div>
                            <div>
                                <label for="a-sackcollect"
                                    class="block text-sm font-medium mb-1">จำนวนแร่ที่เกษตรกรรับไป (กระสอบ)</label>
                                <input type="number" id="a-sackcollect" required min="1" step="1" class="w-full">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div>
                                <label for="a-datenano"
                                    class="block text-sm font-medium mb-1">วันที่เกษตรกรมารับนาโน</label>
                                <input type="date" id="a-datenano" required class="w-full">
                            </div>
                            <div>
                                <label for="a-nanoliters"
                                    class="block text-sm font-medium mb-1">จำนวนนาโนที่เกษตรกรรับไป (ลิตร)</label>
                                <input type="number" id="a-nanoliters" required min="0.1" step="0.1" class="w-full">
                            </div>
                        </div>
                    </div>

                    <div>
                        <label for="a-premitra" class="block text-sm font-medium mb-1">ค่าสารก่อนใช้
                            (ไมทราไจนีน)</label>
                        <input type="number" id="a-premitra" required placeholder="ถ้าไม่มีให้ใส่ 0" min="0" step="0.01"
                            class="w-full">
                    </div>
                </div>

                <div class="space-y-4 pt-4 border rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-stone-700">ข้อมูลอื่นๆ และความยินยอม</h3>
                    <textarea id="a-recentchem" rows="3"
                        placeholder="ปุ๋ย/สารเคมีที่ใช้ใน 30 วันที่ผ่านมา (ชนิด + ปริมาณ + วันที่)"
                        class="w-full"></textarea>

                    <div class="pt-4 space-y-2">
                        <p class="font-medium">ความยินยอม</p>
                        <div class="flex flex-wrap items-center space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="a-consent-sample" value="ยอม" required
                                    class="h-4 w-4 text-stone-800 border-gray-300 focus:ring-stone-500">
                                <span class="ml-2 text-sm">ยินยอมให้เก็บตัวอย่างใบเพื่อวิเคราะห์</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="a-consent-sample" value="ไม่ยอม"
                                    class="h-4 w-4 text-stone-800 border-gray-300 focus:ring-stone-500">
                                <span class="ml-2 text-sm">ไม่ยินยอม</span>
                            </label>
                        </div>
                        <div class="flex flex-wrap items-center space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="a-consent-data" value="ยอม" required
                                    class="h-4 w-4 text-stone-800 border-gray-300 focus:ring-stone-500">
                                <span class="ml-2 text-sm">ยินยอมให้ใช้ข้อมูลเพื่อรายงานผลรวมและวิจัย</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="a-consent-data" value="ไม่ยอม"
                                    class="h-4 w-4 text-stone-800 border-gray-300 focus:ring-ring-stone-500">
                                <span class="ml-2 text-sm">ไม่ยินยอม</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="space-y-4 pt-4 border rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-stone-700">บันทึกหน้างาน</h3>

                    <div>
                        <label class="block text-sm font-medium mb-1">ผู้บันทึก</label>
                        <div class="radio-group flex flex-wrap gap-2">
                            <input type="radio" id="a-recorder-long" name="a-recorder" value="ตัวแทน" required
                                class="hidden">
                            <label for="a-recorder-long" class="px-4 py-2 rounded-lg cursor-pointer">ตัวแทน</label>
                        </div>
                    </div>

                    <div>
                        <label for="a-onsitenotes" class="block text-sm font-medium mb-1">บันทึกเพิ่มเติม</label>
                        <textarea id="a-onsitenotes" rows="3" placeholder="บันทึกเพิ่มเติมจากหน้างาน (ถ้ามี)"
                            class="w-full"></textarea>
                    </div>

                    <div class="flex items-center">
                        <input type="checkbox" id="a-signature" required
                            class="h-4 w-4 text-stone-800 border-gray-300 rounded focus:ring-stone-500">
                        <label for="a-signature" class="ml-2 text-sm font-medium">
                            ผู้รับ: ข้าพเจ้ายอมรับเงื่อนไขและยืนยันความถูกต้องของข้อมูล
                        </label>
                    </div>
                </div>

                <button type="submit" class="w-full pastel-button py-3 mt-6 rounded-lg">
                    บันทึกข้อมูล (การรับแร่และนาโน)
                </button>
            </form>
        </div>

        <!-- SHEET B VIEW -->
        <div id="sheet-b-view" class="space-y-6 hidden">
            <div class="w-full pt-6 pb-2 px-6">
                <h2 class="text-2xl font-bold text-stone-700">
                    ข้อมูลแปลงค่าสารก่อนใช้และค่าสารหลังใช้ (ค้นหา)
                </h2>
            </div>
            <div id="sheet-b-form-container" class="space-y-6">
                <div class="space-y-4 pt-4 border rounded-lg p-4 bg-stone-50">
                    <h3 class="text-lg font-semibold text-stone-700">ข้อมูล (สำหรับค้นหา)</h3>
                    <div class="space-y-4">
                        <label for="b-long-affiliation" class="block text-sm font-medium mb-1">กรุณาเลือกตัวแทนที่สังกัด
                            (ของเกษตรกร)</label>
                        <select id="b-long-affiliation" required class="w-full">
                            <option value="" disabled selected>--- เลือกที่สังกัด (ของเกษตรกร) ---</option>
                        </select>
                        <label for="summary-search-id"
                            class="block text-sm font-medium mb-1">รหัสเกษตรกรของตัวแทน</label>
                        <div class="flex space-x-3 items-end">
                            <input type="text" id="summary-search-id" placeholder="Farmer ID" required
                                class="w-full flex-grow">
                            <button type="button" onclick="fetchAndDisplaySheetBUseData()" id="fetch-data-btn"
                                class="search-button py-2.5 px-6 rounded-lg whitespace-nowrap flex items-center justify-center h-[42px]">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                                    stroke="currentColor" class="w-5 h-5 mr-1">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                                </svg>
                                ค้นหาข้อมูลเกษตรกร
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ข้อมูลเดิม (จาก SheetA) -->
                <div class="space-y-4 border rounded-lg p-4 bg-white">
                    <h3 class="text-lg font-semibold text-stone-700 border-b pb-2">ข้อมูลเดิม</h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- ข้อมูลส่วนตัวเกษตรกร -->
                        <div class="col-span-full">
                            <h4 class="font-semibold text-stone-600 mb-2">ข้อมูลส่วนตัวเกษตรกร</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <p><strong>ชื่อ-สกุล:</strong> <span data-field="a-fullname">---</span></p>
                                <p><strong>รหัสเกษตรกร:</strong> <span data-field="a-id">---</span></p>
                                <p><strong>สังกัดตัวแทน:</strong> <span data-field="a-long-affiliation">---</span></p>
                            </div>
                        </div>

                        <!-- ข้อมูลแปลงและพืชผล -->
                        <div class="col-span-full">
                            <h4 class="font-semibold text-stone-600 mb-2">ข้อมูลแปลงและพืชผล</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <p><strong>ขนาดแปลงที่ใช้แร่และนาโนจริง (ไร่):</strong> <span
                                        data-field="a-plotsize">---</span>
                                </p>
                                <p><strong>สายพันธุ์ที่จะใช้กับแร่และนาโน:</strong> <span
                                        data-field="a-cropspecies">---</span>
                                </p>
                                <p><strong>ระบบให้น้ำ:</strong> <span data-field="a-watering">---</span></p>
                                <p><strong>วิธีใส่ปุ๋ย:</strong> <span data-field="a-fertilizer-methods">---</span></p>
                            </div>
                        </div>

                        <!-- ข้อมูลการรับแร่/นาโน -->
                        <div class="col-span-full">
                            <h4 class="font-semibold text-stone-600 mb-2">ข้อมูลการรับแร่/นาโน</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <p><strong>วันที่รับแร่:</strong> <span data-field="a-datecollect">---</span></p>
                                <p><strong>จำนวนแร่ที่รับ (กระสอบ):</strong> <span data-field="a-sackcollect">---</span>
                                </p>
                                <p><strong>วันที่รับนาโน:</strong> <span data-field="a-datenano">---</span></p>
                                <p><strong>จำนวนนาโน (ลิตร):</strong> <span data-field="a-nanoliters">---</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ข้อมูลการใช้ (จาก SheetB) -->
                <div class="space-y-4 border rounded-lg p-4 bg-white">
                    <h3 class="text-lg font-semibold text-stone-700 border-b pb-2">ข้อมูลการใช้</h3>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- วันที่ใส่ปุ๋ยบำรุงดิน -->
                        <div class="border rounded-lg p-4 bg-green-50">
                            <h4 class="font-semibold text-green-800 mb-3">วันที่บำรุงดิน<br><small
                                    class="text-green-600">ทุก 4
                                    วัน / 1-2 ครั้ง / สัปดาห์</small></h4>
                            <div id="b-fertilizer-usage-display" class="text-sm">
                                <p class="text-stone-500">- ยังไม่มีข้อมูล -</p>
                            </div>
                        </div>

                        <!-- วันที่ใช้นาโน -->
                        <div class="border rounded-lg p-4 bg-blue-50">
                            <h4 class="font-semibold text-blue-800 mb-3">วันที่ใช้นาโน<br><small
                                    class="text-blue-600">ทุก 7 วัน
                                    / 4 ครั้ง / เดือน</small></h4>
                            <div id="b-nano-usage-display" class="text-sm">
                                <p class="text-stone-500">- ยังไม่มีข้อมูล -</p>
                            </div>
                        </div>

                        <!-- วันที่ใช้แร่ -->
                        <div class="border rounded-lg p-4 bg-orange-50">
                            <h4 class="font-semibold text-orange-800 mb-3">วันที่ใช้แร่<br><small
                                    class="text-orange-600">ทุก 16
                                    วัน / 2 ครั้ง / เดือน</small></h4>
                            <div id="b-mineral-usage-display" class="text-sm">
                                <p class="text-stone-500">- ยังไม่มีข้อมูล -</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- อัปเดตค่าสารไม -->
                <div class="space-y-4 border rounded-lg p-4 bg-white">
                    <h3 class="text-lg font-semibold text-stone-700 border-b pb-2">อัปเดตค่าสารไมทราไจนีน</h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- ค่าสารก่อนใช้ -->
                        <div class="border rounded-lg p-4 bg-red-50">
                            <h4 class="font-semibold text-red-800 mb-2">ค่าสารก่อนใช้ (Pre-Mitra)</h4>
                            <p class="text-xl font-bold text-red-600" data-field="a-premitra">---</p>
                            <small class="text-red-600">จากข้อมูลเดิม</small>
                        </div>

                        <!-- ผลตรวจค่าสารหลังใช้ -->
                        <div class="border rounded-lg p-4 bg-blue-50">
                            <h4 class="font-semibold text-blue-800 mb-2">ผลตรวจค่าสารหลังใช้ (Post-Mitra)</h4>
                            <p class="text-xl font-bold text-blue-600" data-field="b-post-mitra">---</p>
                            <small class="text-blue-600">ผลการตรวจจากแล็บ</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SHEET B USE VIEW -->
        <div id="sheet-b-use-view" class="space-y-6 hidden">
            <div class="w-full pt-6 pb-2 px-6">
                <h2 class="text-2xl font-bold text-stone-700">
                    ข้อมูลการใช้แร่และนาโนของเกษตรกร
                </h2>
            </div>
            <form id="sheet-b-use-form" onsubmit="handleSheetBUseSubmit(event)" class="space-y-6">

                <!-- ข้อมูลเกษตรกร (อ้างอิง) -->
                <div class="space-y-4 pt-4 border rounded-lg p-4 bg-stone-50">
                    <h3 class="text-lg font-semibold text-stone-700">ข้อมูลเกษตรกร</h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="b-long-affiliation-use"
                                class="block text-sm font-medium mb-1">ตัวแทนที่สังกัด</label>
                            <select id="b-long-affiliation-use" required class="w-full">
                                <option value="" disabled selected>--- เลือกตัวแทนที่สังกัด ---</option>
                            </select>
                        </div>
                        <div>
                            <label for="b-farmer-id-use" class="block text-sm font-medium mb-1">รหัสเกษตรกร<span
                                    class="text-red-500">(ใช้รหัสที่ตัวแทนกำหนดให้เท่านั้น)</span></label>
                            <input type="text" id="b-farmer-id-use" placeholder="(Farmer ID)" required class="w-full">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="b-fullname-use"
                                class="block text-sm font-medium mb-1">ชื่อ-สกุลเกษตรกร</span>*</label>
                            <input type="text" id="b-fullname-use" placeholder="ชื่อ-สกุลเกษตรกร" required
                                class="w-full">
                        </div>
                    </div>
                </div>

                <div class="space-y-4 pt-4 border rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-stone-700">ข้อมูลการใช้</h3>

                    <!-- วันที่ใส่ปุ๋ยบำรุงดิน -->
                    <div class="border rounded-lg p-4 bg-green-50">
                        <h4 class="font-semibold text-green-800 mb-3">วันที่ใส่ปุ๋ยบำรุงดิน ทุก 4 วัน / 1-2 ครั้ง /
                            สัปดาห์</h4>
                        <div id="fertilizer-usage-container">
                            <div class="fertilizer-usage-item grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                                <div>
                                    <label class="block text-sm font-medium mb-1">วันที่ใส่ปุ๋ย</label>
                                    <input type="date" class="fertilizer-date w-full">
                                </div>

                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium mb-1">บำรุงดินด้วย<span
                                            class="text-xs text-green-600">(เลือกได้มากกว่าหนึ่ง)</span></label>
                                    <div class="radio-group flex flex-wrap gap-2">
                                        <input type="checkbox" id="b-fert-organic" name="fertilizer-type"
                                            value="ปุ๋ยอินทรีย์" class="hidden">
                                        <label for="b-fert-organic"
                                            class="px-3 py-2 rounded-lg cursor-pointer border border-green-300 bg-white hover:bg-green-50">ปุ๋ยอินทรีย์</label>

                                        <input type="checkbox" id="b-fert-chemical" name="fertilizer-type"
                                            value="ปุ๋ยเคมี" class="hidden">
                                        <label for="b-fert-chemical"
                                            class="px-3 py-2 rounded-lg cursor-pointer border border-green-300 bg-white hover:bg-green-50">ปุ๋ยเคมี</label>

                                        <input type="checkbox" id="b-fert-manure" name="fertilizer-type" value="ปุ๋ยคอก"
                                            class="hidden">
                                        <label for="b-fert-manure"
                                            class="px-3 py-2 rounded-lg cursor-pointer border border-green-300 bg-white hover:bg-green-50">ปุ๋ยคอก</label>

                                        <input type="checkbox" id="b-fert-volcanic" name="fertilizer-type"
                                            value="แร่ภูเขาไฟ" class="hidden">
                                        <label for="b-fert-volcanic"
                                            class="px-3 py-2 rounded-lg cursor-pointer border border-green-300 bg-white hover:bg-green-50">แร่ภูเขาไฟ</label>

                                        <input type="checkbox" id="b-fert-other" name="fertilizer-type" value="อื่นๆ"
                                            class="hidden" onchange="toggleOtherFertilizerInputUse(this)">
                                        <label for="b-fert-other"
                                            class="px-3 py-2 rounded-lg cursor-pointer border border-green-300 bg-white hover:bg-green-50">อื่นๆ
                                            (ระบุ)</label>
                                    </div>
                                    <input type="text" id="b-fertilizer-other-text-use"
                                        placeholder="โปรดระบุชนิดปุ๋ยอื่นๆ ที่ใช้"
                                        class="hidden mt-2 w-full fertilizer-other-text">
                                </div>

                                <div class="flex items-end col-span-full">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- วันที่ใช้นาโน -->
                    <div class="border rounded-lg p-4 bg-blue-50">
                        <h4 class="font-semibold text-blue-800 mb-3">วันที่ใช้นาโน ทุก 7 วัน / 4 ครั้ง / เดือน</h4>
                        <div id="nano-usage-container">
                            <div class="nano-usage-item grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                                <div>
                                    <label class="block text-sm font-medium mb-1">วันที่ใช้นาโน</label>
                                    <input type="date" class="nano-date w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">จำนวนที่ใช้ (ลิตร)</label>
                                    <input type="number" class="nano-amount w-full" min="0.1" step="0.1">
                                </div>
                                <div class="flex items-end">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- วันที่ใช้แร่ -->
                    <div class="border rounded-lg p-4 bg-orange-50">
                        <h4 class="font-semibold text-orange-800 mb-3">วันที่ใช้แร่ ทุก 16 วัน / 2 ครั้ง / เดือน</h4>
                        <div id="mineral-usage-container">
                            <div class="mineral-usage-item grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                                <div>
                                    <label class="block text-sm font-medium mb-1">วันที่ใช้แร่</label>
                                    <input type="date" class="mineral-date w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">จำนวนที่ใช้ (กิโลกรัม)</label>
                                    <input type="number" class="mineral-amount w-full" min="0.1" step="0.1">
                                </div>
                                <div class="flex items-end">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ค่าสารและอัตราการใช้ -->
                <div class="space-y-4 pt-4 border rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-stone-700">อัตราการใช้ </h3>

                    <div>
                        <label class="block text-sm font-medium mb-1">อัตราการใส่แร่ที่แนะนำ (เช่น 1 กระสอบ / 1 ไร่)
                            <span class="text-red-500">กรุณาเลือกก่อนบันทึก</span></label>
                        <div class="radio-group flex items-center flex-wrap gap-2">
                            <input type="radio" id="b-rate-follow" name="b-rate" value="ปฏิบัติตาม" required
                                class="hidden" onchange="toggleAdjustedBRate()">
                            <label for="b-rate-follow" class="px-4 py-2 rounded-lg cursor-pointer">ปฏิบัติตาม</label>

                            <input type="radio" id="b-rate-adjust" name="b-rate" value="ปรับตาม" class="hidden"
                                onchange="toggleAdjustedBRate()">
                            <label for="b-rate-adjust" class="px-4 py-2 rounded-lg cursor-pointer">ปรับตาม</label>

                            <input type="number" id="b-rate-adjusted" placeholder="ระบุอัตรา (กระสอบ/ไร่)" min="0.1"
                                step="0.1" class="hidden ml-4">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">อัตราการใส่นาโนที่แนะนำ (เช่น 1 ลิตร / 1 ไร่)
                            <span class="text-red-500">กรุณาเลือกก่อนบันทึก</span></label>
                        <div class="radio-group flex items-center flex-wrap gap-2">
                            <input type="radio" id="b-nano-rate-follow" name="b-nano-rate" value="ปฏิบัติตาม" required
                                class="hidden" onchange="toggleAdjustedBNanoRate()">
                            <label for="b-nano-rate-follow"
                                class="px-4 py-2 rounded-lg cursor-pointer">ปฏิบัติตาม</label>

                            <input type="radio" id="b-nano-rate-adjust" name="b-nano-rate" value="ปรับตาม"
                                class="hidden" onchange="toggleAdjustedBNanoRate()">
                            <label for="b-nano-rate-adjust" class="px-4 py-2 rounded-lg cursor-pointer">ปรับตาม</label>

                            <input type="number" id="b-nano-rate-adjusted" placeholder="ระบุอัตรา (ลิตร/ไร่)" min="0.1"
                                step="0.1" class="hidden ml-4">
                        </div>
                    </div>
                </div>

                <div>
                    <div>
                        <label for="b-recorder" class="block text-sm font-medium mb-1">ผู้บันทึก<span
                                class="text-red-500">(ใครเป็นคนบันทึก)</span></label>
                    </div>
                    <div class="radio-group flex flex-wrap gap-2">
                        <input type="radio" id="b-recorder-long" name="b-recorder" value="ตัวแทน" required>
                        <label for="b-recorder-long" class="px-4 py-2 rounded-lg cursor-pointer">ตัวแทน</label>

                        <input type="radio" id="b-recorder-kk" name="b-recorder" value="เกษตรกร" required>
                        <label for="b-recorder-kk" class="px-4 py-2 rounded-lg cursor-pointer">เกษตรกร</label>
                    </div>
                </div>

                <button type="submit" class="w-full search-button py-3 mt-6 rounded-lg">
                    บันทึกข้อมูลการใช้ 4-7-16
                </button>
            </form>
        </div>

        <!-- SHEET C VIEW -->
        <div id="sheet-c-view" class="space-y-6 hidden">
            <div class="w-full pt-6 pb-2 px-6">
                <h2 class="text-2xl font-bold text-stone-700">
                    สรุปข้อมูลเกษตรกรทั้งหมดของตัวแทน
                </h2>
            </div>

            <div class="space-y-4 pt-4 border rounded-lg p-4 bg-stone-50">
                <h3 class="text-lg font-semibold text-stone-700">ข้อมูลเกษตรกรของคุณ</h3>

                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <div class="flex-grow">
                        <p class="text-sm text-stone-600" id="auto-long-name">
                            <!-- แสดงชื่อตัวแทนอัตโนมัติ -->
                        </p>
                    </div>
                    <div>
                        <button onclick="fetchSummaryData()"
                            class="search-button py-2.5 px-6 rounded-lg whitespace-nowrap flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                                stroke="currentColor" class="w-5 h-5 mr-1">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                            </svg>
                            โหลดข้อมูลเกษตรกร
                        </button>
                    </div>
                </div>
                <div id="summary-count" class="text-sm text-stone-600 font-semibold">
                    กดปุ่ม "โหลดข้อมูลเกษตรกร" เพื่อดูข้อมูล
                </div>
            </div>

            <!-- Data Display Section -->
            <div id="summary-data-container"
                class="overflow-x-auto rounded-xl border border-stone-200 shadow-lg hidden">
                <table class="min-w-full divide-y divide-gray-300 data-table">
                    <thead class="bg-stone-100">
                        <tr class="text-sm uppercase text-stone-700">
                            <th class="px-4 py-3 text-left">รหัสเกษตรกร</th>
                            <th class="px-4 py-3 text-left">ชื่อ-สกุล</th>
                            <th class="px-4 py-3 text-left">เบอร์โทร</th>
                            <th class="px-4 py-3 text-left">ขนาดแปลง</th>
                            <th class="px-4 py-3 text-left">สายพันธุ์</th>
                            <th class="px-4 py-3 text-left">วันที่รับแร่</th>
                            <th class="px-4 py-3 text-left">จำนวนแร่</th>
                            <th class="px-4 py-3 text-left">วันที่รับนาโน</th>
                            <th class="px-4 py-3 text-left">จำนวนนาโน</th>
                            <th class="px-4 py-3 text-left">ค่าสารก่อนใช้</th>
                            <th class="px-4 py-3 text-left">สถานะ</th>
                        </tr>
                    </thead>
                    <tbody id="summary-table-body" class="divide-y divide-gray-200 text-sm bg-white">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>

            <div id="summary-loading" class="text-center p-8 text-stone-500 hidden">
                <div
                    class="animate-spin rounded-full h-8 w-8 border-2 border-stone-400 border-t-stone-800 mx-auto mb-2">
                </div>
                กำลังดึงข้อมูล...
            </div>

            <div id="summary-empty" class="text-center p-8 text-stone-500 hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-2 text-stone-400" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p>ไม่พบข้อมูลเกษตรกรสำหรับตัวแทนนี้</p>
            </div>
        </div>

        <div id="admin-view" class="space-y-6 hidden">

            <div class="w-full pt-6 pb-2 px-6">
                <h2 class="text-2xl font-bold text-stone-700">
                    หน้าผู้ดูแลระบบ (Admin)
                </h2>
            </div>

            <div class="space-y-4 pt-4 border rounded-lg p-4 bg-stone-50">
                <div class="flex items-center justify-between gap-4">
                    <div>
                        <p class="text-sm text-stone-600">เข้าสู่ระบบ: <span id="admin-current-user"
                                class="font-semibold"></span></p>
                    </div>
                    <div class="flex gap-2">
                        <button id="admin-refresh-btn" class="search-button py-2 px-4 rounded-lg"
                            onclick="adminCheckAuthAndInit()">
                            โหลดสถานะ / รีเฟรช
                        </button>
                        <button id="admin-logout-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg"
                            onclick="adminForceLogout()">
                            ออกระบบ
                        </button>
                    </div>
                </div>
                <div id="admin-access-warning" class="text-red-600 text-sm hidden">
                    คุณไม่มีสิทธิ์เข้าถึงหน้านี้
                </div>
            </div>

            <nav class="nav-tabs">

                <button class="nav-tab active" data-target="admin-kratom" data-section-color="orange"
                    onclick="showSection('admin-kratom', this)">ดูข้อมูลทั้งหมด</button>

                <button class="nav-tab" data-target="admin-lounge" data-section-color="blue"
                    onclick="showSection('admin-lounge', this)">2. คู่มือสำหรับตัวแทน</button>
            </nav>

            <div id="admin-kratom" class="content-section active">
                <div class="w-full pt-6 pb-2 px-6">
                    <h2 class="text-2xl font-bold text-stone-700">
                        หน้าเพื่อดูและดาวน์โหลดข้อมูลทุกไฟล์ Sheet A / Sheet B / สรุป
                    </h2>
                </div>

                <div id="admin-controls" class="space-y-4 hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button id="btn-fetch-farmers" class="pastel-button py-3" onclick="adminFetchAllFarmers()">
                            ดึงข้อมูลทั้งหมด (Sheet A)
                        </button>
                        <button id="btn-fetch-usage" class="search-button py-3" onclick="adminFetchAllUsage()">
                            ดึงข้อมูลการใช้ (Sheet B)
                        </button>
                        <button id="btn-fetch-merged" class="blue-button py-3" onclick="adminFetchMerged()">
                            ดึงข้อมูลรวม (Merge)
                        </button>
                    </div>

                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <h4 class="text-sm font-semibold text-yellow-800 mb-3">🔧 เครื่องมือทดสอบระบบ</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                            <button id="btn-simple-test" class="bg-yellow-500 text-white py-2 px-3 rounded text-sm"
                                onclick="adminSimpleTest()">
                                ทดสอบ Basic
                            </button>
                            <button id="btn-sheet-test" class="bg-orange-500 text-white py-2 px-3 rounded text-sm"
                                onclick="adminTestSheetAccess()">
                                ทดสอบ Sheet Access
                            </button>
                            <button id="btn-admin-conn" class="bg-red-500 text-white py-2 px-3 rounded text-sm"
                                onclick="testAdminConnection()">
                                ทดสอบ Admin Connection
                            </button>
                        </div>
                    </div>

                    <!-- เพิ่มในส่วน admin-controls หลังจากปุ่มทดสอบเดิม -->
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mt-4">
                        <h4 class="text-sm font-semibold text-red-800 mb-3">🚨 ทดสอบ getAllFarmers โดยตรง</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <button id="btn-direct-getAll" class="bg-red-600 text-white py-2 px-3 rounded text-sm"
                                onclick="directTestGetAllFarmers()">
                                ทดสอบ getAllFarmers โดยตรง
                            </button>
                            <button id="btn-debug-getAll" class="bg-purple-600 text-white py-2 px-3 rounded text-sm"
                                onclick="testGetAllFarmersDebug()">
                                ทดสอบ getAllFarmersDebug
                            </button>
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <input id="admin-search-input" type="text" placeholder="ค้นหาตามรหัส หรือ ชื่อ"
                            class="w-full p-2 border rounded" />
                        <button id="admin-search-btn" class="search-button px-4"
                            onclick="adminFilterTable()">ค้นหา</button>
                        <button id="admin-export-btn" class="pastel-button px-4"
                            onclick="adminExportCurrentToCSV()">ดาวน์โหลด
                            CSV</button>
                    </div>

                    <div id="admin-loading" class="text-center p-6 hidden">
                        <div class="loading-spinner mx-auto mb-2"></div>
                        กำลังโหลดข้อมูล...
                    </div>

                    <div id="admin-results" class="space-y-4">
                        <div id="admin-table-wrapper" class="overflow-x-auto bg-white rounded-lg border p-4 hidden">
                            <h3 class="font-semibold text-stone-700 mb-2">ผลลัพธ์</h3>
                            <div id="admin-table-container" class="admin-table-scroll"></div>
                        </div>

                        <div id="admin-empty" class="text-stone-500 p-4 hidden">
                            ยังไม่มีข้อมูลที่จะแสดง
                        </div>
                    </div>

                    <div id="admin-results" class="space-y-4">
                        <div id="admin-table-wrapper" class="overflow-x-auto bg-white rounded-lg border p-4 hidden">
                            <h3 class="font-semibold text-stone-700 mb-2">ผลลัพธ์</h3>
                            <div id="admin-table-container" class="admin-table-scroll"></div>
                        </div>

                        <div id="admin-empty" class="text-stone-500 p-4 hidden">
                            ยังไม่มีข้อมูลที่จะแสดง
                        </div>
                    </div>
                </div>
            </div>

            <div id="admin-lounge" class="content-section hidden">
                <h2>คู่มือสำหรับตัวแทน</h2>
                <div class="p-4 bg-white border rounded">
                    <p class="text-sm text-stone-600">คู่มือ / คำแนะนำสำหรับผู้ใช้งานตัวแทน (Placeholder)</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>

        // =============================================
        // CONSTANTS & CONFIGURATION
        // =============================================
        const isGitHubPages = window.location.hostname.includes('github.io');
        const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbwlLPesLd6v2S93WX4myU6MM81Nc-ZqYO6NqOMLd1wga7RlOzvFNCmnWFCLReQHdgNh/exec';

        // =============================================
        // CONSTANTS
        // =============================================
        const LONG_OPTIONS = [
            { value: "", text: "--- เลือกตัวแทนที่สังกัด ---" },
            { value: "ตัวแทนพี่บาสBDS", text: "ตัวแทนพี่บาสBDS" },
            { value: "ตัวแทนพี่Hunterเวียงแก่น", text: "ตัวแทนพี่Hunterเวียงแก่น" },
            { value: "ตัวแทนพี่ก้ามท่าแค", text: "ตัวแทนพี่ก้ามท่าแค" },
            { value: "ตัวแทนพี่กระรอก", text: "ตัวแทนพี่กระรอก" },
            { value: "ตัวแทนพี่รัชช์เมืองนคร", text: "ตัวแทนพี่รัชช์เมืองนคร" },
            { value: "ตัวแทนพี่ตูนบางขัน", text: "ตัวแทนพี่ตูนบางขัน" },
            { value: "ตัวแทนป๋องส์เมืองพัทลุง", text: "ตัวแทนป๋องส์เมืองพัทลุง" },
            { value: "ตัวแทนบจก.จินดารัตน์ โปรดักส์", text: "ตัวแทนบจก.จินดารัตน์ โปรดักส์" },
            { value: "ตัวแทนพี่ดอน", text: "ตัวแทนพี่ดอน" },
            { value: "ตัวแทนพี่เตยพี่เกรซ", text: "ตัวแทนพี่เตยพี่เกรซ" },
            { value: "ตัวแทนพี่สมพงศ์พะยูนตรัง", text: "ตัวแทนพี่สมพงศ์พะยูนตรัง" },
            { value: "ตัวแทนกระท่อมปลอดสารคลองใหม่พัทลุง", text: "ตัวแทนกระท่อมปลอดสารคลองใหม่พัทลุง" },
            { value: "ตัวแทนหรั่งนุ้ยพระนคร", text: "ตัวแทนหรั่งนุ้ยพระนคร" },
            { value: "ตัวแทนพี่เปรี้ยวหล่มสัก", text: "ตัวแทนพี่เปรี้ยวหล่มสัก" },
            { value: "ตัวแทนพี.เจ.กระท่อมทอง", text: "ตัวแทนพี.เจ.กระท่อมทอง" },
            { value: "ตัวแทนทรัพย์มะรุมฟาร์ม", text: "ตัวแทนทรัพย์มะรุมฟาร์ม" },
            { value: "ตัวแทนสวนอิน-จักรภัทร", text: "ตัวแทนสวนอิน-จักรภัทร" },
            { value: "ตัวแทนรักษ์อุทัย", text: "ตัวแทนรักษ์อุทัย" },
            { value: "ตัวแทนพี่วิทย์วิสาหกิจชุมชนชาววัง", text: "ตัวแทนพี่วิทย์วิสาหกิจชุมชนชาววัง" },
            { value: "ตัวแทนพี่สาโรจน์", text: "ตัวแทนพี่สาโรจน์" },
        ];

        // Timing constants for consistent delays across the application
        const DROPDOWN_SELECT_DELAY_MS = 50;  // Delay after populate before auto-select
        const DROPDOWN_RETRY_DELAY_MS = 100;   // Delay for retry attempts
        const DOM_READY_DELAY_MS = 100;        // Delay for DOM to be fully ready

        /**
         * Normalize longName for backward compatibility
         * Converts "ล้ง" prefix to "ตัวแทน" prefix
         */
        function normalizeLongName(longName) {
            if (!longName) return longName;
            
            // If it starts with "ล้ง", replace with "ตัวแทน"
            if (longName.startsWith('ล้ง')) {
                const normalized = longName.replace(/^ล้ง/, 'ตัวแทน');
                console.log(`🔄 Normalized "${longName}" → "${normalized}"`);
                return normalized;
            }
            
            return longName;
        }

        if (isGitHubPages && typeof google === 'undefined') {
            // Create mock google.script.run for GitHub Pages
            window.google = {
                script: {
                    run: {
                        withSuccessHandler: function (successCallback) {
                            this._success = successCallback;
                            return this;
                        },
                        withFailureHandler: function (failureCallback) {
                            this._failure = failureCallback;
                            return this;
                        },
                        withUserObject: function (userObject) {
                            this._userObject = userObject;
                            return this;
                        }
                    }
                }
            };

            // Add proxy functions for each backend function
            const backendFunctions = [
                'userLogin', 'writeSheetA', 'writeSheetB', 'submitForm',
                'searchFarmerData', 'getAllFarmersByLong', 'searchSheetBData',
                'createNewSheetForLong', 'getAllFarmers', 'getAllUsage', 'getAllMerged'
            ];

            backendFunctions.forEach(funcName => {
                google.script.run[funcName] = function (...args) {
                    const self = google.script.run;

                    // Call backend via fetch
                    fetch(BACKEND_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            function: funcName,
                            args: JSON.stringify(args)
                        })
                    })
                        .then(response => response.json())
                        .then(result => {
                            if (self._success) {
                                self._success.call(null, result, self._userObject);
                            }
                        })
                        .catch(error => {
                            if (self._failure) {
                                self._failure.call(null, error, self._userObject);
                            }
                        });
                };
            });
        }

        let currentView = 'main-menu-view';
        let previousView = null;

        // Helper: safe JSON parse that supports object input and string input.
        function safeParseJSON(input) {
            if (input === null || input === undefined) return null;
            if (typeof input === 'object') return input;
            try {
                return JSON.parse(input);
            } catch (e) {
                console.warn('safeParseJSON: invalid JSON input', e, input);
                return null;
            }
        }

        // =============================================
        // UTILITY FUNCTIONS
        // =============================================
        function showMessageBox(title, content) {
            const messageBox = document.getElementById('message-box');
            const messageTitle = document.getElementById('message-title');
            const messageContent = document.getElementById('message-content');

            if (!messageBox || !messageTitle || !messageContent) {
                console.error('❌ ไม่พบ element ของ message box');
                alert(`${title}\n\n${content}`);
                return;
            }

            messageTitle.textContent = title;
            messageContent.style.whiteSpace = 'pre-line';
            // Allow HTML in content (we assume inputs are trusted in this internal app).
            messageContent.innerHTML = content;

            messageBox.classList.remove('hidden');
        }

        function hideMessageBox() {
            const messageBox = document.getElementById('message-box');
            if (messageBox) {
                messageBox.classList.add('hidden');
            }
        }

        function isAppsScriptReady(handlerName, callback) {
            if (typeof google === 'undefined' || typeof google.script === 'undefined' || typeof google.script.run === 'undefined') {
                const errorMessage = `❌ [${handlerName}] Google Apps Script API (google.script.run) ไม่พร้อมใช้งาน. โปรดตรวจสอบว่ารันในสภาพแวดล้อม Google Sheets Web App หรือไม่.`;
                console.error(errorMessage);

                if (handlerName.includes('Submission') || handlerName.includes('Data Fetching')) {
                    showMessageBox("❌ ข้อผิดพลาดการเชื่อมต่อ!", errorMessage);
                }

                const submitAButton = document.querySelector('#sheet-a-form button[type="submit"]');
                if (submitAButton) {
                    submitAButton.disabled = true;
                }

                const fetchButton = document.getElementById('fetch-data-btn');
                if (fetchButton) {
                    fetchButton.disabled = true;
                    fetchButton.innerHTML = 'ค้นหา';
                }

                if (callback) {
                    callback({ success: false, message: errorMessage, data: null });
                }
                return false;
            }

            const fetchButton = document.getElementById('fetch-data-btn');
            if (fetchButton) {
                fetchButton.disabled = false;
            }
            return true;
        }

        // =============================================
        // NAVIGATION FUNCTIONS
        // =============================================
        function showView(viewId) {
            const allViews = [
                'main-menu-view',
                'submenu-view',
                'form-menu-view',
                'sheet-a-view',
                'sheet-b-view',
                'sheet-b-use-view',
                'sheet-c-view',
                'admin-view'
            ];

            allViews.forEach(id => {
                const view = document.getElementById(id);
                if (view) {
                    view.classList.add('hidden');
                }
            });

            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.remove('hidden');
            }

            if (viewId === 'sheet-c-view') {
                updateSummaryView();
            }

            if (viewId === 'sheet-a-view') {
                updateSheetALongDropdown();
            }

            // Update long dropdowns for Sheet B views when user is logged in
            if (viewId === 'sheet-b-view' || viewId === 'sheet-b-use-view') {
                console.log(`📋 Showing ${viewId}, checking login status...`);
                const currentUser = checkLoginStatus();
                if (currentUser && currentUser.longName) {
                    console.log(`✅ User logged in: ${currentUser.longName}`);
                    updateAllLongDropdowns(currentUser.longName);
                } else {
                    console.log('❌ No user logged in or no longName');
                }
            }

            updateBackButton(viewId);

            previousView = currentView;
            currentView = viewId;

            window.scrollTo(0, 0);
        }

        function goBack() {
            if (currentView === 'admin-view') {
                console.log('goBack: current view is admin-view — no action performed.');
                return;
            }
            if (currentView === 'form-menu-view') {
                showView('main-menu-view');
            } else if (currentView === 'sheet-a-view' || currentView === 'sheet-b-view' || currentView === 'sheet-c-view') {
                showView('submenu-view');
            } else if (currentView === 'sheet-b-use-view') {
                showView('main-menu-view');
            } else {
                showView('main-menu-view');
            }
        }

        function updateBackButton(viewId) {
            const backButton = document.getElementById('back-button');
            if (backButton) {
                if (viewId === 'main-menu-view' || viewId === 'submenu-view') {
                    backButton.classList.add('hidden');
                } else {
                    backButton.classList.remove('hidden');
                }
            }
        }

        function updateSummaryView() {
            const currentUser = checkLoginStatus();
            const autoLongElement = document.getElementById('auto-long-name');

            if (currentUser && autoLongElement) {
                autoLongElement.textContent = `ตัวแทน: ${currentUser.longName}`;

                document.getElementById('summary-data-container').classList.add('hidden');
                document.getElementById('summary-empty').classList.add('hidden');
                document.getElementById('summary-count').textContent = 'กดปุ่ม "โหลดข้อมูลเกษตรกร" เพื่อดูข้อมูล';
                document.getElementById('summary-count').className = 'text-sm text-stone-600 font-semibold';
            }
        }

        // =============================================
        // FORM HANDLING FUNCTIONS
        // =============================================
        function toggleOtherWateringInput() {
            const otherInput = document.getElementById('a-watering-other-text');
            const otherRadio = document.getElementById('water-other');
            if (otherInput && otherRadio) {
                if (otherRadio.checked) {
                    otherInput.classList.remove('hidden');
                    otherInput.required = true;
                } else {
                    otherInput.classList.add('hidden');
                    otherInput.required = false;
                    otherInput.value = '';
                }
            }
        }

        function toggleOtherFertilizerInput() {
            const otherInput = document.getElementById('a-fertilizer-other-text');
            const otherRadio = document.getElementById('fert_other');
            if (otherRadio && otherInput) {
                if (otherRadio.checked) {
                    otherInput.classList.remove('hidden');
                    otherInput.required = true;
                } else {
                    otherInput.classList.add('hidden');
                    otherInput.required = false;
                    otherInput.value = '';
                }
            }
        }

        function populateLongOptions() {
            console.log('🔄 populateLongOptions: Starting dropdown population...');
            
            const selectA = document.getElementById('a-long-affiliation');
            const selectB = document.getElementById('b-long-affiliation');
            const selectBUse = document.getElementById('b-long-affiliation-use');

            const selectElements = [selectA, selectB, selectBUse].filter(el => el !== null);

            if (selectElements.length === 0) {
                console.error('❌ populateLongOptions: No dropdown elements found!');
                return false;
            }

            console.log(`🔄 populateLongOptions: Found ${selectElements.length} dropdown(s) to populate`);

            // LONG_OPTIONS is always defined as a const, no need for typeof check
            if (!Array.isArray(LONG_OPTIONS) || LONG_OPTIONS.length === 0) {
                console.error('❌ populateLongOptions: LONG_OPTIONS is empty');
                return false;
            }

            let successCount = 0;
            selectElements.forEach(selectEl => {
                try {
                    const elementId = selectEl.id;
                    
                    // Clear existing options
                    while (selectEl.options.length > 0) {
                        selectEl.remove(0);
                    }

                    // Populate with LONG_OPTIONS
                    LONG_OPTIONS.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option.value;
                        opt.textContent = option.text;
                        selectEl.appendChild(opt);
                    });

                    // Set first option as disabled placeholder
                    if (selectEl.options.length > 0) {
                        selectEl.options[0].disabled = true;
                        selectEl.options[0].selected = true;
                    }
                    
                    successCount++;
                    console.log(`✅ populateLongOptions: Populated ${elementId} with ${selectEl.options.length} options`);
                } catch (e) {
                    console.error(`❌ populateLongOptions: Failed to populate ${selectEl.id}:`, e);
                }
            });
            
            console.log(`📊 populateLongOptions: ${successCount}/${selectElements.length} dropdowns populated successfully`);
            return successCount === selectElements.length;
        }

        // =============================================
        // FORM TOGGLE FUNCTIONS
        // =============================================
        function toggleOtherFertilizerInputUse(checkbox) {
            const item = checkbox.closest('.fertilizer-usage-item');
            if (!item) {
                console.error('❌ ไม่พบ fertilizer-usage-item');
                return;
            }

            const otherText = item.querySelector('.fertilizer-other-text');
            if (!otherText) {
                console.error('❌ ไม่พบ fertilizer-other-text input');
                return;
            }

            if (checkbox.checked) {
                otherText.classList.remove('hidden');
                otherText.required = true;
            } else {
                otherText.classList.add('hidden');
                otherText.required = false;
                otherText.value = '';
            }
        }

        function handleOtherCheckboxChange(event) {
            toggleOtherFertilizerInputUse(event.target);
        }

        function toggleAdjustedBRate() {
            const adjustedInput = document.getElementById('b-rate-adjusted');
            const adjustRadio = document.getElementById('b-rate-adjust');

            if (!adjustRadio || !adjustedInput) {
                console.warn('⚠️ toggleAdjustedBRate: Element ไม่พบ');
                return;
            }
            if (adjustRadio.checked) {
                adjustedInput.classList.remove('hidden');
                adjustedInput.required = true;
            } else {
                adjustedInput.classList.add('hidden');
                adjustedInput.required = false;
                adjustedInput.value = '';
            }
        }

        function toggleAdjustedBNanoRate() {
            const adjustedInput = document.getElementById('b-nano-rate-adjusted');
            const adjustRadio = document.getElementById('b-nano-rate-adjust');

            if (!adjustRadio || !adjustedInput) {
                console.warn('⚠️ toggleAdjustedBNanoRate: Element ไม่พบ');
                return;
            }
            if (adjustRadio.checked) {
                adjustedInput.classList.remove('hidden');
                adjustedInput.required = true;
            } else {
                adjustedInput.classList.add('hidden');
                adjustedInput.required = false;
                adjustedInput.value = '';
            }
        }

        // =============================================
        // VALIDATION & SANITIZATION
        // (single robust validateInput used everywhere)
        // =============================================
        function validateInput(value, type, fieldName) {
            // handle null/undefined and numeric values safely
            if (value === null || value === undefined || (typeof value === 'string' && value.trim() === '')) {
                throw new Error(`กรุณากรอก ${fieldName}`);
            }

            const valStr = (typeof value === 'string') ? value.trim() : String(value);

            switch (type) {
                case 'phone':
                    const phonePattern = /^0[0-9]{9}$/;
                    const cleaned = valStr.replace(/-/g, '');
                    if (!phonePattern.test(cleaned)) {
                        throw new Error(`${fieldName} ไม่ถูกต้อง (ต้องเป็น 0XXXXXXXXX)`);
                    }
                    break;

                case 'number':
                    const num = parseFloat(valStr);
                    if (isNaN(num) || num <= 0) {
                        throw new Error(`${fieldName} ต้องเป็นตัวเลขที่มากกว่า 0`);
                    }
                    break;

                case 'date':
                    if (!valStr) {
                        throw new Error(`กรุณาเลือก ${fieldName}`);
                    }
                    const selectedDate = new Date(valStr);
                    const today = new Date();
                    // compare only date part - not future
                    if (selectedDate > today) {
                        throw new Error(`${fieldName} ไม่สามารถเป็นวันที่ในอนาคตได้`);
                    }
                    break;

                case 'farmerId':
                    if (!valStr) {
                        throw new Error(`${fieldName} ไม่ถูกต้อง`);
                    }
                    if (valStr.length < 3) {
                        throw new Error(`${fieldName} ต้องมีความยาวอย่างน้อย 3 ตัวอักษร`);
                    }
                    break;
            }
            return value;
        }

        // =============================================
        // FORM RESET & MANAGEMENT
        // =============================================
        function resetSheetAFormExceptLong() {
            const form = document.getElementById('sheet-a-form');
            if (!form) return;
            const longSelect = document.getElementById('a-long-affiliation');
            const longValue = longSelect ? longSelect.value : '';

            form.reset();

            if (longSelect) {
                document.getElementById('a-long-affiliation').value = longValue;
            }

            toggleOtherWateringInput();
            toggleOtherFertilizerInput();
        }

        function resetDisplayData() {
            try {
                console.log('🔄 รีเซ็ตข้อมูลแสดงผล');

                const dataElements = document.querySelectorAll('[data-field]');
                dataElements.forEach(el => {
                    el.textContent = '---';
                    if (el.getAttribute('data-field') === 'a-premitra') {
                        el.className = 'text-xl font-bold text-red-600';
                    }
                    if (el.getAttribute('data-field') === 'b-post-mitra') {
                        el.className = 'text-xl font-bold text-blue-600';
                    }
                });

                const fEl = document.getElementById('b-fertilizer-usage-display');
                const nEl = document.getElementById('b-nano-usage-display');
                const mEl = document.getElementById('b-mineral-usage-display');
                if (fEl) fEl.innerHTML = '<p class="text-stone-500">- ยังไม่มีข้อมูล -</p>';
                if (nEl) nEl.innerHTML = '<p class="text-stone-500">- ยังไม่มีข้อมูล -</p>';
                if (mEl) mEl.innerHTML = '<p class="text-stone-500">- ยังไม่มีข้อมูล -</p>';

                console.log('✅ รีเซ็ตข้อมูลเสร็จสิ้น');

            } catch (error) {
                console.error('❌ ข้อผิดพลาดในการรีเซ็ตข้อมูล:', error);
            }
        }

        // =============================================
        // SHEET A FUNCTIONS
        // =============================================
        function getSheetAFormData(form) {
            try {
                if (!form) throw new Error('ไม่พบฟอร์ม');

                const getEl = (id) => {
                    const el = document.getElementById(id);
                    if (!el) throw new Error(`ไม่พบ element: ${id}`);
                    return el;
                };

                const phone = getEl('a-phone').value.trim();
                validateInput(phone, 'phone', 'เบอร์โทรศัพท์');

                const farmerId = getEl('a-id').value.trim();
                validateInput(farmerId, 'farmerId', 'รหัสเกษตรกร');

                const mineralAmount = getEl('a-long-receive-mineral-amount').value;
                validateInput(mineralAmount, 'number', 'จำนวนแร่');

                const nanoAmount = getEl('a-long-receive-nano-amount').value;
                validateInput(nanoAmount, 'number', 'จำนวนนาโน');

                const plotSize = getEl('a-plotsize').value;
                validateInput(plotSize, 'number', 'ขนาดแปลง');

                const sackcollect = getEl('a-sackcollect').value;
                validateInput(sackcollect, 'number', 'จำนวนแร่ที่เกษตรกรรับ');

                const nanoliters = getEl('a-nanoliters').value;
                validateInput(nanoliters, 'number', 'จำนวนนาโนที่เกษตรกรรับ');

                validateInput(getEl('a-long-receive-mineral-date').value, 'date', 'วันที่ตัวแทนรับแร่');
                validateInput(getEl('a-long-receive-nano-date').value, 'date', 'วันที่ตัวแทนรับนาโน');
                validateInput(getEl('a-datecollect').value, 'date', 'วันที่เกษตรกรรับแร่');
                validateInput(getEl('a-datenano').value, 'date', 'วันที่เกษตรกรรับนาโน');

                const parsedMineralAmount = parseFloat(getEl('a-long-receive-mineral-amount').value);
                const parsedNanoAmount = parseFloat(getEl('a-long-receive-nano-amount').value);

                if (isNaN(parsedMineralAmount) || parsedMineralAmount <= 0) {
                    throw new Error("จำนวนแร่ต้องเป็นตัวเลขที่มากกว่า 0");
                }
                if (isNaN(parsedNanoAmount) || parsedNanoAmount <= 0) {
                    throw new Error("จำนวนนาโนต้องเป็นตัวเลขที่มากกว่า 0");
                }

                const formData = {
                    timestamp: new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' }),
                    'a-long-affiliation': (document.getElementById('a-long-affiliation') && document.getElementById('a-long-affiliation').value) || '',
                    'a-fullname': (document.getElementById('a-fullname') && document.getElementById('a-fullname').value.trim()) || '',
                    'a-phone': phone,
                    'a-id': farmerId,
                    'a-address-tambon': (document.getElementById('a-address-tambon') && document.getElementById('a-address-tambon').value.trim()) || '',
                    'a-address-amphoe': (document.getElementById('a-address-amphoe') && document.getElementById('a-address-amphoe').value.trim()) || '',
                    'a-address-province': (document.getElementById('a-address-province') && document.getElementById('a-address-province').value.trim()) || '',
                    'a-emergency': (document.getElementById('a-emergency') && document.getElementById('a-emergency').value.trim()) || '',
                    'a-gpsx': (document.getElementById('a-gpsx') && document.getElementById('a-gpsx').value.trim()) || '',
                    'a-gpsy': (document.getElementById('a-gpsy') && document.getElementById('a-gpsy').value.trim()) || '',
                    'a-plotsize': parseFloat(document.getElementById('a-plotsize').value),
                    'a-cropspecies': (document.getElementById('a-cropspecies') && document.getElementById('a-cropspecies').value.trim()) || '',
                    'a-watering': Array.from(form.querySelectorAll('input[name="a-watering"]:checked')).map(cb => cb.value).join(', '),
                    'a-watering-other-text': (document.getElementById('a-watering-other-text') && document.getElementById('a-watering-other-text').value.trim()) || '',
                    'a-fertilizer-method': Array.from(form.querySelectorAll('input[name="a-fertilizer-method"]:checked')).map(cb => cb.value).join(', '),
                    'a-fertilizer-other-text': (document.getElementById('a-fertilizer-other-text') && document.getElementById('a-fertilizer-other-text').value.trim()) || '',
                    'a-long-receive-mineral-date': document.getElementById('a-long-receive-mineral-date').value,
                    'a-long-receive-mineral-amount': parsedMineralAmount,
                    'a-long-receive-nano-date': document.getElementById('a-long-receive-nano-date').value,
                    'a-long-receive-nano-amount': parsedNanoAmount,
                    'a-datecollect': document.getElementById('a-datecollect').value,
                    'a-sackcollect': parseInt(document.getElementById('a-sackcollect').value, 10),
                    'a-datenano': document.getElementById('a-datenano').value,
                    'a-nanoliters': parseFloat(document.getElementById('a-nanoliters').value),
                    'a-premitra': (document.getElementById('a-premitra') && parseFloat(document.getElementById('a-premitra').value)) || '',
                    'a-recentchem': (document.getElementById('a-recentchem') && document.getElementById('a-recentchem').value.trim()) || '',
                    'a-consent-sample': form.querySelector('input[name="a-consent-sample"]:checked')?.value,
                    'a-consent-data': form.querySelector('input[name="a-consent-data"]:checked')?.value,
                    'a-recorder': document.querySelector('input[name="a-recorder"]:checked')?.value || '',
                    'a-onsitenotes': (document.getElementById('a-onsitenotes') && document.getElementById('a-onsitenotes').value.trim()) || '',
                    'a-signature': document.getElementById('a-signature') && document.getElementById('a-signature').checked ? 'ยืนยัน' : 'ไม่ยืนยัน'
                };

                if (!formData['a-watering'] || !formData['a-watering'].includes('อื่นๆ')) {
                    delete formData['a-watering-other-text'];
                }
                if (!formData['a-fertilizer-method'] || !formData['a-fertilizer-method'].includes('อื่นๆ')) {
                    delete formData['a-fertilizer-other-text'];
                }

                return formData;
            } catch (error) {
                showMessageBox("❌ ข้อมูลไม่ถูกต้อง", error.message);
                throw error;
            }
        }

        function handleSheetASubmit(event) {
            event.preventDefault();

            const form = document.getElementById('sheet-a-form');
            const submitButton = form ? form.querySelector('button[type="submit"]') : null;


            try {
                const session = checkLoginStatus();
                if (!session) {
                    showMessageBox("❌ Session หมดอายุ", "กรุณาล็อกอินใหม่");
                    showLoginModal();
                    return;
                }

                const formData = getSheetAFormData(form);

                if (!formData['a-watering'] || formData['a-watering'].trim() === '') {
                    showMessageBox("❌ ข้อมูลไม่ครบถ้วน!", "กรุณาเลือก **ระบบให้น้ำ** อย่างน้อย 1 ตัว");
                    return;
                }

                if (!formData['a-fertilizer-method'] || formData['a-fertilizer-method'].trim() === '') {
                    showMessageBox("❌ ข้อมูลไม่ครบถ้วน!", "กรุณาเลือก **วิธีใส่ปุ๋ย** อย่างน้อย 1 ตัว");
                    return;
                }

                if (!formData['a-recorder'] || formData['a-recorder'].trim() === '') {
                    showMessageBox("❌ ข้อมูลไม่ครบถ้วน!", "กรุณาเลือก **ผู้บันทึก**");
                    return;
                }

                if (!isAppsScriptReady('Sheet A Submission')) {
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = 'บันทึกข้อมูล';
                    }
                    return;
                }

                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<div class="loading-spinner"></div> กำลังบันทึก...';
                }

                const successHandler = (result) => {
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = 'บันทึกข้อมูล';
                    }

                    if (result && result.success) {
                        showMessageBox("✅ บันทึกสำเร็จ!",
                            `บันทึกข้อมูลการรับแร่และนาโนของ **${formData['a-fullname']}** รหัส **${formData['a-id']}** เข้าระบบเรียบร้อยแล้ว 
                            <br><br>แถวที่บันทึก: **${result.data?.row || 'N/A'}**
                            <br>เวลา: ${new Date().toLocaleTimeString('th-TH')}`
                        );

                        resetSheetAFormExceptLong();
                        showView('sheet-a-view');
                    } else {
                        showMessageBox("❌ บันทึกไม่สำเร็จ!", (result && result.message) || 'ไม่สามารถบันทึกข้อมูลได้');
                    }
                };

                const errorHandler = (error) => {
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = 'บันทึกข้อมูล';
                    }
                    showMessageBox("❌ บันทึกไม่สำเร็จ!",
                        `เกิดข้อผิดพลาดในการบันทึกข้อมูล:
                        <br><br><strong class='text-red-600'>${(error && error.message) || 'Unknown Error'}</strong>
                        <br><br>กรุณาติดต่อผู้ดูแลระบบ`
                    );
                };

                google.script.run
                    .withSuccessHandler(successHandler)
                    .withFailureHandler(errorHandler)
                    .writeSheetA(formData, session.token);

            } catch (error) {
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'บันทึกข้อมูล';
                }
                console.error('Validation error:', error);
            }
        }

        function updateSheetALongDropdown() {
            const currentUser = checkLoginStatus();
            const longSelect = document.getElementById('a-long-affiliation');

            if (!currentUser) {
                console.log('⚠️ updateSheetALongDropdown: No current user');
                return;
            }

            if (!longSelect) {
                console.error('❌ updateSheetALongDropdown: dropdown element not found');
                return;
            }

            // Ensure dropdown is populated
            if (longSelect.options.length === 0) {
                console.log('⚠️ updateSheetALongDropdown: dropdown empty, calling populateLongOptions');
                populateLongOptions();
            }

            // Normalize longName for backward compatibility
            const normalizedLongName = normalizeLongName(currentUser.longName);
            console.log(`🔍 updateSheetALongDropdown: Looking for "${normalizedLongName}"`);
            
            let found = false;
            for (let i = 0; i < longSelect.options.length; i++) {
                if (longSelect.options[i].value === normalizedLongName) {
                    longSelect.selectedIndex = i;
                    longSelect.disabled = true;
                    longSelect.classList.add('bg-gray-100', 'cursor-not-allowed');
                    found = true;
                    console.log(`✅ updateSheetALongDropdown: Auto-selected at index ${i}`);
                    
                    // Trigger change event
                    try {
                        const event = new Event('change', { bubbles: true });
                        longSelect.dispatchEvent(event);
                    } catch (e) {
                        console.warn('⚠️ Could not dispatch change event:', e);
                    }
                    break;
                }
            }

            if (!found) {
                console.warn(`⚠️ updateSheetALongDropdown: No match for "${normalizedLongName}"`);
                console.warn('Available options:', Array.from(longSelect.options).map(o => `"${o.value}"`));
            }

            updateLongDropdownLabels(true);
        }

        // =============================================
        // DATA FETCHING & DISPLAY
        // =============================================
        function fetchAndDisplaySheetAData() {
            const longAffiliationEl = document.getElementById('b-long-affiliation');
            const longAffiliation = longAffiliationEl ? longAffiliationEl.value : '';
            const farmerId = (document.getElementById('summary-search-id') && document.getElementById('summary-search-id').value.trim()) || '';
            const fetchButton = document.getElementById('fetch-data-btn');


            if (!longAffiliation || !farmerId) {
                showMessageBox("❌ ขาดข้อมูล!", "กรุณาเลือกตัวแทนและป้อนรหัสเกษตรกร");
                return;
            }

            if (fetchButton) {
                fetchButton.disabled = true;
                fetchButton.innerHTML = '<div class="loading-spinner"></div> กำลังค้นหา...';
            }

            google.script.run
                .withSuccessHandler((sheetAResult) => {

                    if (fetchButton) {
                        fetchButton.disabled = false;
                        fetchButton.innerHTML = `ค้นหา`;
                    }

                    try {
                        const sheetAData = safeParseJSON(sheetAResult);

                        if (sheetAData && sheetAData.success && Array.isArray(sheetAData.data) && sheetAData.data.length > 0) {
                            const farmer = sheetAData.data[sheetAData.data.length - 1];
                            updateSheetBReadonlyData(farmer);

                            fetchSheetBData(longAffiliation, farmerId);

                        } else {
                            showMessageBox("❌ ไม่พบข้อมูล!", `ไม่พบข้อมูลสำหรับรหัส: ${farmerId}`);
                        }
                    } catch (e) {
                        console.error('❌ ข้อผิดพลาดในการประมวลผลข้อมูล', e);
                        showMessageBox("❌ ข้อผิดพลาด!", "เกิดข้อผิดพลาดในการแสดงผลข้อมูล");
                    }
                })
                .withFailureHandler((error) => {
                    if (fetchButton) {
                        fetchButton.disabled = false;
                        fetchButton.innerHTML = `ค้นหา`;
                    }
                    showMessageBox("❌ ข้อผิดพลาด!", (error && error.message) || 'เกิดข้อผิดพลาดในการค้นหา');
                })
                .searchFarmerData(longAffiliation, farmerId);
        }

        function fetchSheetBData(longAffiliation, farmerId) {
            const fetchButton = document.getElementById('fetch-data-btn');

            console.log('🔍 กำลังดึงข้อมูล Sheet B:', { longAffiliation, farmerId });

            // First ensure sheet for long exists (try to create or ensure)
            google.script.run
                .withSuccessHandler((createResult) => {
                    // Now fetch sheet B data
                    google.script.run
                        .withSuccessHandler((sheetBResult) => {
                            if (fetchButton) {
                                fetchButton.disabled = false;
                                fetchButton.innerHTML = `ค้นหา`;
                            }

                            try {
                                const sheetBData = safeParseJSON(sheetBResult);
                                if (sheetBData && sheetBData.data) {
                                    displaySheetBUsageData(sheetBData.data);
                                } else {
                                    displaySheetBUsageData([]);
                                }
                            } catch (e) {
                                console.error('❌ ข้อผิดพลาดในการประมวลผลข้อมูล Sheet B', e);
                                displaySheetBUsageData([]);
                            }
                        })
                        .withFailureHandler((err) => {
                            if (fetchButton) {
                                fetchButton.disabled = false;
                                fetchButton.innerHTML = `ค้นหา`;
                            }
                            console.error('❌ searchSheetBData failed', err);
                            showMessageBox("❌ ข้อผิดพลาด!", (err && err.message) || 'ไม่สามารถดึงข้อมูล Sheet B ได้');
                        })
                        .searchSheetBData(longAffiliation, farmerId);
                })
                .withFailureHandler((error) => {
                    if (fetchButton) {
                        fetchButton.disabled = false;
                        fetchButton.innerHTML = `ค้นหา`;
                    }
                    console.error('❌ createNewSheetForLong failed', error);
                    showMessageBox("❌ ข้อผิดพลาด!", (error && error.message) || 'ไม่สามารถเตรียม Sheet สำหรับตัวแทนนี้ได้');
                })
                .createNewSheetForLong(longAffiliation);
        }

        function fetchSheetBUsageData(longAffiliation, farmerId, fetchButton) {
            google.script.run
                .withSuccessHandler((sheetBResult) => {
                    if (fetchButton) {
                        fetchButton.disabled = false;
                        fetchButton.innerHTML = 'ค้นหา';
                    }

                    try {
                        const sheetBData = safeParseJSON(sheetBResult);

                        if (sheetBData && sheetBData.success && sheetBData.data && sheetBData.data.length > 0) {
                            displaySheetBUsageData(sheetBData.data);
                        } else {
                            const fEl = document.getElementById('b-fertilizer-usage-display');
                            const nEl = document.getElementById('b-nano-usage-display');
                            const mEl = document.getElementById('b-mineral-usage-display');
                            if (fEl) fEl.textContent = '- ยังไม่มีข้อมูล -';
                            if (nEl) nEl.textContent = '- ยังไม่มีข้อมูล -';
                            if (mEl) mEl.textContent = '- ยังไม่มีข้อมูล -';
                        }
                    } catch (e) {
                        console.error('❌ ข้อผิดพลาดในการประมวลผล Sheet B:', e);
                    }
                })
                .withFailureHandler((error) => {
                    if (fetchButton) {
                        fetchButton.disabled = false;
                        fetchButton.innerHTML = 'ค้นหา';
                    }
                    console.error('❌ ข้อผิดพลาดในการดึง Sheet B:', error);
                })
                .searchSheetBData(longAffiliation, farmerId);
        }

        // =============================================
        // SHEET B FUNCTIONS
        // =============================================
        function fetchAndDisplaySheetBUseData() {
            const longAffiliation = document.getElementById('b-long-affiliation') ? document.getElementById('b-long-affiliation').value : '';
            const farmerId = document.getElementById('summary-search-id') ? document.getElementById('summary-search-id').value.trim() : '';

            if (!longAffiliation || !farmerId) {
                showMessageBox("❌ ขาดข้อมูล!", "กรุณาเลือกตัวแทนและป้อนรหัสเกษตรกร");
                return;
            }

            const fetchButton = document.getElementById('fetch-data-btn');
            if (fetchButton) {
                fetchButton.disabled = true;
                fetchButton.innerHTML = '<div class="loading-spinner"></div> กำลังค้นหา...';
            }

            google.script.run
                .withSuccessHandler((sheetAResult) => {
                    try {
                        const sheetAData = safeParseJSON(sheetAResult);

                        if (sheetAData && sheetAData.success && sheetAData.data.length > 0) {
                            const farmer = sheetAData.data[sheetAData.data.length - 1];
                            updateSheetBReadonlyData(farmer);

                            fetchSheetBUsageData(longAffiliation, farmerId, fetchButton);
                        } else {
                            if (fetchButton) {
                                fetchButton.disabled = false;
                                fetchButton.innerHTML = 'ค้นหา';
                            }
                            showMessageBox("❌ ไม่พบข้อมูล!", `ไม่พบข้อมูลสำหรับรหัส: ${farmerId}`);
                        }
                    } catch (e) {
                        if (fetchButton) {
                            fetchButton.disabled = false;
                            fetchButton.innerHTML = 'ค้นหา';
                        }
                        showMessageBox("❌ ข้อผิดพลาด!", "เกิดข้อผิดพลาดในการแสดงผลข้อมูล");
                    }
                })
                .withFailureHandler((error) => {
                    if (fetchButton) {
                        fetchButton.disabled = false;
                        fetchButton.innerHTML = 'ค้นหา';
                    }
                    showMessageBox("❌ ข้อผิดพลาด!", (error && error.message) || 'เกิดข้อผิดพลาดในการดึงข้อมูล');
                })
                .searchFarmerData(longAffiliation, farmerId);
        }

        function displaySheetBUsageData(usageData) {
            console.log('🔍 displaySheetBUsageData - ข้อมูลที่ได้รับ:', usageData);

            if (!usageData || usageData.length === 0) {
                console.log('❌ ไม่มีข้อมูล - แสดง placeholder');

                const fEl = document.getElementById('b-fertilizer-usage-display');
                const nEl = document.getElementById('b-nano-usage-display');
                const mEl = document.getElementById('b-mineral-usage-display');
                if (fEl) fEl.innerHTML = '<p class="text-stone-500">- ยังไม่มีข้อมูล -</p>';
                if (nEl) nEl.innerHTML = '<p class="text-stone-500">- ยังไม่มีข้อมูล -</p>';
                if (mEl) mEl.innerHTML = '<p class="text-stone-500">- ยังไม่มีข้อมูล -</p>';

                const postMitraEl = document.querySelector('[data-field="b-post-mitra"]');
                if (postMitraEl) postMitraEl.textContent = '---';
                return;
            }

            const latestUsage = usageData[0];

            const fertilizerUsage = latestUsage['b-fertilizer-usage'] || '';
            const nanoUsage = latestUsage['b-nano-usage'] || '';
            const mineralUsage = latestUsage['b-mineral-usage'] || '';
            const postMitra = latestUsage['b-post-mitra'] || '---';

            displayUsageText('b-fertilizer-usage-display', fertilizerUsage);
            displayUsageText('b-nano-usage-display', nanoUsage);
            displayUsageText('b-mineral-usage-display', mineralUsage);

            const postMitraElement = document.querySelector('[data-field="b-post-mitra"]');
            if (postMitraElement) {
                if (postMitra && postMitra !== '' && postMitra !== '---') {
                    const num = parseFloat(postMitra);
                    postMitraElement.textContent = isNaN(num) ? '---' : num.toFixed(2);
                    postMitraElement.className = 'text-xl font-bold text-blue-600';
                } else {
                    postMitraElement.textContent = '---';
                    postMitraElement.className = 'text-xl font-bold text-gray-400';
                }
            }
        }

        function updateSheetBReadonlyData(sheetAData) {
            try {
                console.log('🔄 อัพเดตข้อมูลแสดงผล:', sheetAData);

                if (!sheetAData || Object.keys(sheetAData).length === 0) {
                    console.log('📭 ไม่มีข้อมูลที่จะแสดง');
                    resetDisplayData();
                    return;
                }

                const dataMapA = {
                    'a-fullname': sheetAData['a-fullname'] || '---',
                    'a-id': sheetAData['a-id'] || '---',
                    'a-long-affiliation': sheetAData['a-long-affiliation'] || '---',
                    'a-plotsize': sheetAData['a-plotsize'] || '---',
                    'a-cropspecies': sheetAData['a-cropspecies'] || '---',
                    'a-watering': sheetAData['a-watering'] || '---',
                    'a-fertilizer-methods': sheetAData['a-fertilizer-method'] || '---',
                    'a-datecollect': formatDateForDisplay(sheetAData['a-datecollect']),
                    'a-sackcollect': sheetAData['a-sackcollect'] || '---',
                    'a-datenano': formatDateForDisplay(sheetAData['a-datenano']),
                    'a-nanoliters': sheetAData['a-nanoliters'] || '---',
                    'a-premitra': sheetAData['a-premitra'] || '---'
                };

                Object.keys(dataMapA).forEach(fieldName => {
                    const elements = document.querySelectorAll(`[data-field="${fieldName}"]`);
                    elements.forEach(el => {
                        el.textContent = dataMapA[fieldName];

                        if (fieldName === 'a-premitra' && dataMapA[fieldName] !== '---') {
                            el.className = 'text-xl font-bold text-red-600';
                        }
                    });
                });

            } catch (error) {
                console.error('❌ ข้อผิดพลาดใน updateSheetBReadonlyData:', error);
                showMessageBox("⚠️ ข้อผิดพลาด", "เกิดข้อผิดพลาดในการแสดงผลข้อมูลบางส่วน");
            }
        }

        // =============================================
        // DATA DISPLAY FUNCTIONS
        // =============================================
        function displayUsageText(displayElementId, textData) {
            const displayElement = document.getElementById(displayElementId);

            if (!displayElement) return;

            if (!textData || (typeof textData === 'string' && textData.trim() === '') || textData === '-') {
                displayElement.textContent = '- ยังไม่มีข้อมูล -';
                return;
            }

            // if it's array/object, stringify appropriately
            if (Array.isArray(textData)) {
                displayElement.textContent = textData.map(t => (typeof t === 'string' ? t : JSON.stringify(t))).join('\n');
                return;
            }
            displayElement.textContent = typeof textData === 'string' ? textData : JSON.stringify(textData);
        }

        function formatDateForDisplay(dateString) {
            if (!dateString || dateString === '---') {
                return '---';
            }

            try {
                // handle ISO timestamp or full date
                if (typeof dateString === 'string' && dateString.includes('T') && dateString.includes('Z')) {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('th-TH', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                }

                // handle YYYY-MM-DD (input type="date" value)
                if (typeof dateString === 'string' && dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const [year, month, day] = dateString.split('-');
                    return `${day}/${month}/${year}`;
                }

                // if already DD/MM/YYYY or other readable, return as-is
                return dateString;
            } catch (error) {
                console.error('Error formatting date:', error, dateString);
                return dateString;
            }
        }

        // =============================================
        // SHEET B USE FUNCTIONS
        // =============================================
        function getUsageData() {
            const fertilizerUsage = getFertilizerUsageData();
            const nanoUsage = [];
            const mineralUsage = [];

            console.log('🔍 กำลังดึงข้อมูลการใช้...');

            document.querySelectorAll('.nano-usage-item').forEach(item => {
                const date = item.querySelector('.nano-date')?.value;
                const amount = item.querySelector('.nano-amount')?.value;
                if (date && amount) {
                    const parsed = parseFloat(amount);
                    if (!isNaN(parsed)) {
                        nanoUsage.push({
                            date: date,
                            amount: parsed
                        });
                    }
                }
            });

            document.querySelectorAll('.mineral-usage-item').forEach(item => {
                const date = item.querySelector('.mineral-date')?.value;
                const amount = item.querySelector('.mineral-amount')?.value;
                if (date && amount) {
                    const parsed = parseFloat(amount);
                    if (!isNaN(parsed)) {
                        mineralUsage.push({
                            date: date,
                            amount: parsed
                        });
                    }
                }
            });

            console.log('📊 สรุปข้อมูลการใช้:', {
                fertilizer: fertilizerUsage,
                nano: nanoUsage,
                mineral: mineralUsage
            });

            return {
                fertilizerUsage: fertilizerUsage,
                nanoUsage: nanoUsage,
                mineralUsage: mineralUsage
            };
        }

        function createFertilizerUsageHTML() {
            const uniqueId = `fert-${Date.now()}`;

            // NOTE: removed inline onchange attribute; will attach listener in initializeFertilizerCheckboxes()
            return `
                <div class="fertilizer-usage-item grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">วันที่ใส่ปุ๋ย</label>
                        <input type="date" class="fertilizer-date w-full">
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium mb-1">บำรุงดินด้วย <span class="text-xs text-green-600">(เลือกได้มากกว่าหนึ่ง)</span></label>
                        <div class="radio-group flex flex-wrap gap-2">
                            <input type="checkbox" id="${uniqueId}-organic" name="fertilizer_type[]" value="ปุ๋ยอินทรีย์" class="">
                            <label for="${uniqueId}-organic" class="px-3 py-2 rounded-lg cursor-pointer border border-green-300 bg-white hover:bg-green-50">ปุ๋ยอินทรีย์</label>

                            <input type="checkbox" id="${uniqueId}-chemical" name="fertilizer_type[]" value="ปุ๋ยเคมี" class="">
                            <label for="${uniqueId}-chemical" class="px-3 py-2 rounded-lg cursor-pointer border border-green-300 bg-white hover:bg-green-50">ปุ๋ยเคมี</label>

                            <input type="checkbox" id="${uniqueId}-manure" name="fertilizer_type[]" value="ปุ๋ยคอก" class="">
                            <label for="${uniqueId}-manure" class="px-3 py-2 rounded-lg cursor-pointer border border-green-300 bg-white hover:bg-green-50">ปุ๋ยคอก</label>

                            <input type="checkbox" id="${uniqueId}-other" name="fertilizer_type[]" value="อื่นๆ" class="">
                            <label for="${uniqueId}-other" class="px-3 py-2 rounded-lg cursor-pointer border border-green-300 bg-white hover:bg-green-50">อื่นๆ (ระบุ)</label>
                        </div>
                        <input type="text" placeholder="โปรดระบุชนิดปุ๋ยอื่นๆ ที่ใช้" class="hidden mt-2 w-full fertilizer-other-text">
                    </div>

                    <div class="flex items-end col-span-full"></div> 
                </div>
            `;
        }

        async function handleSheetBUseSubmit(event) {
            event.preventDefault();

            const form = document.getElementById('sheet-b-use-form');
            const submitButton = form ? form.querySelector('button[type="submit"]') : null;

            try {
                const longAffiliation = document.getElementById('b-long-affiliation-use')?.value;
                const farmerId = document.getElementById('b-farmer-id-use')?.value.trim();
                const fullname = document.getElementById('b-fullname-use')?.value.trim();

                if (!longAffiliation) {
                    showMessageBox("❌ ขาดข้อมูล!", "กรุณาเลือกตัวแทนที่สังกัด");
                    return;
                }

                if (!farmerId) {
                    showMessageBox("❌ ขาดข้อมูล!", "กรุณาป้อนรหัสเกษตรกร");
                    return;
                }

                if (!fullname) {
                    showMessageBox("❌ ขาดข้อมูล!", "กรุณากรอกชื่อ-สกุลเกษตรกร");
                    return;
                }

                const recorderElement = document.querySelector('input[name="b-recorder"]:checked');
                if (!recorderElement) {
                    showMessageBox("❌ ขาดข้อมูล!", "กรุณาเลือกผู้บันทึก");
                    return;
                }

                const usageData = getUsageData();
                const hasFertilizer = usageData.fertilizerUsage.length > 0;
                const hasNano = usageData.nanoUsage.length > 0;
                const hasMineral = usageData.mineralUsage.length > 0;

                if (!hasFertilizer && !hasNano && !hasMineral) {
                    showMessageBox("❌ ขาดข้อมูล!", "กรุณากรอกข้อมูลการใช้อย่างน้อย 1 รายการ (ปุ๋ย, นาโน, หรือแร่)");
                    return;
                }

                let errorMessage = '';

                usageData.fertilizerUsage.forEach((item, index) => {
                    if (!item.date || !item.type) {
                        errorMessage += `• รายการปุ๋ยที่ ${index + 1}: กรุณากรอกวันที่และชนิดปุ๋ยให้ครบ<br>`;
                    }
                });

                usageData.nanoUsage.forEach((item, index) => {
                    if (!item.date || !item.amount) {
                        errorMessage += `• รายการนาโนที่ ${index + 1}: กรุณากรอกวันที่และจำนวนให้ครบ<br>`;
                    }
                });

                usageData.mineralUsage.forEach((item, index) => {
                    if (!item.date || !item.amount) {
                        errorMessage += `• รายการแร่ที่ ${index + 1}: กรุณากรอกวันที่และจำนวนให้ครบ<br>`;
                    }
                });

                if (errorMessage) {
                    showMessageBox("❌ ข้อมูลไม่ครบถ้วน!", errorMessage);
                    return;
                }

                const rateElement = form.querySelector('input[name="b-rate"]:checked');
                const nanoRateElement = form.querySelector('input[name="b-nano-rate"]:checked');

                if (!rateElement) {
                    showMessageBox("❌ ขาดข้อมูล!", "กรุณาเลือกอัตราการใส่แร่");
                    return;
                }

                if (!nanoRateElement) {
                    showMessageBox("❌ ขาดข้อมูล!", "กรุณาเลือกอัตราการใส่นาโน");
                    return;
                }


                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<div class="loading-spinner"></div> กำลังบันทึก...';
                }

                const formData = {
                    timestamp: new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' }),
                    'b-long-affiliation': longAffiliation,
                    'b-farmer-id': farmerId,
                    'b-fullname': fullname,
                    'b-phone': document.getElementById('b-phone-use')?.value.trim() || '',
                    'b-fertilizer-usage': usageData.fertilizerUsage,
                    'b-nano-usage': usageData.nanoUsage,
                    'b-mineral-usage': usageData.mineralUsage,
                    'b-rate': rateElement.value,
                    'b-rate-adjusted': document.getElementById('b-rate-adjusted')?.value || '',
                    'b-nano-rate': nanoRateElement.value,
                    'b-nano-rate-adjusted': document.getElementById('b-nano-rate-adjusted')?.value || '',
                    'b-recorder': recorderElement.value
                };

                console.log('📦 ข้อมูลที่จะบันทึก Sheet B:', formData);

                google.script.run
                    .withSuccessHandler((result) => {
                        if (submitButton) {
                            submitButton.disabled = false;
                            submitButton.innerHTML = 'บันทึกข้อมูลการใช้';
                        }

                        if (result && result.success) {
                            showMessageBox("✅ บันทึกสำเร็จ!",
                                `บันทึกข้อมูลการใช้ 4-7-16 ของ **${formData['b-fullname']}** เรียบร้อยแล้ว
                                <br><br>แถวที่บันทึก: **${result.data?.row || 'N/A'}**
                                <br>ชีท: **${result.data?.sheet || 'N/A'}**
                                <br>เวลา: ${new Date().toLocaleTimeString('th-TH')}`
                            );
                            if (form) form.reset();
                            resetUsageContainers();
                            showView('main-menu-view');
                        } else {
                            showMessageBox("❌ บันทึกไม่สำเร็จ!", (result && result.message) || 'ไม่สามารถบันทึกข้อมูลได้');
                        }
                    })
                    .withFailureHandler((error) => {
                        if (submitButton) {
                            submitButton.disabled = false;
                            submitButton.innerHTML = 'บันทึกข้อมูลการใช้';
                        }
                        showMessageBox("❌ บันทึกไม่สำเร็จ!",
                            `เกิดข้อผิดพลาด: ${(error && error.message) || 'Unknown error'}
                            <br><br>กรุณาตรวจสอบข้อมูลและลองอีกครั้ง`
                        );
                        console.error('❌ ข้อผิดพลาดในการบันทึก:', error);
                    })
                    .writeSheetB(formData);

            } catch (error) {
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'บันทึกข้อมูลการใช้';
                }
                console.error('❌ ข้อผิดพลาด:', error);
                showMessageBox("❌ ข้อผิดพลาด!", error.message || 'เกิดข้อผิดพลาด');
            }
        }

        function resetUsageContainers() {
            const fertilizerContainer = document.getElementById('fertilizer-usage-container');
            if (fertilizerContainer) {
                fertilizerContainer.innerHTML = createFertilizerUsageHTML();
            }

            const nanoContainer = document.getElementById('nano-usage-container');
            if (nanoContainer) {
                nanoContainer.innerHTML = `
                    <div class="nano-usage-item grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                        <div>
                            <label class="block text-sm font-medium mb-1">วันที่ใช้นาโน</label>
                            <input type="date" class="nano-date w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">จำนวนที่ใช้ (ลิตร)</label>
                            <input type="number" class="nano-amount w-full" min="0.1" step="0.1">
                        </div>
                        <div class="flex items-end"></div>
                    </div>
                `;
            }

            const mineralContainer = document.getElementById('mineral-usage-container');
            if (mineralContainer) {
                mineralContainer.innerHTML = `
                    <div class="mineral-usage-item grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                        <div>
                            <label class="block text-sm font-medium mb-1">วันที่ใช้แร่</label>
                            <input type="date" class="mineral-date w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">จำนวนที่ใช้ (กิโลกรัม)</label>
                            <input type="number" class="mineral-amount w-full" min="0.1" step="0.1">
                        </div>
                        <div class="flex items-end"></div>
                    </div>
                `;
            }
            initializeFertilizerCheckboxes();
        }

        document.addEventListener('DOMContentLoaded', function () {
            initializeFertilizerCheckboxes();
        });

        // =============================================
        // USAGE DATA MANAGEMENT
        // =============================================
        let fertilizerUsageCount = 1;
        let nanoUsageCount = 1;
        let mineralUsageCount = 1;

        function getFertilizerUsageData() {
            const fertilizerUsage = [];

            document.querySelectorAll('.fertilizer-usage-item').forEach((item, index) => {
                const date = item.querySelector('.fertilizer-date')?.value;
                const checkedBoxes = item.querySelectorAll('input[type="checkbox"]:checked');
                const checkedTypes = Array.from(checkedBoxes).map(cb => {
                    if (cb.value === 'อื่นๆ') {
                        const otherTextInput = item.querySelector('.fertilizer-other-text');
                        if (otherTextInput && !otherTextInput.classList.contains('hidden')) {
                            const otherValue = otherTextInput.value.trim();
                            return otherValue ? `อื่นๆ: ${otherValue}` : 'อื่นๆ';

                        }
                        return 'อื่นๆ'
                    }
                    return cb.value;
                }).filter(val => val); // กรองค่าว่าง

                if (date && checkedTypes.length > 0) {
                    fertilizerUsage.push({
                        date: date,
                        type: checkedTypes.join(', ')
                    });
                }
            });
            return fertilizerUsage;
        }

        function getSheetBUseFormData(form) {
            const usageData = getUsageData();

            const hasUsageData = usageData.fertilizerUsage.length > 0 ||
                usageData.nanoUsage.length > 0 ||
                usageData.mineralUsage.length > 0;

            if (!hasUsageData) {
                throw new Error("กรุณากรอกข้อมูลการใช้อย่างน้อย 1 รายการ");
            }

            const formData = {
                timestamp: new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' }),
                'b-long-affiliation': document.getElementById('b-long-affiliation-use')?.value,
                'b-farmer-id': document.getElementById('b-farmer-id-use')?.value.trim(),
                'b-fullname': document.getElementById('b-fullname-use')?.value.trim(),
                'b-phone': document.getElementById('b-phone-use')?.value.trim() || '',
                'b-fertilizer-usage': usageData.fertilizerUsage,
                'b-nano-usage': usageData.nanoUsage,
                'b-mineral-usage': usageData.mineralUsage,
                'b-premitra': parseFloat(document.getElementById('b-premitra')?.value || 0),
                'b-rate': form.querySelector('input[name="b-rate"]:checked')?.value,
                'b-rate-adjusted': document.getElementById('b-rate-adjusted')?.value ? parseFloat(document.getElementById('b-rate-adjusted').value) : '',
                'b-nano-rate': form.querySelector('input[name="b-nano-rate"]:checked')?.value,
                'b-nano-rate-adjusted': document.getElementById('b-nano-rate-adjusted')?.value ? parseFloat(document.getElementById('b-nano-rate-adjusted').value) : '',
                'b-recorder': document.querySelector('input[name="b-recorder"]:checked')?.value || ''
            };

            if (formData['b-rate'] !== 'ปรับตาม') {
                delete formData['b-rate-adjusted'];
            }
            if (formData['b-nano-rate'] !== 'ปรับตาม') {
                delete formData['b-nano-rate-adjusted'];
            }

            Object.keys(formData).forEach(key => {
                if (formData[key] === '' || formData[key] === null || formData[key] === undefined) {
                    delete formData[key];
                }
            });
            return formData;
        }

        // =============================================
        // VALIDATION & SECURITY
        // =============================================
        function validateBeforeSubmit() {
            const longAffiliation = document.getElementById('b-long-affiliation-use')?.value;
            const farmerId = document.getElementById('b-farmer-id-use')?.value.trim();

            if (!longAffiliation || !farmerId) {
                return Promise.resolve(false);
            }

            return new Promise((resolve) => {
                google.script.run
                    .withSuccessHandler((result) => {
                        if (result && result.success && result.exists) {
                            resolve(true);
                        } else {
                            showMessageBox("❌ ข้อผิดพลาด",
                                `ไม่สามารถบันทึกข้อมูลได้: ${result && result.message ? result.message : 'ความสัมพันธ์ข้อมูลไม่ถูกต้อง'}
                                 <br><br>กรุณาตรวจสอบว่า:
                                 <br>• ดูแลตัวแทนได้บันทึกข้อมูลการรับแร่/นาโนของเกษตรกรหรือยัง
                                 <br>• รหัสเกษตรกรถูกต้องไหม
                                 <br>• เลือกตัวแทนที่สังกัดถูกต้องไหม`);
                            resolve(false);
                        }
                    })
                    .withFailureHandler((error) => {
                        showMessageBox("❌ ข้อผิดพลาด", "ไม่สามารถตรวจสอบข้อมูลได้: " + (error && error.message ? error.message : 'Unknown error'));
                        resolve(false);
                    })
                    .validateDataRelationship(longAffiliation, farmerId);
            });
        }

        // =============================================
        // AUTHENTICATION FUNCTIONS
        // =============================================
        async function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('username')?.value.trim();
            const password = document.getElementById('password')?.value;
            const errorElement = document.getElementById('login-error');
            const submitButton = event.target.querySelector('button[type="submit"]');

            if (!username || !password) {
                const errorMessage = "กรุณากรอกชื่อตัวแทนและรหัสผ่าน";
                if (errorElement) {
                    errorElement.textContent = errorMessage;
                    errorElement.classList.remove('hidden');
                } else {
                    showMessageBox("❌ ข้อมูลไม่ครบ", errorMessage);
                }
                return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = '<div class="loading-spinner"></div> กำลังตรวจสอบ...';

            if (errorElement) {
                errorElement.classList.add('hidden');
            }

            try {
                const response = await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .userLogin(username, password);
                });

                if (response && response.success) {
                    console.log('✅ Login successful:', response);
                    
                    // Store session data
                    sessionStorage.setItem('sessionToken', response.token);
                    sessionStorage.setItem('longName', response.longName);
                    sessionStorage.setItem('username', response.username);
                    sessionStorage.setItem('isAdmin', response.isAdmin ? 'true' : 'false');

                    hideLoginModal();

                    if (response.isAdmin) {
                        // Admin users go to admin panel
                        adminCheckAuthAndInit();
                    } else {
                        // CRITICAL FIX: Ensure dropdowns are populated BEFORE auto-selecting
                        console.log('🔄 Populating dropdowns before auto-select...');
                        
                        // Force populate all dropdowns
                        const populated = populateLongOptions();
                        
                        if (!populated) {
                            console.warn('⚠️ Dropdown population failed, retrying...');
                            // Single setTimeout with combined delay for retry
                            setTimeout(() => {
                                populateLongOptions();
                                updateAllLongDropdowns(response.longName);
                            }, DROPDOWN_RETRY_DELAY_MS * 2);  // 200ms total delay for retry
                        } else {
                            // Success - small delay for DOM rendering before auto-select
                            setTimeout(() => {
                                console.log('🔄 Dropdowns populated, now auto-selecting...');
                                updateAllLongDropdowns(response.longName);
                            }, DROPDOWN_SELECT_DELAY_MS);
                        }
                        
                        showView('submenu-view');
                    }

                    showMessageBox("✅ ล็อกอินสำเร็จ", `ยินดีต้อนรับ ${response.longName}`);
                } else {
                    const errorMessage = (response && response.message) || "ชื่อตัวแทนหรือรหัสผ่านไม่ถูกต้อง";
                    if (errorElement) {
                        errorElement.textContent = errorMessage;
                        errorElement.classList.remove('hidden');
                    } else {
                        showMessageBox("❌ ล็อกอินไม่สำเร็จ", errorMessage);
                    }
                }
            } catch (error) {
                console.error('❌ ข้อผิดพลาดในการล็อกอิน:', error);
                const errorMessage = "เกิดข้อผิดพลาดในการเชื่อมต่อระบบ";
                if (errorElement) {
                    errorElement.textContent = errorMessage;
                    errorElement.classList.remove('hidden');
                } else {
                    showMessageBox("❌ ข้อผิดพลาดระบบ", errorMessage);
                }
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = 'เข้าสู่ระบบ';
            }
        }

        function showLoginModal() {
            const el = document.getElementById('login-modal');
            if (el) el.classList.remove('hidden');
            const input = document.getElementById('username');
            if (input) input.focus();
        }

        function hideLoginModal() {
            const modal = document.getElementById('login-modal');
            if (modal) modal.classList.add('hidden');
            const form = document.getElementById('login-form');
            if (form) form.reset();
            const err = document.getElementById('login-error');
            if (err) err.classList.add('hidden');
        }

        function checkLoginStatus() {

            const token = sessionStorage.getItem('sessionToken');
            const longName = sessionStorage.getItem('longName');
            const username = sessionStorage.getItem('username');

            if (!token || !longName || !username) {
                return null;
            }

            try {
                const parts = token.split('.');
                if (parts.length < 2) {
                    console.log('❌ โครงสร้าง token ไม่ถูกต้อง');
                    sessionStorage.clear();
                    return null;
                }

                const tokenData = JSON.parse(atob(parts[0]));
                const tokenTime = tokenData.timestamp;
                const hoursDiff = (new Date().getTime() - tokenTime) / (1000 * 60 * 60);

                if (hoursDiff >= 24) {
                    console.log('❌ Token หมดอายุ');
                    sessionStorage.clear();
                    showMessageBox("⏰ Session หมดอายุ", "กรุณาล็อกอินใหม่");
                    return null;
                }

                return { username, longName, token };
            } catch (e) {
                console.error('❌ ข้อผิดพลาดในการตรวจสอบ token:', e);
                sessionStorage.clear();
                return null;
            }
        }

        function checkAuthAndShowSubmenu() {
            console.log('🔐 checkAuthAndShowSubmenu called');
            const currentUser = checkLoginStatus();

            if (currentUser) {
                console.log(`✅ User authenticated: ${currentUser.longName}`);
                showView('submenu-view');
                
                // CRITICAL FIX: Ensure dropdowns are populated before auto-selecting
                console.log('🔄 Ensuring dropdowns are populated...');
                populateLongOptions();
                
                // Small delay to ensure DOM rendering, then auto-select
                setTimeout(() => {
                    console.log('🔄 Auto-selecting dropdowns...');
                    updateAllLongDropdowns(currentUser.longName);
                }, DROPDOWN_SELECT_DELAY_MS);
                
                const header = document.querySelector('#submenu-view header');
                if (header) {
                    // ensure we don't append duplicates
                    if (!header.querySelector('.submenu-user-info')) {
                        const userInfo = document.createElement('div');
                        userInfo.className = 'submenu-user-info text-sm text-stone-600 mb-2';
                        userInfo.innerHTML = `ล็อกอินเป็น: <strong>${currentUser.longName}</strong>`;
                        header.insertBefore(userInfo, header.firstChild);
                    }
                }

            } else {
                console.log('❌ User not authenticated, showing login modal');
                showLoginModal();
            }
        }

        function logout() {
            try {
                let longName = sessionStorage.getItem('longName');

                try {
                    const currentUser = sessionStorage.getItem('currentUser');
                    if (currentUser) {
                        const userData = JSON.parse(currentUser);
                        longName = longName || userData.longName;
                    }
                } catch (e) {
                    console.log('❌ ไม่สามารถ parse currentUser:', e);
                }

                sessionStorage.clear();
                resetLongDropdowns();
                showView('main-menu-view');

                showMessageBox("👋 ล็อกเอาท์สำเร็จ", `คุณได้ออกจากระบบ ${longName || ''} แล้ว`);

            } catch (error) {
                console.error('❌ ข้อผิดพลาดใน logout:', error);
                sessionStorage.clear();
                window.location.reload();
            }
        }

        // =============================================
        // SUMMARY & DATA FUNCTIONS
        // =============================================
        function fetchSummaryData() {
            const currentUser = checkLoginStatus();

            if (!currentUser) {
                showMessageBox("❌ ยังไม่ได้ล็อกอิน", "กรุณาล็อกอินใหม่");
                showLoginModal();
                return;
            }

            const loadingElement = document.getElementById('summary-loading');
            const dataContainer = document.getElementById('summary-data-container');
            const emptyElement = document.getElementById('summary-empty');

            if (dataContainer) dataContainer.classList.add('hidden');
            if (emptyElement) emptyElement.classList.add('hidden');
            if (loadingElement) loadingElement.classList.remove('hidden');

            const selectedLong = currentUser.longName;

            if (!isAppsScriptReady('Summary Data Fetching')) {
                if (loadingElement) loadingElement.classList.add('hidden');
                return;
            }

            google.script.run
                .withSuccessHandler((result) => {
                    if (loadingElement) loadingElement.classList.add('hidden');

                    try {
                        const data = safeParseJSON(result);

                        if (data && data.success && Array.isArray(data.data) && data.data.length > 0) {
                            displaySummaryData(data.data, selectedLong);
                        } else {
                            showEmptySummary(selectedLong);
                        }
                    } catch (e) {
                        console.error('❌ ข้อผิดพลาดในการประมวลผลข้อมูล:', e);
                        showMessageBox("❌ ข้อผิดพลาด!", "เกิดข้อผิดพลาดในการดึงข้อมูล");
                    }
                })
                .withFailureHandler((error) => {
                    if (loadingElement) loadingElement.classList.add('hidden');
                    console.error('❌ ข้อผิดพลาดในการดึงข้อมูลสรุป:', error);
                    showMessageBox("❌ ข้อผิดพลาด!", (error && error.message) || 'ไม่สามารถดึงข้อมูลได้');
                })
                .getAllFarmersByLong(selectedLong);
        }

        function displaySummaryData(farmers, selectedLong) {
            const tableBody = document.getElementById('summary-table-body');
            const dataContainer = document.getElementById('summary-data-container');
            const countElement = document.getElementById('summary-count');
            const emptyElement = document.getElementById('summary-empty');

            if (countElement) {
                countElement.textContent = `พบข้อมูลเกษตรกรทั้งหมด ${farmers.length} รายการในตัวแทน ${selectedLong}`;
                countElement.className = 'text-sm text-green-600 font-semibold';
            }

            if (tableBody) tableBody.innerHTML = '';

            farmers.forEach((farmer, index) => {
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-white' : 'bg-stone-50';
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium text-stone-800">${farmer['a-id'] || '---'}</td>
                    <td class="px-4 py-3">${farmer['a-fullname'] || '---'}</td>
                    <td class="px-4 py-3">${farmer['a-phone'] || '---'}</td>
                    <td class="px-4 py-3">${farmer['a-plotsize'] ? `${farmer['a-plotsize']} ไร่` : '---'}</td>
                    <td class="px-4 py-3">${farmer['a-cropspecies'] || '---'}</td>
                    <td class="px-4 py-3">${formatDateForDisplay(farmer['a-datecollect']) || '---'}</td>
                    <td class="px-4 py-3">${farmer['a-sackcollect'] ? `${farmer['a-sackcollect']} กระสอบ` : '---'}</td>
                    <td class="px-4 py-3">${formatDateForDisplay(farmer['a-datenano']) || '---'}</td>
                    <td class="px-4 py-3">${farmer['a-nanoliters'] ? `${farmer['a-nanoliters']} ลิตร` : '---'}</td>
                    <td class="px-4 py-3 font-medium ${getMitraColorClass(farmer['a-premitra'])}">
                        ${farmer['a-premitra'] ? `${parseFloat(farmer['a-premitra']).toFixed(2)}` : '---'}
                    </td>
                    <td class="px-4 py-3">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusClass(farmer)}">
                            ${getStatusText(farmer)}
                        </span>
                    </td>
                `;
                if (tableBody) tableBody.appendChild(row);
            });

            if (dataContainer) dataContainer.classList.remove('hidden');
            if (emptyElement) emptyElement.classList.add('hidden');
        }

        function showEmptySummary(selectedLong) {
            const dataContainer = document.getElementById('summary-data-container');
            const countElement = document.getElementById('summary-count');
            const emptyElement = document.getElementById('summary-empty');

            if (dataContainer) dataContainer.classList.add('hidden');
            if (emptyElement) emptyElement.classList.remove('hidden');
            if (countElement) {
                countElement.textContent = `ไม่พบข้อมูลเกษตรกรในตัวแทน ${selectedLong}`;
                countElement.className = 'text-sm text-red-600 font-semibold';
            }
        }

        function getMitraColorClass(premitra) {
            if (!premitra || premitra === 0) return 'text-stone-500';
            const value = parseFloat(premitra);
            if (isNaN(value)) return 'text-stone-500';
            if (value < 1) return 'text-red-600';
            if (value < 2) return 'text-yellow-600';
            return 'text-green-600';
        }

        function getStatusClass(farmer) {
            if (!farmer['a-datecollect'] && !farmer['a-datenano']) return 'bg-gray-100 text-gray-800';
            if (farmer['a-datecollect'] && farmer['a-datenano']) return 'bg-green-100 text-green-800';
            return 'bg-yellow-100 text-yellow-800';
        }

        function getStatusText(farmer) {
            if (!farmer['a-datecollect'] && !farmer['a-datenano']) return 'รอรับ';
            if (farmer['a-datecollect'] && farmer['a-datenano']) return 'รับแล้ว';
            return 'รับบางส่วน';
        }

        // =============================================
        // DROPDOWN MANAGEMENT
        // =============================================
        function updateAllLongDropdowns(selectedLong) {
            console.log('🔄 updateAllLongDropdowns called with:', selectedLong);
            
            if (!selectedLong) {
                console.warn('⚠️ updateAllLongDropdowns called with empty selectedLong');
                return;
            }
            
            // Normalize the selectedLong for backward compatibility
            const normalizedLong = normalizeLongName(selectedLong);
            console.log('🔄 Normalized long name:', normalizedLong);
            
            const longSelectors = [
                'a-long-affiliation',
                'b-long-affiliation',
                'b-long-affiliation-use'
            ];

            let successCount = 0;
            let failureCount = 0;

            longSelectors.forEach(selector => {
                const element = document.getElementById(selector);
                if (!element) {
                    console.log(`  ❌ Element not found: ${selector}`);
                    failureCount++;
                    return;
                }

                // CRITICAL FIX: Ensure dropdown is populated before attempting auto-select
                if (element.options.length === 0 || element.options.length === 1) {
                    console.log(`  ⚠️ Dropdown ${selector} is empty or has only placeholder, populating...`);
                    
                    // Clear existing options
                    while (element.options.length > 0) {
                        element.remove(0);
                    }
                    
                    // Populate with LONG_OPTIONS (always defined as const, no typeof check needed)
                    if (!Array.isArray(LONG_OPTIONS) || LONG_OPTIONS.length === 0) {
                        console.error(`  ❌ LONG_OPTIONS is empty for ${selector}`);
                        failureCount++;
                        return;
                    }
                    
                    LONG_OPTIONS.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option.value;
                        opt.textContent = option.text;
                        if (option.value === "") {
                            opt.disabled = true;
                        }
                        element.appendChild(opt);
                    });
                    
                    console.log(`  ✅ Populated ${selector} with ${element.options.length} options`);
                }
                
                console.log(`  🔍 Checking dropdown: ${selector}, options count: ${element.options.length}`);
                
                // Try to find and select the matching option (exact match first)
                let found = false;
                for (let i = 0; i < element.options.length; i++) {
                    const optionValue = element.options[i].value;
                    if (optionValue === normalizedLong) {
                        element.selectedIndex = i;
                        found = true;
                        console.log(`  ✅ AUTO-SELECTED at index ${i} for ${selector}: "${optionValue}"`);
                        
                        // Trigger change event to ensure any listeners are notified
                        try {
                            const event = new Event('change', { bubbles: true });
                            element.dispatchEvent(event);
                        } catch (e) {
                            console.warn('  ⚠️ Could not dispatch change event:', e);
                        }
                        
                        successCount++;
                        break;
                    }
                }
                
                // Improved fallback: Only use partial match if normalized contains full word boundary
                // This prevents false positives like matching "ตัวแทน" to every option
                if (!found && normalizedLong.length > 6) {  // Only for specific names, not generic prefixes
                    console.warn(`  ⚠️ NO EXACT MATCH for "${normalizedLong}" in ${selector}, trying partial...`);
                    
                    for (let i = 0; i < element.options.length; i++) {
                        const optionValue = element.options[i].value;
                        // Skip empty values
                        if (!optionValue || optionValue === "") continue;
                        
                        // Check if the option contains the normalized value (but not vice versa to avoid matching generic prefixes)
                        if (optionValue.includes(normalizedLong)) {
                            console.log(`  🔧 Found partial match at index ${i}: "${optionValue}"`);
                            element.selectedIndex = i;
                            
                            try {
                                const event = new Event('change', { bubbles: true });
                                element.dispatchEvent(event);
                            } catch (e) {}
                            
                            successCount++;
                            found = true;
                            break;
                        }
                    }
                }
                
                if (!found) {
                    console.warn(`  ❌ NO MATCH found (exact or partial) for "${normalizedLong}" in ${selector}`);
                    console.warn(`  Available options:`, Array.from(element.options).map(o => `"${o.value}"`));
                    failureCount++;
                }

                // Lock the dropdown after selection (or attempted selection)
                element.disabled = true;
                element.classList.add('bg-gray-100', 'cursor-not-allowed');
            });
            
            updateLongDropdownLabels(true);
            
            // Summary log
            console.log(`📊 Dropdown update summary: ${successCount} succeeded, ${failureCount} failed`);
            
            // Show user feedback if there were failures
            if (failureCount > 0 && successCount === 0) {
                console.error('❌ All dropdown updates failed! User data may not match available options.');
                // Optional: show a subtle notification to user (uncomment if desired)
                // showMessageBox('⚠️ Notice', 'Some dropdowns could not be auto-selected. Please verify your selections.');
            }
        }

        function resetLongDropdowns() {
            const longSelectors = [
                'a-long-affiliation',
                'b-long-affiliation',
                'b-long-affiliation-use'
            ];

            longSelectors.forEach(selector => {
                const element = document.getElementById(selector);
                if (element) {
                    element.disabled = false;
                    element.selectedIndex = 0;
                    element.classList.remove('bg-gray-100', 'cursor-not-allowed');
                }
            });

            updateLongDropdownLabels(false);
        }

        function updateLongDropdownLabels(isAutoSelected) {
            const labels = [
                document.getElementById('long-affiliation-label'),
            ];

            labels.forEach(label => {
                if (label) {
                    const autoLabel = document.getElementById('auto-selected-label');

                    if (isAutoSelected) {
                        label.textContent = 'ตัวแทนที่เกษตรกรสังกัด *';
                        if (autoLabel) autoLabel.classList.remove('hidden');
                    } else {
                        label.textContent = 'กรุณาเลือกตัวแทน';
                        if (autoLabel) autoLabel.classList.add('hidden');
                    }
                }
            });
        }

        // =============================================
        // INITIALIZATION
        // =============================================
        function initializeFertilizerCheckboxes() {
            const items = document.querySelectorAll('.fertilizer-usage-item');
            if (!items || items.length === 0) return;

            items.forEach(item => {

                const checkboxes = item.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    // clear inline onchange to avoid duplicate handling and then add our handler
                    try { checkbox.onchange = null; } catch (e) { }
                    if (checkbox.value && checkbox.value.trim() === 'อื่นๆ') {
                        checkbox.removeEventListener('change', handleOtherCheckboxChange);
                        checkbox.addEventListener('change', handleOtherCheckboxChange);
                    }
                });
            });
        }

        // =============================================
        // EXTERNAL LINK FUNCTIONS
        // =============================================
        function openSurveyForm() {
            const surveyUrl = "https://script.google.com/macros/s/AKfycbwIy3D5nPqvIyVbOAjzEop3gIy2y5IXS4r1BhkmgAYEwDNZqLqGesA_2lBbQvjWzw/exec";

            const newWindow = window.open(surveyUrl, '_blank');

            if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                showMessageBox(
                    "📋 เปิดฟอร์มสำรวจข้อมูลแปลงกระท่อม",
                    "กรุณาคลิกลิงก์ด้านล่างนี้:<br><br>" +
                    "<a href='" + surveyUrl + "' target='_blank' style='color: #16a34a; text-decoration: underline; font-weight: 600;'>" +
                    "🔗 เปิดฟอร์มสำรวจข้อมูลแปลงกระท่อม" +
                    "</a><br><br>" +
                    "<small>หรือคัดลอกลิงก์: " + surveyUrl + "</small>"
                );
            } else {
                showMessageBox(
                    "📋 เปิดฟอร์มสำรวจข้อมูลแปลงกระท่อม",
                    "✅ เปิดฟอร์มสำรวจในแท็บใหม่แล้ว"
                );
            }
        }

        function openLeafSampleForm() {
            const leafSampleUrl = "https://script.google.com/macros/s/AKfycbzYZ0ZPXzjGLujcCto9GwJmDXEhQvSTelAYKt6Z_2Q9FhSCqWVw8DHVhjd2zr25N_dp/exec";

            const newWindow = window.open(leafSampleUrl, '_blank');

            if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                showMessageBox(
                    "🌿 ระบบจัดส่งตัวอย่างใบกระท่อม",
                    "กรุณาคลิกลิงก์ด้านล่างนี้:<br><br>" +
                    "<a href='" + leafSampleUrl + "' target='_blank' style='color: #16a34a; text-decoration: underline; font-weight: 600;'>" +
                    "🔗 เปิดระบบจัดส่งตัวอย่างใบกระท่อม" +
                    "</a><br><br>" +
                    "<small>หรือคัดลอกลิงก์: " + leafSampleUrl + "</small>"
                );
            } else {
                showMessageBox(
                    "🌿 ระบบจัดส่งตัวอย่างใบกระท่อม",
                    "✅ เปิดระบบจัดส่งตัวอย่างใบในแท็บใหม่แล้ว"
                );
            }
        }

        // =============================================
        // ฟังก์ชันสำหรับฟอร์มสำรวจข้อมูลแปลงกระท่อม
        // =============================================

        /* ===== รายชื่อสายพันธุ์ ===== */
        const varieties = [
            'ชุมพช', 'ปทุมธานี', 'สุราษฎร์ธานี', 'หางกั้ง', 'เหรียญทอง',
            'ใบโพธิ์', 'แตงกวา', 'หลังตะพาบ', 'ยอดธง', 'เจ้าพระเยา',
            'สองเล', 'บูรพา', 'ล้านนา', 'นาคา'
        ];

        const stemLabels = {
            red: 'ก้านแดง',
            white: 'ก้านขาว',
            green: 'ก้านเขียว'
        };

        // lazy getter for stem container to avoid null before DOM ready
        function getStemContainer() {
            return document.getElementById('stem-sections');
        }

        function renderStemSection(stem) {
            if (!stem || !stemLabels[stem]) return;
            const stemContainer = getStemContainer();
            if (!stemContainer) return;
            if (document.getElementById(`section-${stem}`)) return;

            let html = `
                <div class="mt-4" id="section-${stem}" style="margin-top: 1rem;">
                    <h5 class="fw-bold" style="font-weight: 700; margin-bottom: 1rem; color: #292524;">${stemLabels[stem]} : ระบุชื่อสายพันธุ์และจำนวนต้น</h5>
                    <div class="row g-3" style="display: grid; grid-template-columns: repeat(12, 1fr); gap: 0.75rem;">
            `;

            varieties.forEach(v => {
                // create a safe id for checkbox + label
                const safeVar = v.replace(/["'\[\]\s]/g, '_').toLowerCase();
                const checkboxId = `${stem}_${safeVar}_${Math.random().toString(36).substr(2, 5)}`;

                html += `
                    <div class="col-md-6" style="grid-column: span 6;">
                        <div class="input-group" style="display: flex; align-items: center;">
                            <div class="input-group-text d-flex align-items-center gap-2" style="padding: 0.5rem; background-color: #f9fafb; border: 1px solid #d1d5db; border-radius: 0.375rem 0 0 0.375rem; display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="${checkboxId}" class="variety-cb form-check-input" style="margin-right: 0.25rem;" aria-label="เลือกสายพันธุ์ ${esc(v)}" />
                                <label for="${checkboxId}" class="mb-0" style="margin-bottom: 0; cursor: pointer;">${esc(v)}</label>
                            </div>
                            <input type="number"
                                   class="form-control variety-count"
                                   name="${stem}_count[${safeVar}]"
                                   placeholder="จำนวนต้น"
                                   disabled
                                   style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0 0.375rem 0.375rem 0; border-left: none;">
                        </div>
                    </div>
                `;
            });

            html += `</div></div>`;
            stemContainer.insertAdjacentHTML('beforeend', html);
        }

        /* ===== คำนวณผลรวม ===== */
        function calculateTotal() {
            let total = 0;
            document.querySelectorAll('.variety-count').forEach(i => {
                if (!i.disabled && i.value) total += Number(i.value);
            });
            const totalEl = document.getElementById('total_tree_count');
            if (totalEl) totalEl.value = total;
        }

        // =============================================
        // ฟังก์ชันช่วยสำหรับฟอร์มสำรวจ
        // =============================================

        // Toggle agent input (show agent-name when 'have' is selected)
        function toggleAgentInput() {
            const agentNameInput = document.getElementById('agent-name');
            const have = document.getElementById('agent-have');
            if (!agentNameInput) return;
            if (have && have.checked) {
                agentNameInput.classList.remove('hidden');
                agentNameInput.required = true;
            } else {
                agentNameInput.classList.add('hidden');
                agentNameInput.required = false;
                agentNameInput.value = '';
            }
        }

        // Toggle date-range visibility for gap/gacp
        function toggleDateRange(type, show) {
            const el = document.getElementById(`${type}-date-range`);
            if (!el) return;
            if (show) {
                el.classList.remove('hidden');
                // Set required for date inputs when visible
                const startDate = el.querySelector(`#${type}_start_date`);
                const endDate = el.querySelector(`#${type}_end_date`);
                if (startDate) startDate.required = true;
                if (endDate) endDate.required = true;
            } else {
                el.classList.add('hidden');
                // Remove required and clear values when hidden
                const startDate = el.querySelector(`#${type}_start_date`);
                const endDate = el.querySelector(`#${type}_end_date`);
                if (startDate) {
                    startDate.required = false;
                    startDate.value = '';
                }
                if (endDate) {
                    endDate.required = false;
                    endDate.value = '';
                }
            }
        }

        // Toggle visibility of "other" text inputs when 'other' checkboxes are toggled
        function setupOtherToggles() {
            const otherCheckboxes = document.querySelectorAll('input[type="checkbox"][data-other-target]');
            otherCheckboxes.forEach(cb => {
                const targetId = cb.getAttribute('data-other-target');

                // Remove existing listeners to prevent duplicates
                cb.removeEventListener('change', handleOtherCheckboxToggle);

                // Add new listener
                cb.addEventListener('change', function () {
                    handleOtherCheckboxToggle(this, targetId);
                });

                // Initialize based on current state
                const targetElem = document.getElementById(targetId);
                if (targetElem) {
                    if (cb.checked) {
                        targetElem.classList.remove('hidden');
                        targetElem.required = true;
                    } else {
                        targetElem.classList.add('hidden');
                        targetElem.required = false;
                    }
                }
            });
        }

        function handleOtherCheckboxToggle(checkbox, targetId) {
            const target = document.getElementById(targetId);
            if (!target) return;

            if (checkbox.checked) {
                target.classList.remove('hidden');
                target.required = true;
            } else {
                target.classList.add('hidden');
                target.required = false;
                target.value = '';
            }
        }

        // Helper escape for HTML
        const esc = (str) => String(str ?? '').replace(/[&<>"']/g, function (m) {
            return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m];
        });

        // Helpers for preview values display
        const val = (value, minSpace = 8) => {
            const v = esc(value);
            const space = '&nbsp;'.repeat(minSpace);
            return `<span style="font-weight: 600; color: #388E3C; text-decoration: underline; white-space: nowrap;">${v || space}</span>`;
        };
        const chk = (bool) => bool ? '<span style="color: #4CAF50; font-weight: 700;">✅ มี</span>' : '<span style="color: #D32F2F;">❌ ไม่มี</span>';
        const count_val = (value) => `<span style="font-weight: 600; color: #388E3C;">${esc(value) || '-'}</span>`;

        // Date part helper
        function getDateParts(dateStr) {
            if (!dateStr) return { day: '', month: '', year: '' };
            const parts = dateStr.split('/').map(p => p.trim());
            return {
                day: parts[0] || '',
                month: parts[1] || '',
                year: parts[2] || ''
            };
        }

        // month utilities
        const MONTH_NAMES = {
            '1': 'มกราคม', '2': 'กุมภาพันธ์', '3': 'มีนาคม', '4': 'เมษายน', '5': 'พฤษภาคม', '6': 'มิถุนายน',
            '7': 'กรกฎาคม', '8': 'สิงหาคม', '9': 'กันยายน', '10': 'ตุลาคม', '11': 'พฤศจิกายน', '12': 'ธันวาคม'
        };

        function monthName(n) { return MONTH_NAMES[String(n)] || ''; }

        function monthCount(start, end) {
            const s = parseInt(start, 10), e = parseInt(end, 10);
            if (!s || !e) return '';
            if (s === e) return 1;
            if (s < e) return e - s + 1;
            // wrap-around
            return (12 - s + 1) + e;
        }

        // Robust helper: get checkbox/boolean by id or name
        function getBooleanByIdOrName(nameOrId) {
            const byId = document.getElementById(nameOrId);
            if (byId) return !!byId.checked;
            // by name (could be RadioNodeList)
            const elems = document.forms['kratomForm']?.elements[nameOrId];
            if (!elems) return false;
            if (elems.length !== undefined) {
                for (let el of elems) {
                    if (el.checked) return true;
                }
                return false;
            }
            return !!elems.checked;
        }

        // Get all checked values for inputs with given name
        function getCheckedValuesByName(name) {
            const form = document.getElementById('kratomForm');
            if (!form) return [];
            // support names like 'water_system[]' or 'water_system'
            const values = [];
            // try exact name first
            const elems1 = form.querySelectorAll(`[name="${name}"]`);
            if (elems1 && elems1.length > 0) {
                elems1.forEach(el => { if (el.checked) values.push(el.value); });
                return values;
            }
            // fallback if name ends with []
            if (name.endsWith('[]')) {
                const alt = name.slice(0, -2);
                const elems2 = form.querySelectorAll(`[name="${alt}"]`);
                elems2.forEach(el => { if (el.checked) values.push(el.value); });
            } else {
                // also try adding [] if not provided
                const alt2 = `${name}[]`;
                const elems3 = form.querySelectorAll(`[name="${alt2}"]`);
                elems3.forEach(el => { if (el.checked) values.push(el.value); });
            }
            return values;
        }

        // =============================================
        // Event handling สำหรับฟอร์มสำรวจ
        // =============================================

        // Event handling for species and variety fields
        document.addEventListener('change', e => {
            // ===== stem checkbox toggles (render/remove sections) =====
            if (e.target.classList && e.target.classList.contains('stem-cb')) {
                const stem = e.target.value;
                if (['red', 'white', 'green'].includes(stem)) {
                    if (e.target.checked) renderStemSection(stem);
                    else {
                        const sec = document.getElementById(`section-${stem}`);
                        if (sec) sec.remove();
                        calculateTotal();
                    }
                }

                // show/hide special-name (cross species) when cross checkbox toggled
                if (stem === 'cross') {
                    const special = document.getElementById('special-name');
                    if (special) special.classList.toggle('hidden', !e.target.checked);
                }

                // when 'other' stem checkbox toggled, setupOtherToggles handles showing the textarea via data-other-target
            }

            // ===== variety checkbox toggles enable/disable associated count input =====
            if (e.target.classList && e.target.classList.contains('variety-cb')) {
                const input = e.target.closest('.input-group').querySelector('.variety-count');
                if (e.target.checked) {
                    input.disabled = false;
                    input.required = true;
                } else {
                    input.disabled = true;
                    input.required = false;
                    input.value = '';
                }
                calculateTotal();
            }
        });

        /* ===== listen for input changes on counts to update total ===== */
        document.addEventListener('input', e => {
            if (e.target.classList && e.target.classList.contains('variety-count')) {
                calculateTotal();
            }
        });

        // =============================================
        // ฟังก์ชันหลักสำหรับฟอร์มสำรวจ
        // =============================================

        // Initialize mock google.script.run only when necessary (do not overwrite existing google)
        function initializeMockGoogleScript() {
            if (typeof google === 'undefined') {
                console.warn("google.script.run is not defined. Using a mock for testing.");
                window.google = {
                    script: {
                        run: (function () {
                            return {
                                withSuccessHandler: function (successCb) {
                                    return {
                                        withFailureHandler: function (failureCb) {
                                            return {
                                                submitForm: function (data) {
                                                    console.log("Mock submitForm data:", data);
                                                    setTimeout(() => successCb("Mock submission successful!"), 800);
                                                },
                                                // Generic passthrough to success for testing other calls
                                                userLogin: function (u, p) { setTimeout(() => successCb({ success: true, token: btoa(JSON.stringify({ timestamp: Date.now() })) + '.x', longName: 'MockLong', username: u }), 300); }
                                            };
                                        }
                                    };
                                }
                            };
                        })()
                    }
                };
            } else if (typeof google.script === 'undefined') {
                google.script = {
                    run: (function () {
                        return {
                            withSuccessHandler: function (successCb) {
                                return {
                                    withFailureHandler: function (failureCb) {
                                        return {
                                            submitForm: function (data) {
                                                console.log("Mock submitForm data:", data);
                                                setTimeout(() => successCb("Mock submission successful!"), 800);
                                            }
                                        };
                                    }
                                };
                            }
                        };
                    })()
                };
            } else if (typeof google.script.run === 'undefined') {
                google.script.run = (function () {
                    return {
                        withSuccessHandler: function (successCb) {
                            return {
                                withFailureHandler: function (failureCb) {
                                    return {
                                        submitForm: function (data) {
                                            console.log("Mock submitForm data:", data);
                                            setTimeout(() => successCb("Mock submission successful!"), 800);
                                        }
                                    };
                                }
                            };
                        }
                    };
                })();
            }
        }

        let formDataObj = {};

        document.addEventListener('DOMContentLoaded', () => {
            // เรียกใช้ฟังก์ชันเริ่มต้นสำหรับฟอร์มสำรวจ
            setupOtherToggles();
            toggleAgentInput();

            // Initialize GAP/GACP date ranges based on pre-selected radios (if any)
            const gapChecked = document.querySelector('input[name="gap_status"]:checked');
            toggleDateRange('gap', gapChecked && gapChecked.value === 'yes');

            const gacpChecked = document.querySelector('input[name="gacp_status"]:checked');
            toggleDateRange('gacp', gacpChecked && gacpChecked.value === 'yes');

            // Substance checkboxes logic (exclusive + conditional input)
            const substanceCheckboxes = document.querySelectorAll('.substance-cb');
            const substanceValueBox = document.getElementById('substanceValueBox');
            if (substanceCheckboxes && substanceCheckboxes.length) {
                substanceCheckboxes.forEach(cb => {
                    cb.addEventListener('change', function () {
                        // make them exclusive (only one)
                        substanceCheckboxes.forEach(other => {
                            if (other !== this) other.checked = false;
                        });

                        // show/hide input
                        if (this.id === 'substance_checked' && this.checked) {
                            if (substanceValueBox) substanceValueBox.classList.remove('hidden');
                        } else {
                            if (substanceValueBox) substanceValueBox.classList.add('hidden');
                            const valInput = document.getElementById('substance_value');
                            if (valInput) valInput.value = '';
                        }
                    });
                });

                // initialize visibility
                const anyChecked = Array.from(substanceCheckboxes).some(cb => cb.checked);
                if (!anyChecked && substanceValueBox) substanceValueBox.classList.add('hidden');
                else {
                    const checked = document.getElementById('substance_checked');
                    if (checked && checked.checked && substanceValueBox) substanceValueBox.classList.remove('hidden');
                }
            }

            // Initialize mock google.script.run for testing (only if needed)
            initializeMockGoogleScript();

            // Event listeners สำหรับปุ่มในฟอร์มสำรวจ
            const nextBtn = document.getElementById('nextBtn');
            const backBtn = document.getElementById('backBtn');
            const submitBtn = document.getElementById('submitBtn');
            const formStep = document.getElementById('formStep');
            const previewStep = document.getElementById('previewStep');
            const previewCard = document.getElementById('previewCard');

            // Ensure initial visibility is consistent (handle possible inline styles)
            if (formStep) {
                formStep.classList.remove('hidden');
                formStep.style.display = ''; // normal display
            }
            if (previewStep) {
                previewStep.classList.add('hidden');
                previewStep.style.display = 'none'; // hide explicitly
            }

            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    const form = document.getElementById('kratomForm');
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return;
                    }

                    const water_system_values = getCheckedValuesByName('water_system[]');
                    const fertilizer_values = getCheckedValuesByName('fertilizer_method[]');
                    const past_land_values = getCheckedValuesByName('past_land_types[]');
                    const agentRadio = form.querySelector('input[name="farmer_agent"]:checked');
                    const farmer_agent = agentRadio ? agentRadio.value : '';

                    // GAP/GACP/contract values
                    const gapRadio = form.querySelector('input[name="gap_status"]:checked');
                    const gap_status = gapRadio ? gapRadio.value : '';
                    const gap_start_date = document.getElementById('gap_start_date')?.value || '';
                    const gap_end_date = document.getElementById('gap_end_date')?.value || '';

                    const gacpRadio = form.querySelector('input[name="gacp_status"]:checked');
                    const gacp_status = gacpRadio ? gacpRadio.value : '';
                    const gacp_start_date = document.getElementById('gacp_start_date')?.value || '';
                    const gacp_end_date = document.getElementById('gacp_end_date')?.value || '';

                    const contractRadio = form.querySelector('input[name="contract_status"]:checked');
                    const contract_status = contractRadio ? contractRadio.value : '';

                    // Collect species data dynamically
                    const speciesData = {};
                    ['red', 'white', 'green'].forEach(stem => {
                        speciesData[stem] = {};
                        const sec = document.getElementById(`section-${stem}`);
                        if (!sec) return;
                        const rows = sec.querySelectorAll('.input-group');
                        rows.forEach(row => {
                            const cb = row.querySelector('.variety-cb');
                            const lbl = row.querySelector('.input-group-text label')?.textContent?.trim() || '';
                            const countInput = row.querySelector('.variety-count');
                            const count = (countInput && !countInput.disabled && countInput.value) ? Number(countInput.value) : 0;
                            if (cb && cb.checked && lbl) {
                                speciesData[stem][lbl] = count;
                            }
                        });
                    });
                    // read cross (special) and other varieties from current form
                    const specialSpeciesName = document.getElementById('special_species_name')?.value || '';
                    const otherVarietiesText = document.getElementById('other_varieties')?.value || '';
                    // total from calculated field
                    const total_tree_count_specified = Number(document.getElementById('total_tree_count')?.value || 0);

                    // Substance status
                    const substance_checked = document.getElementById('substance_checked')?.checked ? 'checked' :
                        document.getElementById('substance_not_checked')?.checked ? 'not_checked' : '';

                    // Combine water/ fertilizer "other" values only in their own fields; do not conflate with hormone_etc
                    const waterSystemDisplay = [
                        ...(water_system_values || []),
                        ...(document.getElementById('water_other_text')?.value ? [`อื่นๆ: ${document.getElementById('water_other_text').value}`] : [])
                    ].filter(Boolean).join(', ');

                    const fertilizerDisplay = [
                        ...(fertilizer_values || []),
                        ...(document.getElementById('fert_other_text')?.value ? [`อื่นๆ: ${document.getElementById('fert_other_text').value}`] : [])
                    ].filter(Boolean).join(', ');

                    // read combined hormone_and_other and volcanic checkbox
                    const hormoneAndOther = document.getElementById('hormone_and_other')?.value || '';
                    const volcanicChecked = document.getElementById('mineral_volcanic')?.checked || false;
                    const firstname = (form.elements['farmer_firstname']?.value || '').trim();
                    const lastname = (form.elements['farmer_lastname']?.value || '').trim();
                    const fallbackFullName = (form.elements['farmer_name_main']?.value || '').trim();
                    const fullName = (firstname || lastname) ? `${firstname} ${lastname}`.trim() : fallbackFullName;

                    formDataObj = {
                        farmer_agent,
                        agent_name: form.elements['agent_name']?.value || '',
                        farmer_firstname: firstname,
                        farmer_lastname: lastname,
                        farmer_name_main: form.elements['farmer_name_main']?.value || '',
                        coord_x: form.elements['coord_x']?.value || '',
                        coord_y: form.elements['coord_y']?.value || '',
                        subdistrict: form.elements['subdistrict']?.value || '',
                        district: form.elements['district']?.value || '',
                        province: form.elements['province']?.value || '',
                        land_evidence: form.elements['land_evidence']?.value || '',
                        tel: form.elements['tel']?.value || '',
                        tree_count: form.elements['tree_count']?.value || '',
                        plant_date: form.elements['plant_date']?.value || '',
                        ready_to_sell_count: form.elements['ready_to_sell_count']?.value || '',
                        water_system_values,
                        water_other_text: document.getElementById('water_other_text')?.value || '',
                        water_system_display: waterSystemDisplay, // เพิ่มฟิลด์นี้
                        water_ph: form.elements['water_ph']?.value || '',
                        fertilizer_values,
                        fert_other_text: document.getElementById('fert_other_text')?.value || '',
                        fertilizer_display: fertilizerDisplay, // เพิ่มฟิลด์นี้
                        soil_ph: form.elements['soil_ph']?.value || '',
                        hormone_and_other: hormoneAndOther, // combined field
                        mineral_volcanic: volcanicChecked ? 'แร่ภูเขาไฟ' : '',
                        substance_value: form.elements['substance_value']?.value || '',
                        substance_status: substance_checked,
                        dry_start_month: form.elements['dry_start_month']?.value || '',
                        dry_end_month: form.elements['dry_end_month']?.value || '',
                        rainy_start_month: form.elements['rainy_start_month']?.value || '',
                        rainy_end_month: form.elements['rainy_end_month']?.value || '',
                        winter_start_month: form.elements['winter_start_month']?.value || '',
                        winter_end_month: form.elements['winter_end_month']?.value || '',
                        gap_status,
                        gap_start_date,
                        gap_end_date,
                        gacp_status,
                        gacp_start_date,
                        gacp_end_date,
                        contract_status,
                        species: speciesData,
                        special_species_name: specialSpeciesName,
                        other_varieties: otherVarietiesText,
                        total_tree_count_specified,
                        past_land_values,
                        past_other_text: document.getElementById('past_other_text')?.value || '',
                        coordinator_name: form.elements['coordinator_name']?.value || '',
                        coordinator_tel: form.elements['coordinator_tel']?.value || ''
                    };

                    // Prepare season display strings and counts
                    const data = formDataObj;
                    const rainyRange = (data.rainy_start_month || data.rainy_end_month) ? `${monthName(data.rainy_start_month) || '-'} — ${monthName(data.rainy_end_month) || '-'}` : '-';
                    const rainyCount = (data.rainy_start_month && data.rainy_end_month) ? `${monthCount(data.rainy_start_month, data.rainy_end_month)} เดือน` : '-';
                    const dryRange = (data.dry_start_month || data.dry_end_month) ? `${monthName(data.dry_start_month) || '-'} — ${monthName(data.dry_end_month) || '-'}` : '-';
                    const dryCount = (data.dry_start_month && data.dry_end_month) ? `${monthCount(data.dry_start_month, data.dry_end_month)} เดือน` : '-';
                    const winterRange = (data.winter_start_month || data.winter_end_month) ? `${monthName(data.winter_start_month) || '-'} — ${monthName(data.winter_end_month) || '-'}` : '-';
                    const winterCount = (data.winter_start_month && data.winter_end_month) ? `${monthCount(data.winter_start_month, data.winter_end_month)} เดือน` : '-';

                    const dateParts = getDateParts(data.plant_date);

                    // Summarize species for preview (compact)
                    const speciesSummary = [];
                    Object.keys(data.species).forEach(stem => {
                        const entries = data.species[stem];
                        Object.keys(entries || {}).forEach(v => {
                            speciesSummary.push(`${v} (${stemLabels[stem] || stem}): ${entries[v]}`);
                        });
                    });
                    // Add other and cross separately (do not conflate)
                    if (data.other_varieties) {
                        // split by comma for display items
                        const others = data.other_varieties.split(',').map(s => s.trim()).filter(Boolean);
                        others.forEach(o => speciesSummary.push(`อื่นๆ: ${o}`));
                    }
                    if (data.special_species_name) speciesSummary.push(`ข้ามสายพันธุ์: ${data.special_species_name}`);

                    // ------------------------
                    // PREVIEW HTML VERSION 2.1 - separate hormone and other; separate other & cross species
                    // ------------------------

                    // แปลงวันที่ GAP/GACP เป็นรูปแบบไทย DD/MM/YYYY สำหรับ preview
                    const gapStartDisplay = formatDateForDisplay(data.gap_start_date || '');
                    const gapEndDisplay = formatDateForDisplay(data.gap_end_date || '');
                    const gacpStartDisplay = formatDateForDisplay(data.gacp_start_date || '');
                    const gacpEndDisplay = formatDateForDisplay(data.gacp_end_date || '');

                    let previewHtml = `
<style>
  .preview-container {
    font-family: 'Inter', 'Sarabun', 'Noto Sans Thai', sans-serif;
    line-height: 1.45;
    color: #212121;
    max-width: 1200px;
    margin: 0 auto;
    padding: 12px;
  }

  /* Section Header */
  .section-header {
    background: linear-gradient(135deg, #1b5e20 0%, #388E3C 100%);
    color: white;
    padding: 12px 16px;
    border-radius: 8px 8px 0 0;
    margin-bottom: 0;
    font-weight: 700;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .section-header i {
    font-size: 1.2rem;
  }

  /* Lock Cards */
  .lock-card {
    background: white;
    border: 2px solid #E8F5E9;
    border-radius: 8px;
    margin-bottom: 20px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }

  .lock-content {
    padding: 16px;
  }

  /* Grid Layout for Lock Cards */
  .lock-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 16px;
    margin-bottom: 20px;
  }

  .lock-row {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    padding: 6px 0;
    border-bottom: 1px dashed #E0E0E0;
  }

  .lock-row:last-child {
    border-bottom: none;
    margin-bottom: 0;
  }

  .lock-label {
    font-weight: 600;
    color: #1b5e20;
    min-width: 140px;
    font-size: 0.9rem;
  }

  .lock-value {
    color: #212121;
    word-break: break-word;
    flex: 1;
    font-size: 0.9rem;
  }

  .lock-value.mono {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
  }

  /* Full Width Lock Card */
  .full-width-lock {
    grid-column: 1 / -1;
  }

  /* Summary Table */
  .summary-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
    margin: 16px 0;
  }

  .summary-table th {
    background: #F1F8E9;
    color: #1b5e20;
    font-weight: 700;
    padding: 10px;
    text-align: left;
    border: 1px solid #C8E6C9;
  }

  .summary-table td {
    padding: 10px;
    border: 1px solid #E0E0E0;
    vertical-align: top;
  }

  .summary-table tr:nth-child(even) {
    background: #F9F9F9;
  }

  /* Status Badges */
  .status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-align: center;
  }

  .status-success {
    background: #E8F5E9;
    color: #2E7D32;
  }

  .status-warning {
    background: #FFF3E0;
    color: #F57C00;
  }

  .status-danger {
    background: #FFEBEE;
    color: #C62828;
  }

  /* Species Grid */
  .species-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
    margin-top: 8px;
  }

  .species-item {
    background: #F9F9F9;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.85rem;
  }

  .species-label {
    font-weight: 600;
    color: #555;
  }

  .species-count {
    font-weight: 700;
    color: #1b5e20;
  }

  /* Signature Section */
  .signature-section {
    background: #F8F9FA;
    border-radius: 8px;
    padding: 20px;
    margin-top: 24px;
    border: 1px solid #E0E0E0;
  }

  .signature-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
    margin-top: 12px;
  }

  .signature-item {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .signature-label {
    font-weight: 600;
    color: #1b5e20;
    min-width: 120px;
  }

  .signature-value {
    flex: 1;
    padding: 6px 12px;
    background: white;
    border: 1px solid #E0E0E0;
    border-radius: 4px;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .preview-container {
      padding: 8px;
    }

    .lock-grid {
      grid-template-columns: 1fr;
    }

    .lock-row {
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
    }

    .lock-label {
      min-width: auto;
      font-size: 0.85rem;
    }

    .summary-table {
      font-size: 0.8rem;
    }

    .summary-table th,
    .summary-table td {
      padding: 6px 8px;
    }

    .species-grid {
      grid-template-columns: 1fr;
    }

    .signature-grid {
      grid-template-columns: 1fr;
    }
  }

  @media (min-width: 1024px) {
    .lock-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>

<div class="preview-container">
  <!-- ===================== LOCK 1: ข้อมูลเกษตรกรหลัก ===================== -->
  <div class="lock-card">
    <div class="section-header">
      <i class="bi bi-person-badge"></i> ข้อมูลเกษตรกรหลัก
    </div>
    <div class="lock-content">
      <div class="lock-grid">
        <!-- ล็อคซ้าย -->
        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">ชื่อเกษตรกร:</span>
            <span class="lock-value">${val(data.farmer_name_main)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">เบอร์โทรศัพท์:</span>
            <span class="lock-value mono">${val(data.tel || '-', 10)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">สถานะตัวแทน:</span>
            <span class="lock-value">${val(data.farmer_agent === 'have' ? 'มีตัวแทน' : data.farmer_agent === 'none' ? 'ยังไม่มีตัวแทน' : '-', 6)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">ชื่อตัวแทน:</span>
            <span class="lock-value">${val(data.agent_name || '-', 8)}</span>
          </div>
        </div>

        <!-- ล็อคขวา -->
        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">พิกัด X:</span>
            <span class="lock-value mono">${val(data.coord_x, 4)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">พิกัด Y:</span>
            <span class="lock-value mono">${val(data.coord_y, 4)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">ตำบล / อำเภอ / จังหวัด:</span>
            <span class="lock-value">${val(data.subdistrict, 4)} / ${val(data.district, 4)} / ${val(data.province, 4)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">หลักฐานที่ดิน:</span>
            <span class="lock-value">${val(data.land_evidence || '-', 6)}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== LOCK 2: ข้อมูลแปลงและพันธุ์ไม้ ===================== -->
  <div class="lock-card">
    <div class="section-header">
      <i class="bi bi-tree"></i> ข้อมูลแปลงและพันธุ์ไม้
    </div>
    <div class="lock-content">
      <div class="lock-grid">
        <!-- ล็อคซ้าย -->
        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">จำนวนต้นทั้งหมด:</span>
            <span class="lock-value">${val(data.tree_count || '-', 6)} ต้น</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">วันที่ปลูกต้นกล้า:</span>
            <span class="lock-value">${val(data.plant_date || '-', 10)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">จำนวนต้นพร้อมขาย:</span>
            <span class="lock-value">${val(data.ready_to_sell_count || '-', 6)} ต้น</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">ประวัติพื้นที่ 3 ปี:</span>
            <span class="lock-value">${val((Array.isArray(data.past_land_values) && data.past_land_values.length) ? data.past_land_values.join(', ') : (data.past_other_text || '-'), 12)}</span>
          </div>
        </div>

        <!-- ล็อคขวา -->
        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">PH น้ำ:</span>
            <span class="lock-value">${val(data.water_ph || '-', 4)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">PH ดิน:</span>
            <span class="lock-value">${val(data.soil_ph || '-', 4)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">จำนวนรวมจากสายพันธุ์:</span>
            <span class="lock-value">${val(data.total_tree_count_specified ? String(data.total_tree_count_specified) : '-', 6)} ต้น</span>
          </div>
        </div>
      </div>

      <!-- ตารางสรุปสายพันธุ์ (แยก Other / Cross) -->
      <table class="summary-table">
        <thead>
          <tr>
            <th>ก้านแดง</th>
            <th>ก้านขาว</th>
            <th>ก้านเขียว</th>
            <th>อื่นๆ (ชื่อ)</th>
            <th>ข้ามสายพันธุ์ (ชื่อ)</th>
            <th>รวมทั้งหมด</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>${count_val(Object.values(data.species?.red || {}).reduce((a, b) => a + (Number(b) || 0), 0) || '0')}</td>
            <td>${count_val(Object.values(data.species?.white || {}).reduce((a, b) => a + (Number(b) || 0), 0) || '0')}</td>
            <td>${count_val(Object.values(data.species?.green || {}).reduce((a, b) => a + (Number(b) || 0), 0) || '0')}</td>
            <td>${val(data.other_varieties || '-', 6)}</td>
            <td>${val(data.special_species_name || '-', 6)}</td>
            <td class="status-success">${count_val(data.total_tree_count_specified || '0')}</td>
          </tr>
        </tbody>
      </table>

      <!-- รายละเอียดสายพันธุ์ (ถ้ามี) -->
      ${speciesSummary.length > 0 ? `
      <div style="margin-top: 12px;">
        <div style="font-weight: 600; color: #1b5e20; margin-bottom: 8px;">รายละเอียดสายพันธุ์:</div>
        <div class="species-grid">
          ${speciesSummary.map(item => `
            <div class="species-item">
              <div class="species-label">${esc(item.split(':')[0] || '')}</div>
              <div class="species-count">${esc((item.split(':')[1] || '').trim())}</div>
            </div>
          `).join('')}
        </div>
      </div>
      ` : ''}
    </div>
  </div>

  <!-- ===================== LOCK 3: การบริหารจัดการแปลง ===================== -->
  <div class="lock-card">
    <div class="section-header">
      <i class="bi bi-tools"></i> การบริหารจัดการแปลง
    </div>
    <div class="lock-content">
      <div class="lock-grid">
        <!-- ล็อคซ้าย -->
        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">ระบบให้น้ำ:</span>
            <span class="lock-value">${val(data.water_system_display || '-', 6)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">ระบให้ปุ๋ย:</span>
            <span class="lock-value">${val(data.fertilizer_display || '-', 6)}</span>
          </div>
        </div>
      </div>

      <!-- แถวแยกสำหรับ ฮอร์โมน/อื่นๆ และ แร่ภูเขาไฟ -->
      <div style="margin-top: 12px;">
        <div class="lock-row">
          <span class="lock-label">ฮอร์โมน / อื่นๆ:</span>
          <span class="lock-value">${val(data.hormone_and_other || '-', 8)}</span>
        </div>
        <div class="lock-row">
          <span class="lock-label">แร่ภูเขาไฟ (ถ้ามี):</span>
          <span class="lock-value">${data.mineral_volcanic ? val(data.mineral_volcanic) : '-'}</span>
        </div>
      </div>

      <!-- ตารางฤดูกาล -->
      <table class="summary-table" style="margin-top:12px;">
        <thead>
          <tr>
            <th>ฤดูกาล</th>
            <th>ช่วงเวลา</th>
            <th>จำนวนเดือน</th>
            <th>สถานะ</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>ฤดูแล้ง</td>
            <td>${val(dryRange, 6)}</td>
            <td>${val(dryCount, 4)}</td>
            <td>${dryRange !== '-' ? '<span class="status-success">✅ มีข้อมูล</span>' : '<span class="status-warning">⚠️ ไม่ระบุ</span>'}</td>
          </tr>
          <tr>
            <td>ฤดูฝน</td>
            <td>${val(rainyRange, 6)}</td>
            <td>${val(rainyCount, 4)}</td>
            <td>${rainyRange !== '-' ? '<span class="status-success">✅ มีข้อมูล</span>' : '<span class="status-warning">⚠️ ไม่ระบุ</span>'}</td>
          </tr>
          <tr>
            <td>ฤดูหนาว</td>
            <td>${val(winterRange, 6)}</td>
            <td>${val(winterCount, 4)}</td>
            <td>${winterRange !== '-' ? '<span class="status-success">✅ มีข้อมูล</span>' : '<span class="status-warning">⚠️ ไม่ระบุ</span>'}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ===================== LOCK 4: มาตรฐานและสัญญา ===================== -->
  <div class="lock-card">
    <div class="section-header">
      <i class="bi bi-file-earmark-check"></i> มาตรฐานและสัญญา
    </div>
    <div class="lock-content">
      <div class="lock-grid">
        <!-- ล็อคซ้าย -->
        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">GAP สมุนไพร:</span>
            <span class="lock-value">
              ${data.gap_status === 'yes' ?
                            '<span class="status-success">✅ มี (' + val(gapStartDisplay || '-', 6) + ' — ' + val(gapEndDisplay || '-', 6) + ')</span>' :
                            data.gap_status === 'no' ?
                                '<span class="status-warning">❌ ไม่มี</span>' :
                                '<span class="status-danger">- ไม่ระบุ -</span>'}
            </span>
          </div>
          <div class="lock-row">
            <span class="lock-label">GACP สมุนไพร:</span>
            <span class="lock-value">
              ${data.gacp_status === 'yes' ?
                            '<span class="status-success">✅ มี (' + val(gacpStartDisplay || '-', 6) + ' — ' + val(gacpEndDisplay || '-', 6) + ')</span>' :
                            data.gacp_status === 'no' ?
                                '<span class="status-warning">❌ ไม่มี</span>' :
                                '<span class="status-danger">- ไม่ระบุ -</span>'}
            </span>
          </div>
        </div>

        <!-- ล็อคขวา -->
        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">คู่สัญญา:</span>
            <span class="lock-value">
              ${data.contract_status === 'old' ?
                            '<span class="status-warning">⚠️ ติดสัญญาเก่า</span>' :
                            data.contract_status === 'none' ?
                                '<span class="status-success">✅ ไม่ติดสัญญาเก่า</span>' :
                                '<span class="status-danger">- ไม่ระบุ -</span>'}
            </span>
          </div>
          <div class="lock-row">
            <span class="lock-label">สถานะโดยรวม:</span>
            <span class="lock-value">
              ${(data.gap_status === 'yes' || data.gacp_status === 'yes') ?
                            '<span class="status-success">✅ ผ่านมาตรฐาน</span>' :
                            '<span class="status-warning">⚠️ ยังไม่ผ่านมาตรฐาน</span>'}
            </span>
          </div>
        </div>

        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">สารไมทราไจนีน:</span>
            <span class="lock-value">
              ${data.substance_status === 'checked' ?
                            '<span class="status-success">✅ ตรวจแล้ว (' + val(data.substance_value || '0', 4) + ')</span>' :
                            data.substance_status === 'not_checked' ?
                                '<span class="status-warning">❌ ยังไม่ตรวจ</span>' :
                                '<span class="status-danger">- ไม่ระบุ -</span>'}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== LOCK 5: ข้อมูลผู้ประสานงาน ===================== -->
  <div class="lock-card">
    <div class="section-header">
      <i class="bi bi-person-lines-fill"></i> ข้อมูลผู้ประสานงาน
    </div>
    <div class="lock-content">
      <div class="lock-grid">
        <!-- ล็อคซ้าย -->
        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">ตัวแทนผู้ประสานงาน:</span>
            <span class="lock-value">${val(data.coordinator_name, 12)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">เบอร์โทรศัพท์:</span>
            <span class="lock-value mono">${val(data.coordinator_tel, 6)}</span>
          </div>
        </div>

        <!-- ล็อคขวา -->
        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">วันที่ตรวจสอบ:</span>
            <span class="lock-value">${val(new Date().toLocaleDateString('th-TH'), 10)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">สถานะการส่ง:</span>
            <span class="lock-value status-success">✅ พร้อมส่งข้อมูล</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="signature-section">
    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #E0E0E0;">
      <div style="font-weight: 600; color: #555; margin-bottom: 8px;">ผู้ตรวจสอบ (บริษัท บ้านไทยเฮิร์บ เซ็นเตอร์ จำกัด)</div>
      <div style="font-size: 0.9rem; color: #777;">
        ✅ ข้อมูลทั้งหมดถูกตรวจสอบและยืนยันเรียบร้อยแล้ว<br>
        📞 ช่องทางติดต่อ: LINE: @bthcenter | โทร: 092-4579929, 063-5033042
      </div>
    </div>
  </div>
</div>
`;
                    // End previewHtml

                    previewCard.innerHTML = previewHtml;

                    // Show preview and hide form (ensure both class and inline style updated)
                    if (formStep) {
                        formStep.classList.add('hidden');
                        formStep.style.display = 'none';
                    }
                    if (previewStep) {
                        previewStep.classList.remove('hidden');
                        previewStep.style.display = 'block';
                    }

                    window.scrollTo(0, 0);
                });
            }

            if (backBtn) {
                backBtn.addEventListener('click', () => {
                    // Show form and hide preview (update both class and inline style)
                    if (formStep) {
                        formStep.classList.remove('hidden');
                        formStep.style.display = '';
                    }
                    if (previewStep) {
                        previewStep.classList.add('hidden');
                        previewStep.style.display = 'none';
                    }
                    window.scrollTo(0, 0);
                });
            }

            if (submitBtn) {
                submitBtn.addEventListener('click', () => {
                    const submitBtnEl = document.getElementById('submitBtn');
                    const originalText = submitBtnEl.innerHTML;

                    submitBtnEl.disabled = true;
                    submitBtnEl.innerHTML = '<div class="loading-spinner"></div> กำลังส่ง...';

                    google.script.run.withSuccessHandler(msg => {
                        showMessageBox('✅ สำเร็จ', msg);
                        document.getElementById('kratomForm').reset();

                        // Hide "other" inputs, agent input and GAP/GACP ranges after reset
                        ['water_other_text', 'fert_other_text', 'past_other_text', 'agent-name', 'gap-date-range', 'gacp-date-range', 'special-name', 'substanceValueBox'].forEach(id => {
                            const el = document.getElementById(id);
                            if (el) {
                                el.classList.add('hidden');
                            }
                        });

                        // clear other_varieties textarea and combined hormone/other
                        const otherVar = document.getElementById('other_varieties');
                        if (otherVar) otherVar.value = '';
                        const hormoneAnd = document.getElementById('hormone_and_other');
                        if (hormoneAnd) hormoneAnd.value = '';
                        const volcanicCb = document.getElementById('mineral_volcanic');
                        if (volcanicCb) volcanicCb.checked = false;

                        // remove generated stem sections and reset total
                        const scb = document.querySelectorAll('.stem-cb');
                        scb.forEach(cb => cb.checked = false);
                        const stCont = getStemContainer();
                        if (stCont) stCont.innerHTML = '';
                        const totalEl = document.getElementById('total_tree_count');
                        if (totalEl) totalEl.value = '';

                        // ensure substance checkboxes are reset
                        const substanceCheckboxes = document.querySelectorAll('.substance-cb');
                        substanceCheckboxes.forEach(cb => cb.checked = false);
                        const subVal = document.getElementById('substance_value');
                        if (subVal) subVal.value = '';

                        // hide preview, show form (update both class and inline style)
                        if (previewStep) {
                            previewStep.classList.add('hidden');
                            previewStep.style.display = 'none';
                        }
                        if (formStep) {
                            formStep.classList.remove('hidden');
                            formStep.style.display = '';
                        }

                        submitBtnEl.disabled = false;
                        submitBtnEl.innerHTML = originalText;
                    }).withFailureHandler(error => {
                        let errorMessage = "เกิดข้อผิดพลาดในการส่งข้อมูล";
                        if (error && error.message) {
                            errorMessage += ": " + esc(error.message);
                            if (error.message.includes('ScriptError: Exception: ไม่พบรายการตามตารางที่ระบุ') || error.message.includes('ScriptError: Exception: ไม่พบชีตตามชื่อ')) {
                                errorMessage += "<br><br><b>นี่คือข้อผิดพลาดจาก Google Apps Script (GAS) Backend ของคุณ โปรดตรวจสอบ:</b>"
                                    + "<br>1. ชื่อฟังก์ชัน GAS ที่รับข้อมูล (ต้องเป็น <code>submitForm</code>)"
                                    + "<br>2. ชื่อ Google Sheet หรือชื่อชีต (Sheet Name) ที่อ้างอิงถึงในโค้ด GAS ว่าถูกต้องหรือไม่"
                                    + "<br>3. สิทธิ์ในการเข้าถึง Google Sheet นั้น";
                            }
                        }
                        showMessageBox('❌ ข้อผิดพลาด', errorMessage);
                        submitBtnEl.disabled = false;
                        submitBtnEl.innerHTML = originalText;
                    }).submitForm(formDataObj);
                });
            }
        });

        // =============================================
        // Custom Alert/Modal Function (Bootstrap modal)
        // =============================================
        function showCustomAlert(message, type = 'info') {
            const alertId = 'custom-alert-modal';
            let alertModal = document.getElementById(alertId);

            if (!alertModal) {
                alertModal = document.createElement('div');
                alertModal.id = alertId;
                alertModal.className = 'modal fade';
                alertModal.tabIndex = '-1';
                alertModal.innerHTML = `
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content" style="border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                            <div class="modal-header" style="border-bottom: none;">
                                <h5 class="modal-title" id="alertModalTitle" style="font-weight: 700;">Notification</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body" id="alertModalBody" style="font-size: 1rem;">
                                <!-- Message will be placed here -->
                            </div>
                            <div class="modal-footer" style="border-top: none;">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 8px;">ปิด</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(alertModal);
            }

            const modalTitle = document.getElementById('alertModalTitle');
            const modalBody = document.getElementById('alertModalBody');
            const modalHeader = alertModal.querySelector('.modal-header');

            let titleText = 'ข้อความแจ้งเตือน';
            let headerColor = '#388E3C';

            if (type === 'success') {
                titleText = '✅ สำเร็จ';
                headerColor = '#4CAF50';
            } else if (type === 'danger') {
                titleText = '❌ ข้อผิดพลาด';
                headerColor = '#D32F2F';
            }

            modalTitle.textContent = titleText;
            // Use innerHTML to allow richer messages
            modalBody.innerHTML = message;

            // Apply header color
            modalHeader.style.backgroundColor = headerColor;
            modalTitle.style.color = 'white';
            alertModal.querySelector('.btn-close').style.filter = 'invert(1)'; // Make close button visible on dark background

            // Show the modal via Bootstrap if available, else fallback to alert
            try {
                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    const modal = new bootstrap.Modal(alertModal);
                    modal.show();
                } else {
                    // fallback simple modal-like behavior
                    alert(message.replace(/<br\s*\/?>/g, '\n').replace(/<\/?[^>]+(>|$)/g, ""));
                }
            } catch (e) {
                alert(message.replace(/<br\s*\/?>/g, '\n').replace(/<\/?[^>]+(>|$)/g, ""));
            }
        }

        window.showSection = function (targetId, btn) {
            try {
                // deactivate all tabs
                document.querySelectorAll('.nav-tab').forEach(t => {
                    t.classList.remove('active');
                    t.setAttribute('aria-selected', 'false');
                });

                // activate clicked tab if provided
                if (btn && btn.classList) {
                    btn.classList.add('active');
                    btn.setAttribute('aria-selected', 'true');
                }

                // hide all sections and show the target
                document.querySelectorAll('.content-section').forEach(s => {
                    s.classList.remove('active');
                    s.classList.add('hidden');
                });

                const target = document.getElementById(targetId);
                if (target) {
                    target.classList.remove('hidden');
                    target.classList.add('active');
                } else {
                    console.warn('showSection: ไม่พบ element id=', targetId);
                }

                // Optional: apply visual color from data-section-color
                try {
                    const color = btn && (btn.getAttribute('data-section-color') || btn.dataset.sectionColor);
                    // remove previous color indicators
                    document.querySelectorAll('.content-section').forEach(s => s.style.borderTop = '');
                    if (color && target) {
                        // you can adjust color mapping or use CSS variables
                        target.style.borderTop = `4px solid ${color === 'orange' ? '#fb923c' : color === 'blue' ? '#3b82f6' : '#6b7280'}`;
                    }
                } catch (e) { /* ignore */ }
            } catch (e) {
                console.error('showSection error', e);
            }
        };

        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.nav-tab').forEach(btn => {
                // ignore if already has inline onclick that you want to keep;
                // this ensures tabs work even if showSection wasn't defined earlier
                btn.removeEventListener('click', btn._navTabHandler);
                btn._navTabHandler = function (ev) {
                    const target = btn.getAttribute('data-target') || btn.dataset.target;
                    if (target) window.showSection(target, btn);
                };
                btn.addEventListener('click', btn._navTabHandler);
            });
        });

        // Admin client-side manager (single IIFE)
        (function () {
            // Configuration constants
            const CONFIG = {
                MAX_SEARCH_QUERY_LENGTH: 100,
                SEARCH_DEBOUNCE_MS: 300,
                MAX_SAFE_EXPORT_ROWS: 5000
            };
            
            // state
            let lastFetchedData = [];
            let currentDisplayKeys = []; // keep keys order used to render the table (for CSV export)
            let isTableExpanded = false;
            let isFetching = false;

            // ---------- Utilities ----------
            function escapeHtml(str) {
                if (str === null || str === undefined) return '';
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }

            function setAdminControlsDisabled(disabled) {
                const ids = [
                    'btn-fetch-farmers', 'btn-fetch-usage', 'btn-fetch-merged',
                    'btn-simple-test', 'btn-sheet-test', 'btn-admin-conn',
                    'btn-direct-getAll', 'btn-debug-getAll', 'admin-search-btn',
                    'admin-export-btn', 'admin-refresh-table'
                ];
                ids.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.disabled = disabled;
                });
                // also disable logout to prevent race
                const logoutBtn = document.getElementById('admin-logout-btn');
                if (logoutBtn) logoutBtn.disabled = disabled;
            }

            // ---------- Table helpers ----------
            function createFooterSummary(count, columns) {
                const footer = document.createElement('div');
                footer.style.padding = '10px';
                footer.style.background = '#f3f4f6';
                footer.style.borderTop = '1px solid #d1d5db';
                footer.style.fontSize = '12px';
                footer.style.color = '#6b7280';
                footer.style.position = 'sticky';
                footer.style.bottom = '0';
                footer.style.display = 'block';
                footer.textContent = `📊 แสดง ${count} รายการ | 📋 ${columns} คอลัมน์ | 🕒 ${new Date().toLocaleTimeString('th-TH')}`;
                return footer;
            }

            function clearTable() {
                const container = document.getElementById('admin-table-container');
                if (container) container.innerHTML = '';
                currentDisplayKeys = [];
            }

            // robust displayTable: uses union of keys, escapes via textContent
            function displayTable(dataArray) {
                try {
                    console.log('displayTable called with:', dataArray);

                    lastFetchedData = Array.isArray(dataArray) ? dataArray : [];
                    console.log('lastFetchedData length:', lastFetchedData.length);

                    const container = document.getElementById('admin-table-container');
                    const wrapper = document.getElementById('admin-table-wrapper');
                    const empty = document.getElementById('admin-empty');

                    if (!container || !wrapper || !empty) {
                        console.error('Required elements not found:', { container: !!container, wrapper: !!wrapper, empty: !!empty });
                        return;
                    }

                    if (!lastFetchedData || lastFetchedData.length === 0) {
                        wrapper.classList.add('hidden');
                        empty.classList.remove('hidden');
                        container.innerHTML = '';
                        currentDisplayKeys = [];
                        return;
                    }

                    empty.classList.add('hidden');
                    wrapper.classList.remove('hidden');

                    // union keys across all rows to ensure all columns shown
                    // preserve order by first-seen across rows
                    const keyOrder = [];
                    const seen = new Set();
                    lastFetchedData.forEach(row => {
                        if (row && typeof row === 'object') {
                            Object.keys(row).forEach(k => {
                                if (!seen.has(k)) {
                                    seen.add(k);
                                    keyOrder.push(k);
                                }
                            });
                        }
                    });

                    const keys = keyOrder.length ? keyOrder : [];

                    // clear and style container
                    container.innerHTML = '';
                    container.style.maxHeight = '500px';
                    container.style.overflow = 'auto';
                    container.style.border = '2px solid #e5e7eb';
                    container.style.borderRadius = '8px';
                    container.style.background = 'white';
                    container.style.position = 'relative';

                    // build table elements
                    const table = document.createElement('table');
                    table.style.width = '100%';
                    table.style.borderCollapse = 'collapse';
                    table.style.minWidth = '800px';

                    // thead
                    const thead = document.createElement('thead');
                    thead.style.position = 'sticky';
                    thead.style.top = '0';
                    thead.style.background = '#f8fafc';
                    thead.style.zIndex = '10';
                    const trh = document.createElement('tr');
                    keys.forEach(key => {
                        const th = document.createElement('th');
                        th.style.padding = '12px 8px';
                        th.style.textAlign = 'left';
                        th.style.border = '1px solid #d1d5db';
                        th.style.whiteSpace = 'nowrap';
                        th.style.minWidth = '120px';
                        th.style.fontWeight = '700';
                        th.textContent = key;
                        trh.appendChild(th);
                    });
                    thead.appendChild(trh);
                    table.appendChild(thead);

                    // tbody
                    const tbody = document.createElement('tbody');
                    lastFetchedData.forEach((row, rowIndex) => {
                        const tr = document.createElement('tr');
                        tr.style.backgroundColor = (rowIndex % 2 === 0) ? '#ffffff' : '#f9fafb';

                        keys.forEach(k => {
                            const td = document.createElement('td');
                            td.style.padding = '8px';
                            td.style.border = '1px solid #e5e7eb';
                            td.style.verticalAlign = 'top';
                            td.style.maxWidth = '200px';
                            td.style.wordBreak = 'break-word';

                            let v = (row && Object.prototype.hasOwnProperty.call(row, k)) ? row[k] : '';
                            if (v === null || v === undefined) v = '';
                            if (typeof v === 'object') {
                                try { v = JSON.stringify(v); } catch (e) { v = String(v); }
                            }
                            // safe: use textContent
                            const div = document.createElement('div');
                            div.style.padding = '0';
                            div.style.fontSize = '0.95rem';
                            div.textContent = String(v);
                            td.appendChild(div);
                            tr.appendChild(td);
                        });

                        tbody.appendChild(tr);
                    });
                    table.appendChild(tbody);

                    container.appendChild(table);

                    // footer summary
                    const footer = createFooterSummary(lastFetchedData.length, keys.length);
                    container.appendChild(footer);

                    // reset scroll
                    container.scrollTop = 0;
                    container.scrollLeft = 0;

                    currentDisplayKeys = keys.slice(); // store keys order for export

                    console.log('Table rendered successfully with keys:', currentDisplayKeys);
                } catch (e) {
                    console.error('displayTable error:', e);
                    // try to fallback to a safe message
                    const container = document.getElementById('admin-table-container');
                    if (container) {
                        container.innerHTML = `<pre style="color:red;">เกิดข้อผิดพลาดในการแสดงตาราง: ${escapeHtml(e && e.message ? e.message : String(e))}</pre>`;
                    }
                }
            }

            // ---------- Session / Auth helpers ----------
            function isAdminSession() {
                try {
                    const token = sessionStorage.getItem('sessionToken');
                    const username = sessionStorage.getItem('username');
                    const isAdmin = sessionStorage.getItem('isAdmin'); // expected 'true' or 'false'

                    // require token and server-provided isAdmin flag
                    if (!token || !username) return false;
                    if (isAdmin === 'true') return true;
                    return false;
                } catch (e) {
                    console.error('admin: isAdminSession error', e);
                    return false;
                }
            }

            window.adminForceLogout = function () {
                try {
                    sessionStorage.removeItem('sessionToken');
                    sessionStorage.removeItem('username');
                    sessionStorage.removeItem('longName');
                    sessionStorage.removeItem('isAdmin');
                    // reuse existing logout function if present
                    if (typeof logout === 'function') logout();
                    else window.location.reload();
                } catch (e) {
                    console.error('adminForceLogout error', e);
                    sessionStorage.clear();
                    window.location.reload();
                }
            };

            window.adminCheckAuthAndInit = function () {
                const currentUserEl = document.getElementById('admin-current-user');
                const warning = document.getElementById('admin-access-warning');
                const controls = document.getElementById('admin-controls');

                const username = sessionStorage.getItem('username') || '';
                const longName = sessionStorage.getItem('longName') || '';
                if (currentUserEl) currentUserEl.textContent = username ? `${username} (${longName || '-'})` : 'ไม่ได้ล็อกอิน';

                if (!isAdminSession()) {
                    if (warning) warning.classList.remove('hidden');
                    if (controls) controls.classList.add('hidden');
                    if (typeof showLoginModal === 'function') showLoginModal();
                    return;
                }

                if (warning) warning.classList.add('hidden');
                if (controls) controls.classList.remove('hidden');
                if (typeof navigateTo === 'function') navigateTo('admin-view');
            };

            function showLoading(show = true) {
                const el = document.getElementById('admin-loading');
                const wrapper = document.getElementById('admin-table-wrapper');
                if (show) {
                    if (el) el.classList.remove('hidden');
                    if (wrapper) wrapper.classList.add('hidden');
                } else {
                    if (el) el.classList.add('hidden');
                }
            }

            // ---------- CSV export ----------
            window.adminExportCurrentToCSV = function () {
                try {
                    if (!lastFetchedData || lastFetchedData.length === 0) {
                        if (typeof showMessageBox === 'function') showMessageBox('❌ ไม่มีข้อมูล', 'ไม่มีข้อมูลให้ดาวน์โหลด');
                        else alert('ไม่มีข้อมูลให้ดาวน์โหลด');
                        return;
                    }

                    // Warn for large exports using config constant
                    if (lastFetchedData.length > CONFIG.MAX_SAFE_EXPORT_ROWS) {
                        const ok = confirm(`กำลังดาวน์โหลด ${lastFetchedData.length} แถว ซึ่งอาจใช้เวลานานหรือทำให้เบราว์เซอร์หน่วง\nต้องการดำเนินการต่อหรือไม่?`);
                        if (!ok) return;
                    }

                    // Determine keys order: prefer currently displayed table header order, else first-seen order
                    let keys = [];
                    const tableEl = document.querySelector('#admin-table-container table');
                    if (tableEl) {
                        const ths = tableEl.querySelectorAll('thead th');
                        if (ths && ths.length) {
                            keys = Array.from(ths).map(th => th.textContent || th.innerText || '').filter(Boolean);
                        }
                    }
                    if (!keys || keys.length === 0) {
                        // build union preserving first-seen order
                        const seen = new Set();
                        lastFetchedData.forEach(row => {
                            if (row && typeof row === 'object') {
                                Object.keys(row).forEach(k => {
                                    if (!seen.has(k)) {
                                        seen.add(k);
                                        keys.push(k);
                                    }
                                });
                            }
                        });
                    }

                    // Fallback to small safe set if somehow still empty
                    if (!keys || keys.length === 0) keys = Object.keys(lastFetchedData[0] || {});

                    // Build CSV with proper quoting and newline handling
                    const rows = [];
                    const headerRow = keys.map(k => `"${String(k).replace(/"/g, '""')}"`).join(',');
                    rows.push(headerRow);

                    lastFetchedData.forEach(obj => {
                        const row = keys.map(k => {
                            let v = obj && Object.prototype.hasOwnProperty.call(obj, k) ? obj[k] : '';
                            if (v === null || v === undefined) return '""';
                            if (typeof v === 'object') {
                                try { v = JSON.stringify(v); } catch (e) { v = String(v); }
                            }
                            // Normalize to string and escape quotes
                            let s = String(v);
                            // Replace CRLF/CR with LF to avoid CSV injection problems (but keep newlines)
                            s = s.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                            s = s.replace(/"/g, '""');
                            return `"${s}"`;
                        }).join(',');
                        rows.push(row);
                    });

                    const csv = rows.join('\n');
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    const username = sessionStorage.getItem('username') || 'admin';
                    const filename = `admin_export_${username}_${new Date().toISOString().slice(0, 10)}.csv`;
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);
                } catch (e) {
                    console.error('adminExportCurrentToCSV error:', e);
                    if (typeof showMessageBox === 'function') showMessageBox('❌ เกิดข้อผิดพลาด', escapeHtml(e && e.message ? e.message : String(e)));
                    else alert(String(e));
                }
            };

            // ---------- Search/filter ----------
            let searchDebounceTimer = null;
            window.adminFilterTable = function () {
                // Clear previous timer
                if (searchDebounceTimer) {
                    clearTimeout(searchDebounceTimer);
                }
                
                // Debounce search using config constant
                searchDebounceTimer = setTimeout(() => {
                    try {
                        const q = (document.getElementById('admin-search-input')?.value || '').trim().toLowerCase();
                        if (!q) {
                            displayTable(lastFetchedData);
                            return;
                        }
                        
                        // Validate search query length using config constant
                        if (q.length > CONFIG.MAX_SEARCH_QUERY_LENGTH) {
                            console.warn('Search query too long, truncating');
                            document.getElementById('admin-search-input').value = q.substring(0, CONFIG.MAX_SEARCH_QUERY_LENGTH);
                            return;
                        }
                        
                        const filtered = lastFetchedData.filter(row => {
                            try {
                                return Object.values(row).some(v => {
                                    if (v === null || v === undefined) return false;
                                    if (typeof v === 'object') {
                                        try { v = JSON.stringify(v); } catch (e) { v = String(v); }
                                    }
                                    return String(v).toLowerCase().includes(q);
                                });
                            } catch (e) {
                                return false;
                            }
                        });
                        displayTable(filtered);
                    } catch (e) {
                        console.error('adminFilterTable error:', e);
                    }
                }, CONFIG.SEARCH_DEBOUNCE_MS);
            };

            // ---------- Admin actions (fetch) ----------
            function setFetching(flag) {
                isFetching = flag;
                setAdminControlsDisabled(flag);
                showLoading(flag);
            }

            window.adminFetchAllFarmers = function () {
                if (!isAdminSession()) {
                    if (typeof showMessageBox === 'function') showMessageBox('❌ สิทธิ์ไม่เพียงพอ', 'คุณไม่มีสิทธิ์เข้าถึงข้อมูลนี้');
                    return;
                }

                if (isFetching) return;
                setFetching(true);
                const token = sessionStorage.getItem('sessionToken') || '';

                try {
                    if (typeof isAppsScriptReady === 'function' && !isAppsScriptReady('Admin Fetch')) {
                        setFetching(false);
                        return;
                    }

                    if (typeof google === 'undefined' || !google.script || !google.script.run) {
                        setFetching(false);
                        if (typeof showMessageBox === 'function') showMessageBox('❌ ไม่สามารถเชื่อมต่อ', 'google.script.run ไม่พร้อมใช้งาน');
                        return;
                    }

                    google.script.run
                        .withSuccessHandler(result => {
                            setFetching(false);
                            console.log('=== adminFetchAllFarmers SUCCESS ===', result);

                            if (result === null || result === undefined) {
                                if (typeof showMessageBox === 'function') showMessageBox('❌ ไม่มีผลลัพธ์', 'getAllFarmers คืนค่าเป็น null/undefined');
                                return;
                            }

                            try {
                                let data = result;
                                if (typeof result === 'string') {
                                    data = JSON.parse(result);
                                }

                                if (!data) {
                                    if (typeof showMessageBox === 'function') showMessageBox('❌ ไม่มีผลลัพธ์', 'ไม่สามารถแปลงผลลัพธ์ได้');
                                    return;
                                }

                                if (data.success === false) {
                                    if (typeof showMessageBox === 'function') showMessageBox('❌ ดึงข้อมูลล้มเหลว (server)', escapeHtml(data.message || JSON.stringify(data)));
                                    return;
                                }

                                if (data.success && Array.isArray(data.data)) {
                                    displayTable(data.data);
                                    return;
                                }

                                if (Array.isArray(data)) {
                                    displayTable(data);
                                    return;
                                }

                                if (typeof showMessageBox === 'function') showMessageBox('❌ รูปแบบข้อมูลไม่ถูกต้อง', `<pre>${escapeHtml(JSON.stringify(data, null, 2))}</pre>`);
                            } catch (e) {
                                console.error('Parse error:', e);
                                if (typeof showMessageBox === 'function') showMessageBox('❌ ข้อผิดพลาดในการประมวลผล', 'เกิดข้อผิดพลาด:  ' + escapeHtml(e.message || String(e)));
                            }
                        })
                        .withFailureHandler(err => {
                            setFetching(false);
                            console.error('=== adminFetchAllFarmers FAILURE ===', err);
                            fetchAndShowAdminDebug(token, 'getAllFarmers failed (failureHandler)');
                            if (typeof showMessageBox === 'function') showMessageBox('❌ ดึงข้อมูลล้มเหลว', escapeHtml((err && err.message) || 'ไม่สามารถดึงข้อมูลจาก Backend ได้'));
                        })
                        .getAllFarmers(token);

                } catch (e) {
                    setFetching(false);
                    console.error('=== adminFetchAllFarmers EXCEPTION ===', e);
                    if (typeof showMessageBox === 'function') showMessageBox('❌ ไม่รองรับ', 'เกิดข้อผิดพลาด: ' + escapeHtml(e.message || String(e)));
                }
            };

            window.adminFetchAllUsage = function () {
                if (!isAdminSession()) {
                    if (typeof showMessageBox === 'function') showMessageBox('❌ สิทธิ์ไม่เพียงพอ', 'คุณไม่มีสิทธิ์เข้าถึงข้อมูลนี้');
                    return;
                }

                if (isFetching) return;
                setFetching(true);
                const token = sessionStorage.getItem('sessionToken') || '';

                try {
                    if (typeof isAppsScriptReady === 'function' && !isAppsScriptReady('Admin Fetch')) {
                        setFetching(false);
                        return;
                    }

                    if (typeof google === 'undefined' || !google.script || !google.script.run) {
                        setFetching(false);
                        if (typeof showMessageBox === 'function') showMessageBox('❌ ไม่สามารถเชื่อมต่อ', 'google.script.run ไม่พร้อมใช้งาน');
                        return;
                    }

                    google.script.run
                        .withSuccessHandler(result => {
                            setFetching(false);
                            console.log('getAllUsage result:', result);

                            if (result === null || typeof result === 'undefined') {
                                fetchAndShowAdminDebug(token, 'getAllUsage returned null/undefined');
                                return;
                            }
                            try {
                                const data = (typeof result === 'string') ? JSON.parse(result) : result;
                                if (!data) { if (typeof showMessageBox === 'function') showMessageBox('❌ ไม่มีผลลัพธ์', 'getAllUsage คืนค่าเป็น null/undefined'); return; }
                                if (data.success === false) { if (typeof showMessageBox === 'function') showMessageBox('❌ ดึงข้อมูลล้มเหลว (server)', escapeHtml(data.message || JSON.stringify(data))); return; }
                                if (data.success && Array.isArray(data.data)) { displayTable(data.data); return; }
                                if (Array.isArray(data)) { displayTable(data); return; }
                                if (typeof showMessageBox === 'function') showMessageBox('❌ ไม่ตรงรูปแบบที่คาด', `<pre style="white-space:pre-wrap;">${escapeHtml(JSON.stringify(data, null, 2))}</pre>`);
                            } catch (e) {
                                console.error('adminFetchAllUsage parse error', e);
                                if (typeof showMessageBox === 'function') showMessageBox('❌ ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการประมวลผลผลลัพธ์: ' + escapeHtml(e && e.message));
                            }
                        })
                        .withFailureHandler(err => {
                            setFetching(false);
                            console.error('adminFetchAllUsage failed', err);
                            fetchAndShowAdminDebug(token, 'getAllUsage failed (failureHandler)');
                            if (typeof showMessageBox === 'function') showMessageBox('❌ ดึงข้อมูลล้มเหลว', escapeHtml((err && err.message) || 'ไม่สามารถดึงข้อมูลจาก Backend ได้'));
                        })
                        .getAllUsage(token);

                } catch (e) {
                    setFetching(false);
                    if (typeof showMessageBox === 'function') showMessageBox('❌ ไม่รองรับ', 'ไม่พบ google.script.run ในสภาพแวดล้อมนี้');
                }
            };

            window.adminFetchMerged = function () {
                if (!isAdminSession()) {
                    if (typeof showMessageBox === 'function') showMessageBox('❌ สิทธิ์ไม่เพียงพอ', 'คุณไม่มีสิทธิ์เข้าถึงข้อมูลนี้');
                    return;
                }

                if (isFetching) return;
                setFetching(true);
                const token = sessionStorage.getItem('sessionToken') || '';

                try {
                    if (typeof isAppsScriptReady === 'function' && !isAppsScriptReady('Admin Fetch')) {
                        setFetching(false);
                        return;
                    }

                    if (typeof google === 'undefined' || !google.script || !google.script.run) {
                        setFetching(false);
                        if (typeof showMessageBox === 'function') showMessageBox('❌ ไม่สามารถเชื่อมต่อ', 'google.script.run ไม่พร้อมใช้งาน');
                        return;
                    }

                    google.script.run
                        .withSuccessHandler(result => {
                            setFetching(false);
                            console.log('getAllMerged result:', result);

                            if (result === null || typeof result === 'undefined') {
                                fetchAndShowAdminDebug(token, 'getAllMerged returned null/undefined');
                                return;
                            }

                            try {
                                const data = (typeof result === 'string') ? JSON.parse(result) : result;
                                if (!data) { if (typeof showMessageBox === 'function') showMessageBox('❌ ไม่มีผลลัพธ์', 'getAllMerged คืนค่าเป็น null/undefined'); return; }
                                if (data.success === false) { if (typeof showMessageBox === 'function') showMessageBox('❌ ดึงข้อมูลล้มเหลว (server)', escapeHtml(data.message || JSON.stringify(data))); return; }
                                if (data.success && Array.isArray(data.data)) { displayTable(data.data); return; }
                                if (Array.isArray(data)) { displayTable(data); return; }
                                if (typeof showMessageBox === 'function') showMessageBox('❌ ไม่ตรงรูปแบบที่คาด', `<pre style="white-space:pre-wrap;">${escapeHtml(JSON.stringify(data, null, 2))}</pre>`);
                            } catch (e) {
                                console.error('adminFetchMerged parse error', e);
                                if (typeof showMessageBox === 'function') showMessageBox('❌ ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการประมวลผลผลลัพธ์: ' + escapeHtml(e && e.message));
                            }
                        })
                        .withFailureHandler(err => {
                            setFetching(false);
                            console.error('adminFetchMerged failed', err);
                            fetchAndShowAdminDebug(token, 'getAllMerged failed (failureHandler)');
                            if (typeof showMessageBox === 'function') showMessageBox('❌ ดึงข้อมูลล้มเหลว', escapeHtml((err && err.message) || 'ไม่สามารถดึงข้อมูลจาก Backend ได้'));
                        })
                        .getAllMerged(token);

                } catch (e) {
                    setFetching(false);
                    if (typeof showMessageBox === 'function') showMessageBox('❌ ไม่รองรับ', 'ไม่พบ google.script.run ในสภาพแวดล้อมนี้');
                }
            };

            // ---------- Test / debug actions ----------
            window.testAdminConnection = function () {
                if (!isAdminSession()) {
                    if (typeof showMessageBox === 'function') showMessageBox('❌ สิทธิ์ไม่เพียงพ��', 'คุณไม่มีสิทธิ์เข้าถึงฟังก์ชันนี้');
                    return;
                }

                const token = sessionStorage.getItem('sessionToken') || '';

                if (typeof isAppsScriptReady === 'function' && !isAppsScriptReady('Admin Test')) return;

                setAdminControlsDisabled(true);
                google.script.run
                    .withSuccessHandler(result => {
                        setAdminControlsDisabled(false);
                        console.log('Test result:', result);
                        if (typeof showMessageBox === 'function') showMessageBox('🔍 ผลการทดสอบ Admin', `<pre style="white-space:pre-wrap;">${escapeHtml(JSON.stringify(result, null, 2))}</pre>`);
                    })
                    .withFailureHandler(err => {
                        setAdminControlsDisabled(false);
                        console.error('Test failed:', err);
                        if (typeof showMessageBox === 'function') showMessageBox('❌ ทดสอบล้มเหลว', escapeHtml((err && err.message) || 'Unknown error'));
                    })
                    .testAdminAccess(token);
            };

            window.adminTestSheetAccess = function () {
                if (!isAdminSession()) {
                    if (typeof showMessageBox === 'function') showMessageBox('❌ สิทธิ์ไม่เพียงพอ', 'คุณไม่มีสิทธิ์เข้าถึงฟังก์ชันนี้');
                    return;
                }
                if (typeof isAppsScriptReady === 'function' && !isAppsScriptReady('Sheet Test')) return;

                setAdminControlsDisabled(true);
                google.script.run
                    .withSuccessHandler(result => {
                        setAdminControlsDisabled(false);
                        console.log('Sheet access test result:', result);
                        if (typeof showMessageBox === 'function') showMessageBox('📊 ผลการทดสอบ Sheet Access', `<pre style="white-space:pre-wrap;">${escapeHtml(JSON.stringify(result, null, 2))}</pre>`);
                    })
                    .withFailureHandler(err => {
                        setAdminControlsDisabled(false);
                        console.error('Sheet test failed:', err);
                        if (typeof showMessageBox === 'function') showMessageBox('❌ ทดสอบ Sheet ล้มเหลว', escapeHtml((err && err.message) || 'Unknown error'));
                    })
                    .testSheetAccessPublic();
            };

            window.adminSimpleTest = function () {
                if (typeof isAppsScriptReady === 'function' && !isAppsScriptReady('Simple Test')) return;
                setAdminControlsDisabled(true);
                google.script.run
                    .withSuccessHandler(result => {
                        setAdminControlsDisabled(false);
                        if (typeof showMessageBox === 'function') showMessageBox('✅ ทดสอบ Simple', `ผลลัพธ์: ${escapeHtml(JSON.stringify(result))}`);
                    })
                    .withFailureHandler(err => {
                        setAdminControlsDisabled(false);
                        if (typeof showMessageBox === 'function') showMessageBox('❌ Simple Test ล้มเหลว', escapeHtml((err && err.message) || 'Unknown error'));
                    })
                    .testPing();
            };

            window.directTestGetAllFarmers = function () {
                if (!isAdminSession()) {
                    if (typeof showMessageBox === 'function') showMessageBox('❌ สิทธิ์ไม่เพียงพอ', 'คุณไม่มีสิทธิ์เข้าถึงฟังก์ชันนี้');
                    return;
                }
                setAdminControlsDisabled(true);
                const token = sessionStorage.getItem('sessionToken') || '';
                google.script.run
                    .withSuccessHandler(result => {
                        setAdminControlsDisabled(false);
                        console.log('DIRECT TEST - Success handler called', result);
                        if (typeof showMessageBox === 'function') showMessageBox('🔍 ผลการทดสอบโดยตรง', `<pre style="white-space: pre-wrap;">${escapeHtml(JSON.stringify(result, null, 2))}</pre>`);
                    })
                    .withFailureHandler(err => {
                        setAdminControlsDisabled(false);
                        console.error('DIRECT TEST - Failure:', err);
                        if (typeof showMessageBox === 'function') showMessageBox('❌ ทดสอบล้มเหลว', escapeHtml((err && err.message) || 'Unknown error'));
                    })
                    .getAllFarmers(token);
            };

            window.testGetAllFarmersDebug = function () {
                if (!isAdminSession()) {
                    if (typeof showMessageBox === 'function') showMessageBox('❌ สิทธิ์ไม่เพียงพอ', 'คุณไม่มีสิทธิ์เข้าถึงฟังก์ชันนี้');
                    return;
                }
                setAdminControlsDisabled(true);
                const token = sessionStorage.getItem('sessionToken') || '';
                google.script.run
                    .withSuccessHandler(result => {
                        setAdminControlsDisabled(false);
                        console.log('DEBUG TEST - Success:', result);
                        if (typeof showMessageBox === 'function') showMessageBox('🔍 Debug Test Results', `<pre style="white-space:pre-wrap;">${escapeHtml(JSON.stringify(result, null, 2))}</pre>`);
                    })
                    .withFailureHandler(err => {
                        setAdminControlsDisabled(false);
                        console.error('DEBUG TEST - Failure:', err);
                        if (typeof showMessageBox === 'function') showMessageBox('❌ Debug Test ล้มเหลว', escapeHtml((err && err.message) || 'Unknown error'));
                    })
                    .getAllFarmersDebug(token);
            };

            // expose internal helpers for debugging
            window._admin_internal = {
                displayTable,
                isAdminSession,
                fetchAndShowAdminDebug,
                getCurrentDisplayKeys: () => currentDisplayKeys.slice(),
                getLastFetchedData: () => lastFetchedData.slice()
            };

            // observer to auto-call adminCheckAuthAndInit when view shown (if you use navigateTo)
            const adminView = document.getElementById('admin-view');
            if (adminView) {
                const mo = new MutationObserver(() => {
                    if (!adminView.classList.contains('hidden')) setTimeout(() => adminCheckAuthAndInit(), 50);
                });
                mo.observe(adminView, { attributes: true, attributeFilter: ['class'] });
            }
        })();

        // =============================================
        // INITIALIZATION ของระบบหลัก
        // =============================================
        window.onload = () => {
            try {
                console.log('🚀 Starting system initialization...');
                
                // Step 1: Populate all dropdowns first
                console.log('Step 1: Populating dropdowns...');
                const populateSuccess = populateLongOptions();
                
                if (!populateSuccess) {
                    console.warn('⚠️ Initial dropdown population had issues, will retry on user interaction');
                }
                
                // Step 2: Initialize other components
                console.log('Step 2: Initializing components...');
                showView('main-menu-view');
                initializeFertilizerCheckboxes();

                // Step 3: Check if user already logged in
                console.log('Step 3: Checking login status...');
                const currentUser = checkLoginStatus();
                
                if (currentUser) {
                    console.log('✅ User already logged in:', currentUser.longName);
                    
                    // Give dropdowns a moment to render, then auto-select
                    setTimeout(() => {
                        console.log('🔄 Auto-selecting dropdowns for logged-in user...');
                        updateAllLongDropdowns(currentUser.longName);
                        updateSheetALongDropdown();
                    }, DOM_READY_DELAY_MS);
                } else {
                    console.log('ℹ️ No active user session');
                }

                // Step 4: Check GAS environment
                isAppsScriptReady('Initialization');

                console.log('✅ ระบบโหลดเสร็จสิ้น');
            } catch (error) {
                console.error('❌ ข้อผิดพลาดในการโหลดระบบ:', error);
                showMessageBox("❌ ข้อผิดพลาดระบบ",
                    "เกิดข้อผิดพลาดในการโหลดระบบ: " + error.message
                );
            }
        };

        // =============================================
        // GLOBAL FUNCTION EXPORTS สำหรับฟอร์มสำรวจ
        // =============================================
        window.toggleAgentInput = toggleAgentInput;
        window.toggleDateRange = toggleDateRange;
        window.renderStemSection = renderStemSection;
        window.calculateTotal = calculateTotal;
        window.setupOtherToggles = setupOtherToggles;
        window.showCustomAlert = showCustomAlert;

        // General exports for other modules
        window.showLoginModal = showLoginModal;
        window.hideLoginModal = hideLoginModal;
        window.handleLogin = handleLogin;
        window.checkAuthAndShowSubmenu = checkAuthAndShowSubmenu;
        window.logout = logout;
        window.toggleOtherWateringInput = toggleOtherWateringInput;
        window.toggleOtherFertilizerInput = toggleOtherFertilizerInput;
        window.handleSheetASubmit = handleSheetASubmit;
        window.hideMessageBox = hideMessageBox;
        window.fetchAndDisplaySheetAData = fetchAndDisplaySheetAData;

        window.getFertilizerUsageData = getFertilizerUsageData;
        window.getUsageData = getUsageData;
        window.toggleOtherFertilizerInputUse = toggleOtherFertilizerInputUse;
        window.initializeFertilizerCheckboxes = initializeFertilizerCheckboxes;
        window.resetUsageContainers = resetUsageContainers;
        window.createFertilizerUsageHTML = createFertilizerUsageHTML;
        window.handleSheetBUseSubmit = handleSheetBUseSubmit;

        window.toggleAdjustedBRate = toggleAdjustedBRate;
        window.toggleAdjustedBNanoRate = toggleAdjustedBNanoRate;
        window.fetchAndDisplaySheetBUseData = fetchAndDisplaySheetBUseData;
        window.fetchSummaryData = fetchSummaryData;
        window.openExpansionForm = openSurveyForm;
        window.openLeafSampleForm = openLeafSampleForm;

        // alias navigateTo to existing showView
        window.navigateTo = showView;

        // =============================================
        // PWA SERVICE WORKER REGISTRATION
        // =============================================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('✅ Service Worker registered successfully:', registration.scope);

                        // Check for updates periodically
                        setInterval(() => {
                            registration.update();
                        }, 60000); // Check every minute

                        // Handle service worker updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New service worker available
                                    console.log('🔄 New version available! Please refresh.');

                                    // Optionally show a notification to the user
                                    if (window.confirm('มีเวอร์ชันใหม่ของระบบ คุณต้องการรีเฟรชหน้าเพื่ออัพเดทหรือไม่?')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('❌ Service Worker registration failed:', error);
                    });

                // Handle service worker controller change (when new SW takes over)
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('🔄 Service Worker controller changed, reloading page...');
                    window.location.reload();
                });
            });
        } else {
            console.warn('⚠️ Service Workers are not supported in this browser');
        }

        // =============================================
        // PWA INSTALL PROMPT
        // =============================================
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent the mini-infobar from appearing on mobile
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;

            console.log('💾 PWA install prompt available');

            // Optionally show a custom install button
            // You can create a button in the UI and call showInstallPrompt() when clicked
        });

        window.showInstallPrompt = async function () {
            if (!deferredPrompt) {
                console.log('ℹ️ Install prompt not available');
                return;
            }

            // Show the install prompt
            deferredPrompt.prompt();

            // Wait for the user to respond to the prompt
            const { outcome } = await deferredPrompt.userChoice;

            if (outcome === 'accepted') {
                console.log('✅ User accepted the install prompt');
            } else {
                console.log('❌ User dismissed the install prompt');
            }

            // Clear the deferredPrompt
            deferredPrompt = null;
        };

        window.addEventListener('appinstalled', () => {
            console.log('✅ PWA installed successfully');
            deferredPrompt = null;
        });
    </script>
</body>

</html>
