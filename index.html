<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <!-- Updated viewport to include safe-area for iOS devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ - ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢‡πÄ‡∏Æ‡∏¥‡∏£‡πå‡∏ö‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡∏à‡∏≥‡∏Å‡∏±‡∏î">
    <meta name="theme-color" content="#16a34a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BTH Farmer">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- App Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512x512.png">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-192x192.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+Thai:wght@400;500;600;700;800&family=Sarabun:wght@400;600;700&display=swap"
        rel="stylesheet">
    <style>
        /* Pastel Palette and Responsive enhancements merged with original styles
           - Restored original styles and added fluid/responsive variables + improved breakpoints
           - Keeps existing theme and detailed component rules while making layout stable across
             phones, tablets (including iPad) and desktops
        */

        /* ---------------------------
           Responsive variables (added/merged)
           --------------------------- */
        :root {
            /* Colors */
            --color-pastel-bg: #f5f8fa;
            --color-card-a: #DCD0FF;
            --color-card-a-dark: #A396D1;
            --color-card-b: #B9FBC0;
            --color-card-b-dark: #8BD193;
            --color-accent: #f7c9b6;
            --color-text-dark: #333333;
            --color-primary-medium: #44403c;
            --color-primary-dark: #292524;
            --dynamic-accent: #16a34a;
            --dynamic-highlight-bg: rgba(139, 209, 147, 0.12);
            --color-warning-bg: #fff7ed;
            --color-warning-accent: #fb923c;
            --color-border: #e5e7eb;

            /* Fluid typography (clamp) */
            --fs-xs: clamp(0.78rem, 0.67rem + 0.4vw, 0.95rem);
            --fs-sm: clamp(0.9rem, 0.85rem + 0.35vw, 1.05rem);
            --fs-base: clamp(1rem, 1rem + 0.5vw, 1.12rem);
            --fs-lg: clamp(1.1rem, 1.05rem + 0.8vw, 1.35rem);
            --fs-xl: clamp(1.35rem, 1.2rem + 1.2vw, 1.75rem);
            --fs-2xl: clamp(1.6rem, 1.45rem + 1.6vw, 2.1rem);

            /* Spacing scale */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2.5rem;

            /* Touch target */
            --touch-size: 44px;

            /* Breakpoints */
            --bp-mobile-max: 600px;
            --bp-tablet-max: 1024px;
            --bp-desktop-min: 1025px;

            /* Additional layout vars for merged styles */
            --gap-xs: 0.5rem;
            --gap-sm: 0.75rem;
            --gap-md: 1rem;
            --gap-lg: 1.5rem;
        }

        body {
            font-family: 'Noto Sans Thai', 'Inter', sans-serif;
            background-color: var(--color-pastel-bg);
            color: var(--color-text-dark);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-text-size-adjust: 100%;
            font-size: var(--fs-base);
        }

        .form-container {
            max-width: min(1200px, 96%);
            background-color: white;
            padding: clamp(16px, 2.6vw, 32px);
            border-radius: clamp(10px, 2vw, 20px);
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            margin: 0 auto;
            border: 1px solid rgba(0, 0, 0, 0.02);
        }

        /* MAIN MENU STYLES - UPDATED (merged with original) */
        .main-menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: clamp(12px, 1.6vw, 28px);
            margin-top: clamp(16px, 2.4vw, 32px);
        }

        .portal-card-enhanced {
            border-radius: 1.5rem;
            padding: clamp(12px, 2.5vw, 32px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: linear-gradient(135deg,
                    rgba(255, 255, 255, 0.9) 0%,
                    rgba(255, 255, 255, 0.7) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 160px;
            /* base shadow used for all portal cards to keep visual consistency */
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.06), 0 4px 6px rgba(15, 23, 42, 0.04);
        }

        .portal-card-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg,
                    #1B5E20 0%,
                    #4CAF50 50%,
                    #C8E6C9 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .portal-card-enhanced:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 30px 60px rgba(15, 23, 42, 0.09), 0 8px 20px rgba(15, 23, 42, 0.06);
        }

        .portal-card-enhanced:hover::before {
            opacity: 1;
        }

        .card-icon-wrapper {
            width: clamp(56px, 8vw, 96px);
            height: clamp(56px, 8vw, 96px);
            margin: 0 auto 1.5rem;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1),
                inset 0 0 0 1px rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
        }

        .portal-card-enhanced:hover .card-icon-wrapper {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15),
                inset 0 0 0 1px rgba(255, 255, 255, 0.8);
        }

        .card-title {
            font-size: clamp(1.0rem, 0.9rem + 0.8vw, 1.5rem);
            font-weight: 800;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            line-height: 1.15;
        }

        .card-description {
            font-size: var(--fs-sm);
            line-height: 1.6;
            color: #4a5568;
            text-align: center;
            margin-bottom: 1rem;
        }

        .card-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.5rem;
            text-align: center;
            width: 100%;
        }

        /* Specific card colorings preserved from original */
        #card-sheet-a .card-badge {
            background: linear-gradient(135deg, var(--color-green-light) 0%, var(--color-green-dark) 100%);
            color: #166534;
        }

        #card-sheet-b .card-badge {
            background: linear-gradient(135deg, #93C5FD 0%, #3b82f6 100%);
            color: white;
        }

        #card-sheet-b-use .card-badge {
            background: linear-gradient(135deg, #FFD6A5 0%, #fb923c 100%);
            color: #7c2d12;
        }

        /* --------- Restore green card (card-sheet-a) complete visual styles ---------
           These overrides ensure the green card (‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°)
           appearance is preserved and not unintentionally overridden by generic rules.
           This block restores background, padding, rounded corners, badge, CTA, icon color,
           title color, subtle inner glow and hover behaviour like in original design.
        */
        #card-sheet-a.portal-card-enhanced {
            background: linear-gradient(135deg, #E6FFF0 0%, #F0FFF6 100%) !important;
            border: 1px solid rgba(34, 197, 94, 0.06) !important;
            /* Use the same base shadow style as .portal-card-enhanced to ensure consistency */
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.06), 0 4px 6px rgba(15, 23, 42, 0.04) !important;
            color: #0b5a34 !important;
            padding: clamp(18px, 3.2vw, 36px) !important;
            border-radius: 22px !important;
            min-height: 220px !important;
        }

        /* Icon wrapper specific for green card */
        #card-sheet-a .card-icon-wrapper {
            background: linear-gradient(180deg, #ffffff 0%, #f7fff9 100%) !important;
            box-shadow: 0 18px 30px rgba(48, 145, 86, 0.06), inset 0 2px 0 rgba(255, 255, 255, 0.9) !important;
            border-radius: 16px !important;
        }

        /* Make the icon stroke fill green where applicable */
        #card-sheet-a .card-icon-wrapper svg {
            color: #10b981;
            /* tailwind emerald-400 like */
            width: clamp(40px, 6vw, 64px);
            height: clamp(40px, 6vw, 64px);
        }

        /* Title on green card: use solid dark green for best contrast */
        #card-sheet-a .card-title {
            background: none !important;
            background-clip: unset !important;
            -webkit-background-clip: unset !important;
            -webkit-text-fill-color: unset !important;
            color: #065f46 !important;
            font-size: clamp(1.05rem, 1.0rem + 0.9vw, 1.6rem) !important;
            line-height: 1.05 !important;
        }

        /* Description color slightly muted green/dark */
        #card-sheet-a .card-description {
            color: #166534 !important;
            opacity: 0.9;
            font-size: var(--fs-sm) !important;
        }

        /* CTA / badge styles emphasized */
        #card-sheet-a .card-badge {
            background: linear-gradient(90deg, #CFF7D9 0%, #8BD193 100%) !important;
            color: #044e2f !important;
            box-shadow: 0 8px 22px rgba(34, 128, 71, 0.08) !important;
            padding: 10px 18px !important;
            border-radius: 999px !important;
            display: inline-block;
            font-weight: 700 !important;
        }

        /* If there's a button inside the card (pastel-button) give it the green gradient look */
        #card-sheet-a .pastel-button {
            background: linear-gradient(90deg, #A7E0AE 0%, #7ED08C 100%) !important;
            color: #064e3b !important;
            box-shadow: 0 10px 24px rgba(34, 128, 71, 0.08) !important;
            border: none !important;
            padding: 10px 18px !important;
            border-radius: 999px !important;
        }

        /* Preserve hover tone but keep green emphasis */
        #card-sheet-a.portal-card-enhanced:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 30px 60px rgba(15, 23, 42, 0.09) !important;
        }

        /* Ensure text inside remains legible on all sizes */
        #card-sheet-a .card-title,
        #card-sheet-a .card-description,
        #card-sheet-a .card-badge {
            -webkit-font-smoothing: antialiased;
        }

        /* card-glow from original */
        .card-glow {
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .portal-card-enhanced:hover .card-glow {
            opacity: 1;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .portal-card-enhanced {
            animation: fadeInUp 0.6s ease forwards;
            animation-delay: calc(var(--card-index, 0) * 0.1s);
            opacity: 0;
        }

        /* Responsive adjustments (merged with original mobile rules) */
        @media (max-width: 768px) {
            .main-menu-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .portal-card-enhanced {
                padding: 2rem 1.5rem;
            }

            .card-icon-wrapper {
                width: 70px;
                height: 70px;
            }
        }

        /* Original portal-card styles preserved */
        .portal-card {
            border-radius: 1rem;
            padding: 2rem;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: scale(1);
        }

        .portal-card:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
            transform: scale(1.02);
        }

        /* FORM MENU view specific overrides */
        #form-menu-view .bg-green-50 {
            background-color: #f0fdf4;
        }

        #form-menu-view .border-green-300 {
            border-color: #86efac;
        }

        #form-menu-view .bg-green-100 {
            background-color: #dcfce7;
        }

        #form-menu-view .text-green-600 {
            color: #16a34a;
        }

        #form-menu-view .hover\:bg-green-50:hover {
            background-color: #f0fdf4;
        }

        #form-menu-view .hover\:border-green-300:hover {
            border-color: #86efac;
        }

        #form-menu-view .group-hover\:bg-green-200:hover {
            background-color: #bbf7d0;
        }

        #form-menu-view .group-hover\:text-green-600:hover {
            color: #16a34a;
        }

        /* specific original card backgrounds (kept) */
        #card-sheet-a {
            background: linear-gradient(135deg, var(--color-green-light), #e6ffec);
        }

        #card-sheet-b {
            background: linear-gradient(135deg, #93C5FD, #e0f2fe);
        }

        #card-sheet-b-use {
            background: linear-gradient(135deg, #FFD6A5, #ffecda);
        }

        /* Inputs styling merged */
        input[type="text"],
        input[type="tel"],
        input[type="number"],
        input[type="date"],
        textarea,
        select {
            padding: clamp(8px, 1.2vw, 12px);
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #ffffff;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            font-size: var(--fs-sm);
        }

        input:focus,
        textarea:focus,
        select:focus {
            border-color: var(--color-green-dark, #8BD193);
            outline: none;
            box-shadow: 0 0 0 3px rgba(139, 209, 147, 0.5);
        }

        .pastel-button {
            background-color: var(--color-green-light);
            color: var(--color-text-dark);
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 4px var(--color-green-dark);
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .pastel-button:hover {
            background-color: #A7E0AE;
            box-shadow: 0 2px var(--color-green-dark);
            transform: translateY(2px);
        }

        .pastel-button:active {
            transform: translateY(4px);
            box-shadow: 0 0 var(--color-green-dark);
        }

        .search-button {
            background-color: var(--color-card-b);
            color: var(--color-text-dark);
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 4px var(--color-card-b-dark);
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .search-button:hover {
            background-color: #A7E0AE;
            box-shadow: 0 2px var(--color-card-b-dark);
            transform: translateY(2px);
        }

        .search-button:active {
            transform: translateY(4px);
            box-shadow: 0 0 var(--color-card-b-dark);
        }

        .radio-group label {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            transition: all 0.2s;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: var(--fs-sm);
        }

        input[type="radio"]:checked+label,
        input[type="checkbox"]:checked+label {
            background-color: #dcfce7;
            border-color: #16a34a;
            font-weight: 600;
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--color-green-dark);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            display: inline-block;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Colors and utilities from original preserved */
        .bg-green-50 {
            background-color: #f0fdf4;
        }

        .bg-blue-50 {
            background-color: #f0f9ff;
        }

        .bg-orange-50 {
            background-color: #fff7ed;
        }

        .text-green-800 {
            color: #166534;
        }

        .text-blue-800 {
            color: #1e40af;
        }

        .text-orange-800 {
            color: #9a3412;
        }

        /* Utilities preserved */
        .hidden {
            display: none !important;
        }

        .block {
            display: block;
        }

        .flex {
            display: flex;
        }

        .grid {
            display: grid;
        }

        .space-y-4>*+* {
            margin-top: 1rem;
        }

        .space-y-6>*+* {
            margin-top: 1.5rem;
        }

        .space-x-4>*+* {
            margin-left: 1rem;
        }

        .mb-1 {
            margin-bottom: 0.25rem;
        }

        .mb-2 {
            margin-bottom: 0.5rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mb-6 {
            margin-bottom: 1.5rem;
        }

        .mt-2 {
            margin-top: 0.5rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .mt-6 {
            margin-top: 1.5rem;
        }

        .p-4 {
            padding: 1rem;
        }

        .p-8 {
            padding: 2rem;
        }

        .pt-2 {
            padding-top: 0.5rem;
        }

        .pt-4 {
            padding-top: 1rem;
        }

        .pb-2 {
            padding-bottom: 0.5rem;
        }

        .rounded-lg {
            border-radius: 0.5rem;
        }

        .rounded-xl {
            border-radius: 0.75rem;
        }

        .border {
            border: 1px solid #e5e7eb;
        }

        .border-t {
            border-top: 1px solid #e5e7eb;
        }

        .bg-stone-50 {
            background-color: #fafaf9;
        }

        .bg-stone-100 {
            background-color: #f5f5f4;
        }

        .bg-white {
            background-color: white;
        }

        .text-sm {
            font-size: var(--fs-sm);
        }

        .text-lg {
            font-size: var(--fs-lg);
        }

        .text-xl {
            font-size: var(--fs-xl);
        }

        .text-2xl {
            font-size: var(--fs-2xl);
        }

        .text-3xl {
            font-size: clamp(1.8rem, 1.6rem + 1.8vw, 2.4rem);
        }

        .font-medium {
            font-weight: 500;
        }

        .font-semibold {
            font-weight: 600;
        }

        .font-bold {
            font-weight: 700;
        }

        .font-extrabold {
            font-weight: 800;
        }

        .text-stone-500 {
            color: #78716c;
        }

        .text-stone-600 {
            color: #57534e;
        }

        .text-stone-700 {
            color: #44403c;
        }

        .text-stone-800 {
            color: #292524;
        }

        .text-red-600 {
            color: #dc2626;
        }

        .whitespace-nowrap {
            white-space: nowrap;
        }

        .flex-grow {
            flex-grow: 1;
        }

        .w-full {
            width: 100%;
        }

        .h-4 {
            height: 1rem;
        }

        .h-6 {
            height: 1.5rem;
        }

        .h-8 {
            height: 2rem;
        }

        .h-16 {
            height: 4rem;
        }

        .w-4 {
            width: 1rem;
        }

        .w-6 {
            width: 1.5rem;
        }

        .w-8 {
            width: 2rem;
        }

        .w-16 {
            width: 4rem;
        }

        .ml-2 {
            margin-left: 0.5rem;
        }

        .ml-4 {
            margin-left: 1rem;
        }

        .mr-1 {
            margin-right: 0.25rem;
        }

        .fixed {
            position: fixed;
        }

        .absolute {
            position: absolute;
        }

        .relative {
            position: relative;
        }

        .inset-0 {
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }

        .top-4 {
            top: 1rem;
        }

        .left-4 {
            left: 1rem;
        }

        .z-10 {
            z-index: 10;
        }

        .z-50 {
            z-index: 50;
        }

        .bg-opacity-30 {
            opacity: 0.3;
        }

        .opacity-30 {
            opacity: 0.3;
        }

        .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .shadow-2xl {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        /* Grid layouts preserved */
        .grid-cols-1 {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }

        .grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .grid-cols-3 {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        .md\:grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .md\:grid-cols-3 {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        .col-span-full {
            grid-column: 1 / -1;
        }

        .md\:col-span-2 {
            grid-column: span 2 / span 2;
        }

        /* Extra responsive rules (merged & added) */
        .radio-group input[type="checkbox"]:checked+label,
        .radio-group label.active {
            background-color: #dcfce7 !important;
            border-color: #16a34a !important;
            color: #166534;
            font-weight: 600;
        }

        select:disabled {
            background-color: #f9fafb;
            color: #374151;
            cursor: not-allowed;
            opacity: 1;
        }

        .bg-gray-100 {
            background-color: #f3f4f6;
        }

        .cursor-not-allowed {
            cursor: not-allowed;
        }

        .blue-button {
            background-color: #C3E0F5;
            color: #1E293B;
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 4px #8AB5DE;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .blue-button:hover {
            background-color: #9FC3EB;
            transform: translateY(2px);
            box-shadow: 0 2px #8AB5DE;
        }

        .blue-button:active {
            transform: translateY(4px) scale(0.98);
            box-shadow: 0 0 0 #8AB5DE;
            background-color: #BFD0F5;
        }

        /* Admin table responsive rules */
        .admin-table-scroll {
            max-height: 70vh;
            overflow: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .admin-table-scroll table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .admin-table-scroll thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #f8fafc;
        }

        .admin-table-scroll th {
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e5e7eb;
            white-space: nowrap;
            background: #f8fafc;
            color: #374151;
            min-width: 120px;
        }

        .admin-table-scroll td {
            padding: 10px 8px;
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: top;
            max-width: 200px;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .admin-table-scroll tr:hover {
            background-color: #e0f2fe !important;
        }

        /* Responsive scrolling adjustments */
        @media (max-width: 768px) {
            .admin-table-scroll {
                max-height: 50vh;
            }

            .admin-table-scroll th,
            .admin-table-scroll td {
                padding: 8px 6px;
                font-size: 12px;
                min-width: 100px;
            }
        }

        /* Custom scrollbar */
        .admin-table-scroll::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .admin-table-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .admin-table-scroll::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .admin-table-scroll::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Additional merged styles (original had many, preserved where needed) */

        /* ===== Additional styles inserted per user request (kept) ===== */
        .container {
            max-width: 1000px;
            margin: 20px auto;
            background: var(--color-card-bg);
            padding: 30px;
            border-radius: 20px;
            box-shadow:
                -10px -10px 20px rgba(255, 255, 255, 1),
                10px 10px 30px rgba(174, 174, 192, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .section-overview {
            background-color: var(--dynamic-highlight-bg);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            border: 1px solid var(--dynamic-accent);
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.1);
        }

        ol,
        ul {
            padding-left: 20px;
        }

        li {
            margin-bottom: 5px;
        }

        .step {
            background-color: var(--color-card-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--color-border);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
        }

        .step::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 6px;
            height: 100%;
            background-color: var(--dynamic-accent);
            opacity: 1;
        }

        .step:hover {
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            transform: translateY(-5px);
            border-color: var(--dynamic-accent);
        }

        .important {
            color: #EF4444;
            font-weight: 700;
        }

        .non-mandatory-note {
            font-size: 0.9em;
            font-weight: 400;
            color: var(--color-primary-medium);
            margin-left: 5px;
        }

        .note {
            background-color: var(--color-warning-bg);
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
            border-left: 8px solid var(--color-warning-accent);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            color: #4B5563;
        }

        .note-accent {
            background-color: var(--dynamic-highlight-bg) !important;
            border-left-color: var(--dynamic-accent) !important;
            color: var(--color-primary-dark) !important;
        }

        .status-box {
            display: inline-block;
            width: 18px;
            height: 18px;
            border-radius: 4px;
            margin-right: 8px;
            vertical-align: middle;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .red-box {
            background-color: #F87171;
        }

        .blue-box {
            background-color: #60A5FA;
        }

        .green-box {
            background-color: #4ADE80;
        }

        .yellow-box {
            background-color: #FCD34D;
        }

        hr {
            border: 0;
            border-top: 1px solid var(--color-border);
            margin: 40px 0;
        }

        /* Navigation tabs improved for touch */
        .nav-tabs {
            display: flex;
            flex-wrap: nowrap;
            gap: 12px;
            margin-bottom: 25px;
            padding: 10px 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .nav-tab {
            background: var(--color-card-bg);
            border: 1px solid var(--color-border);
            padding: 10px 20px;
            cursor: pointer;
            font-family: 'Noto Sans Thai', sans-serif;
            font-size: var(--fs-sm);
            font-weight: 600;
            color: var(--color-primary-medium);
            border-radius: 30px;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            user-select: none;
            white-space: nowrap;
            min-height: var(--touch-size);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .nav-tab:hover {
            color: var(--color-primary-dark);
            background-color: var(--dynamic-highlight-bg);
            border-color: var(--dynamic-accent);
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }

        .nav-tab.active {
            color: var(--color-card-bg);
            background-color: var(--dynamic-accent);
            border-color: var(--dynamic-accent);
            font-weight: 700;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .content-section {
            display: none;
            padding-top: 15px;
        }

        .content-section.active {
            display: block;
        }

        /* small-screen adjustments */
        @media (max-width: 600px) {
            body {
                padding: 10px;
                font-size: 14px;
            }

            .form-container {
                max-width: none;
                margin: 10px 0;
                padding: 15px 10px;
                border-radius: 12px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            }

            h1 {
                font-size: 1.8em;
                margin-bottom: 15px;
                padding-bottom: 10px;
            }

            h2 {
                font-size: 1.5em;
                margin-top: 15px;
                margin-bottom: 15px;
                padding-bottom: 5px;
            }

            h3 {
                font-size: 1.3em;
                margin-top: 15px;
            }

            .nav-tabs {
                justify-content: center;
                gap: 8px 6px;
                padding: 0;
            }

            .nav-tab {
                padding: 8px 14px;
                font-size: 0.9em;
                white-space: nowrap;
            }

            .step {
                padding: 10px 10px 10px 20px;
                margin-bottom: 10px;
            }

            .step::before {
                width: 4px;
            }
        }

        /* admin table wrapper rules merged and preserved */
        #admin-table-wrapper {
            overflow: visible !important;
        }

        #admin-table-container {
            max-height: 70vh !important;
            overflow: auto !important;
            -webkit-overflow-scrolling: touch !important;
            touch-action: pan-y !important;
            pointer-events: auto !important;
        }

        /* Accessibility focus */
        :focus {
            outline: 3px solid rgba(99, 102, 241, 0.12);
            outline-offset: 2px;
        }

        /* Safe-area support for iOS */
        @supports (padding: max(0px)) {
            body {
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        /* End merged head styles */
    </style>
</head>

<body class="p-4 md:p-8">

    <!-- Login Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡πâ‡∏á -->
    <div id="login-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden"
        style="background: rgba(0, 0, 0, 0.5);">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold text-stone-800 mb-6 text-center">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô</h2>
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="space-y-4">
                    <div>
                        <label for="username" class="block text-sm font-medium mb-1">Username</label>
                        <input type="text" id="username" placeholder="username" required
                            class="w-full p-3 border border-stone-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium mb-1">Password</label>
                        <input type="password" id="password" placeholder="password" required
                            class="w-full p-3 border border-stone-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                    </div>
                    <div id="login-error" class="text-red-500 text-sm hidden text-center"></div>

                    <button id="login-submit" type="submit" class="w-full blue-button py-3 rounded-lg font-semibold">
                        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                    <button type="button" onclick="hideLoginModal()"
                        class="w-full bg-stone-200 text-stone-700 py-3 rounded-lg font-semibold hover:bg-stone-300">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <div class="text-center text-sm text-red-500 mt-4">
                        <p>‡∏´‡∏≤‡∏Å‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô: <strong>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</strong></p>
                        <p>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</p>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Back Button -->
    <button id="back-button" onclick="goBack()"
        class="fixed top-4 left-4 px-4 py-2 rounded-full bg-white shadow-lg z-10 hidden" title="‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å">
        <div class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-400 mr-1" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            <span class="text-sm text-stone-600">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
        </div>
    </button>

    <div class="form-container mx-auto">
        <div id="api-warning" class="hidden"></div>

        <div id="api-status" class="hidden mt-4 p-3 rounded-lg text-sm"></div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="fixed inset-0 z-40 flex items-center justify-center hidden">
            <div class="absolute inset-0 bg-black opacity-20"></div>
            <div class="bg-white p-6 rounded-xl shadow-xl z-50 flex items-center">
                <div class="loading-spinner mr-3"></div>
                <span class="text-stone-700 font-medium" id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
            </div>
        </div>

        <!-- Message Box -->
        <div id="message-box" class="fixed inset-0 z-50 flex items-center justify-center hidden">
            <div class="absolute inset-0 bg-black opacity-30"></div>
            <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full z-10 border-t-4 border-stone-800">
                <h3 id="message-title" class="text-xl font-bold mb-4 text-stone-800"></h3>
                <p id="message-content" class="mb-6 text-stone-600"></p>
                <button onclick="hideMessageBox()" class="w-full blue-button py-2 rounded-lg">‡∏ï‡∏Å‡∏•‡∏á</button>
            </div>
        </div>

        <!-- MAIN MENU VIEW - UPDATED DESIGN -->
        <div id="main-menu-view" class="space-y-6 relative">
            <!-- added relative so absolute button positions correctly -->
            <!-- Admin floating button (top-right) -->
            <button id="admin-floating-btn" onclick="adminCheckAuthAndInit()" title="‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin)"
                aria-label="Admin"
                class="absolute top-4 right-4 z-50 transform hover:scale-105 transition-transform duration-200"
                style="width:72px; height:72px; border-radius:12px; background: linear-gradient(135deg,#0f766e,#10b981); box-shadow: 0 12px 30px rgba(16,185,129,0.18); display:flex; align-items:center; justify-content:center; flex-direction:column; color:white; border: none;">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="1.6" style="width:34px;height:34px;color:white;">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 11c2.21 0 4-1.79 4-4S14.21 3 12 3 8 4.79 8 7s1.79 4 4 4zM6 20a6 6 0 0112 0" />
                </svg>
                <span
                    style="font-size:11px; margin-top:2px; font-weight:700; color:rgba(255,255,255,0.95);">Admin</span>
            </button>

            <div class="text-center mb-10">
                <h1 class="text-3xl font-extrabold text-stone-800 mb-3">
                    ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£
                </h1>
                <p class="text-lg text-stone-600 mb-2">
                    (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•)
                </p>
                <p class="text-sm text-gray-500">
                    üöÄ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
                </p>
                <div class="flex justify-center space-x-4 mt-4">
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
                        <span class="text-xs text-gray-600">‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded-full bg-blue-500 mr-2"></div>
                        <span class="text-xs text-gray-600">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded-full bg-orange-500 mr-2"></div>
                        <span class="text-xs text-gray-600">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</span>
                    </div>
                </div>
            </div>

            <div class="main-menu-grid">
                <!-- Card 1: Survey Form - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß -->
                <div id="card-sheet-a" class="portal-card-enhanced" onclick="showView('form-menu-view')"
                    style="--card-index: 1;">
                    <div class="card-glow"></div>
                    <div class="card-icon-wrapper">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-green-600" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                    <h2 class="card-title">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°</h2>
                    <p class="card-description">
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏° ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏£‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà
                    </p>
                    <div class="card-badge">
                        ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
                    </div>
                </div>

                <!-- Card 2: Data Management -->
                <div id="card-sheet-b" class="portal-card-enhanced" onclick="checkAuthAndShowSubmenu()"
                    style="--card-index: 2;">
                    <div class="card-glow"></div>
                    <div class="card-icon-wrapper">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-600" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                    </div>
                    <h2 class="card-title">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</h2>
                    <p class="card-description">
                        ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏£ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
                    </p>
                    <div class="card-badge">
                        ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞
                    </div>
                </div>

                <!-- Card 3: Usage Report 4-7-16 -->
                <div id="card-sheet-b-use" class="portal-card-enhanced" onclick="showView('sheet-b-use-view')"
                    style="--card-index: 3;">
                    <div class="card-glow"></div>
                    <div class="card-icon-wrapper">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-orange-600" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 4h8l-1 3H9L8 4z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M7 7h10l1 13H6L7 7z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 11c-2 1-2 3 0 4c2-1 2-3 0-4z" />
                        </svg>
                    </div>
                    <h2 class="card-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</h2>
                    <p class="card-description">
                        <span class="block text-red-500 font-semibold mt-2 text-sm">
                            (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ß‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö)
                        </span>
                    </p>
                    <div class="card-badge">
                        ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                    </div>
                </div>

                <!-- Card 4: Leaf Sample -->
                <div class="portal-card-enhanced" onclick="openLeafSampleForm()"
                    style="--card-index: 4; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);">
                    <div class="card-glow"></div>
                    <div class="card-icon-wrapper"
                        style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-cyan-600" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.27 6.96L12 12.01l8.73-5.05" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 22.08V12" />
                        </svg>
                    </div>
                    <h2 class="card-title">‡∏™‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</h2>
                    <p class="card-description">
                        ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏Å‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
                        <span class="block text-red-500 font-semibold mt-2 text-sm">
                            (‡∏™‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏£)
                        </span>
                    </p>
                    <div class="card-badge"
                        style="background: linear-gradient(135deg, #a5f3fc 0%, #06b6d4 100%); color: #164e63;">
                        ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡πá‡∏ö
                    </div>
                </div>
            </div>

            <!-- Footer note -->
            <div class="text-center mt-12 pt-6 border-t border-gray-200">
                <div class="mb-2 fw-bold">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢‡πÄ‡∏Æ‡∏¥‡∏£‡πå‡∏ö‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡∏à‡∏≥‡∏Å‡∏±‡∏î</div>
                <div class="mb-2">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: <a href="https://line.me/ti/p/LV4OFl3dcU" target="_blank"
                        class="btn btn-success fw-bold mx-1 d-inline-flex align-items-center gap-1"><i
                            class="fab fa-line"></i>
                        ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô QR ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡∏∞‡πÅ‡∏ä‡∏ó‡∏ú‡πà‡∏≤‡∏ô LINE </a> | <a href="tel:0924579929"
                        class="text-warning text-decoration-none fw-bold">092-4579929</a> | <a href="tel:0635033042"
                        class="text-warning text-decoration-none fw-bold">063-5033042</a></div>
            </div>
        </div>

        <!-- FORM MENU VIEW - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
        <div id="form-menu-view" class="space-y-6 hidden">
            <div class="text-center mb-6 md:mb-10">
                <h2 class="text-xl md:text-2xl font-bold text-stone-800 mb-2">‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°</h2>
                <p class="text-sm md:text-base text-stone-600">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</p>
            </div>

            <div class="bg-white rounded-lg md:rounded-xl shadow-lg p-4 md:p-6 max-w-6xl mx-auto">
                <nav class="space-y-3">
                    <!-- =========== START: ‡πÅ‡∏ó‡∏£‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏π‡∏Å‡∏û‡∏∑‡∏ä‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏° =========== -->
                    <div id="survey-form-container"
                        class="bg-white rounded-lg md:rounded-xl shadow-lg p-3 md:p-6 max-w-6xl mx-auto">
                        <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏π‡∏Å‡∏û‡∏∑‡∏ä‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏° -->
                        <div id="formStep" class="main-container">
                            <div class="form-card">
                                <div
                                    class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 md:mb-6 gap-4">
                                    <div class="w-full md:w-auto">
                                        <h1
                                            class="form-title text-lg md:text-xl lg:text-2xl font-bold text-stone-800 mb-2">
                                            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏π‡∏Å‡∏û‡∏∑‡∏ä‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏° ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢‡πÄ‡∏Æ‡∏¥‡∏£‡πå‡∏ö‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡∏à‡∏≥‡∏Å‡∏±‡∏î</h1>
                                        <p class="form-subtitle text-xs md:text-sm text-stone-600 mb-2">15 ‡∏´‡∏°‡∏π‡πà 12 ‡∏ï‡∏≥‡∏ö‡∏•
                                            ‡∏ó‡πà‡∏≤‡∏ö‡∏∏‡∏ç‡∏°‡∏µ
                                            ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‡πÄ‡∏Å‡∏≤‡∏∞‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ 20240</p>
                                        <p class="mb-2 text-xs md:text-sm">
                                            ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:
                                            <a href="https://line.me/ti/p/LV4OFl3dcU" target="_blank"
                                                class="btn btn-success fw-bold mx-1 inline-flex items-center gap-1 text-xs md:text-sm px-2 py-1 md:px-3 md:py-2 bg-green-600 text-white font-semibold rounded">
                                                <i class="bi bi-qr-code"></i> <span class="hidden sm:inline">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô
                                                    QR
                                                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡∏∞‡πÅ‡∏ä‡∏ó‡∏ú‡πà‡∏≤‡∏ô LINE</span><span
                                                    class="sm:hidden">LINE</span>
                                            </a>
                                            | <a href="tel:0924579929"
                                                class="text-green-600 font-semibold">092-4579929</a>
                                            | <a href="tel:0635033042"
                                                class="text-green-600 font-semibold">063-5033042</a>
                                        </p>
                                    </div>
                                    <img src="https://i.postimg.cc/rsL6ZK4T/image.jpg" alt="BTH Logo"
                                        class="h-16 md:h-24 lg:h-32 w-auto object-contain mx-auto md:mx-0">
                                </div>

                                <form id="kratomForm" novalidate>
                                    <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏° -->
                                    <div class="form-section border border-gray-200 rounded-lg p-3 md:p-6 mb-4 md:mb-6">
                                        <h3
                                            class="section-title text-lg md:text-xl font-bold text-stone-800 mb-3 md:mb-4">
                                            <i class="bi bi-geo-alt-fill me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°
                                        </h3>
                                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-12 gap-3 md:gap-4">
                                            <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ -->
                                            <div class="sm:col-span-2 lg:col-span-3">
                                                <label
                                                    class="form-label block font-medium mb-1 text-stone-800">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</label>
                                                <div class="radio-group flex flex-wrap gap-2">
                                                    <input type="radio" id="agent-none" name="farmer_agent" value="none"
                                                        class="hidden" onchange="toggleAgentInput()">
                                                    <label for="agent-none"
                                                        class="px-3 py-2 rounded-lg cursor-pointer border border-gray-300 bg-white text-sm">
                                                        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô
                                                    </label>
                                                    <input type="radio" id="agent-have" name="farmer_agent" value="have"
                                                        class="hidden" onchange="toggleAgentInput()">
                                                    <label for="agent-have"
                                                        class="px-3 py-2 rounded-lg cursor-pointer border border-gray-300 bg-white text-sm">
                                                        ‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô
                                                    </label>
                                                </div>
                                                <input type="text" id="agent-name" name="agent_name"
                                                    placeholder="‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô"
                                                    class="hidden mt-2 w-full px-3 py-2 border border-gray-300 rounded text-sm">
                                            </div>

                                            <!-- ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ -->
                                            <div class="sm:col-span-2 lg:col-span-6">
                                                <label
                                                    class="form-label block font-medium mb-1 text-stone-800">‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•<span
                                                        class="text-red-600">*</span></label>
                                                <div class="grid grid-cols-2 gap-2">
                                                    <input type="text" id="farmer_firstname" name="farmer_firstname"
                                                        class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                        required placeholder="‡∏ä‡∏∑‡πà‡∏≠">
                                                    <input type="text" id="farmer_lastname" name="farmer_lastname"
                                                        class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                        required placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                                                </div>
                                                <!-- hidden legacy field for backward compatibility -->
                                                <input type="hidden" id="farmer_name_main" name="farmer_name_main"
                                                    value="">
                                            </div>

                                            <!-- ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ -->
                                            <div class="sm:col-span-1 lg:col-span-3">
                                                <label for="tel"
                                                    class="form-label block font-medium mb-1 text-stone-800">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£<span
                                                        class="text-red-600">*</span></label>
                                                <input type="tel"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="tel" name="tel" required placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£">
                                            </div>

                                            <!-- ‡∏û‡∏¥‡∏Å‡∏±‡∏î X -->
                                            <div class="sm:col-span-1 lg:col-span-3">
                                                <label for="coord_x"
                                                    class="form-label block font-medium mb-1 text-stone-800">‡∏û‡∏¥‡∏Å‡∏±‡∏î
                                                    X<span class="text-red-600">*</span></label>
                                                <input type="number" step="any"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="coord_x" name="coord_x" required placeholder="‡πÄ‡∏ä‡πà‡∏ô 13.7563">
                                            </div>

                                            <!-- ‡∏û‡∏¥‡∏Å‡∏±‡∏î Y -->
                                            <div class="sm:col-span-1 lg:col-span-3">
                                                <label for="coord_y"
                                                    class="form-label block font-medium mb-1 text-stone-800">‡∏û‡∏¥‡∏Å‡∏±‡∏î
                                                    Y<span class="text-red-600">*</span></label>
                                                <input type="number" step="any"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="coord_y" name="coord_y" required placeholder="‡πÄ‡∏ä‡πà‡∏ô 100.5018">
                                            </div>

                                            <!-- ‡∏ï‡∏≥‡∏ö‡∏• -->
                                            <div class="sm:col-span-1 lg:col-span-2">
                                                <label for="subdistrict"
                                                    class="form-label block font-medium mb-1 text-stone-800">‡∏ï‡∏≥‡∏ö‡∏•<span
                                                        class="text-red-600">*</span></label>
                                                <input type="text"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="subdistrict" name="subdistrict" required placeholder="‡∏ï‡∏≥‡∏ö‡∏•">
                                            </div>

                                            <!-- ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ -->
                                            <div class="sm:col-span-1 lg:col-span-2">
                                                <label for="district"
                                                    class="form-label block font-medium mb-1 text-stone-800">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠<span
                                                        class="text-red-600">*</span></label>
                                                <input type="text"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="district" name="district" required placeholder="‡∏≠‡∏≥‡πÄ‡∏†‡∏≠">
                                            </div>

                                            <!-- ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î -->
                                            <div class="sm:col-span-1 lg:col-span-2">
                                                <label for="province"
                                                    class="form-label block font-medium mb-1 text-stone-800">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î<span
                                                        class="text-red-600">*</span></label>
                                                <input type="text"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="province" name="province" required placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î">
                                            </div>

                                            <!-- ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô -->
                                            <div class="sm:col-span-2 lg:col-span-12">
                                                <label for="land_evidence"
                                                    class="form-label block font-medium mb-1 text-stone-800">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô</label>
                                                <select id="land_evidence" name="land_evidence"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base">
                                                    <option value="">-- ‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô --</option>
                                                    <option value="‡πÇ‡∏â‡∏ô‡∏î‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô (‡∏ô.‡∏™. 4 ‡∏à.)">‡πÇ‡∏â‡∏ô‡∏î‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô (‡∏ô.‡∏™. 4 ‡∏à.)
                                                    </option>
                                                    <option value="‡∏ô.‡∏™. 3 (‡∏Ñ‡∏£‡∏∏‡∏ë‡∏î‡∏≥)">‡∏ô.‡∏™. 3 (‡∏Ñ‡∏£‡∏∏‡∏ë‡∏î‡∏≥)</option>
                                                    <option value="‡∏ô.‡∏™. 3 ‡∏Å. (‡∏Ñ‡∏£‡∏∏‡∏ë‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß)">‡∏ô.‡∏™. 3 ‡∏Å. (‡∏Ñ‡∏£‡∏∏‡∏ë‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß)</option>
                                                    <option value="‡∏ô.‡∏™. 3 ‡∏Ç. (‡∏Ñ‡∏£‡∏∏‡∏ë‡∏î‡∏≥)">‡∏ô.‡∏™. 3 ‡∏Ç. (‡∏Ñ‡∏£‡∏∏‡∏ë‡∏î‡∏≥)</option>
                                                    <option value="‡∏™.‡∏õ.‡∏Å. 4-01">‡∏™.‡∏õ.‡∏Å. 4-01</option>
                                                    <option value="‡πÉ‡∏ö‡∏à‡∏≠‡∏á (‡∏ô.‡∏™. 2)">‡πÉ‡∏ö‡∏à‡∏≠‡∏á (‡∏ô.‡∏™. 2)</option>
                                                    <option value="‡∏†.‡∏î.‡∏™.">‡∏†.‡∏î.‡∏™.</option>
                                                    <option value="‡∏†.‡∏ö.‡∏ó. 5">‡∏†.‡∏ö.‡∏ó. 5</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div
                                            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-12 gap-3 md:gap-4 mt-3 md:mt-4">
                                            <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
                                            <div class="sm:col-span-1 lg:col-span-3">
                                                <label for="tree_count"
                                                    class="form-label block font-medium mb-1 text-stone-800">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î<span
                                                        class="text-red-600">*</span></label>
                                                <input type="number"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="tree_count" name="tree_count" required placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô">
                                            </div>

                                            <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏π‡∏Å -->
                                            <div class="sm:col-span-1 lg:col-span-6">
                                                <label for="plant_date"
                                                    class="form-label block font-medium mb-1 text-stone-800">‡∏ß/‡∏î/‡∏õ
                                                    ‡∏õ‡∏•‡∏π‡∏Å‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤<span class="text-red-600">*</span></label>
                                                <input type="text"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="plant_date" name="plant_date" required
                                                    placeholder="‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ ‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏π‡∏Å (D/M/YYYY)">
                                            </div>

                                            <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á -->
                                            <div class="sm:col-span-1 lg:col-span-3">
                                                <label for="ready_to_sell_count"
                                                    class="form-label block font-medium mb-1 text-stone-800">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á<span
                                                        class="text-red-600">*</span></label>
                                                <input type="number"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="ready_to_sell_count" name="ready_to_sell_count" required
                                                    placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á -->
                                    <div class="form-section border border-gray-200 rounded-lg p-3 md:p-6 mb-4 md:mb-6">
                                        <h3
                                            class="section-title text-lg md:text-xl font-bold text-stone-800 mb-3 md:mb-4">
                                            <i class="bi bi-tools me-2"></i>‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á
                                        </h3>
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                                            <!-- ‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥ -->
                                            <div>
                                                <label class="form-label block font-medium mb-1 text-stone-800">
                                                    ‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥ <small
                                                        class="text-gray-500">(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏ô‡∏∂‡πà‡∏á)</small>
                                                </label>
                                                <div class="flex flex-col gap-2">
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="water_rain"
                                                            name="water_system[]" value="‡∏ô‡πâ‡∏≥‡∏ù‡∏ô">
                                                        <label for="water_rain"
                                                            class="cursor-pointer text-sm">‡∏ô‡πâ‡∏≥‡∏ù‡∏ô</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="water_natural"
                                                            name="water_system[]" value="‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥">
                                                        <label for="water_natural"
                                                            class="cursor-pointer text-sm">‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="water_reservoir"
                                                            name="water_system[]" value="‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡∏±‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡∏ô‡πâ‡∏≥">
                                                        <label for="water_reservoir"
                                                            class="cursor-pointer text-sm">‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡∏±‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡∏ô‡πâ‡∏≥</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="water_irrigation"
                                                            name="water_system[]" value="‡∏ä‡∏•‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô">
                                                        <label for="water_irrigation"
                                                            class="cursor-pointer text-sm">‡∏ä‡∏•‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="water_ground"
                                                            name="water_system[]" value="‡∏ô‡πâ‡∏≥‡∏ö‡∏≤‡∏î‡∏≤‡∏•">
                                                        <label for="water_ground"
                                                            class="cursor-pointer text-sm">‡∏ô‡πâ‡∏≥‡∏ö‡∏≤‡∏î‡∏≤‡∏•</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="water_sprinkler"
                                                            name="water_system[]" value="‡∏™‡∏õ‡∏£‡∏¥‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå">
                                                        <label for="water_sprinkler"
                                                            class="cursor-pointer text-sm">‡∏™‡∏õ‡∏£‡∏¥‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="water_other"
                                                            name="water_system[]" value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ"
                                                            data-other-target="water_other_text">
                                                        <label for="water_other" class="cursor-pointer text-sm">‡∏≠‡∏∑‡πà‡∏ô‡πÜ
                                                            (‡∏£‡∏∞‡∏ö‡∏∏)</label>
                                                    </div>
                                                </div>
                                                <input type="text" id="water_other_text"
                                                    class="form-control mt-2 hidden w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                    placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏≠‡∏∑‡πà‡∏ô‡πÜ">
                                                <label for="water_ph"
                                                    class="form-label block font-medium mt-3 mb-1 text-stone-800">‡∏Ñ‡πà‡∏≤ PH
                                                    ‡∏ô‡πâ‡∏≥</label>
                                                <input type="text"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="water_ph" name="water_ph" placeholder="‡∏Ñ‡πà‡∏≤ PH ‡∏ô‡πâ‡∏≥">
                                            </div>

                                            <!-- ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πã‡∏¢ -->
                                            <div>
                                                <label class="form-label block font-medium mb-1 text-stone-800">
                                                    ‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πã‡∏¢ <small
                                                        class="text-gray-500">(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏ô‡∏∂‡πà‡∏á)</small>
                                                </label>
                                                <div class="flex flex-col gap-2">
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="fert_organic"
                                                            name="fertilizer_method[]" value="‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå">
                                                        <label for="fert_organic"
                                                            class="cursor-pointer text-sm">‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="fert_chemical"
                                                            name="fertilizer_method[]" value="‡∏õ‡∏∏‡πã‡∏¢‡πÄ‡∏Ñ‡∏°‡∏µ">
                                                        <label for="fert_chemical"
                                                            class="cursor-pointer text-sm">‡∏õ‡∏∏‡πã‡∏¢‡πÄ‡∏Ñ‡∏°‡∏µ</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="fert_manure"
                                                            name="fertilizer_method[]" value="‡∏õ‡∏∏‡πã‡∏¢‡∏Ñ‡∏≠‡∏Å">
                                                        <label for="fert_manure"
                                                            class="cursor-pointer text-sm">‡∏õ‡∏∏‡πã‡∏¢‡∏Ñ‡∏≠‡∏Å</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="fert_bio"
                                                            name="fertilizer_method[]" value="‡∏õ‡∏∏‡πã‡∏¢‡∏ä‡∏µ‡∏ß‡∏†‡∏≤‡∏û">
                                                        <label for="fert_bio"
                                                            class="cursor-pointer text-sm">‡∏õ‡∏∏‡πã‡∏¢‡∏ä‡∏µ‡∏ß‡∏†‡∏≤‡∏û</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="fert_organic_chemical"
                                                            name="fertilizer_method[]" value="‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå‡πÄ‡∏Ñ‡∏°‡∏µ">
                                                        <label for="fert_organic_chemical"
                                                            class="cursor-pointer text-sm">‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå‡πÄ‡∏Ñ‡∏°‡∏µ</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="fert_other"
                                                            name="fertilizer_method[]" value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ"
                                                            data-other-target="fert_other_text">
                                                        <label for="fert_other" class="cursor-pointer text-sm">‡∏≠‡∏∑‡πà‡∏ô‡πÜ
                                                            (‡∏£‡∏∞‡∏ö‡∏∏)</label>
                                                    </div>
                                                </div>
                                                <input type="text" id="fert_other_text"
                                                    class="form-control mt-2 hidden w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                    placeholder="‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ">
                                                <label for="soil_ph"
                                                    class="form-label block font-medium mt-3 mb-1 text-stone-800">‡∏Ñ‡πà‡∏≤ PH
                                                    ‡∏î‡∏¥‡∏ô</label>
                                                <input type="text"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="soil_ph" name="soil_ph" placeholder="‡∏Ñ‡πà‡∏≤ PH ‡∏î‡∏¥‡∏ô">
                                            </div>

                                            <!-- ‡∏Æ‡∏≠‡∏£‡πå‡πÇ‡∏°‡∏ô / ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏ß‡∏°‡πÅ‡∏£‡πà‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡πÑ‡∏ü ‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà) -->
                                            <div>
                                                <label
                                                    class="form-label block font-medium mb-1 text-stone-800">‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏î‡∏¥‡∏ô</label>

                                                <!-- ‡∏¢‡πâ‡∏≤‡∏¢ '‡πÅ‡∏£‡πà‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡πÑ‡∏ü' ‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ -->
                                                <div class="flex items-center mb-2">
                                                    <input class="mr-2" type="checkbox" id="mineral_volcanic"
                                                        name="mineral_options[]" value="‡πÅ‡∏£‡πà‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡πÑ‡∏ü">
                                                    <label for="mineral_volcanic"
                                                        class="cursor-pointer text-sm">‡πÅ‡∏£‡πà‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡πÑ‡∏ü</label>
                                                </div>
                                                <label for="hormone_and_other"
                                                    class="form-label block font-medium mb-1 text-stone-800">‡∏Æ‡∏≠‡∏£‡πå‡πÇ‡∏°‡∏ô /
                                                    ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</label>

                                                <!-- ‡∏£‡∏ß‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏Æ‡∏≠‡∏£‡πå‡πÇ‡∏°‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß -->
                                                <input type="text"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base mb-3"
                                                    id="hormone_and_other" name="hormone_and_other"
                                                    placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Æ‡∏≠‡∏£‡πå‡πÇ‡∏°‡∏ô‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏§‡∏î‡∏π‡∏Å‡∏≤‡∏• -->
                                    <div class="form-section border border-gray-200 rounded-lg p-3 md:p-6 mb-4 md:mb-6">
                                        <h3
                                            class="section-title text-lg md:text-xl font-bold text-stone-800 mb-3 md:mb-4">
                                            <i class="bi bi-cloud-rain me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏§‡∏î‡∏π‡∏Å‡∏≤‡∏• ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏π‡∏Å
                                        </h3>
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">

                                            <!-- ‡∏§‡∏î‡∏π‡πÅ‡∏•‡πâ‡∏á -->
                                            <div>
                                                <label
                                                    class="form-label block font-bold mb-1 text-stone-800">‡∏ä‡πà‡∏ß‡∏á‡∏§‡∏î‡∏π‡πÅ‡∏•‡πâ‡∏á</label>
                                                <select
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base mb-2"
                                                    name="dry_start_month" id="dry_start_month">
                                                    <option value="">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</option>
                                                    <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                                                    <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                                                    <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                                                    <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                                                    <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                                                    <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                                                </select>
                                                <select
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    name="dry_end_month" id="dry_end_month">
                                                    <option value="">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</option>
                                                    <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                                                    <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                                                    <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                                                    <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                                                    <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                                                    <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                                                </select>
                                            </div>

                                            <!-- ‡∏§‡∏î‡∏π‡∏ù‡∏ô -->
                                            <div>
                                                <label
                                                    class="form-label block font-bold mb-1 text-stone-800">‡∏ä‡πà‡∏ß‡∏á‡∏§‡∏î‡∏π‡∏ù‡∏ô</label>
                                                <select
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base mb-2"
                                                    name="rainy_start_month" id="rainy_start_month">
                                                    <option value="">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</option>
                                                    <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                                                    <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                                                    <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                                                    <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                                                    <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                                                    <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                                                </select>
                                                <select
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    name="rainy_end_month" id="rainy_end_month">
                                                    <option value="">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</option>
                                                    <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                                                    <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                                                    <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                                                    <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                                                    <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                                                    <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                                                </select>
                                            </div>

                                            <!-- ‡∏§‡∏î‡∏π‡∏´‡∏ô‡∏≤‡∏ß -->
                                            <div>
                                                <label
                                                    class="form-label block font-bold mb-1 text-stone-800">‡∏ä‡πà‡∏ß‡∏á‡∏§‡∏î‡∏π‡∏´‡∏ô‡∏≤‡∏ß</label>
                                                <select
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base mb-2"
                                                    name="winter_start_month" id="winter_start_month">
                                                    <option value="">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</option>
                                                    <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                                                    <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                                                    <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                                                    <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                                                    <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                                                    <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                                                </select>
                                                <select
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    name="winter_end_month" id="winter_end_month">
                                                    <option value="">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</option>
                                                    <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                                                    <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                                                    <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                                                    <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                                                    <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                                                    <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                                                    <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏π‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤ -->
                                    <div class="form-section border border-gray-200 rounded-lg p-3 md:p-6 mb-4 md:mb-6">
                                        <h3
                                            class="section-title text-lg md:text-xl font-bold text-stone-800 mb-3 md:mb-4">
                                            <i class="bi bi-file-earmark-check me-2"></i>‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏π‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤
                                        </h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                                            <!-- GAP ‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£ -->
                                            <div>
                                                <label class="form-label block font-bold mb-1 text-stone-800">
                                                    ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• GAP ‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£<span class="text-red-600">*</span>
                                                </label>
                                                <div class="flex flex-col gap-2">
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="radio" name="gap_status" id="gap_yes"
                                                            value="yes" onchange="toggleDateRange('gap', true)">
                                                        <label for="gap_yes" class="cursor-pointer">‡∏°‡∏µ</label>
                                                    </div>
                                                    <div id="gap-date-range" class="mt-2 hidden">
                                                        <label
                                                            class="form-label block text-sm mb-1 text-stone-800">‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                                                            ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏</label>
                                                        <div class="grid grid-cols-2 gap-2">
                                                            <div>
                                                                <input type="date"
                                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                                    name="gap_start_date" id="gap_start_date"
                                                                    placeholder="‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô">
                                                            </div>
                                                            <div>
                                                                <input type="date"
                                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                                    name="gap_end_date" id="gap_end_date"
                                                                    placeholder="‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="radio" name="gap_status" id="gap_no"
                                                            value="no" onchange="toggleDateRange('gap', false)">
                                                        <label for="gap_no" class="cursor-pointer">‡πÑ‡∏°‡πà‡∏°‡∏µ</label>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- GACP ‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£ -->
                                            <div>
                                                <label class="form-label block font-bold mb-1 text-stone-800">
                                                    ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• GACP ‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£<span class="text-red-600">*</span>
                                                </label>
                                                <div class="flex flex-col gap-2">
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="radio" name="gacp_status"
                                                            id="gacp_yes" value="yes"
                                                            onchange="toggleDateRange('gacp', true)">
                                                        <label for="gacp_yes" class="cursor-pointer">‡∏°‡∏µ</label>
                                                    </div>
                                                    <div id="gacp-date-range" class="mt-2 hidden">
                                                        <label
                                                            class="form-label block text-sm mb-1 text-stone-800">‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                                                            ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏</label>
                                                        <div class="grid grid-cols-2 gap-2">
                                                            <div>
                                                                <input type="date"
                                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                                    name="gacp_start_date" id="gacp_start_date">
                                                            </div>
                                                            <div>
                                                                <input type="date"
                                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                                    name="gacp_end_date" id="gacp_end_date">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="radio" name="gacp_status" id="gacp_no"
                                                            value="no" onchange="toggleDateRange('gacp', false)">
                                                        <label for="gacp_no" class="cursor-pointer">‡πÑ‡∏°‡πà‡∏°‡∏µ</label>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- ‡∏Ñ‡∏π‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤ -->
                                            <div class="md:col-span-2">
                                                <label class="form-label block font-bold mt-3 mb-1 text-stone-800">
                                                    ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Ñ‡∏π‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤<span class="text-red-600">*</span>
                                                </label>
                                                <div class="flex flex-col gap-2">
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="radio" name="contract_status"
                                                            id="contract_yes" value="old">
                                                        <label for="contract_yes"
                                                            class="cursor-pointer">‡∏ï‡∏¥‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏Å‡πà‡∏≤</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="radio" name="contract_status"
                                                            id="contract_no" value="none">
                                                        <label for="contract_no"
                                                            class="cursor-pointer">‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏Å‡πà‡∏≤</label>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="mt-3">
                                                <label class="form-label block font-medium mb-1 text-stone-800">
                                                    ‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏£‡πÑ‡∏°‡∏ó‡∏£‡∏≤‡πÑ‡∏à‡∏ô‡∏µ‡∏ô <span class="text-red-600">*</span>
                                                </label>
                                                <div class="flex flex-col gap-2">
                                                    <div class="flex items-center">
                                                        <input class="mr-2 substance-cb" type="checkbox"
                                                            id="substance_checked" name="substance_status"
                                                            value="checked">
                                                        <label for="substance_checked"
                                                            class="cursor-pointer text-sm">‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏£</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2 substance-cb" type="checkbox"
                                                            id="substance_not_checked" name="substance_status"
                                                            value="not_checked">
                                                        <label for="substance_not_checked"
                                                            class="cursor-pointer text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏£</label>
                                                    </div>
                                                </div>
                                                <div id="substanceValueBox" class="mt-3 hidden">
                                                    <label for="substance_value"
                                                        class="form-label block font-medium mb-1 text-stone-800">
                                                        ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏£‡πÑ‡∏°‡∏ó‡∏£‡∏≤‡πÑ‡∏à‡∏ô‡∏µ‡∏ô
                                                    </label>
                                                    <input type="number" step="any"
                                                        class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                        id="substance_value" name="substance_value"
                                                        placeholder="‡πÄ‡∏ä‡πà‡∏ô 1.25">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏° -->
                                    <div class="form-section border border-gray-200 rounded-lg p-3 md:p-6 mb-4 md:mb-6">
                                        <h3
                                            class="section-title text-lg md:text-xl font-bold text-stone-800 mb-3 md:mb-4">
                                            <i class="bi bi-trophy-fill me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°
                                        </h3>

                                        <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏° -->
                                        <div class="mb-4">
                                            <label
                                                class="form-label block font-bold mb-1 text-stone-800">‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°</label>
                                            <div class="flex flex-wrap gap-3">
                                                <div class="flex items-center">
                                                    <input class="mr-2 stem-cb" type="checkbox" value="red"
                                                        id="stem_red" name="stem_selector">
                                                    <label for="stem_red" class="cursor-pointer text-sm">‡∏Å‡πâ‡∏≤‡∏ô‡πÅ‡∏î‡∏á</label>
                                                </div>
                                                <div class="flex items-center">
                                                    <input class="mr-2 stem-cb" type="checkbox" value="white"
                                                        id="stem_white" name="stem_selector">
                                                    <label for="stem_white"
                                                        class="cursor-pointer text-sm">‡∏Å‡πâ‡∏≤‡∏ô‡∏Ç‡∏≤‡∏ß</label>
                                                </div>
                                                <div class="flex items-center">
                                                    <input class="mr-2 stem-cb" type="checkbox" value="green"
                                                        id="stem_green" name="stem_selector">
                                                    <label for="stem_green"
                                                        class="cursor-pointer text-sm">‡∏Å‡πâ‡∏≤‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß</label>
                                                </div>
                                                <div class="flex items-center">
                                                    <input class="mr-2 stem-cb" type="checkbox" value="cross"
                                                        id="stem_cross" name="stem_selector">
                                                    <label for="stem_cross"
                                                        class="cursor-pointer text-sm">‡∏Ç‡πâ‡∏≤‡∏°‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå</label>
                                                </div>
                                                <div class="flex items-center">
                                                    <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° data-other-target ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö textarea #other_varieties -->
                                                    <input class="mr-2 stem-cb" type="checkbox" value="other"
                                                        id="stem_other" name="stem_selector"
                                                        data-other-target="other_varieties">
                                                    <label for="stem_other" class="cursor-pointer text-sm">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</label>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- ‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠ (‡∏Ç‡πâ‡∏≤‡∏°‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå / ‡∏≠‡∏∑‡πà‡∏ô‡πÜ) -->
                                        <div id="special-name" class="hidden mb-4">
                                            <label
                                                class="form-label block font-bold mb-1 text-stone-800">‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå
                                                (‡∏Ç‡πâ‡∏≤‡∏°‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå)</label>
                                            <input type="text"
                                                class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                name="special_species_name" id="special_species_name"
                                                placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå">
                                        </div>

                                        <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' ‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå ‡πÅ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≤‡∏°‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå -->
                                        <div class="mb-4">
                                            <label class="form-label block font-bold mb-1 text-stone-800">‡∏≠‡∏∑‡πà‡∏ô‡πÜ
                                                (‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÜ
                                                ‡∏ó‡∏µ‡πà‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</label>
                                            <!-- ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏ß‡πâ ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ checkbox ‡∏ä‡∏∑‡πà‡∏≠ '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' ‡∏ñ‡∏π‡∏Å‡∏ï‡∏¥‡πä‡∏Å (data-other-target) -->
                                            <textarea id="other_varieties" name="other_varieties"
                                                class="hidden w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                rows="2"
                                                placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≠‡∏°‡∏°‡πà‡∏≤ ‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1)"></textarea>
                                        </div>

                                        <!-- container ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡πâ‡∏≤‡∏ô -->
                                        <div id="stem-sections"></div>

                                        <!-- ‡∏£‡∏ß‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
                                        <div class="mt-4 w-full md:w-1/2">
                                            <label
                                                class="form-label block font-bold mb-1 text-stone-800">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå</label>
                                            <input type="number"
                                                class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base bg-gray-50"
                                                id="total_tree_count" readonly>
                                        </div>
                                    </div>

                                    <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 3‡∏õ‡∏µ -->
                                    <div class="form-section border border-gray-200 rounded-lg p-3 md:p-6 mb-4 md:mb-6">
                                        <h3
                                            class="section-title text-lg md:text-xl font-bold text-stone-800 mb-3 md:mb-4">
                                            <i class="bi bi-list-ol me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 3‡∏õ‡∏µ
                                        </h3>
                                        <div class="flex flex-wrap gap-2">
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_empty"
                                                    name="past_land_types[]" value="‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡πà‡∏≤">
                                                <label for="past_empty"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡πà‡∏≤</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_fruit_garden"
                                                    name="past_land_types[]" value="‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏™‡∏ß‡∏ô‡∏ú‡∏•‡πÑ‡∏°‡πâ">
                                                <label for="past_fruit_garden"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏™‡∏ß‡∏ô‡∏ú‡∏•‡πÑ‡∏°‡πâ</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_rice"
                                                    name="past_land_types[]" value="‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏ô‡∏≤">
                                                <label for="past_rice"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏ô‡∏≤</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_vegetable"
                                                    name="past_land_types[]" value="‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á‡∏û‡∏∑‡∏ä‡∏ú‡∏±‡∏Å">
                                                <label for="past_vegetable"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á‡∏û‡∏∑‡∏ä‡∏ú‡∏±‡∏Å</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_fill"
                                                    name="past_land_types[]" value="‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô‡∏ñ‡∏°‡πÉ‡∏´‡∏°‡πà">
                                                <label for="past_fill"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô‡∏ñ‡∏°‡πÉ‡∏´‡∏°‡πà</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_mixed"
                                                    name="past_land_types[]" value="‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏ú‡∏™‡∏°‡∏ú‡∏™‡∏≤‡∏ô">
                                                <label for="past_mixed"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏ú‡∏™‡∏°‡∏ú‡∏™‡∏≤‡∏ô</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_pond"
                                                    name="past_land_types[]" value="‡∏™‡∏£‡∏∞‡∏ô‡πâ‡∏≥">
                                                <label for="past_pond"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">‡∏™‡∏£‡∏∞‡∏ô‡πâ‡∏≥</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_forest"
                                                    name="past_land_types[]" value="‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡πà‡∏≤">
                                                <label for="past_forest"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡πà‡∏≤</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_mangrove"
                                                    name="past_land_types[]" value="‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡πà‡∏≤‡∏ä‡∏≤‡∏¢‡πÄ‡∏•‡∏ô">
                                                <label for="past_mangrove"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡πà‡∏≤‡∏ä‡∏≤‡∏¢‡πÄ‡∏•‡∏ô</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_other"
                                                    name="past_land_types[]" value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ"
                                                    data-other-target="past_other_text">
                                                <label for="past_other"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">‡∏≠‡∏∑‡πà‡∏ô‡πÜ
                                                    (‡∏£‡∏∞‡∏ö‡∏∏)</label>
                                            </div>
                                        </div>
                                        <input type="text" id="past_other_text"
                                            class="form-control mt-2 hidden w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                            placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 3 ‡∏õ‡∏µ)">
                                    </div>

                                    <!-- ‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô -->
                                    <div class="form-section border border-gray-200 rounded-lg p-3 md:p-6 mb-4 md:mb-6">
                                        <h3
                                            class="section-title text-lg md:text-xl font-bold text-stone-800 mb-3 md:mb-4">
                                            <i class="bi bi-person-lines-fill me-2"></i>‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô
                                        </h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label for="coordinator_name"
                                                    class="form-label block font-medium mb-1 text-stone-800">‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô<span
                                                        class="text-red-600">*</span></label>
                                                <input type="text"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="coordinator_name" name="coordinator_name" required
                                                    placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô">
                                            </div>
                                            <div>
                                                <label for="coordinator_tel"
                                                    class="form-label block font-medium mb-1 text-stone-800">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô<span
                                                        class="text-red-600">*</span></label>
                                                <input type="tel"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="coordinator_tel" name="coordinator_tel" required
                                                    placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
                                    <div class="text-center mt-6">
                                        <button type="button" id="nextBtn"
                                            class="btn btn-primary bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold text-sm md:text-base">
                                            <i class="bi bi-eye-fill me-2"></i>‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Preview Step (hidden initially) -->
                        <div id="previewStep" class="main-container hidden">
                            <div class="form-card">
                                <h2 class="form-title text-lg md:text-xl lg:text-2xl font-bold text-stone-800 mb-2">
                                    <i
                                        class="bi bi-search me-2 text-red-600"></i>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏£‡∏¥‡∏á‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°
                                </h2>
                                <p class="form-subtitle text-sm md:text-base text-stone-600 mb-4 md:mb-6">
                                    ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏™‡πà‡∏á</p>

                                <div id="previewCard" class="p-4 border rounded-lg bg-gray-50 mb-6">
                                    <p class="text-gray-500 text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á...</p>
                                </div>

                                <div class="flex flex-col sm:flex-row justify-between gap-4">
                                    <button id="backBtn"
                                        class="btn btn-secondary bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-semibold text-sm md:text-base">
                                        <i class="bi bi-arrow-left-circle-fill me-2"></i>‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                                    </button>
                                    <button id="submitBtn"
                                        class="btn btn-primary bg-gradient-to-b from-green-600 to-green-800 hover:from-green-700 hover:to-green-900 text-white px-6 py-3 rounded-lg font-semibold text-sm md:text-base shadow-lg">
                                        <i class="bi bi-cloud-upload-fill me-2"></i>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- =========== END: ‡πÅ‡∏ó‡∏£‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏π‡∏Å‡∏û‡∏∑‡∏ä‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏° =========== -->

                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏¢‡∏≤‡∏¢‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏° -->
                    <button onclick="openExpansionForm()"
                        class="w-full text-left p-4 rounded-lg font-semibold text-gray-700 hover:bg-green-50 hover:border-green-300 transition duration-200 border-2 border-gray-200 flex items-center group">
                        <div
                            class="flex items-center justify-center h-10 w-10 md:h-12 md:w-12 bg-green-100 rounded-lg mr-3 md:mr-4 group-hover:bg-green-200 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 md:h-6 md:w-6 text-green-600"
                                fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                            </svg>
                        </div>
                        <div class="flex-grow">
                            <div class="text-sm md:text-base font-bold text-stone-800">2.
                                ‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏¢‡∏≤‡∏¢‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°</div>
                            <div class="text-xs text-red-500 mt-1">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏¢‡∏≤‡∏¢‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°</div>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 group-hover:text-green-600"
                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>

                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö -->
                    <div class="mt-6 pt-4 border-t border-gray-200 text-center">
                        <button onclick="showView('form-menu-view')"
                            class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm transition duration-200">
                            <i class="bi bi-arrow-left me-1"></i>‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                        </button>
                    </div>
                </nav>

                <!-- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ -->
                <div class="mt-6 pt-4 border-t border-gray-200 text-center">
                    <p class="text-xs text-stone-500">üí° ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠</p>
                </div>
            </div>
        </div>

        <!-- SUBMENU VIEW (‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•) -->
        <div id="submenu-view" class="space-y-6 hidden">
            <header class="mb-10 text-center">
                <div class="flex justify-between items-center mb-4">
                    <button onclick="logout()"
                        class="bg-red-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-600 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                        ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>
                <h2 class="text-2xl font-bold text-stone-800 mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢‡πÄ‡∏Æ‡∏¥‡∏£‡πå‡∏ö ‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡∏à‡∏≥‡∏Å‡∏±‡∏î
                </h2>
                <p class="text-stone-600">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏£‡πà/‡∏ô‡∏≤‡πÇ‡∏ô/‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ</p>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Card A: Sheet A - Farm & Farmer Info -->
                <div class="portal-card cursor-pointer" onclick="showView('sheet-a-view')"
                    style="background: linear-gradient(135deg, #A5C9FF, #dae7ff);">
                    <div class="flex items-center justify-center h-16 w-16 bg-white bg-opacity-30 rounded-full mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-800" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold text-stone-800 mb-2">‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏™‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏£‡πà‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡πÇ‡∏ô‡πÑ‡∏õ‡πÉ‡∏ä‡πâ
                    </h2>
                    <p class="text-sm text-stone-600">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÅ‡∏£‡πà‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡πÇ‡∏ô</p>
                </div>

                <div class="portal-card cursor-pointer" style="background: linear-gradient(135deg, #bbf7d0, #dcfce7);">
                    <div class="flex items-center justify-center h-16 w-16 bg-white bg-opacity-30 rounded-full mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-800" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold text-stone-800 mb-2">‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏•‡πâ‡∏á (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)</h2>
                    <p class="text-sm text-stone-600"></p>
                </div>

                <div class="portal-card cursor-pointer" onclick="showView('sheet-c-view')"
                    style="background: linear-gradient(135deg, #fdba74, #fed7aa);">
                    <div class="flex items-center justify-center h-16 w-16 bg-white bg-opacity-30 rounded-full mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-800" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold text-stone-800 mb-2">‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô</h2>
                    <p class="text-sm text-stone-600">‡∏î‡∏π‡πÅ‡∏•‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</p>
                </div>

                <!-- Card B: Sheet B - Usage Summary -->
                <div class="portal-card cursor-pointer" onclick="showView('sheet-b-view')"
                    style="background: linear-gradient(135deg, #fecaca, #fee2e2);">
                    <div class="flex items-center justify-center h-16 w-16 bg-white bg-opacity-30 rounded-full mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-800" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold text-stone-800 mb-2">‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏£</h2>
                    <p class="text-sm text-stone-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)</p>
                </div>
            </div>
        </div>

        <!-- SHEET A VIEW -->
        <div id="sheet-a-view" class="space-y-6 hidden">
            <div class="w-full pt-6 pb-2 px-6">
                <h2 class="text-2xl font-bold text-stone-700">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÅ‡∏£‡πà‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡πÇ‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£
                </h2>
            </div>
            <form id="sheet-a-form" onsubmit="handleSheetASubmit(event)" class="space-y-6">
                <div class="space-y-4 pt-4 border rounded-lg p-4 bg-stone-50">
                    <h3 class="text-lg font-semibold text-stone-700">‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</h3>
                    <label for="a-long-affiliation" class="block text-sm font-medium mb-1">
                        <span id="long-affiliation-label">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô</span>
                        <span id="auto-selected-label"
                            class="text-green-600 text-sm hidden">(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô)</span>
                    </label>
                    <select id="a-long-affiliation" required class="w-full">
                        <option value="" disabled selected>--- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î ---</option>
                    </select>
                </div>

                <div class="space-y-4 p-4 border rounded-lg">
                    <h3 class="text-lg font-semibold text-stone-700">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏£‡∏±‡∏ö‡πÅ‡∏£‡πà/‡∏ô‡∏≤‡πÇ‡∏ô</h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="a-fullname" class="block text-sm font-medium mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</label>
                            <input type="text" id="a-fullname" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" required class="w-full">
                        </div>
                        <div>
                            <label for="a-phone" class="block text-sm font-medium mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</label>
                            <input type="tel" id="a-phone" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" required pattern="[0-9]{9,15}"
                                class="w-full">
                        </div>
                    </div>

                    <label for="a-id" class="block text-sm font-medium mb-1">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£: ‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏≠‡∏á<span
                            class="text-red-500">(‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á)</span></label>
                    <input type="text" id="a-id" placeholder="‡πÄ‡∏ä‡πà‡∏ô TEST101 ‡∏´‡∏£‡∏∑‡∏≠ Test01N " required>

                    <h3 class="sm font-medium pt-2 border-t border-stone-100 text-stone-700">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="a-address-tambon" class="block text-sm font-medium mb-1">‡∏ï‡∏≥‡∏ö‡∏•</label>
                            <input type="text" id="a-address-tambon" placeholder="‡∏ï‡∏≥‡∏ö‡∏•" class="w-full">
                        </div>
                        <div>
                            <label for="a-address-amphoe" class="block text-sm font-medium mb-1">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label>
                            <input type="text" id="a-address-amphoe" placeholder="‡∏≠‡∏≥‡πÄ‡∏†‡∏≠" class="w-full">
                        </div>
                        <div>
                            <label for="a-address-province" class="block text-sm font-medium mb-1">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
                            <input type="text" id="a-address-province" placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" class="w-full">
                        </div>
                    </div>
                    <textarea id="a-emergency" rows="2" placeholder="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏ó‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"
                        class="w-full"></textarea>
                </div>

                <div class="space-y-4 pt-4 border rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-stone-700">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á</h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="a-gpsx" class="block text-sm font-medium mb-1">‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS: X</label>
                            <input type="text" id="a-gpsx" placeholder="‡πÄ‡∏ä‡πà‡∏ô 13.7563" required class="w-full">
                        </div>
                        <div>
                            <label for="a-gpsy" class="block text-sm font-medium mb-1">‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS: Y</label>
                            <input type="text" id="a-gpsy" placeholder="‡πÄ‡∏ä‡πà‡∏ô 100.5018" required class="w-full">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="a-plotsize"
                                class="block text-sm font-medium mb-1">‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏£‡πà‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡πÇ‡∏ô‡∏à‡∏£‡∏¥‡∏á</label>
                            <input type="number" id="a-plotsize" placeholder="‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏õ‡∏•‡∏á (‡πÑ‡∏£‡πà) " required min="0.1"
                                step="0.1" class="w-full">
                            <small class="text-stone-500">‡∏´‡∏ô‡πà‡∏ß‡∏¢: ‡πÑ‡∏£‡πà</small>
                        </div>
                        <div class="md:col-span-2">
                            <label for="a-cropspecies"
                                class="block text-sm font-medium mb-1">‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡πÅ‡∏£‡πà‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡πÇ‡∏ô</label>
                            <input type="text" id="a-cropspecies" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡πâ‡∏≤‡∏ô‡πÅ‡∏î‡∏á‡∏´‡∏≤‡∏á‡∏Å‡∏±‡πâ‡∏á,4‡∏õ‡∏µ">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥<span
                                class="text-xs text-red-500 ml-2">(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏ô‡∏∂‡πà‡∏á)</span></label>
                        <div class="radio-group flex flex-wrap gap-2">
                            <input type="checkbox" id="water-rain" name="a-watering" value="‡∏ô‡πâ‡∏≥‡∏ù‡∏ô" class="hidden"
                                onchange="toggleOtherWateringInput()">
                            <label for="water-rain" class="px-4 py-2 rounded-lg cursor-pointer">‡∏ô‡πâ‡∏≥‡∏ù‡∏ô</label>

                            <input type="checkbox" id="water-irrigation" name="a-watering" value="‡∏ä‡∏•‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô"
                                class="hidden" onchange="toggleOtherWateringInput()">
                            <label for="water-irrigation" class="px-4 py-2 rounded-lg cursor-pointer">‡∏ä‡∏•‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô</label>

                            <input type="checkbox" id="water-ground" name="a-watering" value="‡∏ô‡πâ‡∏≥‡∏ö‡∏≤‡∏î‡∏≤‡∏•" class="hidden"
                                onchange="toggleOtherWateringInput()">
                            <label for="water-ground" class="px-4 py-2 rounded-lg cursor-pointer">‡∏ô‡πâ‡∏≥‡∏ö‡∏≤‡∏î‡∏≤‡∏•</label>

                            <input type="checkbox" id="water-sprinkler" name="a-watering" value="‡∏™‡∏õ‡∏£‡∏¥‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå"
                                class="hidden" onchange="toggleOtherWateringInput()">
                            <label for="water-sprinkler" class="px-4 py-2 rounded-lg cursor-pointer">‡∏™‡∏õ‡∏£‡∏¥‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå</label>

                            <input type="checkbox" id="water-other" name="a-watering" value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ" class="hidden"
                                onchange="toggleOtherWateringInput()">
                            <label for="water-other" class="px-4 py-2 rounded-lg cursor-pointer">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏)</label>
                        </div>
                        <input type="text" id="a-watering-other-text"
                            placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏£‡∏∞‡∏ô‡πâ‡∏≥, ‡∏ô‡πâ‡∏≥‡∏à‡∏≤‡∏Å‡∏ö‡πà‡∏≠‡∏û‡∏±‡∏Å)" class="hidden mt-2 w-full">
                    </div>

                    <div>
                        <h3 class="text-sm font-medium mb-1 pt-2 border-t border-stone-100 text-stone-700">
                            ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πã‡∏¢<span class="text-xs text-red-500 ml-2">(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏ô‡∏∂‡πà‡∏á)</span></label>
                            <div class="radio-group flex flex-wrap gap-2">
                                <input type="checkbox" id="fert-organic" name="a-fertilizer-method" value="‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå"
                                    class="hidden" onchange="toggleOtherFertilizerInput()">
                                <label for="fert-organic"
                                    class="px-4 py-2 rounded-lg cursor-pointer">‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå</label>

                                <input type="checkbox" id="fert-chemical" name="a-fertilizer-method" value="‡∏õ‡∏∏‡πã‡∏¢‡πÄ‡∏Ñ‡∏°‡∏µ"
                                    class="hidden" onchange="toggleOtherFertilizerInput()">
                                <label for="fert-chemical" class="px-4 py-2 rounded-lg cursor-pointer">‡∏õ‡∏∏‡πã‡∏¢‡πÄ‡∏Ñ‡∏°‡∏µ</label>

                                <input type="checkbox" id="fert-manure" name="a-fertilizer-method" value="‡∏õ‡∏∏‡πã‡∏¢‡∏Ñ‡∏≠‡∏Å"
                                    class="hidden" onchange="toggleOtherFertilizerInput()">
                                <label for="fert-manure" class="px-4 py-2 rounded-lg cursor-pointer">‡∏õ‡∏∏‡πã‡∏¢‡∏Ñ‡∏≠‡∏Å</label>

                                <input type="checkbox" id="fert-volcanic" name="a-fertilizer-method" value="‡πÅ‡∏£‡πà‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡πÑ‡∏ü"
                                    class="hidden" onchange="toggleOtherFertilizerInput()">
                                <label for="fert-volcanic"
                                    class="px-4 py-2 rounded-lg cursor-pointer">‡πÅ‡∏£‡πà‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡πÑ‡∏ü</label>

                                <input type="checkbox" id="fert-other" name="a-fertilizer-method" value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ"
                                    class="hidden" onchange="toggleOtherFertilizerInput()">
                                <label for="fert-other" class="px-4 py-2 rounded-lg cursor-pointer">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏)</label>
                            </div>
                            <input type="text" id="a-fertilizer-other-text"
                                placeholder="‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏∏‡πã‡∏¢‡∏ô‡πâ‡∏≥‡∏ä‡∏µ‡∏ß‡∏†‡∏≤‡∏û, ‡∏õ‡∏∏‡πã‡∏¢‡∏ä‡∏µ‡∏ß‡∏†‡∏≤‡∏û)"
                                class="hidden mt-2 w-full">
                    </div>
                </div>

                <div class="space-y-4 pt-4 border rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-stone-700">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÅ‡∏£‡πà‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡πÇ‡∏ô</h3>

                    <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏£‡∏±‡∏ö‡πÅ‡∏£‡πà -->
                    <div class="border rounded-lg p-4 bg-purple-50">
                        <h4 class="font-semibold text-purple-800 mb-3">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÅ‡∏£‡πà‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="a-long-receive-mineral-date"
                                    class="block text-sm font-medium mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏£‡∏±‡∏ö‡πÅ‡∏£‡πà‡∏à‡∏≤‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</label>
                                <input type="date" id="a-long-receive-mineral-date" required class="w-full">
                            </div>
                            <div>
                                <label for="a-long-receive-mineral-amount"
                                    class="block text-sm font-medium mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏£‡πà‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏£‡∏±‡∏ö‡πÑ‡∏õ (‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö)</label>
                                <input type="number" id="a-long-receive-mineral-amount" required min="1" step="1"
                                    class="w-full">
                            </div>
                        </div>
                    </div>

                    <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏£‡∏±‡∏ö‡∏ô‡∏≤‡πÇ‡∏ô -->
                    <div class="border rounded-lg p-4 bg-indigo-50">
                        <h4 class="font-semibold text-indigo-800 mb-3">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ô‡∏≤‡πÇ‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="a-long-receive-nano-date"
                                    class="block text-sm font-medium mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏£‡∏±‡∏ö‡∏ô‡∏≤‡πÇ‡∏ô‡∏à‡∏≤‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</label>
                                <input type="date" id="a-long-receive-nano-date" required class="w-full">
                            </div>
                            <div>
                                <label for="a-long-receive-nano-amount"
                                    class="block text-sm font-medium mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏≤‡πÇ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏£‡∏±‡∏ö‡πÑ‡∏õ (‡∏•‡∏¥‡∏ï‡∏£)</label>
                                <input type="number" id="a-long-receive-nano-amount" required min="0.1" step="0.1"
                                    class="w-full">
                            </div>
                        </div>
                    </div>

                    <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏£‡∏±‡∏ö‡πÅ‡∏£‡πà/‡∏ô‡∏≤‡πÇ‡∏ô -->
                    <div class="border rounded-lg p-4 bg-blue-50">
                        <h4 class="font-semibold text-blue-800 mb-3">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏±‡∏ö‡πÅ‡∏£‡πà/‡∏ô‡∏≤‡πÇ‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="a-datecollect"
                                    class="block text-sm font-medium mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏°‡∏≤‡∏£‡∏±‡∏ö‡πÅ‡∏£‡πà</label>
                                <input type="date" id="a-datecollect" required class="w-full">
                            </div>
                            <div>
                                <label for="a-sackcollect"
                                    class="block text-sm font-medium mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏£‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏£‡∏±‡∏ö‡πÑ‡∏õ (‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö)</label>
                                <input type="number" id="a-sackcollect" required min="1" step="1" class="w-full">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div>
                                <label for="a-datenano"
                                    class="block text-sm font-medium mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏°‡∏≤‡∏£‡∏±‡∏ö‡∏ô‡∏≤‡πÇ‡∏ô</label>
                                <input type="date" id="a-datenano" required class="w-full">
                            </div>
                            <div>
                                <label for="a-nanoliters"
                                    class="block text-sm font-medium mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏≤‡πÇ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏£‡∏±‡∏ö‡πÑ‡∏õ (‡∏•‡∏¥‡∏ï‡∏£)</label>
                                <input type="number" id="a-nanoliters" required min="0.1" step="0.1" class="w-full">
                            </div>
                        </div>
                    </div>

                    <div>
                        <label for="a-premitra" class="block text-sm font-medium mb-1">‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ
                            (‡πÑ‡∏°‡∏ó‡∏£‡∏≤‡πÑ‡∏à‡∏ô‡∏µ‡∏ô)</label>
                        <input type="number" id="a-premitra" required placeholder="‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà 0" min="0" step="0.01"
                            class="w-full">
                    </div>
                </div>

                <div class="space-y-4 pt-4 border rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-stone-700">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°</h3>
                    <textarea id="a-recentchem" rows="3"
                        placeholder="‡∏õ‡∏∏‡πã‡∏¢/‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô 30 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤ (‡∏ä‡∏ô‡∏¥‡∏î + ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì + ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà)"
                        class="w-full"></textarea>

                    <div class="pt-4 space-y-2">
                        <p class="font-medium">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°</p>
                        <div class="flex flex-wrap items-center space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="a-consent-sample" value="‡∏¢‡∏≠‡∏°" required
                                    class="h-4 w-4 text-stone-800 border-gray-300 focus:ring-stone-500">
                                <span class="ml-2 text-sm">‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="a-consent-sample" value="‡πÑ‡∏°‡πà‡∏¢‡∏≠‡∏°"
                                    class="h-4 w-4 text-stone-800 border-gray-300 focus:ring-stone-500">
                                <span class="ml-2 text-sm">‡πÑ‡∏°‡πà‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°</span>
                            </label>
                        </div>
                        <div class="flex flex-wrap items-center space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="a-consent-data" value="‡∏¢‡∏≠‡∏°" required
                                    class="h-4 w-4 text-stone-800 border-gray-300 focus:ring-stone-500">
                                <span class="ml-2 text-sm">‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏à‡∏±‡∏¢</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="a-consent-data" value="‡πÑ‡∏°‡πà‡∏¢‡∏≠‡∏°"
                                    class="h-4 w-4 text-stone-800 border-gray-300 focus:ring-ring-stone-500">
                                <span class="ml-2 text-sm">‡πÑ‡∏°‡πà‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="space-y-4 pt-4 border rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-stone-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô</h3>

                    <div>
                        <label class="block text-sm font-medium mb-1">‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</label>
                        <div class="radio-group flex flex-wrap gap-2">
                            <input type="radio" id="a-recorder-long" name="a-recorder" value="‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô" required
                                class="hidden">
                            <label for="a-recorder-long" class="px-4 py-2 rounded-lg cursor-pointer">‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô</label>
                        </div>
                    </div>

                    <div>
                        <label for="a-onsitenotes" class="block text-sm font-medium mb-1">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                        <textarea id="a-onsitenotes" rows="3" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"
                            class="w-full"></textarea>
                    </div>

                    <div class="flex items-center">
                        <input type="checkbox" id="a-signature" required
                            class="h-4 w-4 text-stone-800 border-gray-300 rounded focus:ring-stone-500">
                        <label for="a-signature" class="ml-2 text-sm font-medium">
                            ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö: ‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </label>
                    </div>
                </div>

                <button type="submit" class="w-full pastel-button py-3 mt-6 rounded-lg">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÅ‡∏£‡πà‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡πÇ‡∏ô)
                </button>
            </form>
        </div>

        <!-- SHEET B VIEW -->
        <div id="sheet-b-view" class="space-y-6 hidden">
            <div class="w-full pt-6 pb-2 px-6">
                <h2 class="text-2xl font-bold text-stone-700">
                    ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)
                </h2>
            </div>
            <div id="sheet-b-form-container" class="space-y-6">
                <div class="space-y-4 pt-4 border rounded-lg p-4 bg-stone-50">
                    <h3 class="text-lg font-semibold text-stone-700">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)</h3>
                    <div class="space-y-4">
                        <label for="b-long-affiliation" class="block text-sm font-medium mb-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î
                            (‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£)</label>
                        <select id="b-long-affiliation" required class="w-full">
                            <option value="" disabled selected>--- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î (‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£) ---</option>
                        </select>
                        <label for="summary-search-id"
                            class="block text-sm font-medium mb-1">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô</label>
                        <div class="flex space-x-3 items-end">
                            <input type="text" id="summary-search-id" placeholder="Farmer ID" required
                                class="w-full flex-grow">
                            <button type="button" onclick="fetchAndDisplaySheetBUseData()" id="fetch-data-btn"
                                class="search-button py-2.5 px-6 rounded-lg whitespace-nowrap flex items-center justify-center h-[42px]">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                                    stroke="currentColor" class="w-5 h-5 mr-1">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                                </svg>
                                ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏° (‡∏à‡∏≤‡∏Å SheetA) -->
                <div class="space-y-4 border rounded-lg p-4 bg-white">
                    <h3 class="text-lg font-semibold text-stone-700 border-b pb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°</h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ -->
                        <div class="col-span-full">
                            <h4 class="font-semibold text-stone-600 mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <p><strong>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:</strong> <span data-field="a-fullname">---</span></p>
                                <p><strong>‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£:</strong> <span data-field="a-id">---</span></p>
                                <p><strong>‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏•‡πâ‡∏á:</strong> <span data-field="a-long-affiliation">---</span></p>
                            </div>
                        </div>

                        <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡∏∞‡∏û‡∏∑‡∏ä‡∏ú‡∏• -->
                        <div class="col-span-full">
                            <h4 class="font-semibold text-stone-600 mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡∏∞‡∏û‡∏∑‡∏ä‡∏ú‡∏•</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <p><strong>‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏£‡πà‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡πÇ‡∏ô‡∏à‡∏£‡∏¥‡∏á (‡πÑ‡∏£‡πà):</strong> <span
                                        data-field="a-plotsize">---</span>
                                </p>
                                <p><strong>‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡πÅ‡∏£‡πà‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡πÇ‡∏ô:</strong> <span
                                        data-field="a-cropspecies">---</span>
                                </p>
                                <p><strong>‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥:</strong> <span data-field="a-watering">---</span></p>
                                <p><strong>‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢:</strong> <span data-field="a-fertilizer-methods">---</span></p>
                            </div>
                        </div>

                        <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÅ‡∏£‡πà/‡∏ô‡∏≤‡πÇ‡∏ô -->
                        <div class="col-span-full">
                            <h4 class="font-semibold text-stone-600 mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÅ‡∏£‡πà/‡∏ô‡∏≤‡πÇ‡∏ô</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÅ‡∏£‡πà:</strong> <span data-field="a-datecollect">---</span></p>
                                <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏£‡πà‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö (‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö):</strong> <span data-field="a-sackcollect">---</span>
                                </p>
                                <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ô‡∏≤‡πÇ‡∏ô:</strong> <span data-field="a-datenano">---</span></p>
                                <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏≤‡πÇ‡∏ô (‡∏•‡∏¥‡∏ï‡∏£):</strong> <span data-field="a-nanoliters">---</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ (‡∏à‡∏≤‡∏Å SheetB) -->
                <div class="space-y-4 border rounded-lg p-4 bg-white">
                    <h3 class="text-lg font-semibold text-stone-700 border-b pb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ</h3>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏î‡∏¥‡∏ô -->
                        <div class="border rounded-lg p-4 bg-green-50">
                            <h4 class="font-semibold text-green-800 mb-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏î‡∏¥‡∏ô<br><small
                                    class="text-green-600">‡∏ó‡∏∏‡∏Å 4
                                    ‡∏ß‡∏±‡∏ô / 1-2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á / ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</small></h4>
                            <div id="b-fertilizer-usage-display" class="text-sm">
                                <p class="text-stone-500">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -</p>
                            </div>
                        </div>

                        <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ô‡∏≤‡πÇ‡∏ô -->
                        <div class="border rounded-lg p-4 bg-blue-50">
                            <h4 class="font-semibold text-blue-800 mb-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ô‡∏≤‡πÇ‡∏ô<br><small
                                    class="text-blue-600">‡∏ó‡∏∏‡∏Å 7 ‡∏ß‡∏±‡∏ô
                                    / 4 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á / ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</small></h4>
                            <div id="b-nano-usage-display" class="text-sm">
                                <p class="text-stone-500">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -</p>
                            </div>
                        </div>

                        <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏£‡πà -->
                        <div class="border rounded-lg p-4 bg-orange-50">
                            <h4 class="font-semibold text-orange-800 mb-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏£‡πà<br><small
                                    class="text-orange-600">‡∏ó‡∏∏‡∏Å 16
                                    ‡∏ß‡∏±‡∏ô / 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á / ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</small></h4>
                            <div id="b-mineral-usage-display" class="text-sm">
                                <p class="text-stone-500">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏£‡πÑ‡∏° -->
                <div class="space-y-4 border rounded-lg p-4 bg-white">
                    <h3 class="text-lg font-semibold text-stone-700 border-b pb-2">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏£‡πÑ‡∏°‡∏ó‡∏£‡∏≤‡πÑ‡∏à‡∏ô‡∏µ‡∏ô</h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- ‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ -->
                        <div class="border rounded-lg p-4 bg-red-50">
                            <h4 class="font-semibold text-red-800 mb-2">‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ (Pre-Mitra)</h4>
                            <p class="text-xl font-bold text-red-600" data-field="a-premitra">---</p>
                            <small class="text-red-600">‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°</small>
                        </div>

                        <!-- ‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ -->
                        <div class="border rounded-lg p-4 bg-blue-50">
                            <h4 class="font-semibold text-blue-800 mb-2">‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ (Post-Mitra)</h4>
                            <p class="text-xl font-bold text-blue-600" data-field="b-post-mitra">---</p>
                            <small class="text-blue-600">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏≤‡∏Å‡πÅ‡∏•‡πá‡∏ö</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SHEET B USE VIEW -->
        <div id="sheet-b-use-view" class="space-y-6 hidden">
            <div class="w-full pt-6 pb-2 px-6">
                <h2 class="text-2xl font-bold text-stone-700">
                    ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÅ‡∏£‡πà‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡πÇ‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£
                </h2>
            </div>
            <form id="sheet-b-use-form" onsubmit="handleSheetBUseSubmit(event)" class="space-y-6">

                <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á) -->
                <div class="space-y-4 pt-4 border rounded-lg p-4 bg-stone-50">
                    <h3 class="text-lg font-semibold text-stone-700">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="b-long-affiliation-use"
                                class="block text-sm font-medium mb-1">‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</label>
                            <select id="b-long-affiliation-use" required class="w-full">
                                <option value="" disabled selected>--- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î ---</option>
                            </select>
                        </div>
                        <div>
                            <label for="b-farmer-id-use" class="block text-sm font-medium mb-1">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£<span
                                    class="text-red-500">(‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</span></label>
                            <input type="text" id="b-farmer-id-use" placeholder="(Farmer ID)" required class="w-full">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="b-fullname-use"
                                class="block text-sm font-medium mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</span>*</label>
                            <input type="text" id="b-fullname-use" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£" required
                                class="w-full">
                        </div>
                    </div>
                </div>

                <div class="space-y-4 pt-4 border rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-stone-700">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ</h3>

                    <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏î‡∏¥‡∏ô -->
                    <div class="border rounded-lg p-4 bg-green-50">
                        <h4 class="font-semibold text-green-800 mb-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏î‡∏¥‡∏ô ‡∏ó‡∏∏‡∏Å 4 ‡∏ß‡∏±‡∏ô / 1-2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á /
                            ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h4>
                        <div id="fertilizer-usage-container">
                            <div class="fertilizer-usage-item grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                                <div>
                                    <label class="block text-sm font-medium mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢</label>
                                    <input type="date" class="fertilizer-date w-full">
                                </div>

                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium mb-1">‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏î‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢<span
                                            class="text-xs text-green-600">(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏ô‡∏∂‡πà‡∏á)</span></label>
                                    <div class="radio-group flex flex-wrap gap-2">
                                        <input type="checkbox" id="b-fert-organic" name="fertilizer-type"
                                            value="‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå" class="hidden">
                                        <label for="b-fert-organic"
                                            class="px-3 py-2 rounded-lg cursor-pointer border border-green-300 bg-white hover:bg-green-50">‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå</label>

                                        <input type="checkbox" id="b-fert-chemical" name="fertilizer-type"
                                            value="‡∏õ‡∏∏‡πã‡∏¢‡πÄ‡∏Ñ‡∏°‡∏µ" class="hidden">
                                        <label for="b-fert-chemical"
                                            class="px-3 py-2 rounded-lg cursor-pointer border border-green-300 bg-white hover:bg-green-50">‡∏õ‡∏∏‡πã‡∏¢‡πÄ‡∏Ñ‡∏°‡∏µ</label>

                                        <input type="checkbox" id="b-fert-manure" name="fertilizer-type" value="‡∏õ‡∏∏‡πã‡∏¢‡∏Ñ‡∏≠‡∏Å"
                                            class="hidden">
                                        <label for="b-fert-manure"
                                            class="px-3 py-2 rounded-lg cursor-pointer border border-green-300 bg-white hover:bg-green-50">‡∏õ‡∏∏‡πã‡∏¢‡∏Ñ‡∏≠‡∏Å</label>

                                        <input type="checkbox" id="b-fert-volcanic" name="fertilizer-type"
                                            value="‡πÅ‡∏£‡πà‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡πÑ‡∏ü" class="hidden">
                                        <label for="b-fert-volcanic"
                                            class="px-3 py-2 rounded-lg cursor-pointer border border-green-300 bg-white hover:bg-green-50">‡πÅ‡∏£‡πà‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡πÑ‡∏ü</label>

                                        <input type="checkbox" id="b-fert-other" name="fertilizer-type" value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ"
                                            class="hidden" onchange="toggleOtherFertilizerInputUse(this)">
                                        <label for="b-fert-other"
                                            class="px-3 py-2 rounded-lg cursor-pointer border border-green-300 bg-white hover:bg-green-50">‡∏≠‡∏∑‡πà‡∏ô‡πÜ
                                            (‡∏£‡∏∞‡∏ö‡∏∏)</label>
                                    </div>
                                    <input type="text" id="b-fertilizer-other-text-use"
                                        placeholder="‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ"
                                        class="hidden mt-2 w-full fertilizer-other-text">
                                </div>

                                <div class="flex items-end col-span-full">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ô‡∏≤‡πÇ‡∏ô -->
                    <div class="border rounded-lg p-4 bg-blue-50">
                        <h4 class="font-semibold text-blue-800 mb-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ô‡∏≤‡πÇ‡∏ô ‡∏ó‡∏∏‡∏Å 7 ‡∏ß‡∏±‡∏ô / 4 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á / ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h4>
                        <div id="nano-usage-container">
                            <div class="nano-usage-item grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                                <div>
                                    <label class="block text-sm font-medium mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ô‡∏≤‡πÇ‡∏ô</label>
                                    <input type="date" class="nano-date w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (‡∏•‡∏¥‡∏ï‡∏£)</label>
                                    <input type="number" class="nano-amount w-full" min="0.1" step="0.1">
                                </div>
                                <div class="flex items-end">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏£‡πà -->
                    <div class="border rounded-lg p-4 bg-orange-50">
                        <h4 class="font-semibold text-orange-800 mb-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏£‡πà ‡∏ó‡∏∏‡∏Å 16 ‡∏ß‡∏±‡∏ô / 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á / ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h4>
                        <div id="mineral-usage-container">
                            <div class="mineral-usage-item grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                                <div>
                                    <label class="block text-sm font-medium mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏£‡πà</label>
                                    <input type="date" class="mineral-date w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°)</label>
                                    <input type="number" class="mineral-amount w-full" min="0.1" step="0.1">
                                </div>
                                <div class="flex items-end">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ -->
                <div class="space-y-4 pt-4 border rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-stone-700">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ </h3>

                    <div>
                        <label class="block text-sm font-medium mb-1">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡πÅ‡∏£‡πà‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (‡πÄ‡∏ä‡πà‡∏ô 1 ‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö / 1 ‡πÑ‡∏£‡πà)
                            <span class="text-red-500">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span></label>
                        <div class="radio-group flex items-center flex-wrap gap-2">
                            <input type="radio" id="b-rate-follow" name="b-rate" value="‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°" required
                                class="hidden" onchange="toggleAdjustedBRate()">
                            <label for="b-rate-follow" class="px-4 py-2 rounded-lg cursor-pointer">‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°</label>

                            <input type="radio" id="b-rate-adjust" name="b-rate" value="‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°" class="hidden"
                                onchange="toggleAdjustedBRate()">
                            <label for="b-rate-adjust" class="px-4 py-2 rounded-lg cursor-pointer">‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°</label>

                            <input type="number" id="b-rate-adjusted" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏±‡∏ï‡∏£‡∏≤ (‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö/‡πÑ‡∏£‡πà)" min="0.1"
                                step="0.1" class="hidden ml-4">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏ô‡∏≤‡πÇ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (‡πÄ‡∏ä‡πà‡∏ô 1 ‡∏•‡∏¥‡∏ï‡∏£ / 1 ‡πÑ‡∏£‡πà)
                            <span class="text-red-500">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span></label>
                        <div class="radio-group flex items-center flex-wrap gap-2">
                            <input type="radio" id="b-nano-rate-follow" name="b-nano-rate" value="‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°" required
                                class="hidden" onchange="toggleAdjustedBNanoRate()">
                            <label for="b-nano-rate-follow"
                                class="px-4 py-2 rounded-lg cursor-pointer">‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°</label>

                            <input type="radio" id="b-nano-rate-adjust" name="b-nano-rate" value="‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°"
                                class="hidden" onchange="toggleAdjustedBNanoRate()">
                            <label for="b-nano-rate-adjust" class="px-4 py-2 rounded-lg cursor-pointer">‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°</label>

                            <input type="number" id="b-nano-rate-adjusted" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏±‡∏ï‡∏£‡∏≤ (‡∏•‡∏¥‡∏ï‡∏£/‡πÑ‡∏£‡πà)" min="0.1"
                                step="0.1" class="hidden ml-4">
                        </div>
                    </div>
                </div>

                <div>
                    <div>
                        <label for="b-recorder" class="block text-sm font-medium mb-1">‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å<span
                                class="text-red-500">(‡πÉ‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)</span></label>
                    </div>
                    <div class="radio-group flex flex-wrap gap-2">
                        <input type="radio" id="b-recorder-long" name="b-recorder" value="‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô" required>
                        <label for="b-recorder-long" class="px-4 py-2 rounded-lg cursor-pointer">‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô</label>

                        <input type="radio" id="b-recorder-kk" name="b-recorder" value="‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£" required>
                        <label for="b-recorder-kk" class="px-4 py-2 rounded-lg cursor-pointer">‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</label>
                    </div>
                </div>

                <button type="submit" class="w-full search-button py-3 mt-6 rounded-lg">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ 4-7-16
                </button>
            </form>
        </div>

        <!-- SHEET C VIEW -->
        <div id="sheet-c-view" class="space-y-6 hidden">
            <div class="w-full pt-6 pb-2 px-6">
                <h2 class="text-2xl font-bold text-stone-700">
                    ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô
                </h2>
            </div>

            <div class="space-y-4 pt-4 border rounded-lg p-4 bg-stone-50">
                <h3 class="text-lg font-semibold text-stone-700">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>

                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <div class="flex-grow">
                        <p class="text-sm text-stone-600" id="auto-long-name">
                            <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏•‡πâ‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ -->
                        </p>
                    </div>
                    <div>
                        <button onclick="fetchSummaryData()"
                            class="search-button py-2.5 px-6 rounded-lg whitespace-nowrap flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                                stroke="currentColor" class="w-5 h-5 mr-1">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                            </svg>
                            ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£
                        </button>
                    </div>
                </div>
                <div id="summary-count" class="text-sm text-stone-600 font-semibold">
                    ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </div>
            </div>

            <!-- Data Display Section -->
            <div id="summary-data-container"
                class="overflow-x-auto rounded-xl border border-stone-200 shadow-lg hidden">
                <table class="min-w-full divide-y divide-gray-300 data-table">
                    <thead class="bg-stone-100">
                        <tr class="text-sm uppercase text-stone-700">
                            <th class="px-4 py-3 text-left">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</th>
                            <th class="px-4 py-3 text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                            <th class="px-4 py-3 text-left">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                            <th class="px-4 py-3 text-left">‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏õ‡∏•‡∏á</th>
                            <th class="px-4 py-3 text-left">‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå</th>
                            <th class="px-4 py-3 text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÅ‡∏£‡πà</th>
                            <th class="px-4 py-3 text-left">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏£‡πà</th>
                            <th class="px-4 py-3 text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ô‡∏≤‡πÇ‡∏ô</th>
                            <th class="px-4 py-3 text-left">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏≤‡πÇ‡∏ô</th>
                            <th class="px-4 py-3 text-left">‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ</th>
                            <th class="px-4 py-3 text-left">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        </tr>
                    </thead>
                    <tbody id="summary-table-body" class="divide-y divide-gray-200 text-sm bg-white">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>

            <div id="summary-loading" class="text-center p-8 text-stone-500 hidden">
                <div
                    class="animate-spin rounded-full h-8 w-8 border-2 border-stone-400 border-t-stone-800 mx-auto mb-2">
                </div>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
            </div>

            <div id="summary-empty" class="text-center p-8 text-stone-500 hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-2 text-stone-400" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡πâ‡∏á‡∏ô‡∏µ‡πâ</p>
            </div>
        </div>

        <div id="admin-view" class="space-y-6 hidden">

            <div class="w-full pt-6 pb-2 px-6">
                <h2 class="text-2xl font-bold text-stone-700">
                    ‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin)
                </h2>
            </div>

            <div class="space-y-4 pt-4 border rounded-lg p-4 bg-stone-50">
                <div class="flex items-center justify-between gap-4">
                    <div>
                        <p class="text-sm text-stone-600">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö: <span id="admin-current-user"
                                class="font-semibold"></span></p>
                    </div>
                    <div class="flex gap-2">
                        <button id="admin-refresh-btn" class="search-button py-2 px-4 rounded-lg"
                            onclick="adminCheckAuthAndInit()">
                            ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ / ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                        </button>
                        <button id="admin-logout-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg"
                            onclick="adminForceLogout()">
                            ‡∏≠‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                        </button>
                    </div>
                </div>
                <div id="admin-access-warning" class="text-red-600 text-sm hidden">
                    ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ
                </div>
            </div>

            <nav class="nav-tabs">

                <button class="nav-tab active" data-target="admin-kratom" data-section-color="orange"
                    onclick="showSection('admin-kratom', this)">‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>

                <button class="nav-tab" data-target="admin-lounge" data-section-color="blue"
                    onclick="showSection('admin-lounge', this)">2. ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡πâ‡∏á</button>
            </nav>

            <div id="admin-kratom" class="content-section active">
                <div class="w-full pt-6 pb-2 px-6">
                    <h2 class="text-2xl font-bold text-stone-700">
                        ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡πÑ‡∏ü‡∏•‡πå Sheet A / Sheet B / ‡∏™‡∏£‡∏∏‡∏õ
                    </h2>
                </div>

                <div id="admin-controls" class="space-y-4 hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button id="btn-fetch-farmers" class="pastel-button py-3" onclick="adminFetchAllFarmers()">
                            ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Sheet A)
                        </button>
                        <button id="btn-fetch-usage" class="search-button py-3" onclick="adminFetchAllUsage()">
                            ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ (Sheet B)
                        </button>
                        <button id="btn-fetch-merged" class="blue-button py-3" onclick="adminFetchMerged()">
                            ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ß‡∏° (Merge)
                        </button>
                    </div>

                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <h4 class="text-sm font-semibold text-yellow-800 mb-3">üîß ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                            <button id="btn-simple-test" class="bg-yellow-500 text-white py-2 px-3 rounded text-sm"
                                onclick="adminSimpleTest()">
                                ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Basic
                            </button>
                            <button id="btn-sheet-test" class="bg-orange-500 text-white py-2 px-3 rounded text-sm"
                                onclick="adminTestSheetAccess()">
                                ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Sheet Access
                            </button>
                            <button id="btn-admin-conn" class="bg-red-500 text-white py-2 px-3 rounded text-sm"
                                onclick="testAdminConnection()">
                                ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Admin Connection
                            </button>
                        </div>
                    </div>

                    <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô admin-controls ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏î‡∏¥‡∏° -->
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mt-4">
                        <h4 class="text-sm font-semibold text-red-800 mb-3">üö® ‡∏ó‡∏î‡∏™‡∏≠‡∏ö getAllFarmers ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <button id="btn-direct-getAll" class="bg-red-600 text-white py-2 px-3 rounded text-sm"
                                onclick="directTestGetAllFarmers()">
                                ‡∏ó‡∏î‡∏™‡∏≠‡∏ö getAllFarmers ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                            </button>
                            <button id="btn-debug-getAll" class="bg-purple-600 text-white py-2 px-3 rounded text-sm"
                                onclick="testGetAllFarmersDebug()">
                                ‡∏ó‡∏î‡∏™‡∏≠‡∏ö getAllFarmersDebug
                            </button>
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <input id="admin-search-input" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏£‡∏´‡∏±‡∏™ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠"
                            class="w-full p-2 border rounded" />
                        <button id="admin-search-btn" class="search-button px-4"
                            onclick="adminFilterTable()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                        <button id="admin-export-btn" class="pastel-button px-4"
                            onclick="adminExportCurrentToCSV()">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                            CSV</button>
                    </div>

                    <div id="admin-loading" class="text-center p-6 hidden">
                        <div class="loading-spinner mx-auto mb-2"></div>
                        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                    </div>

                    <div id="admin-results" class="space-y-4">
                        <div id="admin-table-wrapper" class="overflow-x-auto bg-white rounded-lg border p-4 hidden">
                            <h3 class="font-semibold text-stone-700 mb-2">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</h3>
                            <div id="admin-table-container" class="admin-table-scroll"></div>
                        </div>

                        <div id="admin-empty" class="text-stone-500 p-4 hidden">
                            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á
                        </div>
                    </div>

                    <div id="admin-results" class="space-y-4">
                        <div id="admin-table-wrapper" class="overflow-x-auto bg-white rounded-lg border p-4 hidden">
                            <h3 class="font-semibold text-stone-700 mb-2">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</h3>
                            <div id="admin-table-container" class="admin-table-scroll"></div>
                        </div>

                        <div id="admin-empty" class="text-stone-500 p-4 hidden">
                            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á
                        </div>
                    </div>
                </div>
            </div>

            <div id="admin-lounge" class="content-section hidden">
                <h2>‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡πâ‡∏á</h2>
                <div class="p-4 bg-white border rounded">
                    <p class="text-sm text-stone-600">‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ / ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏•‡πâ‡∏á (Placeholder)</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>

        // =============================================
        // CONSTANTS & CONFIGURATION
        // =============================================
        const LONG_OPTIONS = [
            { value: "", text: "--- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î ---" },
            { value: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏û‡∏µ‡πà‡∏ö‡∏≤‡∏™BDS", text: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏û‡∏µ‡πà‡∏ö‡∏≤‡∏™BDS" },
            { value: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏û‡∏µ‡πàHunter‡πÄ‡∏ß‡∏µ‡∏¢‡∏á‡πÅ‡∏Å‡πà‡∏ô", text: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏û‡∏µ‡πàHunter‡πÄ‡∏ß‡∏µ‡∏¢‡∏á‡πÅ‡∏Å‡πà‡∏ô" },
            { value: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏û‡∏µ‡πà‡∏Å‡πâ‡∏≤‡∏°‡∏ó‡πà‡∏≤‡πÅ‡∏Ñ", text: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏û‡∏µ‡πà‡∏Å‡πâ‡∏≤‡∏°‡∏ó‡πà‡∏≤‡πÅ‡∏Ñ" },
            { value: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏û‡∏µ‡πà‡∏Å‡∏£‡∏∞‡∏£‡∏≠‡∏Å", text: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏û‡∏µ‡πà‡∏Å‡∏£‡∏∞‡∏£‡∏≠‡∏Å" },
            { value: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏û‡∏µ‡πà‡∏£‡∏±‡∏ä‡∏ä‡πå‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏Ñ‡∏£", text: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏û‡∏µ‡πà‡∏£‡∏±‡∏ä‡∏ä‡πå‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏Ñ‡∏£" },
            { value: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏û‡∏µ‡πà‡∏ï‡∏π‡∏ô‡∏ö‡∏≤‡∏á‡∏Ç‡∏±‡∏ô", text: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏û‡∏µ‡πà‡∏ï‡∏π‡∏ô‡∏ö‡∏≤‡∏á‡∏Ç‡∏±‡∏ô" },
            { value: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏õ‡πã‡∏≠‡∏á‡∏™‡πå‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á", text: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏õ‡πã‡∏≠‡∏á‡∏™‡πå‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á" },
            { value: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏ö‡∏à‡∏Å.‡∏à‡∏¥‡∏ô‡∏î‡∏≤‡∏£‡∏±‡∏ï‡∏ô‡πå ‡πÇ‡∏õ‡∏£‡∏î‡∏±‡∏Å‡∏™‡πå", text: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏ö‡∏à‡∏Å.‡∏à‡∏¥‡∏ô‡∏î‡∏≤‡∏£‡∏±‡∏ï‡∏ô‡πå ‡πÇ‡∏õ‡∏£‡∏î‡∏±‡∏Å‡∏™‡πå" },
            { value: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏û‡∏µ‡πà‡∏î‡∏≠‡∏ô", text: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏û‡∏µ‡πà‡∏î‡∏≠‡∏ô" },
            { value: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏û‡∏µ‡πà‡πÄ‡∏ï‡∏¢‡∏û‡∏µ‡πà‡πÄ‡∏Å‡∏£‡∏ã", text: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏û‡∏µ‡πà‡πÄ‡∏ï‡∏¢‡∏û‡∏µ‡πà‡πÄ‡∏Å‡∏£‡∏ã" },
            { value: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏û‡∏µ‡πà‡∏™‡∏°‡∏û‡∏á‡∏®‡πå‡∏û‡∏∞‡∏¢‡∏π‡∏ô‡∏ï‡∏£‡∏±‡∏á", text: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏û‡∏µ‡πà‡∏™‡∏°‡∏û‡∏á‡∏®‡πå‡∏û‡∏∞‡∏¢‡∏π‡∏ô‡∏ï‡∏£‡∏±‡∏á" },
            { value: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏™‡∏≤‡∏£‡∏Ñ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á", text: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏™‡∏≤‡∏£‡∏Ñ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á" },
            { value: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏´‡∏£‡∏±‡πà‡∏á‡∏ô‡∏∏‡πâ‡∏¢‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£", text: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏´‡∏£‡∏±‡πà‡∏á‡∏ô‡∏∏‡πâ‡∏¢‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£" },
            { value: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏û‡∏µ‡πà‡πÄ‡∏õ‡∏£‡∏µ‡πâ‡∏¢‡∏ß‡∏´‡∏•‡πà‡∏°‡∏™‡∏±‡∏Å", text: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏û‡∏µ‡πà‡πÄ‡∏õ‡∏£‡∏µ‡πâ‡∏¢‡∏ß‡∏´‡∏•‡πà‡∏°‡∏™‡∏±‡∏Å" },
            { value: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏û‡∏µ.‡πÄ‡∏à.‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°‡∏ó‡∏≠‡∏á", text: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏û‡∏µ.‡πÄ‡∏à.‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°‡∏ó‡∏≠‡∏á" },
            { value: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏°‡∏∞‡∏£‡∏∏‡∏°‡∏ü‡∏≤‡∏£‡πå‡∏°", text: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏°‡∏∞‡∏£‡∏∏‡∏°‡∏ü‡∏≤‡∏£‡πå‡∏°" },
            { value: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏™‡∏ß‡∏ô‡∏≠‡∏¥‡∏ô-‡∏à‡∏±‡∏Å‡∏£‡∏†‡∏±‡∏ó‡∏£", text: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏™‡∏ß‡∏ô‡∏≠‡∏¥‡∏ô-‡∏à‡∏±‡∏Å‡∏£‡∏†‡∏±‡∏ó‡∏£" },
            { value: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏£‡∏±‡∏Å‡∏©‡πå‡∏≠‡∏∏‡∏ó‡∏±‡∏¢", text: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏£‡∏±‡∏Å‡∏©‡πå‡∏≠‡∏∏‡∏ó‡∏±‡∏¢" },
            { value: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏û‡∏µ‡πà‡∏ß‡∏¥‡∏ó‡∏¢‡πå‡∏ß‡∏¥‡∏™‡∏≤‡∏´‡∏Å‡∏¥‡∏à‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏ä‡∏≤‡∏ß‡∏ß‡∏±‡∏á", text: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏û‡∏µ‡πà‡∏ß‡∏¥‡∏ó‡∏¢‡πå‡∏ß‡∏¥‡∏™‡∏≤‡∏´‡∏Å‡∏¥‡∏à‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏ä‡∏≤‡∏ß‡∏ß‡∏±‡∏á" },
            { value: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏û‡∏µ‡πà‡∏™‡∏≤‡πÇ‡∏£‡∏à‡∏ô‡πå", text: "‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏û‡∏µ‡πà‡∏™‡∏≤‡πÇ‡∏£‡∏à‡∏ô‡πå" },
        ];

        let currentView = 'main-menu-view';
        let previousView = null;

        // Helper: safe JSON parse that supports object input and string input.
        function safeParseJSON(input) {
            if (input === null || input === undefined) return null;
            if (typeof input === 'object') return input;
            try {
                return JSON.parse(input);
            } catch (e) {
                console.warn('safeParseJSON: invalid JSON input', e, input);
                return null;
            }
        }

        // =============================================
        // UTILITY FUNCTIONS
        // =============================================
        function showMessageBox(title, content) {
            const messageBox = document.getElementById('message-box');
            const messageTitle = document.getElementById('message-title');
            const messageContent = document.getElementById('message-content');

            if (!messageBox || !messageTitle || !messageContent) {
                console.error('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö element ‡∏Ç‡∏≠‡∏á message box');
                alert(`${title}\n\n${content}`);
                return;
            }

            messageTitle.textContent = title;
            messageContent.style.whiteSpace = 'pre-line';
            // Allow HTML in content (we assume inputs are trusted in this internal app).
            messageContent.innerHTML = content;

            messageBox.classList.remove('hidden');
        }

        function hideMessageBox() {
            const messageBox = document.getElementById('message-box');
            if (messageBox) {
                messageBox.classList.add('hidden');
            }
        }

        function isAppsScriptReady(handlerName, callback) {
            if (typeof google === 'undefined' || typeof google.script === 'undefined' || typeof google.script.run === 'undefined') {
                const errorMessage = `‚ùå [${handlerName}] Google Apps Script API (google.script.run) ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô. ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏£‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏° Google Sheets Web App ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà.`;
                console.error(errorMessage);

                if (handlerName.includes('Submission') || handlerName.includes('Data Fetching')) {
                    showMessageBox("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠!", errorMessage);
                }

                const submitAButton = document.querySelector('#sheet-a-form button[type="submit"]');
                if (submitAButton) {
                    submitAButton.disabled = true;
                }

                const fetchButton = document.getElementById('fetch-data-btn');
                if (fetchButton) {
                    fetchButton.disabled = true;
                    fetchButton.innerHTML = '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';
                }

                if (callback) {
                    callback({ success: false, message: errorMessage, data: null });
                }
                return false;
            }

            const fetchButton = document.getElementById('fetch-data-btn');
            if (fetchButton) {
                fetchButton.disabled = false;
            }
            return true;
        }

        // =============================================
        // NAVIGATION FUNCTIONS
        // =============================================
        function showView(viewId) {
            const allViews = [
                'main-menu-view',
                'submenu-view',
                'form-menu-view',
                'sheet-a-view',
                'sheet-b-view',
                'sheet-b-use-view',
                'sheet-c-view',
                'admin-view'
            ];

            allViews.forEach(id => {
                const view = document.getElementById(id);
                if (view) {
                    view.classList.add('hidden');
                }
            });

            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.remove('hidden');
            }

            if (viewId === 'sheet-c-view') {
                updateSummaryView();
            }

            if (viewId === 'sheet-a-view') {
                updateSheetALongDropdown();
            }

            updateBackButton(viewId);

            previousView = currentView;
            currentView = viewId;

            window.scrollTo(0, 0);
        }

        function goBack() {
            if (currentView === 'admin-view') {
                console.log('goBack: current view is admin-view ‚Äî no action performed.');
                return;
            }
            if (currentView === 'form-menu-view') {
                showView('main-menu-view');
            } else if (currentView === 'sheet-a-view' || currentView === 'sheet-b-view' || currentView === 'sheet-c-view') {
                showView('submenu-view');
            } else if (currentView === 'sheet-b-use-view') {
                showView('main-menu-view');
            } else {
                showView('main-menu-view');
            }
        }

        function updateBackButton(viewId) {
            const backButton = document.getElementById('back-button');
            if (backButton) {
                if (viewId === 'main-menu-view' || viewId === 'submenu-view') {
                    backButton.classList.add('hidden');
                } else {
                    backButton.classList.remove('hidden');
                }
            }
        }

        function updateSummaryView() {
            const currentUser = checkLoginStatus();
            const autoLongElement = document.getElementById('auto-long-name');

            if (currentUser && autoLongElement) {
                autoLongElement.textContent = `‡∏•‡πâ‡∏á: ${currentUser.longName}`;

                document.getElementById('summary-data-container').classList.add('hidden');
                document.getElementById('summary-empty').classList.add('hidden');
                document.getElementById('summary-count').textContent = '‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                document.getElementById('summary-count').className = 'text-sm text-stone-600 font-semibold';
            }
        }

        // =============================================
        // FORM HANDLING FUNCTIONS
        // =============================================
        function toggleOtherWateringInput() {
            const otherInput = document.getElementById('a-watering-other-text');
            const otherRadio = document.getElementById('water-other');
            if (otherInput && otherRadio) {
                if (otherRadio.checked) {
                    otherInput.classList.remove('hidden');
                    otherInput.required = true;
                } else {
                    otherInput.classList.add('hidden');
                    otherInput.required = false;
                    otherInput.value = '';
                }
            }
        }

        function toggleOtherFertilizerInput() {
            const otherInput = document.getElementById('a-fertilizer-other-text');
            const otherRadio = document.getElementById('fert_other');
            if (otherRadio && otherInput) {
                if (otherRadio.checked) {
                    otherInput.classList.remove('hidden');
                    otherInput.required = true;
                } else {
                    otherInput.classList.add('hidden');
                    otherInput.required = false;
                    otherInput.value = '';
                }
            }
        }

        function populateLongOptions() {
            const selectA = document.getElementById('a-long-affiliation');
            const selectB = document.getElementById('b-long-affiliation');
            const selectBUse = document.getElementById('b-long-affiliation-use');

            const selectElements = [selectA, selectB, selectBUse].filter(el => el !== null);

            console.log('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î dropdowns:', selectElements.length, '‡∏ï‡∏±‡∏ß');

            selectElements.forEach(selectEl => {
                while (selectEl.options.length > 0) {
                    selectEl.remove(0);
                }

                LONG_OPTIONS.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option.value;
                    opt.textContent = option.text;
                    selectEl.appendChild(opt);
                });

                if (selectEl.options.length > 0) {
                    selectEl.options[0].disabled = true;
                    selectEl.options[0].selected = true;
                }
                console.log('‚úÖ ‡πÇ‡∏´‡∏•‡∏î dropdown ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', selectEl.id);
            });
        }

        // =============================================
        // FORM TOGGLE FUNCTIONS
        // =============================================
        function toggleOtherFertilizerInputUse(checkbox) {
            const item = checkbox.closest('.fertilizer-usage-item');
            if (!item) {
                console.error('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö fertilizer-usage-item');
                return;
            }

            const otherText = item.querySelector('.fertilizer-other-text');
            if (!otherText) {
                console.error('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö fertilizer-other-text input');
                return;
            }

            if (checkbox.checked) {
                otherText.classList.remove('hidden');
                otherText.required = true;
            } else {
                otherText.classList.add('hidden');
                otherText.required = false;
                otherText.value = '';
            }
        }

        function handleOtherCheckboxChange(event) {
            toggleOtherFertilizerInputUse(event.target);
        }

        function toggleAdjustedBRate() {
            const adjustedInput = document.getElementById('b-rate-adjusted');
            const adjustRadio = document.getElementById('b-rate-adjust');

            if (!adjustRadio || !adjustedInput) {
                console.warn('‚ö†Ô∏è toggleAdjustedBRate: Element ‡πÑ‡∏°‡πà‡∏û‡∏ö');
                return;
            }
            if (adjustRadio.checked) {
                adjustedInput.classList.remove('hidden');
                adjustedInput.required = true;
            } else {
                adjustedInput.classList.add('hidden');
                adjustedInput.required = false;
                adjustedInput.value = '';
            }
        }

        function toggleAdjustedBNanoRate() {
            const adjustedInput = document.getElementById('b-nano-rate-adjusted');
            const adjustRadio = document.getElementById('b-nano-rate-adjust');

            if (!adjustRadio || !adjustedInput) {
                console.warn('‚ö†Ô∏è toggleAdjustedBNanoRate: Element ‡πÑ‡∏°‡πà‡∏û‡∏ö');
                return;
            }
            if (adjustRadio.checked) {
                adjustedInput.classList.remove('hidden');
                adjustedInput.required = true;
            } else {
                adjustedInput.classList.add('hidden');
                adjustedInput.required = false;
                adjustedInput.value = '';
            }
        }

        // =============================================
        // VALIDATION & SANITIZATION
        // (single robust validateInput used everywhere)
        // =============================================
        function validateInput(value, type, fieldName) {
            // handle null/undefined and numeric values safely
            if (value === null || value === undefined || (typeof value === 'string' && value.trim() === '')) {
                throw new Error(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ${fieldName}`);
            }

            const valStr = (typeof value === 'string') ? value.trim() : String(value);

            switch (type) {
                case 'phone':
                    const phonePattern = /^0[0-9]{9}$/;
                    const cleaned = valStr.replace(/-/g, '');
                    if (!phonePattern.test(cleaned)) {
                        throw new Error(`${fieldName} ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô 0XXXXXXXXX)`);
                    }
                    break;

                case 'number':
                    const num = parseFloat(valStr);
                    if (isNaN(num) || num <= 0) {
                        throw new Error(`${fieldName} ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0`);
                    }
                    break;

                case 'date':
                    if (!valStr) {
                        throw new Error(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${fieldName}`);
                    }
                    const selectedDate = new Date(valStr);
                    const today = new Date();
                    // compare only date part - not future
                    if (selectedDate > today) {
                        throw new Error(`${fieldName} ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡πÑ‡∏î‡πâ`);
                    }
                    break;

                case 'farmerId':
                    if (!valStr) {
                        throw new Error(`${fieldName} ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                    }
                    if (valStr.length < 3) {
                        throw new Error(`${fieldName} ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£`);
                    }
                    break;
            }
            return value;
        }

        // =============================================
        // FORM RESET & MANAGEMENT
        // =============================================
        function resetSheetAFormExceptLong() {
            const form = document.getElementById('sheet-a-form');
            if (!form) return;
            const longSelect = document.getElementById('a-long-affiliation');
            const longValue = longSelect ? longSelect.value : '';

            form.reset();

            if (longSelect) {
                document.getElementById('a-long-affiliation').value = longValue;
            }

            toggleOtherWateringInput();
            toggleOtherFertilizerInput();
        }

        function resetDisplayData() {
            try {
                console.log('üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•');

                const dataElements = document.querySelectorAll('[data-field]');
                dataElements.forEach(el => {
                    el.textContent = '---';
                    if (el.getAttribute('data-field') === 'a-premitra') {
                        el.className = 'text-xl font-bold text-red-600';
                    }
                    if (el.getAttribute('data-field') === 'b-post-mitra') {
                        el.className = 'text-xl font-bold text-blue-600';
                    }
                });

                const fEl = document.getElementById('b-fertilizer-usage-display');
                const nEl = document.getElementById('b-nano-usage-display');
                const mEl = document.getElementById('b-mineral-usage-display');
                if (fEl) fEl.innerHTML = '<p class="text-stone-500">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -</p>';
                if (nEl) nEl.innerHTML = '<p class="text-stone-500">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -</p>';
                if (mEl) mEl.innerHTML = '<p class="text-stone-500">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -</p>';

                console.log('‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');

            } catch (error) {
                console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:', error);
            }
        }

        // =============================================
        // SHEET A FUNCTIONS
        // =============================================
        function getSheetAFormData(form) {
            try {
                if (!form) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°');

                const getEl = (id) => {
                    const el = document.getElementById(id);
                    if (!el) throw new Error(`‡πÑ‡∏°‡πà‡∏û‡∏ö element: ${id}`);
                    return el;
                };

                const phone = getEl('a-phone').value.trim();
                validateInput(phone, 'phone', '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå');

                const farmerId = getEl('a-id').value.trim();
                validateInput(farmerId, 'farmerId', '‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£');

                const mineralAmount = getEl('a-long-receive-mineral-amount').value;
                validateInput(mineralAmount, 'number', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏£‡πà');

                const nanoAmount = getEl('a-long-receive-nano-amount').value;
                validateInput(nanoAmount, 'number', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏≤‡πÇ‡∏ô');

                const plotSize = getEl('a-plotsize').value;
                validateInput(plotSize, 'number', '‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏õ‡∏•‡∏á');

                const sackcollect = getEl('a-sackcollect').value;
                validateInput(sackcollect, 'number', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏£‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏£‡∏±‡∏ö');

                const nanoliters = getEl('a-nanoliters').value;
                validateInput(nanoliters, 'number', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏≤‡πÇ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏£‡∏±‡∏ö');

                validateInput(getEl('a-long-receive-mineral-date').value, 'date', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏£‡∏±‡∏ö‡πÅ‡∏£‡πà');
                validateInput(getEl('a-long-receive-nano-date').value, 'date', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏£‡∏±‡∏ö‡∏ô‡∏≤‡πÇ‡∏ô');
                validateInput(getEl('a-datecollect').value, 'date', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏£‡∏±‡∏ö‡πÅ‡∏£‡πà');
                validateInput(getEl('a-datenano').value, 'date', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏£‡∏±‡∏ö‡∏ô‡∏≤‡πÇ‡∏ô');

                const parsedMineralAmount = parseFloat(getEl('a-long-receive-mineral-amount').value);
                const parsedNanoAmount = parseFloat(getEl('a-long-receive-nano-amount').value);

                if (isNaN(parsedMineralAmount) || parsedMineralAmount <= 0) {
                    throw new Error("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏£‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0");
                }
                if (isNaN(parsedNanoAmount) || parsedNanoAmount <= 0) {
                    throw new Error("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏≤‡πÇ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0");
                }

                const formData = {
                    timestamp: new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' }),
                    'a-long-affiliation': (document.getElementById('a-long-affiliation') && document.getElementById('a-long-affiliation').value) || '',
                    'a-fullname': (document.getElementById('a-fullname') && document.getElementById('a-fullname').value.trim()) || '',
                    'a-phone': phone,
                    'a-id': farmerId,
                    'a-address-tambon': (document.getElementById('a-address-tambon') && document.getElementById('a-address-tambon').value.trim()) || '',
                    'a-address-amphoe': (document.getElementById('a-address-amphoe') && document.getElementById('a-address-amphoe').value.trim()) || '',
                    'a-address-province': (document.getElementById('a-address-province') && document.getElementById('a-address-province').value.trim()) || '',
                    'a-emergency': (document.getElementById('a-emergency') && document.getElementById('a-emergency').value.trim()) || '',
                    'a-gpsx': (document.getElementById('a-gpsx') && document.getElementById('a-gpsx').value.trim()) || '',
                    'a-gpsy': (document.getElementById('a-gpsy') && document.getElementById('a-gpsy').value.trim()) || '',
                    'a-plotsize': parseFloat(document.getElementById('a-plotsize').value),
                    'a-cropspecies': (document.getElementById('a-cropspecies') && document.getElementById('a-cropspecies').value.trim()) || '',
                    'a-watering': Array.from(form.querySelectorAll('input[name="a-watering"]:checked')).map(cb => cb.value).join(', '),
                    'a-watering-other-text': (document.getElementById('a-watering-other-text') && document.getElementById('a-watering-other-text').value.trim()) || '',
                    'a-fertilizer-method': Array.from(form.querySelectorAll('input[name="a-fertilizer-method"]:checked')).map(cb => cb.value).join(', '),
                    'a-fertilizer-other-text': (document.getElementById('a-fertilizer-other-text') && document.getElementById('a-fertilizer-other-text').value.trim()) || '',
                    'a-long-receive-mineral-date': document.getElementById('a-long-receive-mineral-date').value,
                    'a-long-receive-mineral-amount': parsedMineralAmount,
                    'a-long-receive-nano-date': document.getElementById('a-long-receive-nano-date').value,
                    'a-long-receive-nano-amount': parsedNanoAmount,
                    'a-datecollect': document.getElementById('a-datecollect').value,
                    'a-sackcollect': parseInt(document.getElementById('a-sackcollect').value, 10),
                    'a-datenano': document.getElementById('a-datenano').value,
                    'a-nanoliters': parseFloat(document.getElementById('a-nanoliters').value),
                    'a-premitra': (document.getElementById('a-premitra') && parseFloat(document.getElementById('a-premitra').value)) || '',
                    'a-recentchem': (document.getElementById('a-recentchem') && document.getElementById('a-recentchem').value.trim()) || '',
                    'a-consent-sample': form.querySelector('input[name="a-consent-sample"]:checked')?.value,
                    'a-consent-data': form.querySelector('input[name="a-consent-data"]:checked')?.value,
                    'a-recorder': document.querySelector('input[name="a-recorder"]:checked')?.value || '',
                    'a-onsitenotes': (document.getElementById('a-onsitenotes') && document.getElementById('a-onsitenotes').value.trim()) || '',
                    'a-signature': document.getElementById('a-signature') && document.getElementById('a-signature').checked ? '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô' : '‡πÑ‡∏°‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô'
                };

                if (!formData['a-watering'] || !formData['a-watering'].includes('‡∏≠‡∏∑‡πà‡∏ô‡πÜ')) {
                    delete formData['a-watering-other-text'];
                }
                if (!formData['a-fertilizer-method'] || !formData['a-fertilizer-method'].includes('‡∏≠‡∏∑‡πà‡∏ô‡πÜ')) {
                    delete formData['a-fertilizer-other-text'];
                }

                return formData;
            } catch (error) {
                showMessageBox("‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", error.message);
                throw error;
            }
        }

        function handleSheetASubmit(event) {
            event.preventDefault();

            const form = document.getElementById('sheet-a-form');
            const submitButton = form ? form.querySelector('button[type="submit"]') : null;


            try {
                const session = checkLoginStatus();
                if (!session) {
                    showMessageBox("‚ùå Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà");
                    showLoginModal();
                    return;
                }

                const formData = getSheetAFormData(form);

                if (!formData['a-watering'] || formData['a-watering'].trim() === '') {
                    showMessageBox("‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô!", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å **‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥** ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß");
                    return;
                }

                if (!formData['a-fertilizer-method'] || formData['a-fertilizer-method'].trim() === '') {
                    showMessageBox("‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô!", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å **‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢** ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß");
                    return;
                }

                if (!formData['a-recorder'] || formData['a-recorder'].trim() === '') {
                    showMessageBox("‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô!", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å **‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å**");
                    return;
                }

                if (!isAppsScriptReady('Sheet A Submission')) {
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                    }
                    return;
                }

                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<div class="loading-spinner"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                }

                const successHandler = (result) => {
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                    }

                    if (result && result.success) {
                        showMessageBox("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!",
                            `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÅ‡∏£‡πà‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡πÇ‡∏ô‡∏Ç‡∏≠‡∏á **${formData['a-fullname']}** ‡∏£‡∏´‡∏±‡∏™ **${formData['a-id']}** ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß 
                            <br><br>‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: **${result.data?.row || 'N/A'}**
                            <br>‡πÄ‡∏ß‡∏•‡∏≤: ${new Date().toLocaleTimeString('th-TH')}`
                        );

                        resetSheetAFormExceptLong();
                        showView('sheet-a-view');
                    } else {
                        showMessageBox("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", (result && result.message) || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                    }
                };

                const errorHandler = (error) => {
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                    }
                    showMessageBox("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!",
                        `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:
                        <br><br><strong class='text-red-600'>${(error && error.message) || 'Unknown Error'}</strong>
                        <br><br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö`
                    );
                };

                google.script.run
                    .withSuccessHandler(successHandler)
                    .withFailureHandler(errorHandler)
                    .writeSheetA(formData, session.token);

            } catch (error) {
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                }
                console.error('Validation error:', error);
            }
        }

        function updateSheetALongDropdown() {
            const currentUser = checkLoginStatus();
            const longSelect = document.getElementById('a-long-affiliation');

            if (currentUser && longSelect) {
                for (let i = 0; i < longSelect.options.length; i++) {
                    if (longSelect.options[i].value === currentUser.longName) {
                        longSelect.selectedIndex = i;
                        longSelect.disabled = true;
                        longSelect.classList.add('bg-gray-100', 'cursor-not-allowed');
                        break;
                    }
                }

                updateLongDropdownLabels(true);
            }
        }

        // =============================================
        // DATA FETCHING & DISPLAY
        // =============================================
        function fetchAndDisplaySheetAData() {
            const longAffiliationEl = document.getElementById('b-long-affiliation');
            const longAffiliation = longAffiliationEl ? longAffiliationEl.value : '';
            const farmerId = (document.getElementById('summary-search-id') && document.getElementById('summary-search-id').value.trim()) || '';
            const fetchButton = document.getElementById('fetch-data-btn');


            if (!longAffiliation || !farmerId) {
                showMessageBox("‚ùå ‡∏Ç‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•!", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡πâ‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£");
                return;
            }

            if (fetchButton) {
                fetchButton.disabled = true;
                fetchButton.innerHTML = '<div class="loading-spinner"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...';
            }

            google.script.run
                .withSuccessHandler((sheetAResult) => {

                    if (fetchButton) {
                        fetchButton.disabled = false;
                        fetchButton.innerHTML = `‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤`;
                    }

                    try {
                        const sheetAData = safeParseJSON(sheetAResult);

                        if (sheetAData && sheetAData.success && Array.isArray(sheetAData.data) && sheetAData.data.length > 0) {
                            const farmer = sheetAData.data[sheetAData.data.length - 1];
                            updateSheetBReadonlyData(farmer);

                            fetchSheetBData(longAffiliation, farmerId);

                        } else {
                            showMessageBox("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•!", `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™: ${farmerId}`);
                        }
                    } catch (e) {
                        console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', e);
                        showMessageBox("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!", "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
                    }
                })
                .withFailureHandler((error) => {
                    if (fetchButton) {
                        fetchButton.disabled = false;
                        fetchButton.innerHTML = `‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤`;
                    }
                    showMessageBox("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!", (error && error.message) || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤');
                })
                .searchFarmerData(longAffiliation, farmerId);
        }

        function fetchSheetBData(longAffiliation, farmerId) {
            const fetchButton = document.getElementById('fetch-data-btn');

            console.log('üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Sheet B:', { longAffiliation, farmerId });

            // First ensure sheet for long exists (try to create or ensure)
            google.script.run
                .withSuccessHandler((createResult) => {
                    // Now fetch sheet B data
                    google.script.run
                        .withSuccessHandler((sheetBResult) => {
                            if (fetchButton) {
                                fetchButton.disabled = false;
                                fetchButton.innerHTML = `‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤`;
                            }

                            try {
                                const sheetBData = safeParseJSON(sheetBResult);
                                if (sheetBData && sheetBData.data) {
                                    displaySheetBUsageData(sheetBData.data);
                                } else {
                                    displaySheetBUsageData([]);
                                }
                            } catch (e) {
                                console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Sheet B', e);
                                displaySheetBUsageData([]);
                            }
                        })
                        .withFailureHandler((err) => {
                            if (fetchButton) {
                                fetchButton.disabled = false;
                                fetchButton.innerHTML = `‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤`;
                            }
                            console.error('‚ùå searchSheetBData failed', err);
                            showMessageBox("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!", (err && err.message) || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Sheet B ‡πÑ‡∏î‡πâ');
                        })
                        .searchSheetBData(longAffiliation, farmerId);
                })
                .withFailureHandler((error) => {
                    if (fetchButton) {
                        fetchButton.disabled = false;
                        fetchButton.innerHTML = `‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤`;
                    }
                    console.error('‚ùå createNewSheetForLong failed', error);
                    showMessageBox("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!", (error && error.message) || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Sheet ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡πâ‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ');
                })
                .createNewSheetForLong(longAffiliation);
        }

        function fetchSheetBUsageData(longAffiliation, farmerId, fetchButton) {
            google.script.run
                .withSuccessHandler((sheetBResult) => {
                    if (fetchButton) {
                        fetchButton.disabled = false;
                        fetchButton.innerHTML = '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';
                    }

                    try {
                        const sheetBData = safeParseJSON(sheetBResult);

                        if (sheetBData && sheetBData.success && sheetBData.data && sheetBData.data.length > 0) {
                            displaySheetBUsageData(sheetBData.data);
                        } else {
                            const fEl = document.getElementById('b-fertilizer-usage-display');
                            const nEl = document.getElementById('b-nano-usage-display');
                            const mEl = document.getElementById('b-mineral-usage-display');
                            if (fEl) fEl.textContent = '- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -';
                            if (nEl) nEl.textContent = '- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -';
                            if (mEl) mEl.textContent = '- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -';
                        }
                    } catch (e) {
                        console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• Sheet B:', e);
                    }
                })
                .withFailureHandler((error) => {
                    if (fetchButton) {
                        fetchButton.disabled = false;
                        fetchButton.innerHTML = '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';
                    }
                    console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á Sheet B:', error);
                })
                .searchSheetBData(longAffiliation, farmerId);
        }

        // =============================================
        // SHEET B FUNCTIONS
        // =============================================
        function fetchAndDisplaySheetBUseData() {
            const longAffiliation = document.getElementById('b-long-affiliation') ? document.getElementById('b-long-affiliation').value : '';
            const farmerId = document.getElementById('summary-search-id') ? document.getElementById('summary-search-id').value.trim() : '';

            if (!longAffiliation || !farmerId) {
                showMessageBox("‚ùå ‡∏Ç‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•!", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡πâ‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£");
                return;
            }

            const fetchButton = document.getElementById('fetch-data-btn');
            if (fetchButton) {
                fetchButton.disabled = true;
                fetchButton.innerHTML = '<div class="loading-spinner"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...';
            }

            google.script.run
                .withSuccessHandler((sheetAResult) => {
                    try {
                        const sheetAData = safeParseJSON(sheetAResult);

                        if (sheetAData && sheetAData.success && sheetAData.data.length > 0) {
                            const farmer = sheetAData.data[sheetAData.data.length - 1];
                            updateSheetBReadonlyData(farmer);

                            fetchSheetBUsageData(longAffiliation, farmerId, fetchButton);
                        } else {
                            if (fetchButton) {
                                fetchButton.disabled = false;
                                fetchButton.innerHTML = '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';
                            }
                            showMessageBox("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•!", `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™: ${farmerId}`);
                        }
                    } catch (e) {
                        if (fetchButton) {
                            fetchButton.disabled = false;
                            fetchButton.innerHTML = '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';
                        }
                        showMessageBox("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!", "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
                    }
                })
                .withFailureHandler((error) => {
                    if (fetchButton) {
                        fetchButton.disabled = false;
                        fetchButton.innerHTML = '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';
                    }
                    showMessageBox("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!", (error && error.message) || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                })
                .searchFarmerData(longAffiliation, farmerId);
        }

        function displaySheetBUsageData(usageData) {
            console.log('üîç displaySheetBUsageData - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö:', usageData);

            if (!usageData || usageData.length === 0) {
                console.log('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• - ‡πÅ‡∏™‡∏î‡∏á placeholder');

                const fEl = document.getElementById('b-fertilizer-usage-display');
                const nEl = document.getElementById('b-nano-usage-display');
                const mEl = document.getElementById('b-mineral-usage-display');
                if (fEl) fEl.innerHTML = '<p class="text-stone-500">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -</p>';
                if (nEl) nEl.innerHTML = '<p class="text-stone-500">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -</p>';
                if (mEl) mEl.innerHTML = '<p class="text-stone-500">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -</p>';

                const postMitraEl = document.querySelector('[data-field="b-post-mitra"]');
                if (postMitraEl) postMitraEl.textContent = '---';
                return;
            }

            const latestUsage = usageData[0];

            const fertilizerUsage = latestUsage['b-fertilizer-usage'] || '';
            const nanoUsage = latestUsage['b-nano-usage'] || '';
            const mineralUsage = latestUsage['b-mineral-usage'] || '';
            const postMitra = latestUsage['b-post-mitra'] || '---';

            displayUsageText('b-fertilizer-usage-display', fertilizerUsage);
            displayUsageText('b-nano-usage-display', nanoUsage);
            displayUsageText('b-mineral-usage-display', mineralUsage);

            const postMitraElement = document.querySelector('[data-field="b-post-mitra"]');
            if (postMitraElement) {
                if (postMitra && postMitra !== '' && postMitra !== '---') {
                    const num = parseFloat(postMitra);
                    postMitraElement.textContent = isNaN(num) ? '---' : num.toFixed(2);
                    postMitraElement.className = 'text-xl font-bold text-blue-600';
                } else {
                    postMitraElement.textContent = '---';
                    postMitraElement.className = 'text-xl font-bold text-gray-400';
                }
            }
        }

        function updateSheetBReadonlyData(sheetAData) {
            try {
                console.log('üîÑ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•:', sheetAData);

                if (!sheetAData || Object.keys(sheetAData).length === 0) {
                    console.log('üì≠ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á');
                    resetDisplayData();
                    return;
                }

                const dataMapA = {
                    'a-fullname': sheetAData['a-fullname'] || '---',
                    'a-id': sheetAData['a-id'] || '---',
                    'a-long-affiliation': sheetAData['a-long-affiliation'] || '---',
                    'a-plotsize': sheetAData['a-plotsize'] || '---',
                    'a-cropspecies': sheetAData['a-cropspecies'] || '---',
                    'a-watering': sheetAData['a-watering'] || '---',
                    'a-fertilizer-methods': sheetAData['a-fertilizer-method'] || '---',
                    'a-datecollect': formatDateForDisplay(sheetAData['a-datecollect']),
                    'a-sackcollect': sheetAData['a-sackcollect'] || '---',
                    'a-datenano': formatDateForDisplay(sheetAData['a-datenano']),
                    'a-nanoliters': sheetAData['a-nanoliters'] || '---',
                    'a-premitra': sheetAData['a-premitra'] || '---'
                };

                Object.keys(dataMapA).forEach(fieldName => {
                    const elements = document.querySelectorAll(`[data-field="${fieldName}"]`);
                    elements.forEach(el => {
                        el.textContent = dataMapA[fieldName];

                        if (fieldName === 'a-premitra' && dataMapA[fieldName] !== '---') {
                            el.className = 'text-xl font-bold text-red-600';
                        }
                    });
                });

            } catch (error) {
                console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô updateSheetBReadonlyData:', error);
                showMessageBox("‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô");
            }
        }

        // =============================================
        // DATA DISPLAY FUNCTIONS
        // =============================================
        function displayUsageText(displayElementId, textData) {
            const displayElement = document.getElementById(displayElementId);

            if (!displayElement) return;

            if (!textData || (typeof textData === 'string' && textData.trim() === '') || textData === '-') {
                displayElement.textContent = '- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -';
                return;
            }

            // if it's array/object, stringify appropriately
            if (Array.isArray(textData)) {
                displayElement.textContent = textData.map(t => (typeof t === 'string' ? t : JSON.stringify(t))).join('\n');
                return;
            }
            displayElement.textContent = typeof textData === 'string' ? textData : JSON.stringify(textData);
        }

        function formatDateForDisplay(dateString) {
            if (!dateString || dateString === '---') {
                return '---';
            }

            try {
                // handle ISO timestamp or full date
                if (typeof dateString === 'string' && dateString.includes('T') && dateString.includes('Z')) {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('th-TH', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                }

                // handle YYYY-MM-DD (input type="date" value)
                if (typeof dateString === 'string' && dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const [year, month, day] = dateString.split('-');
                    return `${day}/${month}/${year}`;
                }

                // if already DD/MM/YYYY or other readable, return as-is
                return dateString;
            } catch (error) {
                console.error('Error formatting date:', error, dateString);
                return dateString;
            }
        }

        // =============================================
        // SHEET B USE FUNCTIONS
        // =============================================
        function getUsageData() {
            const fertilizerUsage = getFertilizerUsageData();
            const nanoUsage = [];
            const mineralUsage = [];

            console.log('üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ...');

            document.querySelectorAll('.nano-usage-item').forEach(item => {
                const date = item.querySelector('.nano-date')?.value;
                const amount = item.querySelector('.nano-amount')?.value;
                if (date && amount) {
                    const parsed = parseFloat(amount);
                    if (!isNaN(parsed)) {
                        nanoUsage.push({
                            date: date,
                            amount: parsed
                        });
                    }
                }
            });

            document.querySelectorAll('.mineral-usage-item').forEach(item => {
                const date = item.querySelector('.mineral-date')?.value;
                const amount = item.querySelector('.mineral-amount')?.value;
                if (date && amount) {
                    const parsed = parseFloat(amount);
                    if (!isNaN(parsed)) {
                        mineralUsage.push({
                            date: date,
                            amount: parsed
                        });
                    }
                }
            });

            console.log('üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ:', {
                fertilizer: fertilizerUsage,
                nano: nanoUsage,
                mineral: mineralUsage
            });

            return {
                fertilizerUsage: fertilizerUsage,
                nanoUsage: nanoUsage,
                mineralUsage: mineralUsage
            };
        }

        function createFertilizerUsageHTML() {
            const uniqueId = `fert-${Date.now()}`;

            // NOTE: removed inline onchange attribute; will attach listener in initializeFertilizerCheckboxes()
            return `
                <div class="fertilizer-usage-item grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢</label>
                        <input type="date" class="fertilizer-date w-full">
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium mb-1">‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏î‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢ <span class="text-xs text-green-600">(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏ô‡∏∂‡πà‡∏á)</span></label>
                        <div class="radio-group flex flex-wrap gap-2">
                            <input type="checkbox" id="${uniqueId}-organic" name="fertilizer_type[]" value="‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå" class="">
                            <label for="${uniqueId}-organic" class="px-3 py-2 rounded-lg cursor-pointer border border-green-300 bg-white hover:bg-green-50">‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå</label>

                            <input type="checkbox" id="${uniqueId}-chemical" name="fertilizer_type[]" value="‡∏õ‡∏∏‡πã‡∏¢‡πÄ‡∏Ñ‡∏°‡∏µ" class="">
                            <label for="${uniqueId}-chemical" class="px-3 py-2 rounded-lg cursor-pointer border border-green-300 bg-white hover:bg-green-50">‡∏õ‡∏∏‡πã‡∏¢‡πÄ‡∏Ñ‡∏°‡∏µ</label>

                            <input type="checkbox" id="${uniqueId}-manure" name="fertilizer_type[]" value="‡∏õ‡∏∏‡πã‡∏¢‡∏Ñ‡∏≠‡∏Å" class="">
                            <label for="${uniqueId}-manure" class="px-3 py-2 rounded-lg cursor-pointer border border-green-300 bg-white hover:bg-green-50">‡∏õ‡∏∏‡πã‡∏¢‡∏Ñ‡∏≠‡∏Å</label>

                            <input type="checkbox" id="${uniqueId}-other" name="fertilizer_type[]" value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ" class="">
                            <label for="${uniqueId}-other" class="px-3 py-2 rounded-lg cursor-pointer border border-green-300 bg-white hover:bg-green-50">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏)</label>
                        </div>
                        <input type="text" placeholder="‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ" class="hidden mt-2 w-full fertilizer-other-text">
                    </div>

                    <div class="flex items-end col-span-full"></div> 
                </div>
            `;
        }

        async function handleSheetBUseSubmit(event) {
            event.preventDefault();

            const form = document.getElementById('sheet-b-use-form');
            const submitButton = form ? form.querySelector('button[type="submit"]') : null;

            try {
                const longAffiliation = document.getElementById('b-long-affiliation-use')?.value;
                const farmerId = document.getElementById('b-farmer-id-use')?.value.trim();
                const fullname = document.getElementById('b-fullname-use')?.value.trim();

                if (!longAffiliation) {
                    showMessageBox("‚ùå ‡∏Ç‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•!", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î");
                    return;
                }

                if (!farmerId) {
                    showMessageBox("‚ùå ‡∏Ç‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•!", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡πâ‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£");
                    return;
                }

                if (!fullname) {
                    showMessageBox("‚ùå ‡∏Ç‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•!", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£");
                    return;
                }

                const recorderElement = document.querySelector('input[name="b-recorder"]:checked');
                if (!recorderElement) {
                    showMessageBox("‚ùå ‡∏Ç‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•!", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
                    return;
                }

                const usageData = getUsageData();
                const hasFertilizer = usageData.fertilizerUsage.length > 0;
                const hasNano = usageData.nanoUsage.length > 0;
                const hasMineral = usageData.mineralUsage.length > 0;

                if (!hasFertilizer && !hasNano && !hasMineral) {
                    showMessageBox("‚ùå ‡∏Ç‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•!", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏õ‡∏∏‡πã‡∏¢, ‡∏ô‡∏≤‡πÇ‡∏ô, ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏£‡πà)");
                    return;
                }

                let errorMessage = '';

                usageData.fertilizerUsage.forEach((item, index) => {
                    if (!item.date || !item.type) {
                        errorMessage += `‚Ä¢ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πã‡∏¢‡∏ó‡∏µ‡πà ${index + 1}: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏ä‡∏ô‡∏¥‡∏î‡∏õ‡∏∏‡πã‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö<br>`;
                    }
                });

                usageData.nanoUsage.forEach((item, index) => {
                    if (!item.date || !item.amount) {
                        errorMessage += `‚Ä¢ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏≤‡πÇ‡∏ô‡∏ó‡∏µ‡πà ${index + 1}: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö<br>`;
                    }
                });

                usageData.mineralUsage.forEach((item, index) => {
                    if (!item.date || !item.amount) {
                        errorMessage += `‚Ä¢ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡πà‡∏ó‡∏µ‡πà ${index + 1}: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö<br>`;
                    }
                });

                if (errorMessage) {
                    showMessageBox("‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô!", errorMessage);
                    return;
                }

                const rateElement = form.querySelector('input[name="b-rate"]:checked');
                const nanoRateElement = form.querySelector('input[name="b-nano-rate"]:checked');

                if (!rateElement) {
                    showMessageBox("‚ùå ‡∏Ç‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•!", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡πÅ‡∏£‡πà");
                    return;
                }

                if (!nanoRateElement) {
                    showMessageBox("‚ùå ‡∏Ç‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•!", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏ô‡∏≤‡πÇ‡∏ô");
                    return;
                }


                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<div class="loading-spinner"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                }

                const formData = {
                    timestamp: new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' }),
                    'b-long-affiliation': longAffiliation,
                    'b-farmer-id': farmerId,
                    'b-fullname': fullname,
                    'b-phone': document.getElementById('b-phone-use')?.value.trim() || '',
                    'b-fertilizer-usage': usageData.fertilizerUsage,
                    'b-nano-usage': usageData.nanoUsage,
                    'b-mineral-usage': usageData.mineralUsage,
                    'b-rate': rateElement.value,
                    'b-rate-adjusted': document.getElementById('b-rate-adjusted')?.value || '',
                    'b-nano-rate': nanoRateElement.value,
                    'b-nano-rate-adjusted': document.getElementById('b-nano-rate-adjusted')?.value || '',
                    'b-recorder': recorderElement.value
                };

                console.log('üì¶ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Sheet B:', formData);

                google.script.run
                    .withSuccessHandler((result) => {
                        if (submitButton) {
                            submitButton.disabled = false;
                            submitButton.innerHTML = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ';
                        }

                        if (result && result.success) {
                            showMessageBox("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!",
                                `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ 4-7-16 ‡∏Ç‡∏≠‡∏á **${formData['b-fullname']}** ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß
                                <br><br>‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: **${result.data?.row || 'N/A'}**
                                <br>‡∏ä‡∏µ‡∏ó: **${result.data?.sheet || 'N/A'}**
                                <br>‡πÄ‡∏ß‡∏•‡∏≤: ${new Date().toLocaleTimeString('th-TH')}`
                            );
                            if (form) form.reset();
                            resetUsageContainers();
                            showView('main-menu-view');
                        } else {
                            showMessageBox("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", (result && result.message) || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                        }
                    })
                    .withFailureHandler((error) => {
                        if (submitButton) {
                            submitButton.disabled = false;
                            submitButton.innerHTML = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ';
                        }
                        showMessageBox("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!",
                            `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${(error && error.message) || 'Unknown error'}
                            <br><br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á`
                        );
                        console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:', error);
                    })
                    .writeSheetB(formData);

            } catch (error) {
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ';
                }
                console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:', error);
                showMessageBox("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!", error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            }
        }

        function resetUsageContainers() {
            const fertilizerContainer = document.getElementById('fertilizer-usage-container');
            if (fertilizerContainer) {
                fertilizerContainer.innerHTML = createFertilizerUsageHTML();
            }

            const nanoContainer = document.getElementById('nano-usage-container');
            if (nanoContainer) {
                nanoContainer.innerHTML = `
                    <div class="nano-usage-item grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                        <div>
                            <label class="block text-sm font-medium mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ô‡∏≤‡πÇ‡∏ô</label>
                            <input type="date" class="nano-date w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (‡∏•‡∏¥‡∏ï‡∏£)</label>
                            <input type="number" class="nano-amount w-full" min="0.1" step="0.1">
                        </div>
                        <div class="flex items-end"></div>
                    </div>
                `;
            }

            const mineralContainer = document.getElementById('mineral-usage-container');
            if (mineralContainer) {
                mineralContainer.innerHTML = `
                    <div class="mineral-usage-item grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                        <div>
                            <label class="block text-sm font-medium mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏£‡πà</label>
                            <input type="date" class="mineral-date w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°)</label>
                            <input type="number" class="mineral-amount w-full" min="0.1" step="0.1">
                        </div>
                        <div class="flex items-end"></div>
                    </div>
                `;
            }
            initializeFertilizerCheckboxes();
        }

        document.addEventListener('DOMContentLoaded', function () {
            initializeFertilizerCheckboxes();
        });

        // =============================================
        // USAGE DATA MANAGEMENT
        // =============================================
        let fertilizerUsageCount = 1;
        let nanoUsageCount = 1;
        let mineralUsageCount = 1;

        function getFertilizerUsageData() {
            const fertilizerUsage = [];

            document.querySelectorAll('.fertilizer-usage-item').forEach((item, index) => {
                const date = item.querySelector('.fertilizer-date')?.value;
                const checkedBoxes = item.querySelectorAll('input[type="checkbox"]:checked');
                const checkedTypes = Array.from(checkedBoxes).map(cb => {
                    if (cb.value === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ') {
                        const otherTextInput = item.querySelector('.fertilizer-other-text');
                        if (otherTextInput && !otherTextInput.classList.contains('hidden')) {
                            const otherValue = otherTextInput.value.trim();
                            return otherValue ? `‡∏≠‡∏∑‡πà‡∏ô‡πÜ: ${otherValue}` : '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';

                        }
                        return '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'
                    }
                    return cb.value;
                }).filter(val => val); // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á

                if (date && checkedTypes.length > 0) {
                    fertilizerUsage.push({
                        date: date,
                        type: checkedTypes.join(', ')
                    });
                }
            });
            return fertilizerUsage;
        }

        function getSheetBUseFormData(form) {
            const usageData = getUsageData();

            const hasUsageData = usageData.fertilizerUsage.length > 0 ||
                usageData.nanoUsage.length > 0 ||
                usageData.mineralUsage.length > 0;

            if (!hasUsageData) {
                throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
            }

            const formData = {
                timestamp: new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' }),
                'b-long-affiliation': document.getElementById('b-long-affiliation-use')?.value,
                'b-farmer-id': document.getElementById('b-farmer-id-use')?.value.trim(),
                'b-fullname': document.getElementById('b-fullname-use')?.value.trim(),
                'b-phone': document.getElementById('b-phone-use')?.value.trim() || '',
                'b-fertilizer-usage': usageData.fertilizerUsage,
                'b-nano-usage': usageData.nanoUsage,
                'b-mineral-usage': usageData.mineralUsage,
                'b-premitra': parseFloat(document.getElementById('b-premitra')?.value || 0),
                'b-rate': form.querySelector('input[name="b-rate"]:checked')?.value,
                'b-rate-adjusted': document.getElementById('b-rate-adjusted')?.value ? parseFloat(document.getElementById('b-rate-adjusted').value) : '',
                'b-nano-rate': form.querySelector('input[name="b-nano-rate"]:checked')?.value,
                'b-nano-rate-adjusted': document.getElementById('b-nano-rate-adjusted')?.value ? parseFloat(document.getElementById('b-nano-rate-adjusted').value) : '',
                'b-recorder': document.querySelector('input[name="b-recorder"]:checked')?.value || ''
            };

            if (formData['b-rate'] !== '‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°') {
                delete formData['b-rate-adjusted'];
            }
            if (formData['b-nano-rate'] !== '‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°') {
                delete formData['b-nano-rate-adjusted'];
            }

            Object.keys(formData).forEach(key => {
                if (formData[key] === '' || formData[key] === null || formData[key] === undefined) {
                    delete formData[key];
                }
            });
            return formData;
        }

        // =============================================
        // VALIDATION & SECURITY
        // =============================================
        function validateBeforeSubmit() {
            const longAffiliation = document.getElementById('b-long-affiliation-use')?.value;
            const farmerId = document.getElementById('b-farmer-id-use')?.value.trim();

            if (!longAffiliation || !farmerId) {
                return Promise.resolve(false);
            }

            return new Promise((resolve) => {
                google.script.run
                    .withSuccessHandler((result) => {
                        if (result && result.success && result.exists) {
                            resolve(true);
                        } else {
                            showMessageBox("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î",
                                `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ${result && result.message ? result.message : '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'}
                                 <br><br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤:
                                 <br>‚Ä¢ ‡∏î‡∏π‡πÅ‡∏•‡∏•‡πâ‡∏á‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÅ‡∏£‡πà/‡∏ô‡∏≤‡πÇ‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
                                 <br>‚Ä¢ ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏´‡∏°
                                 <br>‚Ä¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏´‡∏°`);
                            resolve(false);
                        }
                    })
                    .withFailureHandler((error) => {
                        showMessageBox("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: " + (error && error.message ? error.message : 'Unknown error'));
                        resolve(false);
                    })
                    .validateDataRelationship(longAffiliation, farmerId);
            });
        }

        // =============================================
        // AUTHENTICATION FUNCTIONS
        // =============================================
        async function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('username')?.value.trim();
            const password = document.getElementById('password')?.value;
            const errorElement = document.getElementById('login-error');
            const submitButton = event.target.querySelector('button[type="submit"]');

            if (!username || !password) {
                const errorMessage = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏•‡πâ‡∏á‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô";
                if (errorElement) {
                    errorElement.textContent = errorMessage;
                    errorElement.classList.remove('hidden');
                } else {
                    showMessageBox("‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö", errorMessage);
                }
                return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = '<div class="loading-spinner"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';

            if (errorElement) {
                errorElement.classList.add('hidden');
            }

            try {
                const response = await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .userLogin(username, password);
                });

                if (response && response.success) {
                    sessionStorage.setItem('sessionToken', response.token);
                    sessionStorage.setItem('longName', response.longName);
                    sessionStorage.setItem('username', response.username);
                    sessionStorage.setItem('isAdmin', response.isAdmin ? 'true' : 'false');

                    hideLoginModal();

                    if (response.isAdmin) {
                        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô admin ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ admin
                        adminCheckAuthAndInit();
                    } else {
                        showView('submenu-view');
                        updateAllLongDropdowns(response.longName);
                    }

                    showMessageBox("‚úÖ ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${response.longName}`);
                } else {
                    const errorMessage = (response && response.message) || "‡∏ä‡∏∑‡πà‡∏≠‡∏•‡πâ‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
                    if (errorElement) {
                        errorElement.textContent = errorMessage;
                        errorElement.classList.remove('hidden');
                    } else {
                        showMessageBox("‚ùå ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", errorMessage);
                    }
                }
            } catch (error) {
                console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô:', error);
                const errorMessage = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö";
                if (errorElement) {
                    errorElement.textContent = errorMessage;
                    errorElement.classList.remove('hidden');
                } else {
                    showMessageBox("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏ö‡∏ö", errorMessage);
                }
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
            }
        }

        function showLoginModal() {
            const el = document.getElementById('login-modal');
            if (el) el.classList.remove('hidden');
            const input = document.getElementById('username');
            if (input) input.focus();
        }

        function hideLoginModal() {
            const modal = document.getElementById('login-modal');
            if (modal) modal.classList.add('hidden');
            const form = document.getElementById('login-form');
            if (form) form.reset();
            const err = document.getElementById('login-error');
            if (err) err.classList.add('hidden');
        }

        function checkLoginStatus() {

            const token = sessionStorage.getItem('sessionToken');
            const longName = sessionStorage.getItem('longName');
            const username = sessionStorage.getItem('username');

            if (!token || !longName || !username) {
                return null;
            }

            try {
                const parts = token.split('.');
                if (parts.length < 2) {
                    console.log('‚ùå ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                    sessionStorage.clear();
                    return null;
                }

                const tokenData = JSON.parse(atob(parts[0]));
                const tokenTime = tokenData.timestamp;
                const hoursDiff = (new Date().getTime() - tokenTime) / (1000 * 60 * 60);

                if (hoursDiff >= 24) {
                    console.log('‚ùå Token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏');
                    sessionStorage.clear();
                    showMessageBox("‚è∞ Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà");
                    return null;
                }

                return { username, longName, token };
            } catch (e) {
                console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö token:', e);
                sessionStorage.clear();
                return null;
            }
        }

        function checkAuthAndShowSubmenu() {
            const currentUser = checkLoginStatus();

            if (currentUser) {
                showView('submenu-view');
                const header = document.querySelector('#submenu-view header');
                if (header) {
                    // ensure we don't append duplicates
                    if (!header.querySelector('.submenu-user-info')) {
                        const userInfo = document.createElement('div');
                        userInfo.className = 'submenu-user-info text-sm text-stone-600 mb-2';
                        userInfo.innerHTML = `‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô: <strong>${currentUser.longName}</strong>`;
                        header.insertBefore(userInfo, header.firstChild);
                    }
                }

            } else {
                showLoginModal();
            }
        }

        function logout() {
            try {
                let longName = sessionStorage.getItem('longName');

                try {
                    const currentUser = sessionStorage.getItem('currentUser');
                    if (currentUser) {
                        const userData = JSON.parse(currentUser);
                        longName = longName || userData.longName;
                    }
                } catch (e) {
                    console.log('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ parse currentUser:', e);
                }

                sessionStorage.clear();
                resetLongDropdowns();
                showView('main-menu-view');

                showMessageBox("üëã ‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", `‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö ${longName || ''} ‡πÅ‡∏•‡πâ‡∏ß`);

            } catch (error) {
                console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô logout:', error);
                sessionStorage.clear();
                window.location.reload();
            }
        }

        // =============================================
        // SUMMARY & DATA FUNCTIONS
        // =============================================
        function fetchSummaryData() {
            const currentUser = checkLoginStatus();

            if (!currentUser) {
                showMessageBox("‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà");
                showLoginModal();
                return;
            }

            const loadingElement = document.getElementById('summary-loading');
            const dataContainer = document.getElementById('summary-data-container');
            const emptyElement = document.getElementById('summary-empty');

            if (dataContainer) dataContainer.classList.add('hidden');
            if (emptyElement) emptyElement.classList.add('hidden');
            if (loadingElement) loadingElement.classList.remove('hidden');

            const selectedLong = currentUser.longName;

            if (!isAppsScriptReady('Summary Data Fetching')) {
                if (loadingElement) loadingElement.classList.add('hidden');
                return;
            }

            google.script.run
                .withSuccessHandler((result) => {
                    if (loadingElement) loadingElement.classList.add('hidden');

                    try {
                        const data = safeParseJSON(result);

                        if (data && data.success && Array.isArray(data.data) && data.data.length > 0) {
                            displaySummaryData(data.data, selectedLong);
                        } else {
                            showEmptySummary(selectedLong);
                        }
                    } catch (e) {
                        console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:', e);
                        showMessageBox("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!", "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
                    }
                })
                .withFailureHandler((error) => {
                    if (loadingElement) loadingElement.classList.add('hidden');
                    console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ:', error);
                    showMessageBox("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!", (error && error.message) || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                })
                .getAllFarmersByLong(selectedLong);
        }

        function displaySummaryData(farmers, selectedLong) {
            const tableBody = document.getElementById('summary-table-body');
            const dataContainer = document.getElementById('summary-data-container');
            const countElement = document.getElementById('summary-count');
            const emptyElement = document.getElementById('summary-empty');

            if (countElement) {
                countElement.textContent = `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${farmers.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏•‡πâ‡∏á ${selectedLong}`;
                countElement.className = 'text-sm text-green-600 font-semibold';
            }

            if (tableBody) tableBody.innerHTML = '';

            farmers.forEach((farmer, index) => {
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-white' : 'bg-stone-50';
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium text-stone-800">${farmer['a-id'] || '---'}</td>
                    <td class="px-4 py-3">${farmer['a-fullname'] || '---'}</td>
                    <td class="px-4 py-3">${farmer['a-phone'] || '---'}</td>
                    <td class="px-4 py-3">${farmer['a-plotsize'] ? `${farmer['a-plotsize']} ‡πÑ‡∏£‡πà` : '---'}</td>
                    <td class="px-4 py-3">${farmer['a-cropspecies'] || '---'}</td>
                    <td class="px-4 py-3">${formatDateForDisplay(farmer['a-datecollect']) || '---'}</td>
                    <td class="px-4 py-3">${farmer['a-sackcollect'] ? `${farmer['a-sackcollect']} ‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö` : '---'}</td>
                    <td class="px-4 py-3">${formatDateForDisplay(farmer['a-datenano']) || '---'}</td>
                    <td class="px-4 py-3">${farmer['a-nanoliters'] ? `${farmer['a-nanoliters']} ‡∏•‡∏¥‡∏ï‡∏£` : '---'}</td>
                    <td class="px-4 py-3 font-medium ${getMitraColorClass(farmer['a-premitra'])}">
                        ${farmer['a-premitra'] ? `${parseFloat(farmer['a-premitra']).toFixed(2)}` : '---'}
                    </td>
                    <td class="px-4 py-3">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusClass(farmer)}">
                            ${getStatusText(farmer)}
                        </span>
                    </td>
                `;
                if (tableBody) tableBody.appendChild(row);
            });

            if (dataContainer) dataContainer.classList.remove('hidden');
            if (emptyElement) emptyElement.classList.add('hidden');
        }

        function showEmptySummary(selectedLong) {
            const dataContainer = document.getElementById('summary-data-container');
            const countElement = document.getElementById('summary-count');
            const emptyElement = document.getElementById('summary-empty');

            if (dataContainer) dataContainer.classList.add('hidden');
            if (emptyElement) emptyElement.classList.remove('hidden');
            if (countElement) {
                countElement.textContent = `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÉ‡∏ô‡∏•‡πâ‡∏á ${selectedLong}`;
                countElement.className = 'text-sm text-red-600 font-semibold';
            }
        }

        function getMitraColorClass(premitra) {
            if (!premitra || premitra === 0) return 'text-stone-500';
            const value = parseFloat(premitra);
            if (isNaN(value)) return 'text-stone-500';
            if (value < 1) return 'text-red-600';
            if (value < 2) return 'text-yellow-600';
            return 'text-green-600';
        }

        function getStatusClass(farmer) {
            if (!farmer['a-datecollect'] && !farmer['a-datenano']) return 'bg-gray-100 text-gray-800';
            if (farmer['a-datecollect'] && farmer['a-datenano']) return 'bg-green-100 text-green-800';
            return 'bg-yellow-100 text-yellow-800';
        }

        function getStatusText(farmer) {
            if (!farmer['a-datecollect'] && !farmer['a-datenano']) return '‡∏£‡∏≠‡∏£‡∏±‡∏ö';
            if (farmer['a-datecollect'] && farmer['a-datenano']) return '‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß';
            return '‡∏£‡∏±‡∏ö‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô';
        }

        // =============================================
        // DROPDOWN MANAGEMENT
        // =============================================
        function updateAllLongDropdowns(selectedLong) {
            const longSelectors = [
                'a-long-affiliation',
                'b-long-affiliation',
                'b-long-affiliation-use'
            ];

            longSelectors.forEach(selector => {
                const element = document.getElementById(selector);
                if (element) {
                    for (let i = 0; i < element.options.length; i++) {
                        if (element.options[i].value === selectedLong) {
                            element.selectedIndex = i;
                            break;
                        }
                    }

                    element.disabled = true;
                    element.classList.add('bg-gray-100', 'cursor-not-allowed');
                }
            });
            updateLongDropdownLabels(true);
        }

        function resetLongDropdowns() {
            const longSelectors = [
                'a-long-affiliation',
                'b-long-affiliation',
                'b-long-affiliation-use'
            ];

            longSelectors.forEach(selector => {
                const element = document.getElementById(selector);
                if (element) {
                    element.disabled = false;
                    element.selectedIndex = 0;
                    element.classList.remove('bg-gray-100', 'cursor-not-allowed');
                }
            });

            updateLongDropdownLabels(false);
        }

        function updateLongDropdownLabels(isAutoSelected) {
            const labels = [
                document.getElementById('long-affiliation-label'),
            ];

            labels.forEach(label => {
                if (label) {
                    const autoLabel = document.getElementById('auto-selected-label');

                    if (isAutoSelected) {
                        label.textContent = '‡∏•‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î *';
                        if (autoLabel) autoLabel.classList.remove('hidden');
                    } else {
                        label.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡πâ‡∏á';
                        if (autoLabel) autoLabel.classList.add('hidden');
                    }
                }
            });
        }

        // =============================================
        // INITIALIZATION
        // =============================================
        function initializeFertilizerCheckboxes() {
            const items = document.querySelectorAll('.fertilizer-usage-item');
            if (!items || items.length === 0) return;

            items.forEach(item => {

                const checkboxes = item.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    // clear inline onchange to avoid duplicate handling and then add our handler
                    try { checkbox.onchange = null; } catch (e) { }
                    if (checkbox.value && checkbox.value.trim() === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ') {
                        checkbox.removeEventListener('change', handleOtherCheckboxChange);
                        checkbox.addEventListener('change', handleOtherCheckboxChange);
                    }
                });
            });
        }

        // =============================================
        // EXTERNAL LINK FUNCTIONS
        // =============================================
        function openSurveyForm() {
            const surveyUrl = "https://script.google.com/macros/s/AKfycbwIy3D5nPqvIyVbOAjzEop3gIy2y5IXS4r1BhkmgAYEwDNZqLqGesA_2lBbQvjWzw/exec";

            const newWindow = window.open(surveyUrl, '_blank');

            if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                showMessageBox(
                    "üìã ‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°",
                    "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ:<br><br>" +
                    "<a href='" + surveyUrl + "' target='_blank' style='color: #16a34a; text-decoration: underline; font-weight: 600;'>" +
                    "üîó ‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°" +
                    "</a><br><br>" +
                    "<small>‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå: " + surveyUrl + "</small>"
                );
            } else {
                showMessageBox(
                    "üìã ‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°",
                    "‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß"
                );
            }
        }

        function openLeafSampleForm() {
            const leafSampleUrl = "https://script.google.com/macros/s/AKfycbzYZ0ZPXzjGLujcCto9GwJmDXEhQvSTelAYKt6Z_2Q9FhSCqWVw8DHVhjd2zr25N_dp/exec";

            const newWindow = window.open(leafSampleUrl, '_blank');

            if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                showMessageBox(
                    "üåø ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°",
                    "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ:<br><br>" +
                    "<a href='" + leafSampleUrl + "' target='_blank' style='color: #16a34a; text-decoration: underline; font-weight: 600;'>" +
                    "üîó ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°" +
                    "</a><br><br>" +
                    "<small>‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå: " + leafSampleUrl + "</small>"
                );
            } else {
                showMessageBox(
                    "üåø ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°",
                    "‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ö‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß"
                );
            }
        }

        // =============================================
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°
        // =============================================

        /* ===== ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå ===== */
        const varieties = [
            '‡∏ä‡∏∏‡∏°‡∏û‡∏ä', '‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏´‡∏≤‡∏á‡∏Å‡∏±‡πâ‡∏á', '‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ó‡∏≠‡∏á',
            '‡πÉ‡∏ö‡πÇ‡∏û‡∏ò‡∏¥‡πå', '‡πÅ‡∏ï‡∏á‡∏Å‡∏ß‡∏≤', '‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏∞‡∏û‡∏≤‡∏ö', '‡∏¢‡∏≠‡∏î‡∏ò‡∏á', '‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞‡πÄ‡∏¢‡∏≤',
            '‡∏™‡∏≠‡∏á‡πÄ‡∏•', '‡∏ö‡∏π‡∏£‡∏û‡∏≤', '‡∏•‡πâ‡∏≤‡∏ô‡∏ô‡∏≤', '‡∏ô‡∏≤‡∏Ñ‡∏≤'
        ];

        const stemLabels = {
            red: '‡∏Å‡πâ‡∏≤‡∏ô‡πÅ‡∏î‡∏á',
            white: '‡∏Å‡πâ‡∏≤‡∏ô‡∏Ç‡∏≤‡∏ß',
            green: '‡∏Å‡πâ‡∏≤‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß'
        };

        // lazy getter for stem container to avoid null before DOM ready
        function getStemContainer() {
            return document.getElementById('stem-sections');
        }

        function renderStemSection(stem) {
            if (!stem || !stemLabels[stem]) return;
            const stemContainer = getStemContainer();
            if (!stemContainer) return;
            if (document.getElementById(`section-${stem}`)) return;

            let html = `
                <div class="mt-4" id="section-${stem}" style="margin-top: 1rem;">
                    <h5 class="fw-bold" style="font-weight: 700; margin-bottom: 1rem; color: #292524;">${stemLabels[stem]} : ‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô</h5>
                    <div class="row g-3" style="display: grid; grid-template-columns: repeat(12, 1fr); gap: 0.75rem;">
            `;

            varieties.forEach(v => {
                // create a safe id for checkbox + label
                const safeVar = v.replace(/["'\[\]\s]/g, '_').toLowerCase();
                const checkboxId = `${stem}_${safeVar}_${Math.random().toString(36).substr(2, 5)}`;

                html += `
                    <div class="col-md-6" style="grid-column: span 6;">
                        <div class="input-group" style="display: flex; align-items: center;">
                            <div class="input-group-text d-flex align-items-center gap-2" style="padding: 0.5rem; background-color: #f9fafb; border: 1px solid #d1d5db; border-radius: 0.375rem 0 0 0.375rem; display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="${checkboxId}" class="variety-cb form-check-input" style="margin-right: 0.25rem;" aria-label="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå ${esc(v)}" />
                                <label for="${checkboxId}" class="mb-0" style="margin-bottom: 0; cursor: pointer;">${esc(v)}</label>
                            </div>
                            <input type="number"
                                   class="form-control variety-count"
                                   name="${stem}_count[${safeVar}]"
                                   placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô"
                                   disabled
                                   style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0 0.375rem 0.375rem 0; border-left: none;">
                        </div>
                    </div>
                `;
            });

            html += `</div></div>`;
            stemContainer.insertAdjacentHTML('beforeend', html);
        }

        /* ===== ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏£‡∏ß‡∏° ===== */
        function calculateTotal() {
            let total = 0;
            document.querySelectorAll('.variety-count').forEach(i => {
                if (!i.disabled && i.value) total += Number(i.value);
            });
            const totalEl = document.getElementById('total_tree_count');
            if (totalEl) totalEl.value = total;
        }

        // =============================================
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≥‡∏£‡∏ß‡∏à
        // =============================================

        // Toggle agent input (show agent-name when 'have' is selected)
        function toggleAgentInput() {
            const agentNameInput = document.getElementById('agent-name');
            const have = document.getElementById('agent-have');
            if (!agentNameInput) return;
            if (have && have.checked) {
                agentNameInput.classList.remove('hidden');
                agentNameInput.required = true;
            } else {
                agentNameInput.classList.add('hidden');
                agentNameInput.required = false;
                agentNameInput.value = '';
            }
        }

        // Toggle date-range visibility for gap/gacp
        function toggleDateRange(type, show) {
            const el = document.getElementById(`${type}-date-range`);
            if (!el) return;
            if (show) {
                el.classList.remove('hidden');
                // Set required for date inputs when visible
                const startDate = el.querySelector(`#${type}_start_date`);
                const endDate = el.querySelector(`#${type}_end_date`);
                if (startDate) startDate.required = true;
                if (endDate) endDate.required = true;
            } else {
                el.classList.add('hidden');
                // Remove required and clear values when hidden
                const startDate = el.querySelector(`#${type}_start_date`);
                const endDate = el.querySelector(`#${type}_end_date`);
                if (startDate) {
                    startDate.required = false;
                    startDate.value = '';
                }
                if (endDate) {
                    endDate.required = false;
                    endDate.value = '';
                }
            }
        }

        // Toggle visibility of "other" text inputs when 'other' checkboxes are toggled
        function setupOtherToggles() {
            const otherCheckboxes = document.querySelectorAll('input[type="checkbox"][data-other-target]');
            otherCheckboxes.forEach(cb => {
                const targetId = cb.getAttribute('data-other-target');

                // Remove existing listeners to prevent duplicates
                cb.removeEventListener('change', handleOtherCheckboxToggle);

                // Add new listener
                cb.addEventListener('change', function () {
                    handleOtherCheckboxToggle(this, targetId);
                });

                // Initialize based on current state
                const targetElem = document.getElementById(targetId);
                if (targetElem) {
                    if (cb.checked) {
                        targetElem.classList.remove('hidden');
                        targetElem.required = true;
                    } else {
                        targetElem.classList.add('hidden');
                        targetElem.required = false;
                    }
                }
            });
        }

        function handleOtherCheckboxToggle(checkbox, targetId) {
            const target = document.getElementById(targetId);
            if (!target) return;

            if (checkbox.checked) {
                target.classList.remove('hidden');
                target.required = true;
            } else {
                target.classList.add('hidden');
                target.required = false;
                target.value = '';
            }
        }

        // Helper escape for HTML
        const esc = (str) => String(str ?? '').replace(/[&<>"']/g, function (m) {
            return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m];
        });

        // Helpers for preview values display
        const val = (value, minSpace = 8) => {
            const v = esc(value);
            const space = '&nbsp;'.repeat(minSpace);
            return `<span style="font-weight: 600; color: #388E3C; text-decoration: underline; white-space: nowrap;">${v || space}</span>`;
        };
        const chk = (bool) => bool ? '<span style="color: #4CAF50; font-weight: 700;">‚úÖ ‡∏°‡∏µ</span>' : '<span style="color: #D32F2F;">‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ</span>';
        const count_val = (value) => `<span style="font-weight: 600; color: #388E3C;">${esc(value) || '-'}</span>`;

        // Date part helper
        function getDateParts(dateStr) {
            if (!dateStr) return { day: '', month: '', year: '' };
            const parts = dateStr.split('/').map(p => p.trim());
            return {
                day: parts[0] || '',
                month: parts[1] || '',
                year: parts[2] || ''
            };
        }

        // month utilities
        const MONTH_NAMES = {
            '1': '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '2': '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '3': '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '4': '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '5': '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '6': '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
            '7': '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '8': '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '9': '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '10': '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '11': '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '12': '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
        };

        function monthName(n) { return MONTH_NAMES[String(n)] || ''; }

        function monthCount(start, end) {
            const s = parseInt(start, 10), e = parseInt(end, 10);
            if (!s || !e) return '';
            if (s === e) return 1;
            if (s < e) return e - s + 1;
            // wrap-around
            return (12 - s + 1) + e;
        }

        // Robust helper: get checkbox/boolean by id or name
        function getBooleanByIdOrName(nameOrId) {
            const byId = document.getElementById(nameOrId);
            if (byId) return !!byId.checked;
            // by name (could be RadioNodeList)
            const elems = document.forms['kratomForm']?.elements[nameOrId];
            if (!elems) return false;
            if (elems.length !== undefined) {
                for (let el of elems) {
                    if (el.checked) return true;
                }
                return false;
            }
            return !!elems.checked;
        }

        // Get all checked values for inputs with given name
        function getCheckedValuesByName(name) {
            const form = document.getElementById('kratomForm');
            if (!form) return [];
            // support names like 'water_system[]' or 'water_system'
            const values = [];
            // try exact name first
            const elems1 = form.querySelectorAll(`[name="${name}"]`);
            if (elems1 && elems1.length > 0) {
                elems1.forEach(el => { if (el.checked) values.push(el.value); });
                return values;
            }
            // fallback if name ends with []
            if (name.endsWith('[]')) {
                const alt = name.slice(0, -2);
                const elems2 = form.querySelectorAll(`[name="${alt}"]`);
                elems2.forEach(el => { if (el.checked) values.push(el.value); });
            } else {
                // also try adding [] if not provided
                const alt2 = `${name}[]`;
                const elems3 = form.querySelectorAll(`[name="${alt2}"]`);
                elems3.forEach(el => { if (el.checked) values.push(el.value); });
            }
            return values;
        }

        // =============================================
        // Event handling ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≥‡∏£‡∏ß‡∏à
        // =============================================

        // Event handling for species and variety fields
        document.addEventListener('change', e => {
            // ===== stem checkbox toggles (render/remove sections) =====
            if (e.target.classList && e.target.classList.contains('stem-cb')) {
                const stem = e.target.value;
                if (['red', 'white', 'green'].includes(stem)) {
                    if (e.target.checked) renderStemSection(stem);
                    else {
                        const sec = document.getElementById(`section-${stem}`);
                        if (sec) sec.remove();
                        calculateTotal();
                    }
                }

                // show/hide special-name (cross species) when cross checkbox toggled
                if (stem === 'cross') {
                    const special = document.getElementById('special-name');
                    if (special) special.classList.toggle('hidden', !e.target.checked);
                }

                // when 'other' stem checkbox toggled, setupOtherToggles handles showing the textarea via data-other-target
            }

            // ===== variety checkbox toggles enable/disable associated count input =====
            if (e.target.classList && e.target.classList.contains('variety-cb')) {
                const input = e.target.closest('.input-group').querySelector('.variety-count');
                if (e.target.checked) {
                    input.disabled = false;
                    input.required = true;
                } else {
                    input.disabled = true;
                    input.required = false;
                    input.value = '';
                }
                calculateTotal();
            }
        });

        /* ===== listen for input changes on counts to update total ===== */
        document.addEventListener('input', e => {
            if (e.target.classList && e.target.classList.contains('variety-count')) {
                calculateTotal();
            }
        });

        // =============================================
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≥‡∏£‡∏ß‡∏à
        // =============================================

        // Initialize mock google.script.run only when necessary (do not overwrite existing google)
        function initializeMockGoogleScript() {
            if (typeof google === 'undefined') {
                console.warn("google.script.run is not defined. Using a mock for testing.");
                window.google = {
                    script: {
                        run: (function () {
                            return {
                                withSuccessHandler: function (successCb) {
                                    return {
                                        withFailureHandler: function (failureCb) {
                                            return {
                                                submitForm: function (data) {
                                                    console.log("Mock submitForm data:", data);
                                                    setTimeout(() => successCb("Mock submission successful!"), 800);
                                                },
                                                // Generic passthrough to success for testing other calls
                                                userLogin: function (u, p) { setTimeout(() => successCb({ success: true, token: btoa(JSON.stringify({ timestamp: Date.now() })) + '.x', longName: 'MockLong', username: u }), 300); }
                                            };
                                        }
                                    };
                                }
                            };
                        })()
                    }
                };
            } else if (typeof google.script === 'undefined') {
                google.script = {
                    run: (function () {
                        return {
                            withSuccessHandler: function (successCb) {
                                return {
                                    withFailureHandler: function (failureCb) {
                                        return {
                                            submitForm: function (data) {
                                                console.log("Mock submitForm data:", data);
                                                setTimeout(() => successCb("Mock submission successful!"), 800);
                                            }
                                        };
                                    }
                                };
                            }
                        };
                    })()
                };
            } else if (typeof google.script.run === 'undefined') {
                google.script.run = (function () {
                    return {
                        withSuccessHandler: function (successCb) {
                            return {
                                withFailureHandler: function (failureCb) {
                                    return {
                                        submitForm: function (data) {
                                            console.log("Mock submitForm data:", data);
                                            setTimeout(() => successCb("Mock submission successful!"), 800);
                                        }
                                    };
                                }
                            };
                        }
                    };
                })();
            }
        }

        let formDataObj = {};

        document.addEventListener('DOMContentLoaded', () => {
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≥‡∏£‡∏ß‡∏à
            setupOtherToggles();
            toggleAgentInput();

            // Initialize GAP/GACP date ranges based on pre-selected radios (if any)
            const gapChecked = document.querySelector('input[name="gap_status"]:checked');
            toggleDateRange('gap', gapChecked && gapChecked.value === 'yes');

            const gacpChecked = document.querySelector('input[name="gacp_status"]:checked');
            toggleDateRange('gacp', gacpChecked && gacpChecked.value === 'yes');

            // Substance checkboxes logic (exclusive + conditional input)
            const substanceCheckboxes = document.querySelectorAll('.substance-cb');
            const substanceValueBox = document.getElementById('substanceValueBox');
            if (substanceCheckboxes && substanceCheckboxes.length) {
                substanceCheckboxes.forEach(cb => {
                    cb.addEventListener('change', function () {
                        // make them exclusive (only one)
                        substanceCheckboxes.forEach(other => {
                            if (other !== this) other.checked = false;
                        });

                        // show/hide input
                        if (this.id === 'substance_checked' && this.checked) {
                            if (substanceValueBox) substanceValueBox.classList.remove('hidden');
                        } else {
                            if (substanceValueBox) substanceValueBox.classList.add('hidden');
                            const valInput = document.getElementById('substance_value');
                            if (valInput) valInput.value = '';
                        }
                    });
                });

                // initialize visibility
                const anyChecked = Array.from(substanceCheckboxes).some(cb => cb.checked);
                if (!anyChecked && substanceValueBox) substanceValueBox.classList.add('hidden');
                else {
                    const checked = document.getElementById('substance_checked');
                    if (checked && checked.checked && substanceValueBox) substanceValueBox.classList.remove('hidden');
                }
            }

            // Initialize mock google.script.run for testing (only if needed)
            initializeMockGoogleScript();

            // Event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≥‡∏£‡∏ß‡∏à
            const nextBtn = document.getElementById('nextBtn');
            const backBtn = document.getElementById('backBtn');
            const submitBtn = document.getElementById('submitBtn');
            const formStep = document.getElementById('formStep');
            const previewStep = document.getElementById('previewStep');
            const previewCard = document.getElementById('previewCard');

            // Ensure initial visibility is consistent (handle possible inline styles)
            if (formStep) {
                formStep.classList.remove('hidden');
                formStep.style.display = ''; // normal display
            }
            if (previewStep) {
                previewStep.classList.add('hidden');
                previewStep.style.display = 'none'; // hide explicitly
            }

            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    const form = document.getElementById('kratomForm');
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return;
                    }

                    const water_system_values = getCheckedValuesByName('water_system[]');
                    const fertilizer_values = getCheckedValuesByName('fertilizer_method[]');
                    const past_land_values = getCheckedValuesByName('past_land_types[]');
                    const agentRadio = form.querySelector('input[name="farmer_agent"]:checked');
                    const farmer_agent = agentRadio ? agentRadio.value : '';

                    // GAP/GACP/contract values
                    const gapRadio = form.querySelector('input[name="gap_status"]:checked');
                    const gap_status = gapRadio ? gapRadio.value : '';
                    const gap_start_date = document.getElementById('gap_start_date')?.value || '';
                    const gap_end_date = document.getElementById('gap_end_date')?.value || '';

                    const gacpRadio = form.querySelector('input[name="gacp_status"]:checked');
                    const gacp_status = gacpRadio ? gacpRadio.value : '';
                    const gacp_start_date = document.getElementById('gacp_start_date')?.value || '';
                    const gacp_end_date = document.getElementById('gacp_end_date')?.value || '';

                    const contractRadio = form.querySelector('input[name="contract_status"]:checked');
                    const contract_status = contractRadio ? contractRadio.value : '';

                    // Collect species data dynamically
                    const speciesData = {};
                    ['red', 'white', 'green'].forEach(stem => {
                        speciesData[stem] = {};
                        const sec = document.getElementById(`section-${stem}`);
                        if (!sec) return;
                        const rows = sec.querySelectorAll('.input-group');
                        rows.forEach(row => {
                            const cb = row.querySelector('.variety-cb');
                            const lbl = row.querySelector('.input-group-text label')?.textContent?.trim() || '';
                            const countInput = row.querySelector('.variety-count');
                            const count = (countInput && !countInput.disabled && countInput.value) ? Number(countInput.value) : 0;
                            if (cb && cb.checked && lbl) {
                                speciesData[stem][lbl] = count;
                            }
                        });
                    });
                    // read cross (special) and other varieties from current form
                    const specialSpeciesName = document.getElementById('special_species_name')?.value || '';
                    const otherVarietiesText = document.getElementById('other_varieties')?.value || '';
                    // total from calculated field
                    const total_tree_count_specified = Number(document.getElementById('total_tree_count')?.value || 0);

                    // Substance status
                    const substance_checked = document.getElementById('substance_checked')?.checked ? 'checked' :
                        document.getElementById('substance_not_checked')?.checked ? 'not_checked' : '';

                    // Combine water/ fertilizer "other" values only in their own fields; do not conflate with hormone_etc
                    const waterSystemDisplay = [
                        ...(water_system_values || []),
                        ...(document.getElementById('water_other_text')?.value ? [`‡∏≠‡∏∑‡πà‡∏ô‡πÜ: ${document.getElementById('water_other_text').value}`] : [])
                    ].filter(Boolean).join(', ');

                    const fertilizerDisplay = [
                        ...(fertilizer_values || []),
                        ...(document.getElementById('fert_other_text')?.value ? [`‡∏≠‡∏∑‡πà‡∏ô‡πÜ: ${document.getElementById('fert_other_text').value}`] : [])
                    ].filter(Boolean).join(', ');

                    // read combined hormone_and_other and volcanic checkbox
                    const hormoneAndOther = document.getElementById('hormone_and_other')?.value || '';
                    const volcanicChecked = document.getElementById('mineral_volcanic')?.checked || false;
                    const firstname = (form.elements['farmer_firstname']?.value || '').trim();
                    const lastname = (form.elements['farmer_lastname']?.value || '').trim();
                    const fallbackFullName = (form.elements['farmer_name_main']?.value || '').trim();
                    const fullName = (firstname || lastname) ? `${firstname} ${lastname}`.trim() : fallbackFullName;

                    formDataObj = {
                        farmer_agent,
                        agent_name: form.elements['agent_name']?.value || '',
                        farmer_firstname: firstname,
                        farmer_lastname: lastname,
                        farmer_name_main: form.elements['farmer_name_main']?.value || '',
                        coord_x: form.elements['coord_x']?.value || '',
                        coord_y: form.elements['coord_y']?.value || '',
                        subdistrict: form.elements['subdistrict']?.value || '',
                        district: form.elements['district']?.value || '',
                        province: form.elements['province']?.value || '',
                        land_evidence: form.elements['land_evidence']?.value || '',
                        tel: form.elements['tel']?.value || '',
                        tree_count: form.elements['tree_count']?.value || '',
                        plant_date: form.elements['plant_date']?.value || '',
                        ready_to_sell_count: form.elements['ready_to_sell_count']?.value || '',
                        water_system_values,
                        water_other_text: document.getElementById('water_other_text')?.value || '',
                        water_system_display: waterSystemDisplay, // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ô‡∏µ‡πâ
                        water_ph: form.elements['water_ph']?.value || '',
                        fertilizer_values,
                        fert_other_text: document.getElementById('fert_other_text')?.value || '',
                        fertilizer_display: fertilizerDisplay, // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ô‡∏µ‡πâ
                        soil_ph: form.elements['soil_ph']?.value || '',
                        hormone_and_other: hormoneAndOther, // combined field
                        mineral_volcanic: volcanicChecked ? '‡πÅ‡∏£‡πà‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡πÑ‡∏ü' : '',
                        substance_value: form.elements['substance_value']?.value || '',
                        substance_status: substance_checked,
                        dry_start_month: form.elements['dry_start_month']?.value || '',
                        dry_end_month: form.elements['dry_end_month']?.value || '',
                        rainy_start_month: form.elements['rainy_start_month']?.value || '',
                        rainy_end_month: form.elements['rainy_end_month']?.value || '',
                        winter_start_month: form.elements['winter_start_month']?.value || '',
                        winter_end_month: form.elements['winter_end_month']?.value || '',
                        gap_status,
                        gap_start_date,
                        gap_end_date,
                        gacp_status,
                        gacp_start_date,
                        gacp_end_date,
                        contract_status,
                        species: speciesData,
                        special_species_name: specialSpeciesName,
                        other_varieties: otherVarietiesText,
                        total_tree_count_specified,
                        past_land_values,
                        past_other_text: document.getElementById('past_other_text')?.value || '',
                        coordinator_name: form.elements['coordinator_name']?.value || '',
                        coordinator_tel: form.elements['coordinator_tel']?.value || ''
                    };

                    // Prepare season display strings and counts
                    const data = formDataObj;
                    const rainyRange = (data.rainy_start_month || data.rainy_end_month) ? `${monthName(data.rainy_start_month) || '-'} ‚Äî ${monthName(data.rainy_end_month) || '-'}` : '-';
                    const rainyCount = (data.rainy_start_month && data.rainy_end_month) ? `${monthCount(data.rainy_start_month, data.rainy_end_month)} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô` : '-';
                    const dryRange = (data.dry_start_month || data.dry_end_month) ? `${monthName(data.dry_start_month) || '-'} ‚Äî ${monthName(data.dry_end_month) || '-'}` : '-';
                    const dryCount = (data.dry_start_month && data.dry_end_month) ? `${monthCount(data.dry_start_month, data.dry_end_month)} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô` : '-';
                    const winterRange = (data.winter_start_month || data.winter_end_month) ? `${monthName(data.winter_start_month) || '-'} ‚Äî ${monthName(data.winter_end_month) || '-'}` : '-';
                    const winterCount = (data.winter_start_month && data.winter_end_month) ? `${monthCount(data.winter_start_month, data.winter_end_month)} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô` : '-';

                    const dateParts = getDateParts(data.plant_date);

                    // Summarize species for preview (compact)
                    const speciesSummary = [];
                    Object.keys(data.species).forEach(stem => {
                        const entries = data.species[stem];
                        Object.keys(entries || {}).forEach(v => {
                            speciesSummary.push(`${v} (${stemLabels[stem] || stem}): ${entries[v]}`);
                        });
                    });
                    // Add other and cross separately (do not conflate)
                    if (data.other_varieties) {
                        // split by comma for display items
                        const others = data.other_varieties.split(',').map(s => s.trim()).filter(Boolean);
                        others.forEach(o => speciesSummary.push(`‡∏≠‡∏∑‡πà‡∏ô‡πÜ: ${o}`));
                    }
                    if (data.special_species_name) speciesSummary.push(`‡∏Ç‡πâ‡∏≤‡∏°‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå: ${data.special_species_name}`);

                    // ------------------------
                    // PREVIEW HTML VERSION 2.1 - separate hormone and other; separate other & cross species
                    // ------------------------

                    // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà GAP/GACP ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢ DD/MM/YYYY ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö preview
                    const gapStartDisplay = formatDateForDisplay(data.gap_start_date || '');
                    const gapEndDisplay = formatDateForDisplay(data.gap_end_date || '');
                    const gacpStartDisplay = formatDateForDisplay(data.gacp_start_date || '');
                    const gacpEndDisplay = formatDateForDisplay(data.gacp_end_date || '');

                    let previewHtml = `
<style>
  .preview-container {
    font-family: 'Inter', 'Sarabun', 'Noto Sans Thai', sans-serif;
    line-height: 1.45;
    color: #212121;
    max-width: 1200px;
    margin: 0 auto;
    padding: 12px;
  }

  /* Section Header */
  .section-header {
    background: linear-gradient(135deg, #1b5e20 0%, #388E3C 100%);
    color: white;
    padding: 12px 16px;
    border-radius: 8px 8px 0 0;
    margin-bottom: 0;
    font-weight: 700;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .section-header i {
    font-size: 1.2rem;
  }

  /* Lock Cards */
  .lock-card {
    background: white;
    border: 2px solid #E8F5E9;
    border-radius: 8px;
    margin-bottom: 20px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }

  .lock-content {
    padding: 16px;
  }

  /* Grid Layout for Lock Cards */
  .lock-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 16px;
    margin-bottom: 20px;
  }

  .lock-row {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    padding: 6px 0;
    border-bottom: 1px dashed #E0E0E0;
  }

  .lock-row:last-child {
    border-bottom: none;
    margin-bottom: 0;
  }

  .lock-label {
    font-weight: 600;
    color: #1b5e20;
    min-width: 140px;
    font-size: 0.9rem;
  }

  .lock-value {
    color: #212121;
    word-break: break-word;
    flex: 1;
    font-size: 0.9rem;
  }

  .lock-value.mono {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
  }

  /* Full Width Lock Card */
  .full-width-lock {
    grid-column: 1 / -1;
  }

  /* Summary Table */
  .summary-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
    margin: 16px 0;
  }

  .summary-table th {
    background: #F1F8E9;
    color: #1b5e20;
    font-weight: 700;
    padding: 10px;
    text-align: left;
    border: 1px solid #C8E6C9;
  }

  .summary-table td {
    padding: 10px;
    border: 1px solid #E0E0E0;
    vertical-align: top;
  }

  .summary-table tr:nth-child(even) {
    background: #F9F9F9;
  }

  /* Status Badges */
  .status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-align: center;
  }

  .status-success {
    background: #E8F5E9;
    color: #2E7D32;
  }

  .status-warning {
    background: #FFF3E0;
    color: #F57C00;
  }

  .status-danger {
    background: #FFEBEE;
    color: #C62828;
  }

  /* Species Grid */
  .species-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
    margin-top: 8px;
  }

  .species-item {
    background: #F9F9F9;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.85rem;
  }

  .species-label {
    font-weight: 600;
    color: #555;
  }

  .species-count {
    font-weight: 700;
    color: #1b5e20;
  }

  /* Signature Section */
  .signature-section {
    background: #F8F9FA;
    border-radius: 8px;
    padding: 20px;
    margin-top: 24px;
    border: 1px solid #E0E0E0;
  }

  .signature-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
    margin-top: 12px;
  }

  .signature-item {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .signature-label {
    font-weight: 600;
    color: #1b5e20;
    min-width: 120px;
  }

  .signature-value {
    flex: 1;
    padding: 6px 12px;
    background: white;
    border: 1px solid #E0E0E0;
    border-radius: 4px;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .preview-container {
      padding: 8px;
    }

    .lock-grid {
      grid-template-columns: 1fr;
    }

    .lock-row {
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
    }

    .lock-label {
      min-width: auto;
      font-size: 0.85rem;
    }

    .summary-table {
      font-size: 0.8rem;
    }

    .summary-table th,
    .summary-table td {
      padding: 6px 8px;
    }

    .species-grid {
      grid-template-columns: 1fr;
    }

    .signature-grid {
      grid-template-columns: 1fr;
    }
  }

  @media (min-width: 1024px) {
    .lock-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>

<div class="preview-container">
  <!-- ===================== LOCK 1: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏´‡∏•‡∏±‡∏Å ===================== -->
  <div class="lock-card">
    <div class="section-header">
      <i class="bi bi-person-badge"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏´‡∏•‡∏±‡∏Å
    </div>
    <div class="lock-content">
      <div class="lock-grid">
        <!-- ‡∏•‡πá‡∏≠‡∏Ñ‡∏ã‡πâ‡∏≤‡∏¢ -->
        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£:</span>
            <span class="lock-value">${val(data.farmer_name_main)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</span>
            <span class="lock-value mono">${val(data.tel || '-', 10)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô:</span>
            <span class="lock-value">${val(data.farmer_agent === 'have' ? '‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô' : data.farmer_agent === 'none' ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô' : '-', 6)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô:</span>
            <span class="lock-value">${val(data.agent_name || '-', 8)}</span>
          </div>
        </div>

        <!-- ‡∏•‡πá‡∏≠‡∏Ñ‡∏Ç‡∏ß‡∏≤ -->
        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">‡∏û‡∏¥‡∏Å‡∏±‡∏î X:</span>
            <span class="lock-value mono">${val(data.coord_x, 4)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">‡∏û‡∏¥‡∏Å‡∏±‡∏î Y:</span>
            <span class="lock-value mono">${val(data.coord_y, 4)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">‡∏ï‡∏≥‡∏ö‡∏• / ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ / ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</span>
            <span class="lock-value">${val(data.subdistrict, 4)} / ${val(data.district, 4)} / ${val(data.province, 4)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô:</span>
            <span class="lock-value">${val(data.land_evidence || '-', 6)}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== LOCK 2: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡πÑ‡∏°‡πâ ===================== -->
  <div class="lock-card">
    <div class="section-header">
      <i class="bi bi-tree"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡πÑ‡∏°‡πâ
    </div>
    <div class="lock-content">
      <div class="lock-grid">
        <!-- ‡∏•‡πá‡∏≠‡∏Ñ‡∏ã‡πâ‡∏≤‡∏¢ -->
        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
            <span class="lock-value">${val(data.tree_count || '-', 6)} ‡∏ï‡πâ‡∏ô</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏π‡∏Å‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤:</span>
            <span class="lock-value">${val(data.plant_date || '-', 10)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢:</span>
            <span class="lock-value">${val(data.ready_to_sell_count || '-', 6)} ‡∏ï‡πâ‡∏ô</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà 3 ‡∏õ‡∏µ:</span>
            <span class="lock-value">${val((Array.isArray(data.past_land_values) && data.past_land_values.length) ? data.past_land_values.join(', ') : (data.past_other_text || '-'), 12)}</span>
          </div>
        </div>

        <!-- ‡∏•‡πá‡∏≠‡∏Ñ‡∏Ç‡∏ß‡∏≤ -->
        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">PH ‡∏ô‡πâ‡∏≥:</span>
            <span class="lock-value">${val(data.water_ph || '-', 4)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">PH ‡∏î‡∏¥‡∏ô:</span>
            <span class="lock-value">${val(data.soil_ph || '-', 4)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°‡∏à‡∏≤‡∏Å‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå:</span>
            <span class="lock-value">${val(data.total_tree_count_specified ? String(data.total_tree_count_specified) : '-', 6)} ‡∏ï‡πâ‡∏ô</span>
          </div>
        </div>
      </div>

      <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå (‡πÅ‡∏¢‡∏Å Other / Cross) -->
      <table class="summary-table">
        <thead>
          <tr>
            <th>‡∏Å‡πâ‡∏≤‡∏ô‡πÅ‡∏î‡∏á</th>
            <th>‡∏Å‡πâ‡∏≤‡∏ô‡∏Ç‡∏≤‡∏ß</th>
            <th>‡∏Å‡πâ‡∏≤‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß</th>
            <th>‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏ä‡∏∑‡πà‡∏≠)</th>
            <th>‡∏Ç‡πâ‡∏≤‡∏°‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå (‡∏ä‡∏∑‡πà‡∏≠)</th>
            <th>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>${count_val(Object.values(data.species?.red || {}).reduce((a, b) => a + (Number(b) || 0), 0) || '0')}</td>
            <td>${count_val(Object.values(data.species?.white || {}).reduce((a, b) => a + (Number(b) || 0), 0) || '0')}</td>
            <td>${count_val(Object.values(data.species?.green || {}).reduce((a, b) => a + (Number(b) || 0), 0) || '0')}</td>
            <td>${val(data.other_varieties || '-', 6)}</td>
            <td>${val(data.special_species_name || '-', 6)}</td>
            <td class="status-success">${count_val(data.total_tree_count_specified || '0')}</td>
          </tr>
        </tbody>
      </table>

      <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) -->
      ${speciesSummary.length > 0 ? `
      <div style="margin-top: 12px;">
        <div style="font-weight: 600; color: #1b5e20; margin-bottom: 8px;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå:</div>
        <div class="species-grid">
          ${speciesSummary.map(item => `
            <div class="species-item">
              <div class="species-label">${esc(item.split(':')[0] || '')}</div>
              <div class="species-count">${esc((item.split(':')[1] || '').trim())}</div>
            </div>
          `).join('')}
        </div>
      </div>
      ` : ''}
    </div>
  </div>

  <!-- ===================== LOCK 3: ‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á ===================== -->
  <div class="lock-card">
    <div class="section-header">
      <i class="bi bi-tools"></i> ‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á
    </div>
    <div class="lock-content">
      <div class="lock-grid">
        <!-- ‡∏•‡πá‡∏≠‡∏Ñ‡∏ã‡πâ‡∏≤‡∏¢ -->
        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥:</span>
            <span class="lock-value">${val(data.water_system_display || '-', 6)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">‡∏£‡∏∞‡∏ö‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πã‡∏¢:</span>
            <span class="lock-value">${val(data.fertilizer_display || '-', 6)}</span>
          </div>
        </div>
      </div>

      <!-- ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏¢‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏Æ‡∏≠‡∏£‡πå‡πÇ‡∏°‡∏ô/‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÅ‡∏•‡∏∞ ‡πÅ‡∏£‡πà‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡πÑ‡∏ü -->
      <div style="margin-top: 12px;">
        <div class="lock-row">
          <span class="lock-label">‡∏Æ‡∏≠‡∏£‡πå‡πÇ‡∏°‡∏ô / ‡∏≠‡∏∑‡πà‡∏ô‡πÜ:</span>
          <span class="lock-value">${val(data.hormone_and_other || '-', 8)}</span>
        </div>
        <div class="lock-row">
          <span class="lock-label">‡πÅ‡∏£‡πà‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡πÑ‡∏ü (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):</span>
          <span class="lock-value">${data.mineral_volcanic ? val(data.mineral_volcanic) : '-'}</span>
        </div>
      </div>

      <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏§‡∏î‡∏π‡∏Å‡∏≤‡∏• -->
      <table class="summary-table" style="margin-top:12px;">
        <thead>
          <tr>
            <th>‡∏§‡∏î‡∏π‡∏Å‡∏≤‡∏•</th>
            <th>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</th>
            <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>‡∏§‡∏î‡∏π‡πÅ‡∏•‡πâ‡∏á</td>
            <td>${val(dryRange, 6)}</td>
            <td>${val(dryCount, 4)}</td>
            <td>${dryRange !== '-' ? '<span class="status-success">‚úÖ ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>' : '<span class="status-warning">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</span>'}</td>
          </tr>
          <tr>
            <td>‡∏§‡∏î‡∏π‡∏ù‡∏ô</td>
            <td>${val(rainyRange, 6)}</td>
            <td>${val(rainyCount, 4)}</td>
            <td>${rainyRange !== '-' ? '<span class="status-success">‚úÖ ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>' : '<span class="status-warning">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</span>'}</td>
          </tr>
          <tr>
            <td>‡∏§‡∏î‡∏π‡∏´‡∏ô‡∏≤‡∏ß</td>
            <td>${val(winterRange, 6)}</td>
            <td>${val(winterCount, 4)}</td>
            <td>${winterRange !== '-' ? '<span class="status-success">‚úÖ ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>' : '<span class="status-warning">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</span>'}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ===================== LOCK 4: ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏ç‡∏ç‡∏≤ ===================== -->
  <div class="lock-card">
    <div class="section-header">
      <i class="bi bi-file-earmark-check"></i> ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏ç‡∏ç‡∏≤
    </div>
    <div class="lock-content">
      <div class="lock-grid">
        <!-- ‡∏•‡πá‡∏≠‡∏Ñ‡∏ã‡πâ‡∏≤‡∏¢ -->
        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">GAP ‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£:</span>
            <span class="lock-value">
              ${data.gap_status === 'yes' ?
                            '<span class="status-success">‚úÖ ‡∏°‡∏µ (' + val(gapStartDisplay || '-', 6) + ' ‚Äî ' + val(gapEndDisplay || '-', 6) + ')</span>' :
                            data.gap_status === 'no' ?
                                '<span class="status-warning">‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ</span>' :
                                '<span class="status-danger">- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ -</span>'}
            </span>
          </div>
          <div class="lock-row">
            <span class="lock-label">GACP ‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£:</span>
            <span class="lock-value">
              ${data.gacp_status === 'yes' ?
                            '<span class="status-success">‚úÖ ‡∏°‡∏µ (' + val(gacpStartDisplay || '-', 6) + ' ‚Äî ' + val(gacpEndDisplay || '-', 6) + ')</span>' :
                            data.gacp_status === 'no' ?
                                '<span class="status-warning">‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ</span>' :
                                '<span class="status-danger">- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ -</span>'}
            </span>
          </div>
        </div>

        <!-- ‡∏•‡πá‡∏≠‡∏Ñ‡∏Ç‡∏ß‡∏≤ -->
        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">‡∏Ñ‡∏π‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤:</span>
            <span class="lock-value">
              ${data.contract_status === 'old' ?
                            '<span class="status-warning">‚ö†Ô∏è ‡∏ï‡∏¥‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏Å‡πà‡∏≤</span>' :
                            data.contract_status === 'none' ?
                                '<span class="status-success">‚úÖ ‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏Å‡πà‡∏≤</span>' :
                                '<span class="status-danger">- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ -</span>'}
            </span>
          </div>
          <div class="lock-row">
            <span class="lock-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°:</span>
            <span class="lock-value">
              ${(data.gap_status === 'yes' || data.gacp_status === 'yes') ?
                            '<span class="status-success">‚úÖ ‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô</span>' :
                            '<span class="status-warning">‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô</span>'}
            </span>
          </div>
        </div>

        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">‡∏™‡∏≤‡∏£‡πÑ‡∏°‡∏ó‡∏£‡∏≤‡πÑ‡∏à‡∏ô‡∏µ‡∏ô:</span>
            <span class="lock-value">
              ${data.substance_status === 'checked' ?
                            '<span class="status-success">‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß (' + val(data.substance_value || '0', 4) + ')</span>' :
                            data.substance_status === 'not_checked' ?
                                '<span class="status-warning">‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏ß‡∏à</span>' :
                                '<span class="status-danger">- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ -</span>'}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== LOCK 5: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô ===================== -->
  <div class="lock-card">
    <div class="section-header">
      <i class="bi bi-person-lines-fill"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô
    </div>
    <div class="lock-content">
      <div class="lock-grid">
        <!-- ‡∏•‡πá‡∏≠‡∏Ñ‡∏ã‡πâ‡∏≤‡∏¢ -->
        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô:</span>
            <span class="lock-value">${val(data.coordinator_name, 12)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</span>
            <span class="lock-value mono">${val(data.coordinator_tel, 6)}</span>
          </div>
        </div>

        <!-- ‡∏•‡πá‡∏≠‡∏Ñ‡∏Ç‡∏ß‡∏≤ -->
        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:</span>
            <span class="lock-value">${val(new Date().toLocaleDateString('th-TH'), 10)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á:</span>
            <span class="lock-value status-success">‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="signature-section">
    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #E0E0E0;">
      <div style="font-weight: 600; color: #555; margin-bottom: 8px;">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢‡πÄ‡∏Æ‡∏¥‡∏£‡πå‡∏ö ‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡∏à‡∏≥‡∏Å‡∏±‡∏î)</div>
      <div style="font-size: 0.9rem; color: #777;">
        ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡∏π‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß<br>
        üìû ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: LINE: @bthcenter | ‡πÇ‡∏ó‡∏£: 092-4579929, 063-5033042
      </div>
    </div>
  </div>
</div>
`;
                    // End previewHtml

                    previewCard.innerHTML = previewHtml;

                    // Show preview and hide form (ensure both class and inline style updated)
                    if (formStep) {
                        formStep.classList.add('hidden');
                        formStep.style.display = 'none';
                    }
                    if (previewStep) {
                        previewStep.classList.remove('hidden');
                        previewStep.style.display = 'block';
                    }

                    window.scrollTo(0, 0);
                });
            }

            if (backBtn) {
                backBtn.addEventListener('click', () => {
                    // Show form and hide preview (update both class and inline style)
                    if (formStep) {
                        formStep.classList.remove('hidden');
                        formStep.style.display = '';
                    }
                    if (previewStep) {
                        previewStep.classList.add('hidden');
                        previewStep.style.display = 'none';
                    }
                    window.scrollTo(0, 0);
                });
            }

            if (submitBtn) {
                submitBtn.addEventListener('click', () => {
                    const submitBtnEl = document.getElementById('submitBtn');
                    const originalText = submitBtnEl.innerHTML;

                    submitBtnEl.disabled = true;
                    submitBtnEl.innerHTML = '<div class="loading-spinner"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';

                    google.script.run.withSuccessHandler(msg => {
                        showCustomAlert(msg, 'success');
                        document.getElementById('kratomForm').reset();

                        // Hide "other" inputs, agent input and GAP/GACP ranges after reset
                        ['water_other_text', 'fert_other_text', 'past_other_text', 'agent-name', 'gap-date-range', 'gacp-date-range', 'special-name', 'substanceValueBox'].forEach(id => {
                            const el = document.getElementById(id);
                            if (el) {
                                el.classList.add('hidden');
                            }
                        });

                        // clear other_varieties textarea and combined hormone/other
                        const otherVar = document.getElementById('other_varieties');
                        if (otherVar) otherVar.value = '';
                        const hormoneAnd = document.getElementById('hormone_and_other');
                        if (hormoneAnd) hormoneAnd.value = '';
                        const volcanicCb = document.getElementById('mineral_volcanic');
                        if (volcanicCb) volcanicCb.checked = false;

                        // remove generated stem sections and reset total
                        const scb = document.querySelectorAll('.stem-cb');
                        scb.forEach(cb => cb.checked = false);
                        const stCont = getStemContainer();
                        if (stCont) stCont.innerHTML = '';
                        const totalEl = document.getElementById('total_tree_count');
                        if (totalEl) totalEl.value = '';

                        // ensure substance checkboxes are reset
                        const substanceCheckboxes = document.querySelectorAll('.substance-cb');
                        substanceCheckboxes.forEach(cb => cb.checked = false);
                        const subVal = document.getElementById('substance_value');
                        if (subVal) subVal.value = '';

                        // hide preview, show form (update both class and inline style)
                        if (previewStep) {
                            previewStep.classList.add('hidden');
                            previewStep.style.display = 'none';
                        }
                        if (formStep) {
                            formStep.classList.remove('hidden');
                            formStep.style.display = '';
                        }

                        submitBtnEl.disabled = false;
                        submitBtnEl.innerHTML = originalText;
                    }).withFailureHandler(error => {
                        let errorMessage = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
                        if (error && error.message) {
                            errorMessage += ": " + esc(error.message);
                            if (error.message.includes('ScriptError: Exception: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏') || error.message.includes('ScriptError: Exception: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ï‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠')) {
                                errorMessage += "<br><br><b>‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å Google Apps Script (GAS) Backend ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:</b>"
                                    + "<br>1. ‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô GAS ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô <code>submitForm</code>)"
                                    + "<br>2. ‡∏ä‡∏∑‡πà‡∏≠ Google Sheet ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ï (Sheet Name) ‡∏ó‡∏µ‡πà‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ñ‡∏∂‡∏á‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î GAS ‡∏ß‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà"
                                    + "<br>3. ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Google Sheet ‡∏ô‡∏±‡πâ‡∏ô";
                            }
                        }
                        showCustomAlert(errorMessage, 'danger');
                        submitBtnEl.disabled = false;
                        submitBtnEl.innerHTML = originalText;
                    }).submitForm(formDataObj);
                });
            }
        });

        // =============================================
        // Custom Alert/Modal Function (Bootstrap modal)
        // =============================================
        function showCustomAlert(message, type = 'info') {
            const alertId = 'custom-alert-modal';
            let alertModal = document.getElementById(alertId);

            if (!alertModal) {
                alertModal = document.createElement('div');
                alertModal.id = alertId;
                alertModal.className = 'modal fade';
                alertModal.tabIndex = '-1';
                alertModal.innerHTML = `
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content" style="border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                            <div class="modal-header" style="border-bottom: none;">
                                <h5 class="modal-title" id="alertModalTitle" style="font-weight: 700;">Notification</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body" id="alertModalBody" style="font-size: 1rem;">
                                <!-- Message will be placed here -->
                            </div>
                            <div class="modal-footer" style="border-top: none;">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 8px;">‡∏õ‡∏¥‡∏î</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(alertModal);
            }

            const modalTitle = document.getElementById('alertModalTitle');
            const modalBody = document.getElementById('alertModalBody');
            const modalHeader = alertModal.querySelector('.modal-header');

            let titleText = '‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô';
            let headerColor = '#388E3C';

            if (type === 'success') {
                titleText = '‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                headerColor = '#4CAF50';
            } else if (type === 'danger') {
                titleText = '‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
                headerColor = '#D32F2F';
            }

            modalTitle.textContent = titleText;
            // Use innerHTML to allow richer messages
            modalBody.innerHTML = message;

            // Apply header color
            modalHeader.style.backgroundColor = headerColor;
            modalTitle.style.color = 'white';
            alertModal.querySelector('.btn-close').style.filter = 'invert(1)'; // Make close button visible on dark background

            // Show the modal via Bootstrap if available, else fallback to alert
            try {
                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    const modal = new bootstrap.Modal(alertModal);
                    modal.show();
                } else {
                    // fallback simple modal-like behavior
                    alert(message.replace(/<br\s*\/?>/g, '\n').replace(/<\/?[^>]+(>|$)/g, ""));
                }
            } catch (e) {
                alert(message.replace(/<br\s*\/?>/g, '\n').replace(/<\/?[^>]+(>|$)/g, ""));
            }
        }

        window.showSection = function (targetId, btn) {
            try {
                // deactivate all tabs
                document.querySelectorAll('.nav-tab').forEach(t => {
                    t.classList.remove('active');
                    t.setAttribute('aria-selected', 'false');
                });

                // activate clicked tab if provided
                if (btn && btn.classList) {
                    btn.classList.add('active');
                    btn.setAttribute('aria-selected', 'true');
                }

                // hide all sections and show the target
                document.querySelectorAll('.content-section').forEach(s => {
                    s.classList.remove('active');
                    s.classList.add('hidden');
                });

                const target = document.getElementById(targetId);
                if (target) {
                    target.classList.remove('hidden');
                    target.classList.add('active');
                } else {
                    console.warn('showSection: ‡πÑ‡∏°‡πà‡∏û‡∏ö element id=', targetId);
                }

                // Optional: apply visual color from data-section-color
                try {
                    const color = btn && (btn.getAttribute('data-section-color') || btn.dataset.sectionColor);
                    // remove previous color indicators
                    document.querySelectorAll('.content-section').forEach(s => s.style.borderTop = '');
                    if (color && target) {
                        // you can adjust color mapping or use CSS variables
                        target.style.borderTop = `4px solid ${color === 'orange' ? '#fb923c' : color === 'blue' ? '#3b82f6' : '#6b7280'}`;
                    }
                } catch (e) { /* ignore */ }
            } catch (e) {
                console.error('showSection error', e);
            }
        };

        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.nav-tab').forEach(btn => {
                // ignore if already has inline onclick that you want to keep;
                // this ensures tabs work even if showSection wasn't defined earlier
                btn.removeEventListener('click', btn._navTabHandler);
                btn._navTabHandler = function (ev) {
                    const target = btn.getAttribute('data-target') || btn.dataset.target;
                    if (target) window.showSection(target, btn);
                };
                btn.addEventListener('click', btn._navTabHandler);
            });
        });

        // Admin client-side manager (single IIFE)
        (function () {
            // state
            let lastFetchedData = [];
            let currentDisplayKeys = []; // keep keys order used to render the table (for CSV export)
            let isTableExpanded = false;
            let isFetching = false;

            // ---------- Utilities ----------
            function escapeHtml(str) {
                if (str === null || str === undefined) return '';
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }

            function setAdminControlsDisabled(disabled) {
                const ids = [
                    'btn-fetch-farmers', 'btn-fetch-usage', 'btn-fetch-merged',
                    'btn-simple-test', 'btn-sheet-test', 'btn-admin-conn',
                    'btn-direct-getAll', 'btn-debug-getAll', 'admin-search-btn',
                    'admin-export-btn', 'admin-refresh-table'
                ];
                ids.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.disabled = disabled;
                });
                // also disable logout to prevent race
                const logoutBtn = document.getElementById('admin-logout-btn');
                if (logoutBtn) logoutBtn.disabled = disabled;
            }

            // ---------- Table helpers ----------
            function createFooterSummary(count, columns) {
                const footer = document.createElement('div');
                footer.style.padding = '10px';
                footer.style.background = '#f3f4f6';
                footer.style.borderTop = '1px solid #d1d5db';
                footer.style.fontSize = '12px';
                footer.style.color = '#6b7280';
                footer.style.position = 'sticky';
                footer.style.bottom = '0';
                footer.style.display = 'block';
                footer.textContent = `üìä ‡πÅ‡∏™‡∏î‡∏á ${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ | üìã ${columns} ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå | üïí ${new Date().toLocaleTimeString('th-TH')}`;
                return footer;
            }

            function clearTable() {
                const container = document.getElementById('admin-table-container');
                if (container) container.innerHTML = '';
                currentDisplayKeys = [];
            }

            // robust displayTable: uses union of keys, escapes via textContent
            function displayTable(dataArray) {
                try {
                    console.log('displayTable called with:', dataArray);

                    lastFetchedData = Array.isArray(dataArray) ? dataArray : [];
                    console.log('lastFetchedData length:', lastFetchedData.length);

                    const container = document.getElementById('admin-table-container');
                    const wrapper = document.getElementById('admin-table-wrapper');
                    const empty = document.getElementById('admin-empty');

                    if (!container || !wrapper || !empty) {
                        console.error('Required elements not found:', { container: !!container, wrapper: !!wrapper, empty: !!empty });
                        return;
                    }

                    if (!lastFetchedData || lastFetchedData.length === 0) {
                        wrapper.classList.add('hidden');
                        empty.classList.remove('hidden');
                        container.innerHTML = '';
                        currentDisplayKeys = [];
                        return;
                    }

                    empty.classList.add('hidden');
                    wrapper.classList.remove('hidden');

                    // union keys across all rows to ensure all columns shown
                    // preserve order by first-seen across rows
                    const keyOrder = [];
                    const seen = new Set();
                    lastFetchedData.forEach(row => {
                        if (row && typeof row === 'object') {
                            Object.keys(row).forEach(k => {
                                if (!seen.has(k)) {
                                    seen.add(k);
                                    keyOrder.push(k);
                                }
                            });
                        }
                    });

                    const keys = keyOrder.length ? keyOrder : [];

                    // clear and style container
                    container.innerHTML = '';
                    container.style.maxHeight = '500px';
                    container.style.overflow = 'auto';
                    container.style.border = '2px solid #e5e7eb';
                    container.style.borderRadius = '8px';
                    container.style.background = 'white';
                    container.style.position = 'relative';

                    // build table elements
                    const table = document.createElement('table');
                    table.style.width = '100%';
                    table.style.borderCollapse = 'collapse';
                    table.style.minWidth = '800px';

                    // thead
                    const thead = document.createElement('thead');
                    thead.style.position = 'sticky';
                    thead.style.top = '0';
                    thead.style.background = '#f8fafc';
                    thead.style.zIndex = '10';
                    const trh = document.createElement('tr');
                    keys.forEach(key => {
                        const th = document.createElement('th');
                        th.style.padding = '12px 8px';
                        th.style.textAlign = 'left';
                        th.style.border = '1px solid #d1d5db';
                        th.style.whiteSpace = 'nowrap';
                        th.style.minWidth = '120px';
                        th.style.fontWeight = '700';
                        th.textContent = key;
                        trh.appendChild(th);
                    });
                    thead.appendChild(trh);
                    table.appendChild(thead);

                    // tbody
                    const tbody = document.createElement('tbody');
                    lastFetchedData.forEach((row, rowIndex) => {
                        const tr = document.createElement('tr');
                        tr.style.backgroundColor = (rowIndex % 2 === 0) ? '#ffffff' : '#f9fafb';

                        keys.forEach(k => {
                            const td = document.createElement('td');
                            td.style.padding = '8px';
                            td.style.border = '1px solid #e5e7eb';
                            td.style.verticalAlign = 'top';
                            td.style.maxWidth = '200px';
                            td.style.wordBreak = 'break-word';

                            let v = (row && Object.prototype.hasOwnProperty.call(row, k)) ? row[k] : '';
                            if (v === null || v === undefined) v = '';
                            if (typeof v === 'object') {
                                try { v = JSON.stringify(v); } catch (e) { v = String(v); }
                            }
                            // safe: use textContent
                            const div = document.createElement('div');
                            div.style.padding = '0';
                            div.style.fontSize = '0.95rem';
                            div.textContent = String(v);
                            td.appendChild(div);
                            tr.appendChild(td);
                        });

                        tbody.appendChild(tr);
                    });
                    table.appendChild(tbody);

                    container.appendChild(table);

                    // footer summary
                    const footer = createFooterSummary(lastFetchedData.length, keys.length);
                    container.appendChild(footer);

                    // reset scroll
                    container.scrollTop = 0;
                    container.scrollLeft = 0;

                    currentDisplayKeys = keys.slice(); // store keys order for export

                    console.log('Table rendered successfully with keys:', currentDisplayKeys);
                } catch (e) {
                    console.error('displayTable error:', e);
                    // try to fallback to a safe message
                    const container = document.getElementById('admin-table-container');
                    if (container) {
                        container.innerHTML = `<pre style="color:red;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á: ${escapeHtml(e && e.message ? e.message : String(e))}</pre>`;
                    }
                }
            }

            // ---------- Session / Auth helpers ----------
            function isAdminSession() {
                try {
                    const token = sessionStorage.getItem('sessionToken');
                    const username = sessionStorage.getItem('username');
                    const isAdmin = sessionStorage.getItem('isAdmin'); // expected 'true' or 'false'

                    // require token and server-provided isAdmin flag
                    if (!token || !username) return false;
                    if (isAdmin === 'true') return true;
                    return false;
                } catch (e) {
                    console.error('admin: isAdminSession error', e);
                    return false;
                }
            }

            window.adminForceLogout = function () {
                try {
                    sessionStorage.removeItem('sessionToken');
                    sessionStorage.removeItem('username');
                    sessionStorage.removeItem('longName');
                    sessionStorage.removeItem('isAdmin');
                    // reuse existing logout function if present
                    if (typeof logout === 'function') logout();
                    else window.location.reload();
                } catch (e) {
                    console.error('adminForceLogout error', e);
                    sessionStorage.clear();
                    window.location.reload();
                }
            };

            window.adminCheckAuthAndInit = function () {
                const currentUserEl = document.getElementById('admin-current-user');
                const warning = document.getElementById('admin-access-warning');
                const controls = document.getElementById('admin-controls');

                const username = sessionStorage.getItem('username') || '';
                const longName = sessionStorage.getItem('longName') || '';
                if (currentUserEl) currentUserEl.textContent = username ? `${username} (${longName || '-'})` : '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô';

                if (!isAdminSession()) {
                    if (warning) warning.classList.remove('hidden');
                    if (controls) controls.classList.add('hidden');
                    if (typeof showLoginModal === 'function') showLoginModal();
                    return;
                }

                if (warning) warning.classList.add('hidden');
                if (controls) controls.classList.remove('hidden');
                if (typeof navigateTo === 'function') navigateTo('admin-view');
            };

            function showLoading(show = true) {
                const el = document.getElementById('admin-loading');
                const wrapper = document.getElementById('admin-table-wrapper');
                if (show) {
                    if (el) el.classList.remove('hidden');
                    if (wrapper) wrapper.classList.add('hidden');
                } else {
                    if (el) el.classList.add('hidden');
                }
            }

            // ---------- CSV export ----------
            window.adminExportCurrentToCSV = function () {
                try {
                    if (!lastFetchedData || lastFetchedData.length === 0) {
                        if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î');
                        else alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î');
                        return;
                    }

                    // Warn for large exports
                    const MAX_SAFE = 5000;
                    if (lastFetchedData.length > MAX_SAFE) {
                        const ok = confirm(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ${lastFetchedData.length} ‡πÅ‡∏ñ‡∏ß ‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏´‡∏ô‡πà‡∏ß‡∏á\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`);
                        if (!ok) return;
                    }

                    // Determine keys order: prefer currently displayed table header order, else first-seen order
                    let keys = [];
                    const tableEl = document.querySelector('#admin-table-container table');
                    if (tableEl) {
                        const ths = tableEl.querySelectorAll('thead th');
                        if (ths && ths.length) {
                            keys = Array.from(ths).map(th => th.textContent || th.innerText || '').filter(Boolean);
                        }
                    }
                    if (!keys || keys.length === 0) {
                        // build union preserving first-seen order
                        const seen = new Set();
                        lastFetchedData.forEach(row => {
                            if (row && typeof row === 'object') {
                                Object.keys(row).forEach(k => {
                                    if (!seen.has(k)) {
                                        seen.add(k);
                                        keys.push(k);
                                    }
                                });
                            }
                        });
                    }

                    // Fallback to small safe set if somehow still empty
                    if (!keys || keys.length === 0) keys = Object.keys(lastFetchedData[0] || {});

                    // Build CSV with proper quoting and newline handling
                    const rows = [];
                    const headerRow = keys.map(k => `"${String(k).replace(/"/g, '""')}"`).join(',');
                    rows.push(headerRow);

                    lastFetchedData.forEach(obj => {
                        const row = keys.map(k => {
                            let v = obj && Object.prototype.hasOwnProperty.call(obj, k) ? obj[k] : '';
                            if (v === null || v === undefined) return '""';
                            if (typeof v === 'object') {
                                try { v = JSON.stringify(v); } catch (e) { v = String(v); }
                            }
                            // Normalize to string and escape quotes
                            let s = String(v);
                            // Replace CRLF/CR with LF to avoid CSV injection problems (but keep newlines)
                            s = s.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                            s = s.replace(/"/g, '""');
                            return `"${s}"`;
                        }).join(',');
                        rows.push(row);
                    });

                    const csv = rows.join('\n');
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    const username = sessionStorage.getItem('username') || 'admin';
                    const filename = `admin_export_${username}_${new Date().toISOString().slice(0, 10)}.csv`;
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);
                } catch (e) {
                    console.error('adminExportCurrentToCSV error:', e);
                    if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', escapeHtml(e && e.message ? e.message : String(e)));
                    else alert(String(e));
                }
            };

            // ---------- Search/filter ----------
            window.adminFilterTable = function () {
                try {
                    const q = (document.getElementById('admin-search-input')?.value || '').trim().toLowerCase();
                    if (!q) {
                        displayTable(lastFetchedData);
                        return;
                    }
                    const filtered = lastFetchedData.filter(row => {
                        try {
                            return Object.values(row).some(v => {
                                if (v === null || v === undefined) return false;
                                if (typeof v === 'object') {
                                    try { v = JSON.stringify(v); } catch (e) { v = String(v); }
                                }
                                return String(v).toLowerCase().includes(q);
                            });
                        } catch (e) {
                            return false;
                        }
                    });
                    displayTable(filtered);
                } catch (e) {
                    console.error('adminFilterTable error:', e);
                }
            };

            // ---------- Admin actions (fetch) ----------
            function setFetching(flag) {
                isFetching = flag;
                setAdminControlsDisabled(flag);
                showLoading(flag);
            }

            window.adminFetchAllFarmers = function () {
                if (!isAdminSession()) {
                    if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠', '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ');
                    return;
                }

                if (isFetching) return;
                setFetching(true);
                const token = sessionStorage.getItem('sessionToken') || '';

                try {
                    if (typeof isAppsScriptReady === 'function' && !isAppsScriptReady('Admin Fetch')) {
                        setFetching(false);
                        return;
                    }

                    if (typeof google === 'undefined' || !google.script || !google.script.run) {
                        setFetching(false);
                        if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'google.script.run ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                        return;
                    }

                    google.script.run
                        .withSuccessHandler(result => {
                            setFetching(false);
                            console.log('=== adminFetchAllFarmers SUCCESS ===', result);

                            if (result === null || result === undefined) {
                                if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå', 'getAllFarmers ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô null/undefined');
                                return;
                            }

                            try {
                                let data = result;
                                if (typeof result === 'string') {
                                    data = JSON.parse(result);
                                }

                                if (!data) {
                                    if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÑ‡∏î‡πâ');
                                    return;
                                }

                                if (data.success === false) {
                                    if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (server)', escapeHtml(data.message || JSON.stringify(data)));
                                    return;
                                }

                                if (data.success && Array.isArray(data.data)) {
                                    displayTable(data.data);
                                    return;
                                }

                                if (Array.isArray(data)) {
                                    displayTable(data);
                                    return;
                                }

                                if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', `<pre>${escapeHtml(JSON.stringify(data, null, 2))}</pre>`);
                            } catch (e) {
                                console.error('Parse error:', e);
                                if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:  ' + escapeHtml(e.message || String(e)));
                            }
                        })
                        .withFailureHandler(err => {
                            setFetching(false);
                            console.error('=== adminFetchAllFarmers FAILURE ===', err);
                            fetchAndShowAdminDebug(token, 'getAllFarmers failed (failureHandler)');
                            if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', escapeHtml((err && err.message) || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Backend ‡πÑ‡∏î‡πâ'));
                        })
                        .getAllFarmers(token);

                } catch (e) {
                    setFetching(false);
                    console.error('=== adminFetchAllFarmers EXCEPTION ===', e);
                    if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + escapeHtml(e.message || String(e)));
                }
            };

            window.adminFetchAllUsage = function () {
                if (!isAdminSession()) {
                    if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠', '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ');
                    return;
                }

                if (isFetching) return;
                setFetching(true);
                const token = sessionStorage.getItem('sessionToken') || '';

                try {
                    if (typeof isAppsScriptReady === 'function' && !isAppsScriptReady('Admin Fetch')) {
                        setFetching(false);
                        return;
                    }

                    if (typeof google === 'undefined' || !google.script || !google.script.run) {
                        setFetching(false);
                        if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'google.script.run ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                        return;
                    }

                    google.script.run
                        .withSuccessHandler(result => {
                            setFetching(false);
                            console.log('getAllUsage result:', result);

                            if (result === null || typeof result === 'undefined') {
                                fetchAndShowAdminDebug(token, 'getAllUsage returned null/undefined');
                                return;
                            }
                            try {
                                const data = (typeof result === 'string') ? JSON.parse(result) : result;
                                if (!data) { if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå', 'getAllUsage ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô null/undefined'); return; }
                                if (data.success === false) { if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (server)', escapeHtml(data.message || JSON.stringify(data))); return; }
                                if (data.success && Array.isArray(data.data)) { displayTable(data.data); return; }
                                if (Array.isArray(data)) { displayTable(data); return; }
                                if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î', `<pre style="white-space:pre-wrap;">${escapeHtml(JSON.stringify(data, null, 2))}</pre>`);
                            } catch (e) {
                                console.error('adminFetchAllUsage parse error', e);
                                if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ' + escapeHtml(e && e.message));
                            }
                        })
                        .withFailureHandler(err => {
                            setFetching(false);
                            console.error('adminFetchAllUsage failed', err);
                            fetchAndShowAdminDebug(token, 'getAllUsage failed (failureHandler)');
                            if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', escapeHtml((err && err.message) || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Backend ‡πÑ‡∏î‡πâ'));
                        })
                        .getAllUsage(token);

                } catch (e) {
                    setFetching(false);
                    if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö', '‡πÑ‡∏°‡πà‡∏û‡∏ö google.script.run ‡πÉ‡∏ô‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡∏ô‡∏µ‡πâ');
                }
            };

            window.adminFetchMerged = function () {
                if (!isAdminSession()) {
                    if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠', '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ');
                    return;
                }

                if (isFetching) return;
                setFetching(true);
                const token = sessionStorage.getItem('sessionToken') || '';

                try {
                    if (typeof isAppsScriptReady === 'function' && !isAppsScriptReady('Admin Fetch')) {
                        setFetching(false);
                        return;
                    }

                    if (typeof google === 'undefined' || !google.script || !google.script.run) {
                        setFetching(false);
                        if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'google.script.run ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                        return;
                    }

                    google.script.run
                        .withSuccessHandler(result => {
                            setFetching(false);
                            console.log('getAllMerged result:', result);

                            if (result === null || typeof result === 'undefined') {
                                fetchAndShowAdminDebug(token, 'getAllMerged returned null/undefined');
                                return;
                            }

                            try {
                                const data = (typeof result === 'string') ? JSON.parse(result) : result;
                                if (!data) { if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå', 'getAllMerged ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô null/undefined'); return; }
                                if (data.success === false) { if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (server)', escapeHtml(data.message || JSON.stringify(data))); return; }
                                if (data.success && Array.isArray(data.data)) { displayTable(data.data); return; }
                                if (Array.isArray(data)) { displayTable(data); return; }
                                if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î', `<pre style="white-space:pre-wrap;">${escapeHtml(JSON.stringify(data, null, 2))}</pre>`);
                            } catch (e) {
                                console.error('adminFetchMerged parse error', e);
                                if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ' + escapeHtml(e && e.message));
                            }
                        })
                        .withFailureHandler(err => {
                            setFetching(false);
                            console.error('adminFetchMerged failed', err);
                            fetchAndShowAdminDebug(token, 'getAllMerged failed (failureHandler)');
                            if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', escapeHtml((err && err.message) || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Backend ‡πÑ‡∏î‡πâ'));
                        })
                        .getAllMerged(token);

                } catch (e) {
                    setFetching(false);
                    if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö', '‡πÑ‡∏°‡πà‡∏û‡∏ö google.script.run ‡πÉ‡∏ô‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡∏ô‡∏µ‡πâ');
                }
            };

            // ---------- Test / debug actions ----------
            window.testAdminConnection = function () {
                if (!isAdminSession()) {
                    if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏ûÔøΩÔøΩ', '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ');
                    return;
                }

                const token = sessionStorage.getItem('sessionToken') || '';

                if (typeof isAppsScriptReady === 'function' && !isAppsScriptReady('Admin Test')) return;

                setAdminControlsDisabled(true);
                google.script.run
                    .withSuccessHandler(result => {
                        setAdminControlsDisabled(false);
                        console.log('Test result:', result);
                        if (typeof showMessageBox === 'function') showMessageBox('üîç ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö Admin', `<pre style="white-space:pre-wrap;">${escapeHtml(JSON.stringify(result, null, 2))}</pre>`);
                    })
                    .withFailureHandler(err => {
                        setAdminControlsDisabled(false);
                        console.error('Test failed:', err);
                        if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', escapeHtml((err && err.message) || 'Unknown error'));
                    })
                    .testAdminAccess(token);
            };

            window.adminTestSheetAccess = function () {
                if (!isAdminSession()) {
                    if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠', '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ');
                    return;
                }
                if (typeof isAppsScriptReady === 'function' && !isAppsScriptReady('Sheet Test')) return;

                setAdminControlsDisabled(true);
                google.script.run
                    .withSuccessHandler(result => {
                        setAdminControlsDisabled(false);
                        console.log('Sheet access test result:', result);
                        if (typeof showMessageBox === 'function') showMessageBox('üìä ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö Sheet Access', `<pre style="white-space:pre-wrap;">${escapeHtml(JSON.stringify(result, null, 2))}</pre>`);
                    })
                    .withFailureHandler(err => {
                        setAdminControlsDisabled(false);
                        console.error('Sheet test failed:', err);
                        if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Sheet ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', escapeHtml((err && err.message) || 'Unknown error'));
                    })
                    .testSheetAccessPublic();
            };

            window.adminSimpleTest = function () {
                if (typeof isAppsScriptReady === 'function' && !isAppsScriptReady('Simple Test')) return;
                setAdminControlsDisabled(true);
                google.script.run
                    .withSuccessHandler(result => {
                        setAdminControlsDisabled(false);
                        if (typeof showMessageBox === 'function') showMessageBox('‚úÖ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Simple', `‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ${escapeHtml(JSON.stringify(result))}`);
                    })
                    .withFailureHandler(err => {
                        setAdminControlsDisabled(false);
                        if (typeof showMessageBox === 'function') showMessageBox('‚ùå Simple Test ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', escapeHtml((err && err.message) || 'Unknown error'));
                    })
                    .testPing();
            };

            window.directTestGetAllFarmers = function () {
                if (!isAdminSession()) {
                    if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠', '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ');
                    return;
                }
                setAdminControlsDisabled(true);
                const token = sessionStorage.getItem('sessionToken') || '';
                google.script.run
                    .withSuccessHandler(result => {
                        setAdminControlsDisabled(false);
                        console.log('DIRECT TEST - Success handler called', result);
                        if (typeof showMessageBox === 'function') showMessageBox('üîç ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á', `<pre style="white-space: pre-wrap;">${escapeHtml(JSON.stringify(result, null, 2))}</pre>`);
                    })
                    .withFailureHandler(err => {
                        setAdminControlsDisabled(false);
                        console.error('DIRECT TEST - Failure:', err);
                        if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', escapeHtml((err && err.message) || 'Unknown error'));
                    })
                    .getAllFarmers(token);
            };

            window.testGetAllFarmersDebug = function () {
                if (!isAdminSession()) {
                    if (typeof showMessageBox === 'function') showMessageBox('‚ùå ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠', '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ');
                    return;
                }
                setAdminControlsDisabled(true);
                const token = sessionStorage.getItem('sessionToken') || '';
                google.script.run
                    .withSuccessHandler(result => {
                        setAdminControlsDisabled(false);
                        console.log('DEBUG TEST - Success:', result);
                        if (typeof showMessageBox === 'function') showMessageBox('üîç Debug Test Results', `<pre style="white-space:pre-wrap;">${escapeHtml(JSON.stringify(result, null, 2))}</pre>`);
                    })
                    .withFailureHandler(err => {
                        setAdminControlsDisabled(false);
                        console.error('DEBUG TEST - Failure:', err);
                        if (typeof showMessageBox === 'function') showMessageBox('‚ùå Debug Test ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', escapeHtml((err && err.message) || 'Unknown error'));
                    })
                    .getAllFarmersDebug(token);
            };

            // expose internal helpers for debugging
            window._admin_internal = {
                displayTable,
                isAdminSession,
                fetchAndShowAdminDebug,
                getCurrentDisplayKeys: () => currentDisplayKeys.slice(),
                getLastFetchedData: () => lastFetchedData.slice()
            };

            // observer to auto-call adminCheckAuthAndInit when view shown (if you use navigateTo)
            const adminView = document.getElementById('admin-view');
            if (adminView) {
                const mo = new MutationObserver(() => {
                    if (!adminView.classList.contains('hidden')) setTimeout(() => adminCheckAuthAndInit(), 50);
                });
                mo.observe(adminView, { attributes: true, attributeFilter: ['class'] });
            }
        })();

        // =============================================
        // INITIALIZATION ‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å
        // =============================================
        window.onload = () => {
            try {
                populateLongOptions();
                showView('main-menu-view');
                initializeFertilizerCheckboxes();

                const currentUser = checkLoginStatus();
                if (currentUser) {
                    updateAllLongDropdowns(currentUser.longName);
                    updateSheetALongDropdown();
                }

                isAppsScriptReady('Initialization');

                console.log('‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');
            } catch (error) {
                console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö:', error);
                showMessageBox("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏ö‡∏ö",
                    "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö: " + error.message
                );
            }
        };

        // =============================================
        // GLOBAL FUNCTION EXPORTS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≥‡∏£‡∏ß‡∏à
        // =============================================
        window.toggleAgentInput = toggleAgentInput;
        window.toggleDateRange = toggleDateRange;
        window.renderStemSection = renderStemSection;
        window.calculateTotal = calculateTotal;
        window.setupOtherToggles = setupOtherToggles;
        window.showCustomAlert = showCustomAlert;

        // General exports for other modules
        window.showLoginModal = showLoginModal;
        window.hideLoginModal = hideLoginModal;
        window.handleLogin = handleLogin;
        window.checkAuthAndShowSubmenu = checkAuthAndShowSubmenu;
        window.logout = logout;
        window.toggleOtherWateringInput = toggleOtherWateringInput;
        window.toggleOtherFertilizerInput = toggleOtherFertilizerInput;
        window.handleSheetASubmit = handleSheetASubmit;
        window.hideMessageBox = hideMessageBox;
        window.fetchAndDisplaySheetAData = fetchAndDisplaySheetAData;

        window.getFertilizerUsageData = getFertilizerUsageData;
        window.getUsageData = getUsageData;
        window.toggleOtherFertilizerInputUse = toggleOtherFertilizerInputUse;
        window.initializeFertilizerCheckboxes = initializeFertilizerCheckboxes;
        window.resetUsageContainers = resetUsageContainers;
        window.createFertilizerUsageHTML = createFertilizerUsageHTML;
        window.handleSheetBUseSubmit = handleSheetBUseSubmit;

        window.toggleAdjustedBRate = toggleAdjustedBRate;
        window.toggleAdjustedBNanoRate = toggleAdjustedBNanoRate;
        window.fetchAndDisplaySheetBUseData = fetchAndDisplaySheetBUseData;
        window.fetchSummaryData = fetchSummaryData;
        window.openExpansionForm = openSurveyForm;
        window.openLeafSampleForm = openLeafSampleForm;

        // alias navigateTo to existing showView
        window.navigateTo = showView;

        // =============================================
        // PWA SERVICE WORKER REGISTRATION
        // =============================================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registered successfully:', registration.scope);
                        
                        // Check for updates periodically
                        setInterval(() => {
                            registration.update();
                        }, 60000); // Check every minute
                        
                        // Handle service worker updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New service worker available
                                    console.log('üîÑ New version available! Please refresh.');
                                    
                                    // Optionally show a notification to the user
                                    if (window.confirm('‡∏°‡∏µ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('‚ùå Service Worker registration failed:', error);
                    });
                
                // Handle service worker controller change (when new SW takes over)
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('üîÑ Service Worker controller changed, reloading page...');
                    window.location.reload();
                });
            });
        } else {
            console.warn('‚ö†Ô∏è Service Workers are not supported in this browser');
        }

        // =============================================
        // PWA INSTALL PROMPT
        // =============================================
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent the mini-infobar from appearing on mobile
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            
            console.log('üíæ PWA install prompt available');
            
            // Optionally show a custom install button
            // You can create a button in the UI and call showInstallPrompt() when clicked
        });
        
        window.showInstallPrompt = async function() {
            if (!deferredPrompt) {
                console.log('‚ÑπÔ∏è Install prompt not available');
                return;
            }
            
            // Show the install prompt
            deferredPrompt.prompt();
            
            // Wait for the user to respond to the prompt
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                console.log('‚úÖ User accepted the install prompt');
            } else {
                console.log('‚ùå User dismissed the install prompt');
            }
            
            // Clear the deferredPrompt
            deferredPrompt = null;
        };
        
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ PWA installed successfully');
            deferredPrompt = null;
        });
    </script>
</body>

</html>